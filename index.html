<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Sim Generator v16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="data/interventions.js"></script>
    <script src="data/scenarios.js"></script>
    
    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .flash-red { animation: flashRed 1.5s ease-in-out infinite; }
        @keyframes flashRed { 0%, 100% { background-color: rgba(30, 41, 59, 1); } 50% { background-color: rgba(127, 29, 29, 0.5); } }
        .flash-green { animation: flashGreen 1s ease-in-out; }
        @keyframes flashGreen { 0%, 100% { border-color: #334155; } 50% { border-color: #10b981; } }
        html, body { height: 100%; overflow: hidden; overscroll-behavior-y: none; }
        body { background-color: #0f172a; color: #f1f5f9; display: flex; flex-direction: column; user-select: none; -webkit-user-select: none; }
        #root { height: 100%; display: flex; flex-direction: column; }
        .loading-bar { position: absolute; bottom: 0; left: 0; height: 100%; background-color: rgba(16, 185, 129, 0.2); animation: loadProgress 2s linear forwards; z-index: 0; }
        @keyframes loadProgress { from { width: 0%; } to { width: 100%; } }
        .diamond-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 768px) { .diamond-grid { grid-template-columns: 1fr; } }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button { touch-action: manipulation; }
    </style>
</head>
<body class="antialiased selection:bg-sky-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
    // --- LOAD EXTERNAL DATA ---
    const INTERVENTIONS = window.INTERVENTIONS || {};
    const RAW_SCENARIOS = window.RAW_SCENARIOS || [];

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBz77EHl9QhFJ0k2ZFODydChuGeCAXq1II",
        authDomain: "wmebem-sim.firebaseapp.com",
        projectId: "wmebem-sim",
        storageBucket: "wmebem-sim.firebasestorage.app",
        messagingSenderId: "143041936940",
        appId: "1:143041936940:web:4d15c3fc3ce7e10c081b89",
        measurementId: "G-8C6WW1EWXJ"
    };

    let db = null;
    try {
        if (window.firebase) {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            else firebase.app();
            db = firebase.database();
        }
    } catch (e) { console.error("Firebase Init Error:", e); }
    
    // --- HELPER FUNCTIONS ---
    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getRandomFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
    const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

    const generateHistory = (age, sex = 'Male') => {
        if (age < 20) return { pmh: ["Nil significant"], dhx: ["Nil"], allergies: ["Nil"] };
        const commonPMH = ["Hypertension", "Type 2 Diabetes", "Asthma", "Hyperlipidaemia", "GORD", "Depression", "Anxiety", "Previous MI", "AF", "CKD Stage 3"];
        let pmh = []; let dhx = [];
        const pmhCount = age > 60 ? getRandomInt(1, 4) : age > 40 ? getRandomInt(0, 2) : getRandomInt(0, 1);
        for(let i=0; i<pmhCount; i++) { const item = getRandomItem(commonPMH); if(!pmh.includes(item)) pmh.push(item); }
        if (pmh.includes("Hypertension")) dhx.push("Ramipril 5mg OD");
        if (pmh.includes("Type 2 Diabetes")) dhx.push("Metformin 1g BD");
        if (pmh.includes("Asthma")) dhx.push("Salbutamol PRN", "Beclometasone BD");
        if (pmh.length === 0) pmh.push("Nil significant");
        if (dhx.length === 0) dhx.push("Nil regular medications");
        return { pmh: pmh, dhx: dhx, allergies: [Math.random() > 0.8 ? getRandomItem(["Penicillin", "Latex", "NSAIDs"]) : "NKDA"] };
    };

    const estimateWeight = (age) => {
        if (age < 0) return null;
        if (age === 0) return "3.5"; 
        if (age < 1) return "6.0"; 
        if (age >= 1 && age <= 10) return Math.round((age + 4) * 2); 
        if (age > 10 && age < 16) return Math.round(age * 3 + 7); 
        return null;
    };

    const calculateWetflag = (age, weightStr) => {
        const weight = parseFloat(weightStr);
        if (isNaN(weight) || weight <= 0) return null;
        return {
            weight: weight,
            energy: Math.min(200, Math.round(weight * 4)),
            tube: age < 1 ? "3.5-4.0" : Math.min(8.0, ((age / 4) + 4)).toFixed(1),
            fluids: Math.round(weight * 10),
            lorazepam: Math.min(4, weight * 0.1).toFixed(1),
            adrenaline: Math.min(10, weight * 0.1).toFixed(1),
            glucose: Math.round(weight * 2)
        };
    };

    const generateVbg = (clinicalState = "normal") => {
        let vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.0, K: 4.0, Glu: 5.5 };
        vbg.pH += getRandomFloat(-0.03, 0.03, 2);
        switch (clinicalState) {
            case "dka_severe": vbg = { pH: 6.95, pCO2: 2.5, HCO3: 5, BE: -24, Lac: 2.5, K: 5.4, Glu: 28.0 }; break;
            case "septic_shock": vbg = { pH: 7.25, pCO2: 4.5, HCO3: 16, BE: -8, Lac: 6.5, K: 4.2, Glu: 4.0 }; break;
            case "haemorrhagic_shock": vbg = { pH: 7.20, pCO2: 4.8, HCO3: 14, BE: -10, Lac: 8.0, K: 3.8, Glu: 9.0 }; break;
            case "copd_retainer": vbg = { pH: 7.30, pCO2: 9.5, HCO3: 34, BE: 8, Lac: 1.2, K: 4.0, Glu: 6.0 }; break;
            case "metabolic_acidosis_severe": vbg = { pH: 6.90, pCO2: 6.0, HCO3: 10, BE: -22, Lac: 12.0, K: 6.5, Glu: 6.0 }; break;
            default: break;
        }
        return vbg;
    };

    const calculateDynamicVbg = (startVbg, currentVitals, activeInterventions, timeSeconds) => {
        if (!startVbg) return { pH: 7.4, pCO2: 5.0, HCO3: 24, Lac: 1.0, K: 4.0, Glu: 5.5 };
        let vbg = { ...startVbg };
        const minutes = timeSeconds / 60;
        const isVentilated = activeInterventions.has('Bagging') || activeInterventions.has('RSI') || activeInterventions.has('i-gel') || activeInterventions.has('NIV');
        if (currentVitals.rr < 10 && !isVentilated) {
            vbg.pCO2 = Math.min(15, vbg.pCO2 + (0.1 * minutes)); 
            vbg.pH = Math.max(6.8, vbg.pH - (0.01 * minutes));
        }
        if (currentVitals.spO2 < 85 || currentVitals.bpSys < 80) {
            vbg.Lac = Math.min(15, vbg.Lac + (0.1 * minutes));
            vbg.pH = Math.max(6.8, vbg.pH - (0.01 * minutes));
        }
        return vbg;
    };

    const HUMAN_FACTOR_CHALLENGES = [
      { id: 'hf0', type: 'Standard Simulation', description: 'Manage effectively.' },
      { id: 'hf1', type: 'Blindfolded Lead', description: 'Leader blindfolded. Tests closed-loop comms.' },
      { id: 'hf2', type: 'Silent Team', description: 'Only leader speaks.' },
      { id: 'hf3', type: 'New Junior', description: 'Junior member needs explicit instructions.' },
      { id: 'hf4', type: 'Missing Kit', description: 'Crucial equipment missing.' },
      { id: 'hf5', type: 'Distracted Senior', description: 'Consultant on phone, dismissive.' },
    ];

    // --- ENRICH SCENARIOS ---
    const ALL_SCENARIOS = RAW_SCENARIOS.map(s => {
        let kit = ['Monitoring', 'IV Access'];
        let links = [];
        if (s.acuity === 'Resus') kit = [...kit, 'Defibrillator', 'Airway Trolley', 'Drugs Bag', 'IO Drill', 'Ultrasound'];
        if (s.ageRange === 'Paediatric') {
            links.push({ label: 'RCUK Paeds Guidelines 2025', url: 'https://www.resus.org.uk/professional-library/2025-resuscitation-guidelines' });
            links.push({ label: 'APLS Algorithms', url: '#' });
        } else {
            links.push({ label: 'RCUK Adult ALS 2025', url: 'https://www.resus.org.uk/professional-library/2025-resuscitation-guidelines/adult-advanced-life-support-guidelines' });
        }
        
        let improved = { ...s };
        let deteriorated = { ...s };

        if (s.chestXray) {
            let newCXR = s.chestXray.findings;
            if (newCXR.includes("Pneumothorax")) newCXR = "Lung re-expanded. No residual pneumothorax.";
            improved.chestXray = { findings: newCXR };
        }
        
        return {
            ...s,
            equipment: s.instructorBrief?.equipment || kit, 
            learningLinks: s.learningLinks || links,
            evolution: { improved, deteriorated }
        };
    });

    // --- COMPONENTS ---
    const { useState, useEffect, useRef, useReducer } = React;
    
    // Lucide Icon
    const Lucide = React.memo(({ icon, className = "" }) => {
        const ref = useRef(null);
        useEffect(() => {
            if (!ref.current || !window.lucide) return;
            ref.current.innerHTML = '';
            const kebabToPascal = (str) => str.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
            const iconName = kebabToPascal(icon);
            if (window.lucide.icons && window.lucide.icons[iconName]) {
                 if (window.lucide.createElement) {
                     const svg = window.lucide.createElement(window.lucide.icons[iconName]);
                     if (className) svg.setAttribute('class', className);
                     ref.current.appendChild(svg);
                     return;
                 }
            }
            if (window.lucide.createIcons) {
                const i = document.createElement('i');
                i.setAttribute('data-lucide', icon);
                if (className) i.setAttribute('class', className);
                ref.current.appendChild(i);
                window.lucide.createIcons({ root: ref.current });
            }
        }, [icon, className]);
        return <span ref={ref} className="inline-flex items-center justify-center"></span>;
    });

    const Button = ({ onClick, children, variant = 'primary', className = '', disabled = false, progress = 0 }) => {
        let variants = {
            primary: "bg-sky-600 hover:bg-sky-500 text-white",
            secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
            danger: "bg-red-600 hover:bg-red-500 text-white",
            success: "bg-emerald-600 hover:bg-emerald-500 text-white",
            warning: "bg-amber-500 hover:bg-amber-600 text-white",
            outline: "border border-slate-600 text-slate-300 hover:bg-slate-800"
        };
        return (
            <button onClick={onClick} disabled={disabled} className={`px-4 py-3 rounded font-semibold transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 relative overflow-hidden z-0 ${variants[variant]} ${className}`}>
                {progress > 0 && <div className="absolute top-0 left-0 bottom-0 bg-emerald-500/50 z-[-1] transition-all duration-1000 ease-linear" style={{ width: `${progress}%` }}></div>}
                <span className="relative z-10 flex items-center gap-2 whitespace-nowrap w-full justify-center">{children}</span>
            </button>
        );
    };

    const Card = ({ title, icon, children, className = "", collapsible = false, defaultOpen = true }) => {
        const [isOpen, setIsOpen] = useState(defaultOpen);
        return (
            <div className={`bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-lg flex flex-col ${className}`}>
                {title && (
                    <div className={`bg-slate-800/50 p-3 border-b border-slate-700 flex items-center justify-between flex-shrink-0 ${collapsible ? 'cursor-pointer hover:bg-slate-700/50' : ''}`} onClick={() => collapsible && setIsOpen(!isOpen)}>
                        <div className="flex items-center gap-2">
                            {icon && <Lucide icon={icon} className="w-5 h-5 text-sky-400" />}
                            <h3 className="font-bold text-slate-200">{title}</h3>
                        </div>
                        {collapsible && <Lucide icon="chevron-down" className={`w-4 h-4 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />}
                    </div>
                )}
                {(!collapsible || isOpen) && <div className="p-4 animate-fadeIn flex-grow overflow-auto min-h-0">{children}</div>}
            </div>
        );
    };

    const VitalDisplay = ({ label, value, value2, prev, unit, lowIsBad = true, onUpdate, alert, isText = false, visible = true, isMonitor = false, hideTrends = false }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editVal, setEditVal] = useState(value);
        useEffect(() => { if (!isEditing) setEditVal(value); }, [value, isEditing]);
        const handleBlur = () => { setIsEditing(false); if (editVal !== value) onUpdate(isText ? editVal : parseFloat(editVal)); };
        const isBP = label === "BP" || label === "NIBP" || label === "ABP";

        if (isMonitor) {
            if (!visible) return <div className="flex flex-col items-center justify-center h-full bg-slate-900/20 rounded border border-slate-800 opacity-20"><span className="text-sm md:text-2xl font-bold text-slate-600">{label}</span><span className="text-2xl md:text-4xl font-mono text-slate-700">--</span></div>;
            return (
                <div className={`flex flex-col items-center justify-center h-full w-full rounded border-2 transition-colors duration-500 overflow-hidden ${alert ? 'bg-red-900/40 border-red-500 animate-pulse' : 'bg-slate-900/40 border-slate-700'}`}>
                    <span className="text-xs md:text-xl font-bold text-slate-400 uppercase tracking-widest mb-1">{label}</span>
                    <div className="flex items-baseline justify-center gap-1 md:gap-2 w-full text-center">
                        <span className={`font-mono font-bold text-white leading-none ${isText ? 'text-2xl md:text-5xl' : 'text-4xl md:text-6xl lg:text-7xl'}`}>
                            {value === '?' ? '--' : (isText ? value : Math.round(value * 10) / 10)}
                            {isBP && <span className="text-2xl md:text-5xl text-slate-400">/{value2 !== undefined ? Math.round(value2) : '--'}</span>}
                        </span>
                    </div>
                    <span className="text-xs md:text-lg text-slate-500 mt-1 md:mt-2">{unit}</span>
                </div>
            );
        }

        if (!visible) return <div className="bg-slate-900/50 p-1 md:p-2 rounded border border-slate-800 flex flex-col items-center justify-center h-20 relative opacity-40"><span className="text-[9px] font-bold text-slate-600 uppercase">{label}</span><span className="text-xl font-mono text-slate-700">--</span></div>;

        return (
            <div className={`bg-slate-900/50 p-1 md:p-2 rounded border flex flex-col items-center justify-center h-20 relative transition-colors duration-300 ${alert ? 'border-red-500 bg-red-900/20' : 'border-slate-700'}`}>
                <span className="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">{label}</span>
                {isEditing ? (
                    <input type={isText ? "text" : "number"} value={editVal} onChange={(e) => setEditVal(e.target.value)} onBlur={handleBlur} onKeyDown={(e) => e.key === 'Enter' && handleBlur()} className="text-lg font-mono font-bold text-white bg-slate-800 border border-slate-500 rounded w-full text-center" autoFocus />
                ) : (
                    <div className="flex items-baseline gap-1 cursor-pointer hover:bg-slate-800/50 rounded px-2 py-0.5" onClick={() => { setEditVal(value); setIsEditing(true); }}>
                        <span className={`font-mono font-bold text-white ${isText ? 'text-lg' : 'text-2xl'}`}>
                            {value === '?' ? '--' : (isText ? value : Math.round(value * 10) / 10)}
                            {isBP && <span className="text-lg text-slate-400 ml-0.5">/{value2 !== undefined ? Math.round(value2) : '--'}</span>}
                        </span>
                    </div>
                )}
                <span className="text-[8px] md:text-[9px] text-slate-600 leading-none">{unit}</span>
            </div>
        );
    };

    const ECGMonitor = ({ rhythmType, hr, isPaused, showEtco2, rr, pathology, spO2, showTraces, showArt, isCPR, className = "h-40", rhythmLabel = null }) => {
        const canvasRef = useRef(null);
        const requestRef = useRef(null);
        const drawState = useRef({ x: 0, lastY: 50, beatProgress: 0, breathProgress: 0, lastTime: 0, lastYCO2: 0, lastYPleth: 0, lastYArt: 0 });
        const propsRef = useRef({ rhythmType, hr, rr, showEtco2, pathology, isPaused, spO2, showTraces, showArt, isCPR, rhythmLabel });

        useEffect(() => { propsRef.current = { rhythmType, hr, rr, showEtco2, pathology, isPaused, spO2, showTraces, showArt, isCPR, rhythmLabel }; }, [rhythmType, hr, rr, showEtco2, pathology, isPaused, spO2, showTraces, showArt, isCPR, rhythmLabel]);

        const getWaveform = (type, t, cpr, baseline) => {
            const noise = (Math.random() - 0.5) * 1.5;
            if (cpr) return baseline + (Math.sin(t * 12) * 45) + (Math.random() * 10 - 5);
            if (type === 'Asystole') return baseline + noise;
            if (type === 'VF' || type === 'Coarse VF') return baseline + Math.sin(t * 20) * 25 + Math.sin(t * 7) * 30 + noise * 3;
            if (type === 'VT' || type === 'VT (No Pulse)') { let y = baseline; if (t < 0.2) y += Math.sin(t * 5 * Math.PI) * 50; else if (t < 0.6) y -= Math.sin((t-0.2) * 2.5 * Math.PI) * 50; return y + noise; }
            let y = baseline;
            const hasP = !['AF', 'SVT', 'VT', 'VF', 'Asystole', 'PEA'].includes(type);
            if (hasP && t < 0.1) y -= Math.sin(t/0.1 * Math.PI) * 4;
            if (type === 'AF') y += Math.sin(t * 60) * 2 + Math.sin(t * 37) * 1.5;
            if (t > 0.12 && t < 0.14) y += 3; else if (t >= 0.14 && t < 0.18) y -= 55; else if (t >= 0.18 && t < 0.20) y += 12; 
            if (type === 'STEMI' && t >= 0.20 && t < 0.4) { y -= 15; y -= Math.sin((t-0.20)/0.2 * Math.PI) * 8; }
            else if (t > 0.3 && t < 0.5) y -= Math.sin((t-0.3)/0.2 * Math.PI) * 8;
            return y + noise;
        };

        useEffect(() => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            const setSize = () => { if(canvas.parentElement) { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; drawState.current.lastY = canvas.height * 0.30; } };
            setSize();
            window.addEventListener('resize', setSize);

            const animate = (timestamp) => {
                const state = drawState.current;
                const props = propsRef.current;
                if (!state.lastTime) state.lastTime = timestamp;
                let dt = (timestamp - state.lastTime) / 1000; if (dt > 0.05) dt = 0.05;
                state.lastTime = timestamp;
                if (props.isPaused) { requestRef.current = requestAnimationFrame(animate); return; }

                const ecgSpeed = 150; const dx = ecgSpeed * dt;
                const prevX = state.x; state.x += dx;
                ctx.fillStyle = '#000000';
                if (state.x + 30 < canvas.width) ctx.fillRect(state.x, 0, 35, canvas.height);
                else { ctx.fillRect(state.x, 0, canvas.width - state.x, canvas.height); ctx.fillRect(0, 0, 30, canvas.height); }

                const baselineECG = canvas.height * 0.30;
                if (!props.showTraces) { ctx.strokeStyle = '#111'; ctx.beginPath(); ctx.moveTo(prevX, baselineECG); ctx.lineTo(state.x, baselineECG); ctx.stroke(); requestRef.current = requestAnimationFrame(animate); return; }

                let currentRhythm = props.rhythmType || 'Sinus Rhythm';
                let beatDuration = 60 / Math.max(10, props.isCPR ? 110 : (props.hr || 60));
                if (['VF', 'Coarse VF', 'Fine VF'].includes(currentRhythm)) beatDuration = 0.2;
                state.beatProgress += dt / beatDuration; if (state.beatProgress >= 1) state.beatProgress = 0;

                if (state.x > canvas.width) { state.x = 0; state.lastY = getWaveform(currentRhythm, state.beatProgress, props.isCPR, baselineECG); }

                const yECG = getWaveform(currentRhythm, state.beatProgress, props.isCPR, baselineECG);
                if (state.x > prevX) { ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round'; ctx.beginPath(); ctx.moveTo(prevX, state.lastY); ctx.lineTo(state.x, yECG); ctx.stroke(); }
                state.lastY = yECG;

                requestRef.current = requestAnimationFrame(animate);
            };
            requestRef.current = requestAnimationFrame(animate);
            return () => { window.removeEventListener('resize', setSize); if (requestRef.current) cancelAnimationFrame(requestRef.current); };
        }, []);

        const labelClass = "absolute right-2 px-2 py-0.5 rounded border-l-2 text-[10px] md:text-sm font-mono font-bold bg-black/60 shadow-md";
        return (
            <div className={`w-full bg-black rounded border border-slate-700 relative overflow-hidden ${className}`}>
                <canvas ref={canvasRef} className="block w-full h-full"></canvas>
                {showTraces && <div className={`${labelClass} border-green-500 text-green-500 top-[5%]`}>{propsRef.current.rhythmLabel || rhythmType}</div>}
            </div>
        );
    };

    const InvestigationButton = ({ type, icon, label, isRevealed, isLoading, revealInvestigation, isRunning, scenario }) => {
        const hasData = (type === 'ECG' && scenario.ecg) || (type === 'X-ray' && scenario.chestXray) || (type === 'POCUS' && scenario.ultrasound) || (type === 'VBG' && scenario.vbg) || (type === 'CT' && scenario.ct) || (type === 'Urine' && scenario.urine);
        return (
            <div className="flex flex-col gap-2">
                <Button variant={isRevealed ? "secondary" : "outline"} onClick={() => revealInvestigation(type)} disabled={!isRunning || isRevealed || isLoading} className="h-10 text-xs relative overflow-hidden">
                    {isLoading && <div className="loading-bar"></div>}
                    <div className="relative z-10 flex items-center gap-2"><Lucide icon={icon} className="w-3 h-3"/> {isLoading ? `Requesting...` : (isRevealed ? `View ${type}` : `Request ${type}`)}</div>
                </Button>
                {isRevealed && (
                    <div className="p-3 bg-slate-700/30 rounded text-xs border-l-2 border-sky-500 animate-fadeIn">
                        {hasData ? (
                            type === 'VBG' ? <div className="font-mono space-y-1"><div>pH: {scenario.vbg.pH.toFixed(2)}</div><div>pCO2: {scenario.vbg.pCO2} kPa</div><div>Lac: {scenario.vbg.Lac}</div><div className="font-bold text-sky-400">Glu: {scenario.vbg.Glu}</div></div> : 
                            type === 'ECG' ? <div><p className="mb-1 font-bold">{scenario.ecg.findings}</p></div> : 
                            type === 'X-ray' ? <div className="text-slate-200">{scenario.chestXray.findings}</div> : 
                            'Result Available'
                        ) : 'Normal / Not Indicated'}
                    </div>
                )}
            </div>
        );
    };

    const DisclaimerModal = ({ onAccept }) => (
        <div className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4">
             <div className="bg-slate-800 border-2 border-red-500 rounded-lg p-6 max-w-md text-center shadow-2xl animate-fadeIn">
                 <Lucide icon="alert-triangle" className="w-16 h-16 text-red-500 mx-auto mb-4"/>
                 <h2 className="text-2xl font-bold text-white mb-4">MEDICAL DISCLAIMER</h2>
                 <p className="text-slate-300 mb-6 leading-relaxed">
                     This application is for <strong>educational and simulation purposes only</strong>.
                     <br/><br/>
                     It is <span className="text-red-400 font-bold uppercase">NOT a medical device</span> and must
                     never be used for real patient care or diagnostic decision making.
                 </p>
                 <Button onClick={onAccept} variant="danger" className="w-full py-4 text-xl font-bold shadow-lg shadow-red-900/20">I UNDERSTAND & ACCEPT</Button>
             </div>
        </div>
    );

    // --- LOGIC ---
    const initialState = {
        scenario: null, time: 0, cycleTimer: 0, isRunning: false, vitals: {}, prevVitals: {}, rhythm: "Sinus Rhythm", 
        log: [], flash: null, history: [], investigationsRevealed: {}, loadingInvestigations: {}, activeInterventions: new Set(), 
        interventionCounts: {}, activeDurations: {}, processedEvents: new Set(), isMuted: false, etco2Enabled: false, 
        isParalysed: false, queuedRhythm: null, cprInProgress: false
    };

    const simReducer = (state, action) => {
        switch (action.type) {
            case 'START_SIM': return { ...state, isRunning: true, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: '00:00', msg: "Simulation Started", type: 'system' }] };
            case 'PAUSE_SIM': return { ...state, isRunning: false, log: [...state.log, { time: new Date().toLocaleTimeString(), msg: "Simulation Paused", type: 'system' }] };
            case 'LOAD_SCENARIO': return { ...initialState, scenario: action.payload, vitals: {...action.payload.vitals}, prevVitals: {...action.payload.vitals}, rhythm: action.payload.ecg?.type || "Sinus Rhythm", activeInterventions: new Set() };
            case 'RESTORE_SESSION': return { ...action.payload, activeInterventions: new Set(action.payload.activeInterventions || []), isRunning: false };
            
            case 'TICK_TIME':
                let nextState = { ...state, time: state.time + 1, cycleTimer: state.cycleTimer + 1 };
                const newDurations = { ...state.activeDurations };
                let durChanged = false;
                Object.keys(newDurations).forEach(key => { if ((state.time + 1 - newDurations[key].startTime) >= newDurations[key].duration) { delete newDurations[key]; durChanged = true; } });
                if(durChanged) nextState.activeDurations = newDurations;

                // TIMED EVENTS ENGINE
                if (state.scenario && state.scenario.timedEvents) {
                    state.scenario.timedEvents.forEach(e => {
                        if (nextState.time === (parseInt(e.time) * 60) && !state.processedEvents.has(e.time + e.type)) {
                            nextState.log = [...nextState.log, { time: new Date().toLocaleTimeString(), simTime: `${e.time}:00`, msg: `TIMED EVENT: ${e.type}`, type: 'danger' }];
                            nextState.processedEvents = new Set([...state.processedEvents, e.time + e.type]);
                            if (e.type === 'Cardiac Arrest') {
                                nextState.rhythm = 'VF'; nextState.vitals = { ...nextState.vitals, hr: 0, bpSys: 0, bpDia: 0, spO2: 0, rr: 0, gcs: 3 }; nextState.flash = 'red';
                            } else if (e.type === 'Deteriorate') {
                                nextState.flash = 'red'; nextState.vitals = { ...nextState.vitals, hr: Math.min(180, nextState.vitals.hr + 30), bpSys: Math.max(60, nextState.vitals.bpSys - 30), spO2: Math.max(70, nextState.vitals.spO2 - 15) };
                            } else if (e.type === 'Improve') {
                                nextState.flash = 'green'; nextState.vitals = { ...nextState.vitals, hr: 80, bpSys: 120, spO2: 98 };
                            }
                        }
                    });
                }
                return nextState;

            case 'UPDATE_VITALS': return { ...state, vitals: action.payload, history: [...state.history, { time: state.time, hr: action.payload.hr, bp: action.payload.bpSys, spo2: action.payload.spO2 }] };
            case 'UPDATE_RHYTHM': return { ...state, rhythm: action.payload };
            case 'SYNC_FROM_MASTER': return { ...state, vitals: action.payload.vitals, rhythm: action.payload.rhythm, cprInProgress: action.payload.cprInProgress, etco2Enabled: action.payload.etco2Enabled, flash: action.payload.flash, cycleTimer: action.payload.cycleTimer, scenario: { ...state.scenario, title: action.payload.scenarioTitle, deterioration: { type: action.payload.pathology } }, activeInterventions: new Set(action.payload.activeInterventions || []) };
            case 'ADD_LOG': return { ...state, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: `${Math.floor(state.time/60)}:${(state.time%60).toString().padStart(2,'0')}`, msg: action.payload.msg, type: action.payload.type, timeSeconds: state.time }] };
            case 'UPDATE_INTERVENTION_STATE': return { ...state, activeInterventions: action.payload.active, interventionCounts: action.payload.counts };
            case 'TOGGLE_CPR': return { ...state, cprInProgress: action.payload };
            case 'SET_FLASH': return { ...state, flash: action.payload };
            case 'REVEAL_INVESTIGATION': return { ...state, investigationsRevealed: { ...state.investigationsRevealed, [action.payload]: true }, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: false } };
            case 'SET_LOADING_INVESTIGATION': return { ...state, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: true } };
            case 'TRIGGER_IMPROVE': return { ...state, scenario: { ...state.scenario, ...state.scenario.evolution.improved, deterioration: { active: false } }, flash: 'green' };
            case 'TRIGGER_DETERIORATE': return { ...state, scenario: { ...state.scenario, ...state.scenario.evolution.deteriorated, deterioration: { active: true } }, flash: 'red' };
            case 'MANUAL_VITAL_UPDATE': return { ...state, vitals: { ...state.vitals, [action.payload.key]: action.payload.value }, prevVitals: { ...state.vitals } };
            case 'TOGGLE_ETCO2': return { ...state, etco2Enabled: !state.etco2Enabled };
            case 'RESET_CYCLE_TIMER': return { ...state, cycleTimer: 0 };
            case 'FAST_FORWARD': return { ...state, time: state.time + action.payload };
            case 'UPDATE_SCENARIO': return { ...state, scenario: action.payload };
            default: return state;
        }
    };

    const useSimulation = (initial, isMonitor, sessionID) => {
        const [state, dispatch] = useReducer(simReducer, initialState);
        const timerRef = useRef(null);
        
        // SYNC LOGIC
        useEffect(() => {
            if (!db || !sessionID || !isMonitor) return;
            const sessionRef = db.ref(`sessions/${sessionID}`);
            const handleUpdate = (snapshot) => { const data = snapshot.val(); if(data) dispatch({ type: 'SYNC_FROM_MASTER', payload: data }); };
            sessionRef.on('value', handleUpdate);
            return () => sessionRef.off('value', handleUpdate);
        }, [isMonitor, sessionID]);

        useEffect(() => {
            if (!db || !sessionID || isMonitor || !state.scenario) return;
            const sessionRef = db.ref(`sessions/${sessionID}`);
            const payload = { vitals: state.vitals, rhythm: state.rhythm, cprInProgress: state.cprInProgress, etco2Enabled: state.etco2Enabled, flash: state.flash, cycleTimer: state.cycleTimer, scenarioTitle: state.scenario.title, pathology: state.scenario.deterioration?.type || 'normal', activeInterventions: Array.from(state.activeInterventions) };
            sessionRef.set(payload).catch(e => console.error(e));
        }, [state, isMonitor, sessionID]);

        useEffect(() => {
            if (state.isRunning) {
                timerRef.current = setInterval(() => {
                    dispatch({ type: 'TICK_TIME' });
                    // Physiology
                    let next = { ...state.vitals };
                    if (state.cprInProgress && state.vitals.hr === 0) { next.bpSys = 30 + getRandomInt(-5, 5); next.bpDia = 15; }
                    else if (!state.cprInProgress && state.vitals.hr === 0) { next.bpSys = 0; next.bpDia = 0; }
                    else {
                        next.hr = clamp(next.hr + getRandomInt(-1, 1), 0, 250);
                        next.bpSys = clamp(next.bpSys + getRandomInt(-1, 1), 0, 300);
                        next.spO2 = clamp(next.spO2 + (Math.random()>0.8?getRandomInt(-1,1):0), 0, 100);
                    }
                    if (state.scenario?.vbg) {
                        const newVbg = calculateDynamicVbg(state.scenario.vbg, next, state.activeInterventions, 3);
                        if (Math.abs(newVbg.pH - state.scenario.vbg.pH) > 0.001) dispatch({ type: 'UPDATE_SCENARIO', payload: { ...state.scenario, vbg: newVbg } });
                    }
                    dispatch({ type: 'UPDATE_VITALS', payload: next });
                }, 1000);
            } else { clearInterval(timerRef.current); }
            return () => clearInterval(timerRef.current);
        }, [state.isRunning, state.vitals, state.cprInProgress]);

        const applyIntervention = (key) => {
            const action = INTERVENTIONS[key];
            if (!action) return;
            const newActive = new Set(state.activeInterventions);
            const newCounts = { ...state.interventionCounts };
            if (action.type === 'continuous') { if (newActive.has(key)) newActive.delete(key); else newActive.add(key); }
            else { newCounts[key] = (newCounts[key] || 0) + 1; }
            
            dispatch({ type: 'UPDATE_INTERVENTION_STATE', payload: { active: newActive, counts: newCounts } });
            dispatch({ type: 'ADD_LOG', payload: { msg: action.log, type: 'action' } });
            
            // Physiology Effects
            let newVitals = { ...state.vitals };
            if (action.effect.changeRhythm === 'defib' && ['VF', 'VT'].includes(state.rhythm)) {
                dispatch({ type: 'UPDATE_RHYTHM', payload: 'Sinus Rhythm' });
                newVitals.hr = 80; newVitals.bpSys = 110;
                dispatch({ type: 'ADD_LOG', payload: { msg: 'Defibrillation Successful. ROSC.', type: 'success' } });
                dispatch({ type: 'SET_FLASH', payload: 'green' });
            }
            if (action.effect.BP) newVitals.bpSys += action.effect.BP;
            if (action.effect.SpO2) newVitals.spO2 += action.effect.SpO2;
            dispatch({ type: 'UPDATE_VITALS', payload: newVitals });
        };

        const toggleLocalSound = () => {}; 

        return { state, dispatch, start: ()=>dispatch({type:'START_SIM'}), pause: ()=>dispatch({type:'PAUSE_SIM'}), stop: ()=>dispatch({type:'PAUSE_SIM'}), applyIntervention, addLogEntry: (msg, type)=>dispatch({type:'ADD_LOG', payload:{msg, type}}), manualUpdateVital: (key, value)=>dispatch({type:'MANUAL_VITAL_UPDATE', payload:{key, value}}), triggerArrest: ()=>{dispatch({type:'UPDATE_RHYTHM', payload:'VF'}); dispatch({type:'UPDATE_VITALS', payload:{...state.vitals, hr:0, bpSys:0}}); dispatch({type:'SET_FLASH', payload:'red'});}, triggerROSC: ()=>{dispatch({type:'UPDATE_RHYTHM', payload:'Sinus Rhythm'}); dispatch({type:'UPDATE_VITALS', payload:{...state.vitals, hr:80, bpSys:110}}); dispatch({type:'SET_FLASH', payload:'green'});}, revealInvestigation: (t)=>{dispatch({type:'SET_LOADING_INVESTIGATION', payload:t}); setTimeout(()=>dispatch({type:'REVEAL_INVESTIGATION', payload:t}), 1500);}, nextCycle: ()=>dispatch({type:'FAST_FORWARD', payload:120}), toggleLocalSound };
    };

    // --- SCREENS ---
    const SetupScreen = ({ onGenerate, savedState, onResume }) => {
        const [mode, setMode] = useState('random');
        const [category, setCategory] = useState('Any');
        const [age, setAge] = useState('Any');
        
        // Custom Builder
        const [buildTitle, setBuildTitle] = useState("Custom Case");
        const [buildAge, setBuildAge] = useState(40);
        const [buildDesc, setBuildDesc] = useState("Patient collapsed...");
        const [buildVitals, setBuildVitals] = useState({ hr: 80, bpSys: 120, rr: 16, spO2: 98 });
        const [buildPMH, setBuildPMH] = useState("Hypertension");
        const [buildMeds, setBuildMeds] = useState("Ramipril");
        const [buildAllergies, setBuildAllergies] = useState("NKDA");
        const [buildEvents, setBuildEvents] = useState([]);
        const [newEventTime, setNewEventTime] = useState(5);
        const [newEventType, setNewEventType] = useState('Cardiac Arrest');

        const addEvent = () => setBuildEvents([...buildEvents, { time: newEventTime, type: newEventType }]);

        const handleRandom = () => {
            let pool = RAW_SCENARIOS;
            const base = pool[Math.floor(Math.random() * pool.length)];
            const patientAge = base.ageGenerator();
            const history = generateHistory(patientAge);
            const generated = { 
                ...base, 
                patientAge, 
                profile: base.patientProfileTemplate.replace('{age}', patientAge).replace('{sex}', 'Male'),
                vitals: { hr: 80, bpSys: 120, bpDia: 80, rr: 16, spO2: 98, temp: 37, gcs: 15, bm: 5, pupils: '3mm', ...base.vitalsMod },
                pmh: base.pmh || history.pmh, 
                dhx: base.dhx || history.dhx, 
                allergies: base.allergies || history.allergies,
                vbg: generateVbg(base.vbgClinicalState),
                hf: HUMAN_FACTOR_CHALLENGES[0],
                wetflag: calculateWetflag(patientAge, estimateWeight(patientAge))
            };
            onGenerate(generated);
        };

        const handleCustom = () => {
            const customScen = {
                id: 'CUSTOM',
                title: buildTitle,
                category: 'Custom',
                ageRange: buildAge < 18 ? 'Paediatric' : 'Adult',
                patientAge: buildAge,
                patientProfileTemplate: buildDesc,
                presentingComplaint: "Custom",
                profile: buildDesc,
                pmh: buildPMH.split(','),
                dhx: buildMeds.split(','),
                allergies: buildAllergies.split(','),
                vitals: { ...buildVitals, bpDia: Math.floor(buildVitals.bpSys * 0.65), gcs: 15, temp: 37, bm: 5 },
                instructorBrief: { progression: "Custom Scenario", interventions: [] },
                timedEvents: buildEvents,
                wetflag: calculateWetflag(buildAge, estimateWeight(buildAge)),
                hf: HUMAN_FACTOR_CHALLENGES[0]
            };
            onGenerate(customScen);
        };

        return (
            <div className="max-w-2xl mx-auto p-4 space-y-6">
                {savedState && <div className="bg-emerald-900/30 border border-emerald-500 p-4 rounded-lg flex justify-between"><span className="text-emerald-400">Previous Session Found</span><Button onClick={onResume} variant="success">Resume</Button></div>}
                <div className="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-sky-400 mb-4 flex items-center gap-2"><Lucide icon="settings"/> Sim Setup</h2>
                    <div className="flex gap-2 mb-6 border-b border-slate-700">
                        <button onClick={() => setMode('random')} className={`pb-2 px-4 font-bold ${mode === 'random' ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Random</button>
                        <button onClick={() => setMode('builder')} className={`pb-2 px-4 font-bold ${mode === 'builder' ? 'text-emerald-400 border-b-2 border-emerald-400' : 'text-slate-500'}`}>Builder</button>
                    </div>
                    {mode === 'random' ? (
                        <div className="space-y-4 animate-fadeIn">
                             <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">Category</label><select value={category} onChange={e=>setCategory(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white"><option>Any</option><option>Medical</option><option>Trauma</option></select></div>
                                <div><label className="text-xs font-bold text-slate-500">Age</label><select value={age} onChange={e=>setAge(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white"><option>Any</option><option>Adult</option><option>Paediatric</option></select></div>
                             </div>
                             <Button onClick={handleRandom} className="w-full py-4 text-lg">Generate Random Scenario</Button>
                        </div>
                    ) : (
                        <div className="space-y-4 animate-fadeIn">
                            <input placeholder="Title" value={buildTitle} onChange={e=>setBuildTitle(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white font-bold"/>
                            <div className="grid grid-cols-4 gap-2">
                                <div className="col-span-1"><label className="text-xs text-slate-500">Age</label><input type="number" value={buildAge} onChange={e=>setBuildAge(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white"/></div>
                                <div><label className="text-xs text-slate-500">HR</label><input type="number" value={buildVitals.hr} onChange={e=>setBuildVitals({...buildVitals, hr: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white"/></div>
                                <div><label className="text-xs text-slate-500">BP Sys</label><input type="number" value={buildVitals.bpSys} onChange={e=>setBuildVitals({...buildVitals, bpSys: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white"/></div>
                                <div><label className="text-xs text-slate-500">SpO2</label><input type="number" value={buildVitals.spO2} onChange={e=>setBuildVitals({...buildVitals, spO2: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white"/></div>
                            </div>
                            <textarea placeholder="Clinical Description..." value={buildDesc} onChange={e=>setBuildDesc(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white h-20"/>
                            <div className="grid grid-cols-3 gap-2">
                                <input placeholder="PMHx" value={buildPMH} onChange={e=>setBuildPMH(e.target.value)} className="bg-slate-900 border border-slate-600 rounded p-2 text-white"/>
                                <input placeholder="Meds" value={buildMeds} onChange={e=>setBuildMeds(e.target.value)} className="bg-slate-900 border border-slate-600 rounded p-2 text-white"/>
                                <input placeholder="Allergies" value={buildAllergies} onChange={e=>setBuildAllergies(e.target.value)} className="bg-slate-900 border border-slate-600 rounded p-2 text-white text-red-300"/>
                            </div>
                            <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                                <h3 className="text-sm font-bold text-sky-400 mb-2 uppercase">Timed Events Engine</h3>
                                <div className="flex gap-2 mb-2">
                                    <input type="number" value={newEventTime} onChange={e=>setNewEventTime(e.target.value)} className="w-16 bg-slate-800 border border-slate-500 rounded p-1 text-white text-center" placeholder="Min"/>
                                    <select value={newEventType} onChange={e=>setNewEventType(e.target.value)} className="flex-1 bg-slate-800 border border-slate-500 rounded p-1 text-white">
                                        <option value="Cardiac Arrest">Cardiac Arrest (VF)</option>
                                        <option value="Deteriorate">Deteriorate</option>
                                        <option value="Improve">Improve</option>
                                    </select>
                                    <Button onClick={addEvent} variant="secondary" className="h-8 text-xs">Add</Button>
                                </div>
                                <div className="space-y-1">
                                    {buildEvents.map((ev, i) => <div key={i} className="flex justify-between bg-slate-800 px-2 py-1 rounded text-xs text-slate-300"><span>At <strong>{ev.time} mins</strong></span><span className="font-mono text-sky-300">{ev.type}</span></div>)}
                                </div>
                            </div>
                            <Button onClick={handleCustom} variant="success" className="w-full py-4 text-lg">Launch Custom Scenario</Button>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const BriefingScreen = ({ scenario, onStart, onBack, onNewScenario }) => (
        <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-4 overflow-y-auto h-full">
            <div className="bg-slate-800 p-6 rounded-lg border-l-4 border-sky-500 shadow-lg">
                <div className="flex justify-between items-start mb-4">
                    <div><h2 className="text-3xl font-bold text-white">{scenario.title}</h2><span className="inline-block bg-slate-700 text-sky-300 text-xs px-2 py-1 rounded mt-2">{scenario.category}</span></div>
                    <div className="text-right"><p className="text-2xl font-mono font-bold text-emerald-400">GCS {scenario.vitals.gcs}</p></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p className="text-lg leading-relaxed mb-4">{scenario.profile}</p>
                        <div className="space-y-2 mb-4">
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700"><span className="text-xs text-slate-500 uppercase font-bold block">PMH</span><span className="text-sm text-slate-200">{scenario.pmh ? scenario.pmh.join(", ") : 'Nil'}</span></div>
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700"><span className="text-xs text-slate-500 uppercase font-bold block">Drug History</span><span className="text-sm text-slate-200">{scenario.dhx ? scenario.dhx.join(", ") : 'Nil'}</span></div>
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700"><span className="text-xs text-slate-500 uppercase font-bold block">Allergies</span><span className="text-sm text-red-300 font-bold">{scenario.allergies ? scenario.allergies.join(", ") : 'Nil'}</span></div>
                        </div>
                        <div className="p-3 bg-slate-700/50 rounded border border-slate-600"><p className="font-bold text-sky-300">PC: {scenario.presentingComplaint}</p></div>
                    </div>
                    <div className="space-y-4">
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600"><h4 className="text-sm font-bold text-amber-400 uppercase mb-2">Progression</h4><p className="text-sm text-slate-300">{scenario.instructorBrief.progression}</p></div>
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600"><h4 className="text-sm font-bold text-sky-400 uppercase mb-2">Learning Objectives</h4><ul className="list-disc pl-4 text-sm text-slate-300">{scenario.instructorBrief.learningObjectives?.map((l, i) => <li key={i}>{l}</li>)}</ul></div>
                    </div>
                </div>
            </div>
            <div className="flex flex-col md:flex-row gap-4">
                <Button onClick={onBack} variant="secondary" className="flex-1">Back</Button>
                <Button onClick={onNewScenario} variant="secondary" className="flex-1">New Scenario</Button>
                <Button onClick={onStart} className="flex-1 shadow-sky-900/20 shadow-xl">Start Simulation</Button>
            </div>
        </div>
    );

    const MonitorScreen = ({ sim }) => {
        const { state } = sim;
        const { vitals, prevVitals, rhythm, flash, activeInterventions, etco2Enabled, cprInProgress, cycleTimer } = state;
        const hasMonitoring = activeInterventions.has('Obs');
        const hasArtLine = activeInterventions.has('ArtLine');
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        return (
            <div className={`fixed inset-0 flex flex-col bg-black text-white p-2 md:p-4 transition-colors duration-200 ${flash === 'red' ? 'flash-red' : (flash === 'green' ? 'flash-green' : '')}`}>
                <div className="flex justify-between items-center shrink-0 mb-2 min-h-[50px]">
                    <div className="flex items-center gap-3 md:gap-4"><img src="https://iili.io/KGQOvkl.md.png" className="h-8 md:h-12 object-contain" /><div><h1 className="text-lg md:text-2xl font-bold text-sky-500 tracking-tight">EM Sim Generator v16</h1></div></div>
                    {cprInProgress && <div className="flex flex-col items-end animate-fadeIn z-50 ml-auto"><div className="flex items-center gap-2 md:gap-3 bg-red-900/80 border border-red-500 px-2 md:px-4 py-1 md:py-2 rounded"><span className="text-red-500 font-bold uppercase tracking-widest text-[10px] md:text-sm hidden sm:inline">Cycle Time</span><span className={`font-mono text-2xl md:text-4xl font-bold ${cycleTimer > 120 ? 'text-red-500 animate-pulse' : 'text-white'}`}>{formatTime(cycleTimer)}</span></div><span className="text-red-500 font-bold tracking-widest text-[10px] md:text-xs mt-1 animate-pulse">CPR IN PROGRESS</span></div>}
                </div>
                <div className="flex-grow relative border border-slate-800 rounded mb-2 md:mb-4 overflow-hidden flex flex-col"><ECGMonitor rhythmType={rhythm} hr={vitals.hr} rr={vitals.rr} spO2={vitals.spO2} isPaused={false} showEtco2={etco2Enabled} pathology={state.scenario?.deterioration?.type || 'normal'} showTraces={hasMonitoring} showArt={hasArtLine} isCPR={cprInProgress} className="h-full w-full" rhythmLabel="ECG" /></div>
                <div className="shrink-0 h-auto min-h-[120px] md:h-[20vh] grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4">
                    <VitalDisplay label="Heart Rate" value={vitals.hr} prev={prevVitals.hr} unit="bpm" lowIsBad={false} onUpdate={() => {}} alert={vitals.hr > 140 || vitals.hr < 40} visible={hasMonitoring} isMonitor={true} hideTrends={true} />
                    <VitalDisplay label={hasArtLine ? "ABP" : "NIBP"} value={vitals.bpSys} value2={vitals.bpDia} prev={prevVitals.bpSys} unit="mmHg" onUpdate={() => {}} alert={vitals.bpSys < 90} visible={hasMonitoring} isMonitor={true} hideTrends={true} />
                    <VitalDisplay label="SpO2" value={vitals.spO2} prev={prevVitals.spO2} unit="%" onUpdate={() => {}} alert={vitals.spO2 < 90} visible={hasMonitoring} isMonitor={true} hideTrends={true} />
                    <VitalDisplay label="RR" value={vitals.rr} prev={prevVitals.rr} unit="/min" lowIsBad={false} onUpdate={() => {}} alert={vitals.rr > 30 || vitals.rr < 8} visible={hasMonitoring} isMonitor={true} hideTrends={true} />
                </div>
            </div>
        );
    };

    const JoinScreen = ({ onJoin }) => {
        const [code, setCode] = useState("");
        return (
            <div className="flex flex-col items-center justify-center h-full bg-slate-900 text-white p-4">
                <div className="w-full max-w-md space-y-6 text-center">
                    <img src="https://iili.io/KGQOvkl.md.png" className="h-20 object-contain mx-auto" />
                    <h1 className="text-3xl font-bold text-sky-400">Sim Monitor</h1>
                    <input type="text" value={code} onChange={e => setCode(e.target.value.toUpperCase())} placeholder="e.g. A1B2" className="w-full bg-slate-800 border-2 border-slate-600 rounded-lg p-4 text-center text-3xl font-mono tracking-widest uppercase text-white focus:border-sky-500 outline-none transition-colors" maxLength={4} />
                    <Button onClick={() => onJoin(code)} disabled={code.length < 4} className="w-full py-4 text-xl">Connect to Session</Button>
                </div>
            </div>
        );
    };

    const LiveSimScreen = ({ sim, onFinish, onBack }) => {
        const { state, start, pause, applyIntervention, addLogEntry, manualUpdateVital, triggerArrest, triggerROSC, revealInvestigation } = sim;
        const { scenario, time, vitals, prevVitals, log, flash, activeInterventions, interventionCounts, activeDurations, rhythm, etco2Enabled, cprInProgress } = state;
        const [arrestMode, setArrestMode] = useState(false);
        const [expandRhythm, setExpandRhythm] = useState(false);
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
        return (
            <div className={`h-full overflow-y-auto lg:overflow-hidden grid grid-cols-1 lg:grid-cols-3 gap-4 p-2 md:p-4 transition-colors duration-500 relative ${flash === 'red' ? 'flash-red' : (flash === 'green' ? 'flash-green' : '')}`}>
                <div className="lg:col-span-2 flex flex-col gap-4 lg:overflow-hidden lg:h-full h-auto">
                    <Card className="bg-slate-900 border-slate-800 flex-shrink-0">
                        <div className="flex justify-between items-center mb-2 border-b border-slate-800 pb-2">
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={onBack} className="h-8 text-xs px-2"><Lucide icon="arrow-left"/> Back</Button>
                                {!state.isRunning ? <Button variant="success" onClick={start} className="h-8 px-4 font-bold"><Lucide icon="play"/> START</Button> : <Button variant="danger" onClick={pause} className="h-8 px-4"><Lucide icon="pause"/> Pause</Button>}
                                <Button variant="outline" onClick={() => window.open(window.location.href.split('?')[0] + '?mode=monitor', '_blank', 'popup=yes')} className="h-8 px-2 text-xs"><Lucide icon="monitor"/> Monitor</Button>
                                <Button variant="primary" onClick={onFinish} className="h-8 px-4"><Lucide icon="square"/> Finish</Button>
                            </div>
                            <div className="font-mono text-xl font-bold text-emerald-400 bg-black/40 px-3 py-1 rounded">{formatTime(time)}</div>
                        </div>
                        <div className="mb-2 relative"><ECGMonitor rhythmType={rhythm} hr={vitals.hr} rr={vitals.rr} spO2={vitals.spO2} isPaused={!state.isRunning} showEtco2={etco2Enabled} pathology={scenario.deterioration?.type} showTraces={activeInterventions.has('Obs')} showArt={activeInterventions.has('ArtLine')} isCPR={cprInProgress} className="h-28 md:h-60"/></div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <VitalDisplay label="Heart Rate" value={vitals.hr} prev={prevVitals.hr} unit="bpm" lowIsBad={false} onUpdate={(v) => manualUpdateVital('hr', v)} alert={vitals.hr > 140 || vitals.hr < 40} visible={activeInterventions.has('Obs')} />
                            <VitalDisplay label={activeInterventions.has('ArtLine') ? "ABP" : "NIBP"} value={vitals.bpSys} value2={vitals.bpDia} prev={prevVitals.bpSys} unit="mmHg" onUpdate={(v) => manualUpdateVital('bpSys', v)} alert={vitals.bpSys < 90} visible={activeInterventions.has('Obs')} />
                            <VitalDisplay label="SpO2" value={vitals.spO2} prev={prevVitals.spO2} unit="%" onUpdate={(v) => manualUpdateVital('spO2', v)} alert={vitals.spO2 < 90} visible={activeInterventions.has('Obs')} />
                            <VitalDisplay label="RR" value={vitals.rr} prev={prevVitals.rr} unit="/min" lowIsBad={false} onUpdate={(v) => manualUpdateVital('rr', v)} alert={vitals.rr > 30 || vitals.rr < 8} visible={activeInterventions.has('Obs')} />
                        </div>
                    </Card>
                    <Card title="Clinical Actions" icon="activity" className="flex-1 min-h-0 bg-slate-800">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 bg-slate-900/50 p-2 rounded">
                             <Button variant="danger" onClick={triggerArrest} className="text-xs h-8">VF Arrest</Button>
                             <Button variant="success" onClick={triggerROSC} className="text-xs h-8">ROSC</Button>
                             <div className="relative">
                                 <Button variant="secondary" onClick={() => setExpandRhythm(!expandRhythm)} className="text-xs h-8 w-full border border-slate-600">Rhythm Select...</Button>
                                 {expandRhythm && <div className="absolute top-full left-0 w-full bg-slate-800 border border-slate-600 z-50 rounded shadow-xl max-h-96 overflow-y-auto">{['Sinus Rhythm', 'Sinus Tachycardia', 'Sinus Bradycardia', 'AF', 'SVT', 'VT', 'VF', 'Asystole', 'PEA'].map(r => <button key={r} onClick={() => {sim.dispatch({type: 'UPDATE_RHYTHM', payload: r}); setExpandRhythm(false)}} className="block w-full text-left px-2 py-2 text-xs hover:bg-sky-600 border-b border-slate-700">{r}</button>)}</div>}
                             </div>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                             {['Obs', 'Oxygen', 'IV Access', 'Fluids', 'Analgesia', 'Antiemetic', 'Antibiotics', 'Nebs', 'AdrenalineIM', 'RSI', 'Bagging', 'Lucas'].map(key => {
                                 const action = INTERVENTIONS[key];
                                 return action && <Button key={key} variant={activeInterventions.has(key) ? "success" : "secondary"} onClick={() => applyIntervention(key)} disabled={!state.isRunning} className="text-xs h-10">{action.label}</Button>;
                             })}
                        </div>
                    </Card>
                </div>
                <div className="flex flex-col gap-4 h-full overflow-hidden">
                    <Card title="Scenario Info" icon="info" collapsible={true} className="flex-shrink-0 bg-slate-800 border-l-4 border-sky-500 max-h-[50%]">
                         <div className="mb-3"><p className="text-sm text-slate-200 leading-snug">{scenario.patientProfileTemplate.replace('{age}', scenario.patientAge).replace('{sex}', 'Male')}</p><p className="text-sm font-bold text-sky-400 mt-1">PC: {scenario.presentingComplaint}</p></div>
                         <div className="grid grid-cols-3 gap-2 mt-3">{['ECG', 'VBG', 'X-ray', 'POCUS', 'CT', 'Urine'].map(t => <InvestigationButton key={t} type={t} icon="activity" label={t} isRevealed={state.investigationsRevealed[t]} isLoading={state.loadingInvestigations[t]} revealInvestigation={revealInvestigation} isRunning={state.isRunning} scenario={scenario}/>)}</div>
                    </Card>
                    <div className="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-inner flex flex-col flex-1 min-h-0">
                        <div className="bg-slate-800/50 p-3 border-b border-slate-700 flex items-center gap-2"><Lucide icon="list" className="w-5 h-5 text-sky-400" /><h3 className="font-bold text-slate-200">Incident Log</h3></div>
                        <div className="flex-1 overflow-y-auto space-y-1 p-2 text-xs font-mono">{log.map((l, i) => <div key={i} className={`p-1.5 rounded border-l-2 ${l.type === 'success' ? 'bg-emerald-900/20 border-emerald-500' : l.type === 'danger' ? 'bg-red-900/30 border-red-500' : 'bg-slate-700/30 border-slate-500'}`}><span className="text-slate-500 mr-2">{l.simTime}</span><span className="text-slate-200">{l.msg}</span></div>)}<div ref={(el) => { if (el) el.scrollIntoView({ behavior: "smooth" }); }}></div></div>
                    </div>
                </div>
            </div>
        );
    };

    const DebriefScreen = ({ sim, onRestart }) => {
        const { state } = sim; const { log, scenario } = state; 
        const handleExport = () => { const doc = new window.jspdf.jsPDF(); doc.setFontSize(16); doc.text(`Debrief: ${scenario.title}`, 10, 10); doc.setFontSize(10); let y=30; log.forEach(l=>{if(y>280){doc.addPage();y=10} doc.text(`[${l.simTime}] ${l.msg}`,10,y);y+=6;}); doc.save("debrief.pdf"); };
        return (
            <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-4 h-full overflow-y-auto">
                <div className="flex justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700"><h2 className="text-2xl font-bold text-white">Simulation Debrief</h2><div className="flex gap-2"><Button onClick={handleExport} variant="secondary"><Lucide icon="download"/> PDF</Button><Button onClick={onRestart} variant="primary"><Lucide icon="rotate-ccw"/> New Sim</Button></div></div>
                <Card title="Diamond Debrief" icon="message-circle">
                    <div className="diamond-grid">
                        <div className="bg-sky-900/20 p-4 rounded border border-sky-600/30"><h4 className="text-sky-400 font-bold mb-2 uppercase text-sm">Description</h4><p className="text-slate-300 text-xs italic">Clarify facts. What happened?</p></div>
                        <div className="bg-amber-900/20 p-4 rounded border border-amber-600/30"><h4 className="text-amber-400 font-bold mb-2 uppercase text-sm">Analysis</h4><p className="text-slate-300 text-xs italic">Why did it happen?</p></div>
                        <div className="bg-purple-900/20 p-4 rounded border border-purple-600/30"><h4 className="text-purple-400 font-bold mb-2 uppercase text-sm">Human Factors</h4><p className="text-slate-300 text-xs italic">Leadership, Communication.</p></div>
                        <div className="bg-emerald-900/20 p-4 rounded border border-emerald-600/30"><h4 className="text-emerald-400 font-bold mb-2 uppercase text-sm">Application</h4><p className="text-slate-300 text-xs italic">Take home messages.</p></div>
                    </div>
                </Card>
                <Card title="Timeline" icon="clock"><div className="space-y-1 font-mono text-xs">{log.map((l, i) => <div key={i} className="flex gap-4 border-b border-slate-700 pb-1"><span className="text-sky-400">{l.simTime}</span><span className="text-slate-300">{l.msg}</span></div>)}</div></Card>
            </div>
        );
    };

    const App = () => {
        const [view, setView] = useState('setup');
        const [showDisclaimer, setShowDisclaimer] = useState(true);
        const [sessionID, setSessionID] = useState(null);
        
        useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'monitor') setView('join');
            else { const sid = localStorage.getItem('wmebem_session_id') || Math.random().toString(36).substring(2, 6).toUpperCase(); localStorage.setItem('wmebem_session_id', sid); setSessionID(sid); }
        }, []);
        
        const sim = useSimulation(null, view === 'monitor', sessionID);
        const handleJoin = (code) => { setSessionID(code); setView('monitor'); };
        
        if (showDisclaimer) return <DisclaimerModal onAccept={() => setShowDisclaimer(false)} />;
        if (view === 'join') return <JoinScreen onJoin={handleJoin} />;
        if (view === 'monitor') { if(!sessionID || !sim.state.vitals.hr) return <div className="h-full flex flex-col items-center justify-center bg-black text-slate-500 animate-pulse"><Lucide icon="loader" className="w-16 h-16 animate-spin mb-4"/><div className="text-2xl font-bold">Waiting for Controller...</div></div>; return <MonitorScreen sim={sim} />; }

        return (
            <div className="h-full flex flex-col bg-slate-900 text-slate-100 font-sans">
                <header className="flex items-center justify-between p-2 md:p-4 border-b border-slate-800 bg-slate-900 flex-shrink-0">
                    <div className="flex items-center gap-4"><img src="https://iili.io/KGQOvkl.md.png" className="h-10 md:h-16 object-contain" /><div><h1 className="text-xl md:text-3xl font-bold text-sky-400 tracking-tight">EM Sim Generator v16</h1></div></div>
                    <div className="flex flex-col items-end"><div className="flex items-center gap-2 bg-sky-900/20 border border-sky-500/30 px-3 py-1 rounded cursor-pointer" onClick={() => navigator.clipboard.writeText(sessionID)}><span className="text-[10px] text-sky-500 uppercase tracking-widest">Session</span><span className="font-mono text-xl font-bold text-white tracking-widest">{sessionID || "..."}</span></div></div>
                </header>
                <main className="flex-grow overflow-hidden relative">
                    {view === 'setup' && <SetupScreen onGenerate={(s) => { sim.dispatch({type:'LOAD_SCENARIO', payload:s}); setView('briefing'); }} />}
                    {view === 'briefing' && <BriefingScreen scenario={sim.state.scenario} onStart={() => { sim.dispatch({type:'START_SIM'}); setView('live'); }} onBack={() => setView('setup')} onNewScenario={() => setView('setup')} />}
                    {view === 'live' && <LiveSimScreen sim={sim} onFinish={() => { sim.dispatch({type:'PAUSE_SIM'}); setView('debrief'); }} onBack={() => setView('briefing')} />}
                    {view === 'debrief' && <DebriefScreen sim={sim} onRestart={() => { sim.dispatch({type:'LOAD_SCENARIO', payload:null}); setView('setup'); }} />}
                </main>
            </div>
        );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
