<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EM Sim Generator v17 - WMEBEM</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    
    <script>
        // Maps the UMD variable to the name your ui.js expects
        window.lucide = window.lucideReact || window.lucide;
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #root { height: 100%; width: 100%; overflow: hidden; }
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: #0f172a;
            color: white;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Flash animations */
        @keyframes flash-red {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(239, 68, 68, 0.2); }
        }
        @keyframes flash-green {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.2); }
        }
        .flash-red { animation: flash-red 0.5s ease-in-out infinite; }
        .flash-green { animation: flash-green 0.5s ease-in-out; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px;">
            <div class="loading-spinner"></div>
            <div style="color: #94a3b8;">Loading EM Sim Generator...</div>
        </div>
    </div>

    <script src="data/interventions.js"></script>
    <script src="data/generators.js"></script>
    <script src="data/scenarios.js"></script>
    <script src="data/ui.js"></script>
    <script src="data/engine.js"></script>
    
    <script src="data/screens/index.js"></script> 
    
    <script src="data/screens/livesim.js"></script>
    <script src="data/screens/monitor.js"></script>
    <script src="data/screens/debrief.js"></script>
    
    <script src="data/screens/setup.js"></script>

    <script>
        // Safe localStorage wrapper
        const safeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } 
                catch (e) { console.warn('localStorage unavailable'); return null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } 
                catch (e) { console.warn('localStorage unavailable'); }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); } 
                catch (e) { console.warn('localStorage unavailable'); }
            }
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBz77EHl9QhFJ0k2ZFODydChuGeCAXq1II",
            authDomain: "wmebem-sim.firebaseapp.com",
            databaseURL: "https://wmebem-sim-default-rtdb.firebaseio.com",
            projectId: "wmebem-sim",
            storageBucket: "wmebem-sim.firebasestorage.app",
            messagingSenderId: "143041936940",
            appId: "1:143041936940:web:4d15c3fc3ce7e10c081b89",
            measurementId: "G-8C6WW1EWXJ"
        };

        // Initialize Firebase (replace config with your own)
        try {
            if (window.firebase && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.database();
                console.log('Firebase initialized');
            }
        } catch (e) {
            console.warn('Firebase initialization failed:', e);
        }

        // Main App Component
        const App = () => {
            const { useState, useEffect } = React;

            const [view, setView] = useState('setup');
            const [sessionID, setSessionID] = useState(null);
            const [resumeAvailable, setResumeAvailable] = useState(null);

            // Session Management
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                
                // Check for monitor mode
                if (params.get('mode') === 'monitor') {
                    const sid = params.get('session');
                    if (sid) {
                        setSessionID(sid);
                        setView('monitor');
                    }
                    return;
                }

                // Normal controller mode - get or create session ID
                const savedID = safeStorage.getItem('wmebem_session_id');
                if (savedID) {
                    setSessionID(savedID);
                } else {
                    const newID = Math.random().toString(36).substring(2, 6).toUpperCase();
                    safeStorage.setItem('wmebem_session_id', newID);
                    setSessionID(newID);
                }

                // Check for resume data
                const savedState = safeStorage.getItem('wmebem_sim_state');
                if (savedState) {
                    try {
                        const parsed = JSON.parse(savedState);
                        if (parsed && parsed.scenario && !parsed.isFinished) {
                            setResumeAvailable(parsed);
                        }
                    } catch (e) {
                        console.warn('Failed to parse saved state');
                    }
                }
            }, []);

            // Initialize simulation engine
            const sim = window.useSimulation(null, view === 'monitor', view === 'monitor' ? sessionID : null);

            // Handle scenario generation
            const handleGenerate = (scenario) => {
                sim.dispatch({ type: 'SET_SCENARIO', payload: scenario });
                setView('briefing');
                setResumeAvailable(null);
                safeStorage.removeItem('wmebem_sim_state');
            };

            // Handle resume
            const handleResume = (savedState) => {
                sim.dispatch({ type: 'RESTORE_STATE', payload: savedState });
                setView('live');
                setResumeAvailable(null);
            };

            // Handle restart
            const handleRestart = () => {
                const currentScenario = sim.state.scenario;
                sim.dispatch({ type: 'RESET' });
                if (currentScenario) {
                    sim.dispatch({ type: 'SET_SCENARIO', payload: currentScenario });
                    setView('briefing');
                } else {
                    setView('setup');
                }
                safeStorage.removeItem('wmebem_sim_state');
            };

            // Monitor View
            if (view === 'monitor') {
                return React.createElement(window.MonitorContainer, { sessionID });
            }

            // Join Screen
            if (view === 'join') {
                return React.createElement(window.JoinScreen, {
                    onJoin: (code) => {
                        setSessionID(code);
                        // Redirect to monitor mode
                        window.location.href = `?mode=monitor&session=${code}`;
                    }
                });
            }

            // Main Controller Interface
            return React.createElement('div', { className: 'h-full flex flex-col bg-slate-900' },
                // Header
                React.createElement('header', { className: 'bg-slate-950 border-b border-slate-800 p-3 flex items-center justify-between flex-shrink-0' },
                    React.createElement('div', { className: 'flex items-center gap-3' },
                        React.createElement('img', { 
                            src: 'https://iili.io/KGQOvkl.md.png', 
                            alt: 'WMEBEM Logo', 
                            className: 'h-10 md:h-14 object-contain' 
                        }),
                        React.createElement('div', null,
                            React.createElement('h1', { className: 'text-xl md:text-2xl font-bold text-sky-400 tracking-tight' }, 'EM Sim Generator v17'),
                            React.createElement('p', { className: 'text-xs text-slate-500 hidden md:block' }, 'Emergency Medicine Simulation Training')
                        )
                    ),
                    React.createElement('div', { className: 'flex items-center gap-4' },
                        // Session ID Display
                        sessionID && React.createElement('div', {
                            className: 'flex items-center gap-2 bg-sky-900/20 border border-sky-500/30 px-3 py-2 rounded cursor-pointer hover:bg-sky-900/40 transition-colors',
                            onClick: () => {
                                navigator.clipboard.writeText(sessionID);
                                alert('Session ID copied to clipboard!');
                            },
                            title: 'Click to copy'
                        },
                            React.createElement('span', { className: 'text-[10px] text-sky-500 uppercase tracking-widest' }, 'Session'),
                            React.createElement('span', { className: 'font-mono text-lg font-bold text-white tracking-widest' }, sessionID)
                        ),
                        // Monitor Link
                        React.createElement('button', {
                            className: 'px-3 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded text-slate-300 text-sm transition-colors',
                            onClick: () => setView('join')
                        }, 'Join as Monitor')
                    )
                ),

                // Main Content
                React.createElement('main', { className: 'flex-grow overflow-hidden relative' },
                    view === 'setup' && React.createElement(window.SetupScreen, {
                        onGenerate: handleGenerate,
                        savedState: resumeAvailable,
                        onResume: () => handleResume(resumeAvailable),
                        sessionID: sessionID,
                        onJoinClick: () => setView('join')
                    }),
                    view === 'briefing' && sim.state.scenario && React.createElement(window.BriefingScreen, {
                        scenario: sim.state.scenario,
                        onStart: () => {
                            sim.start();
                            setView('live');
                        },
                        onBack: () => setView('setup')
                    }),
                    (view === 'live' || view === 'debrief') && sim.state.scenario && React.createElement(window.LiveSimContainer, {
                        sim: sim,
                        view: view,
                        setView: setView,
                        resumeData: view === 'live' && resumeAvailable ? resumeAvailable : null,
                        onRestart: handleRestart,
                        sessionID: sessionID
                    })
                ),

                // Footer
                React.createElement('footer', { className: 'bg-slate-950 border-t border-slate-800 p-2 text-center text-[10px] text-slate-500 flex-shrink-0' },
                    React.createElement('p', null, `© ${new Date().getFullYear()} West Midlands Evidence Based Emergency Medicine Ltd.`)
                )
            );
        };

        // Wait for all components to load then render
        const checkReady = setInterval(() => {
            if (window.MonitorContainer && 
                window.SetupScreen && 
                window.ALL_SCENARIOS && 
                window.useSimulation &&
                window.LiveSimScreen &&
                window.DebriefScreen) {
                
                clearInterval(checkReady);
                
                try {
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(React.createElement(App));
                    console.log('EM Sim Generator v17 loaded successfully');
                } catch (e) {
                    console.error('Render error:', e);
                    // Fallback for older React
                    try {
                        ReactDOM.render(React.createElement(App), document.getElementById('root'));
                    } catch (e2) {
                        console.error('Fallback render error:', e2);
                    }
                }
            }
        }, 100);

        // Timeout after 10 seconds
        setTimeout(() => {
            clearInterval(checkReady);
            const root = document.getElementById('root');
            if (root.querySelector('.loading-spinner')) {
                root.innerHTML = `
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; padding: 20px; text-align: center;">
                        <div style="color: #ef4444; font-size: 24px;">⚠️</div>
                        <div style="color: #f87171; font-size: 18px;">Failed to load application</div>
                        <div style="color: #94a3b8; max-width: 400px;">
                            The app failed to initialize. Please check console for errors.
                        </div>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }, 10000);
    </script>
</body>
</html>
