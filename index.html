<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Scenario Generator v6.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for Exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Flash animation for deterioration */
        .flash-red {
            animation: flashRed 1.5s ease-in-out;
        }
        @keyframes flashRed {
            0%, 100% { background-color: rgba(30, 41, 59, 1); } /* slate-800 */
            50% { background-color: rgba(127, 29, 29, 0.5); } /* red-900/50 */
        }
        
        /* Success flash */
        .flash-green {
            animation: flashGreen 1s ease-in-out;
        }
        @keyframes flashGreen {
            0%, 100% { border-color: #334155; }
            50% { border-color: #10b981; }
        }
        
        /* Prevent layout shift on scrollbar appearance */
        html {
            overflow-y: scroll;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }

        /* Progress bar animation for buttons */
        @keyframes loadProgress {
            from { width: 0%; }
            to { width: 100%; }
        }
        .loading-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 100%;
            background-color: rgba(16, 185, 129, 0.2); /* emerald-500 with opacity */
            animation: loadProgress 2s linear forwards; /* 2s duration matches logic */
            z-index: 0;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 antialiased selection:bg-sky-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
    
    // --- 1. HELPER FUNCTIONS & DATA ---

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getRandomFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));

    const AGE_BRACKETS = {
        INFANT: { maxAge: 1 }, TODDLER: { maxAge: 5 }, SCHOOL: { maxAge: 12 }, 
        ADOLESCENT: { maxAge: 17 }, ADULT: { maxAge: 64 }, ELDERLY: { maxAge: 120 } 
    };

    const getBaseVitals = (age, isMonths = false) => {
        if (isMonths || age <= 1) return { hr: 140, rr: 40, bpSys: 80, bpDia: 50, temp: 37.0, bm: 4.5 }; // Infant
        if (age <= 5) return { hr: 110, rr: 30, bpSys: 90, bpDia: 60, temp: 37.0, bm: 5.0 }; // Toddler
        if (age <= 12) return { hr: 90, rr: 22, bpSys: 100, bpDia: 65, temp: 36.8, bm: 5.5 }; // School
        return { hr: 75, rr: 16, bpSys: 120, bpDia: 75, temp: 36.8, bm: 5.8 }; // Adult/Adolescent
    };

    // Paediatric Weight Estimation (APLS Formula)
    const estimateWeight = (age) => {
        if (age < 1) return "4-10"; // Range for <1yr
        if (age >= 1 && age <= 5) return (2 * age + 8).toFixed(1);
        if (age >= 6 && age <= 12) return (3 * age + 7).toFixed(1);
        return null; // Adult/Older child
    };

    // VBG Generator
    const generateVbg = (clinicalState = "normal") => {
        let vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.0, K: 4.0, Glu: 5.5 };
        vbg.pH += getRandomFloat(-0.03, 0.03, 2);
        
        switch (clinicalState) {
            case "dka_severe": vbg = { pH: 7.05, pCO2: 3.0, HCO3: 8, BE: -18, Lac: 2.5, K: 5.2, Glu: 28.0 }; break;
            case "septic_shock": vbg = { pH: 7.25, pCO2: 4.5, HCO3: 16, BE: -8, Lac: 6.5, K: 4.2, Glu: 7.0 }; break;
            case "haemorrhagic_shock": vbg = { pH: 7.20, pCO2: 4.8, HCO3: 14, BE: -10, Lac: 8.0, K: 3.8, Glu: 9.0 }; break;
            case "copd_retainer": vbg = { pH: 7.30, pCO2: 9.5, HCO3: 34, BE: 8, Lac: 1.2, K: 4.0, Glu: 6.0 }; break;
            case "respiratory_acidosis_acute": vbg = { pH: 7.20, pCO2: 9.0, HCO3: 24, BE: 0, Lac: 1.5, K: 4.1, Glu: 6.2 }; break;
            default: break;
        }
        return vbg;
    };

    const HUMAN_FACTOR_CHALLENGES = [
      { id: 'hf0', type: 'Standard Simulation', description: 'Manage effectively.' },
      { id: 'hf1', type: 'Blindfolded Lead', description: 'Leader blindfolded. Tests closed-loop comms.' },
      { id: 'hf2', type: 'Silent Team', description: 'Only leader speaks.' },
      { id: 'hf3', type: 'New Junior', description: 'Junior member needs explicit instructions.' },
      { id: 'hf4', type: 'Missing Kit', description: 'Crucial equipment missing.' },
      { id: 'hf5', type: 'Distracted Senior', description: 'Consultant on phone, dismissive.' },
    ];

    // Comprehensive Interventions Database
    const INTERVENTIONS = {
        // AIRWAY & BREATHING
        'Oxygen': { label: 'High Flow O2', effect: { SpO2: 5 }, category: 'Airway', log: 'High flow oxygen applied.' },
        'Nebs': { label: 'Nebulisers', effect: { HR: 10, RR: -2, SpO2: 2 }, category: 'Airway', log: 'Salbutamol/Ipratropium nebulisers administered.' },
        'Needle': { label: 'Needle Decompression', effect: { SpO2: 10, BP: 10, RR: -5 }, category: 'Airway', log: 'Needle thoracocentesis performed.' },
        
        // CIRCULATION & ACCESS
        'Obs': { label: 'Apply Monitoring', effect: {}, category: 'Circulation', log: 'Full monitoring applied (ECG, SpO2, BP).' },
        'IV Access': { label: 'IV Access (Peripheral)', effect: {}, category: 'Circulation', log: 'Peripheral IV access secured.' },
        'Central Line': { label: 'Central Line', effect: {}, category: 'Circulation', log: 'Central Venous Catheter inserted.' },
        'Art Line': { label: 'Arterial Line', effect: {}, category: 'Circulation', log: 'Arterial Line inserted.' },
        'Fluids': { label: 'IV Fluids (500ml)', effect: { BP: 5, HR: -2 }, category: 'Circulation', log: '500ml Crystalloid bolus given.' },
        'Blood': { label: 'pRBC (1 Unit)', effect: { BP: 10, HR: -5 }, category: 'Circulation', log: '1 Unit Packed Red Blood Cells transfused.' },
        'FFP': { label: 'FFP', effect: { BP: 5 }, category: 'Circulation', log: 'Fresh Frozen Plasma transfused.' },
        'Platelets': { label: 'Platelets', effect: {}, category: 'Circulation', log: 'Platelets transfused.' },
        'MHP': { label: 'Activate MHP', effect: {}, category: 'Circulation', log: 'Major Haemorrhage Protocol activated.' },

        // DRUGS
        'Analgesia': { label: 'Analgesia (Morphine)', effect: { HR: -5, RR: -2 }, category: 'Drugs', log: 'Morphine administered.' },
        'Paracetamol': { label: 'IV Paracetamol', effect: {}, category: 'Drugs', log: 'IV Paracetamol administered.' },
        'Antibiotics': { label: 'Antibiotics', effect: {}, category: 'Drugs', log: 'IV Antibiotics administered.' },
        'Ondansetron': { label: 'Ondansetron', effect: {}, category: 'Drugs', log: 'Ondansetron administered.' },
        'TXA': { label: 'TXA 1g', effect: {}, category: 'Drugs', log: 'Tranexamic Acid 1g administered.' },
        'Adrenaline': { label: 'IM Adrenaline', effect: { HR: 20, BP: 10, RR: -2 }, category: 'Drugs', log: 'IM Adrenaline 1:1000 administered.' },
        'Atropine': { label: 'Atropine', effect: { HR: 20 }, category: 'Drugs', log: 'Atropine 500mcg administered.' },
        'Amiodarone': { label: 'Amiodarone', effect: { HR: -10 }, category: 'Drugs', log: 'Amiodarone 300mg administered.' },
        'Adenosine': { label: 'Adenosine', effect: { HR: -80 }, category: 'Drugs', log: 'Adenosine rapid bolus administered.' },
        'Benzos': { label: 'Benzodiazepines', effect: { HR: -10, RR: -2, gcs: -1 }, category: 'Drugs', log: 'Lorazepam/Midazolam administered.' },
        'Dexamethasone': { label: 'Dexamethasone', effect: {}, category: 'Drugs', log: 'Dexamethasone administered.' },
        'Calcium': { label: 'Calcium Gluconate', effect: {}, category: 'Drugs', log: 'Calcium Gluconate administered.' },
        'Insulin': { label: 'Actrapid Insulin', effect: {}, category: 'Drugs', log: 'Insulin/Dextrose infusion started.' },
        'Magnesium': { label: 'Magnesium', effect: { BP: -5 }, category: 'Drugs', log: 'IV Magnesium administered.' },
        'Naloxone': { label: 'Naloxone', effect: { RR: 10, gcs: 3 }, category: 'Drugs', log: 'Naloxone administered.' },

        // PROCEDURES
        'Cardioversion': { label: 'Cardioversion', effect: { HR: -50, BP: 10 }, category: 'Procedures', log: 'Synchronised DC Cardioversion delivered.' },
        'Pacing': { label: 'External Pacing', effect: { HR: 40, BP: 20 }, category: 'Procedures', log: 'External Pacing initiated.' },
        'Intubation': { label: 'RSI / Intubation', effect: { SpO2: 100, RR: -10 }, category: 'Procedures', log: 'Patient Intubated and Ventilated.' },
        'CPR': { label: 'CPR', effect: {}, category: 'Procedures', log: 'CPR in progress.' }
    };

    const ALL_SCENARIOS = [
      // === CARDIAC ===
      {
        id: 'AM001', title: 'Acute STEMI', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(40, 70), 
        patientProfileTemplate: "A {age}-year-old {sex}, smoker. {durationPain} hour(s) of crushing chest pain.",
        presentingComplaint: 'Chest pain, diaphoresis.',
        scenarioDetails: ['Pale, clammy.', 'ECG: Anterior STE (V1-V4).', 'Pain 10/10.'], 
        vitalsMod: { hr: 100, bpSys: 130, spO2: 94, rr: 20 },
        deterioration: { active: true, rate: 0.05, type: 'cardiac' },
        stabilisers: ['Analgesia', 'Oxygen', 'Fluids', 'MHP', 'Cardioversion'], 
        vbgClinicalState: "normal",
        ecg: { type: "Anterior STEMI", findings: "STE V1-V4." },
        chestXray: { findings: "Clear." },
        ultrasound: { type: "Echo", findings: "Anterior wall motion abnormality." },
        ct: { findings: "Not indicated." }
      },
      {
        id: 'AM008', title: 'SVT (Supraventricular Tachycardia)', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 50),
        patientProfileTemplate: "A {age}-year-old {sex} with sudden onset palpitations. Feeling lightheaded.",
        presentingComplaint: 'Palpitations, pre-syncope.',
        scenarioDetails: ['Alert but anxious.', ' HR > 180bpm narrow complex.', 'BP stable initially.'],
        vitalsMod: { hr: 190, bpSys: 110, spO2: 98, rr: 20 },
        deterioration: { active: true, rate: 0.05, type: 'shock' },
        stabilisers: ['Adenosine', 'Cardioversion'],
        vbgClinicalState: "normal",
        ecg: { type: "SVT", findings: "Narrow complex tachycardia, rate 190, no P waves." },
        chestXray: { findings: "Clear." },
        ultrasound: { type: "Echo", findings: "Hyperdynamic LV, normal structure." },
        ct: { findings: "Not indicated." }
      },
      {
        id: 'AM009', title: 'Pulsed VT', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(50, 75),
        patientProfileTemplate: "A {age}-year-old {sex} with history of IHD. Palpitations and chest tightness.",
        presentingComplaint: 'Palpitations, Chest Pain.',
        scenarioDetails: ['Pale, diaphoretic.', 'Broad complex tachycardia on monitor.', 'Conscious.'],
        vitalsMod: { hr: 160, bpSys: 90, spO2: 94, rr: 22 },
        deterioration: { active: true, rate: 0.1, type: 'shock' },
        stabilisers: ['Amiodarone', 'Cardioversion'],
        vbgClinicalState: "normal",
        ecg: { type: "VT", findings: "Broad complex tachycardia, rate 160, AV dissociation." },
        chestXray: { findings: "Mild pulmonary congestion." },
        ultrasound: { type: "Echo", findings: "Reduced EF, global hypokinesis." },
        ct: { findings: "Not indicated." }
      },
      {
        id: 'AM010', title: 'Cardiac Arrest (VF)', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(50, 80),
        patientProfileTemplate: "A {age}-year-old {sex} collapsed in waiting room. No output.",
        presentingComplaint: 'Cardiac Arrest.',
        scenarioDetails: ['Unresponsive, apnoeic.', 'CPR in progress.', 'Rhythm check: VF.'],
        vitalsMod: { hr: 0, bpSys: 0, spO2: 0, rr: 0, gcs: 3 },
        deterioration: { active: false, rate: 0, type: 'arrest' },
        stabilisers: ['CPR', 'Cardioversion', 'Adrenaline', 'Amiodarone'],
        vbgClinicalState: "metabolic_acidosis_severe",
        ecg: { type: "VF", findings: "Ventricular Fibrillation." },
        chestXray: { findings: "Not indicated during CPR." },
        ultrasound: { type: "Echo (During Pulse Check)", findings: "Quivering myocardium, no coordinated squeeze." },
        ct: { findings: "Not indicated." }
      },
      {
        id: 'AM005', title: 'Acute Heart Failure', category: 'Medical', ageRange: 'Elderly',
        ageGenerator: () => getRandomInt(70, 90),
        patientProfileTemplate: "A {age}-year-old {sex} with IHD. Severe respiratory distress.",
        presentingComplaint: 'Severe breathlessness, frothy sputum.',
        scenarioDetails: ['Sat upright, sweating.', 'Bibasal crackles.', 'BP Hypertensive.'],
        vitalsMod: { hr: 110, bpSys: 180, bpDia: 100, spO2: 85, rr: 32 },
        deterioration: { active: true, rate: 0.1, type: 'respiratory' }, 
        stabilisers: ['Oxygen', 'Analgesia'], // Fluids worsen logic handles this
        vbgClinicalState: "normal",
        ecg: { type: "AF RVR", findings: "AF rate 110." },
        chestXray: { findings: "Pulmonary oedema." },
        ultrasound: { type: "Lung", findings: "B-lines everywhere." },
        ct: { findings: "Not immediately indicated." }
      },

      // === TRAUMA ===
      {
        id: 'AT003', title: 'Traumatic Arrest (Penetrating)', category: 'Trauma', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(18, 40),
        patientProfileTemplate: "A {age}-year-old {sex} stabbed in left chest. Lost output en route.",
        presentingComplaint: 'Traumatic Arrest.',
        scenarioDetails: ['CPR in progress.', 'Single stab wound L parasternal.', 'Distended neck veins.'],
        vitalsMod: { hr: 0, bpSys: 0, spO2: 0, rr: 0, gcs: 3 },
        deterioration: { active: false, rate: 0, type: 'arrest' },
        stabilisers: ['Thoracotomy' /* Not in list but Needle is proxy */, 'Needle', 'Blood', 'MHP'],
        vbgClinicalState: "haemorrhagic_shock",
        ecg: { type: "PEA", findings: "Narrow complex PEA." },
        chestXray: { findings: "Usually straight to theatre/thoracotomy." },
        ultrasound: { type: "EFAST", findings: "Pericardial fluid (Tamponade)." },
        ct: { findings: "Not indicated." }
      },
      {
        id: 'AT004', title: 'Traumatic Arrest (Blunt)', category: 'Trauma', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 60),
        patientProfileTemplate: "A {age}-year-old {sex} pedestrian vs car. Agonal breathing.",
        presentingComplaint: 'Traumatic Arrest.',
        scenarioDetails: ['Loss of output on transfer.', 'Chest injury right.', 'Pelvis unstable.'],
        vitalsMod: { hr: 0, bpSys: 0, spO2: 0, rr: 4, gcs: 3 },
        deterioration: { active: false, rate: 0, type: 'arrest' },
        stabilisers: ['Blood', 'Needle', 'MHP'],
        vbgClinicalState: "haemorrhagic_shock",
        ecg: { type: "PEA", findings: "Slow PEA." },
        chestXray: { findings: "Massive Haemothorax." },
        ultrasound: { type: "EFAST", findings: "Positive free fluid + pneumothorax." },
        ct: { findings: "Not indicated." }
      },
      {
        id: 'AT005', title: 'Severe Head Injury', category: 'Trauma', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(18, 60),
        patientProfileTemplate: "A {age}-year-old {sex} fell from 3m ladder. GCS 7.",
        presentingComplaint: 'Head Injury, Reduced GCS.',
        scenarioDetails: ['GCS E2 V2 M3.', 'Right pupil dilated.', 'Cushing\'s Reflex?'],
        vitalsMod: { hr: 50, bpSys: 170, bpDia: 90, spO2: 94, rr: 10, gcs: 7 },
        deterioration: { active: true, rate: 0.1, type: 'neuro' },
        stabilisers: ['Intubation'], // Needs airway protection
        vbgClinicalState: "normal",
        ecg: { type: "Sinus Bradycardia", findings: "Sinus Bradycardia." },
        chestXray: { findings: "Clear." },
        ultrasound: { type: "Optic Nerve Sheath", findings: "Increased ONSD (>5mm) suggesting raised ICP." },
        ct: { findings: "CT Head: Large Extradural Haematoma with midline shift." }
      },
      
      // === RESPIRATORY ===
      {
        id: 'AM002', title: 'Severe COPD', category: 'Medical', ageRange: 'Elderly',
        ageGenerator: () => getRandomInt(65, 90),
        patientProfileTemplate: "A {age}-year-old {sex}, severe COPD. Drowsy on arrival.",
        presentingComplaint: 'Dyspnoea, reduced GCS.',
        scenarioDetails: ['GCS 13. Wheezy.', 'Asterixis positive.', 'On 15L O2 from crew.'], 
        vitalsMod: { hr: 110, bpSys: 140, spO2: 98, rr: 10, gcs: 12 }, 
        deterioration: { active: true, rate: 0.08, type: 'respiratory' },
        stabilisers: ['Nebs', 'Dexamethasone'], 
        vbgClinicalState: "copd_retainer",
        ecg: { type: "MAT", findings: "Multifocal Atrial Tachycardia." },
        chestXray: { findings: "Hyperinflation." },
        ultrasound: { type: "Lung", findings: "Lung sliding present." },
        ct: { findings: "CTPA: Negative for PE. Emphysematous changes." }
      },
      {
        id: 'AM011', title: 'Life Threatening Asthma', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(18, 40),
        patientProfileTemplate: "A {age}-year-old {sex}, brittle asthma. Becoming exhausted.",
        presentingComplaint: 'Severe dyspnoea, silent chest.',
        scenarioDetails: ['Silent chest on auscultation.', 'Exhausted, dropping GCS.', 'Sats falling.'],
        vitalsMod: { hr: 140, bpSys: 110, spO2: 88, rr: 8, gcs: 13 },
        deterioration: { active: true, rate: 0.15, type: 'respiratory' },
        stabilisers: ['Adrenaline', 'Magnesium', 'Nebs', 'Dexamethasone'],
        vbgClinicalState: "respiratory_acidosis_acute", // CO2 rising = bad
        ecg: { type: "Sinus Tach", findings: "Rate 140, P pulmonale." },
        chestXray: { findings: "Hyperinflation." },
        ultrasound: { type: "Lung", findings: "Sliding present." },
        ct: { findings: "Not indicated." }
      },

      // === OTHER MEDICAL ===
      {
        id: 'AM012', title: 'Anaphylaxis', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 50),
        patientProfileTemplate: "A {age}-year-old {sex} stung by wasp. Lip swelling and wheeze.",
        presentingComplaint: 'Angioedema, Stridor, Shock.',
        scenarioDetails: ['Swollen lips/tongue.', 'Widespread urticaria.', 'Audible stridor.'],
        vitalsMod: { hr: 130, bpSys: 80, bpDia: 40, spO2: 91, rr: 28 },
        deterioration: { active: true, rate: 0.1, type: 'shock' },
        stabilisers: ['Adrenaline', 'Fluids', 'Dexamethasone'],
        vbgClinicalState: "normal",
        ecg: { type: "Sinus Tach", findings: "Rate 130." },
        chestXray: { findings: "Normal." },
        ultrasound: { type: "Echo", findings: "Hyperdynamic, empty IVC." },
        ct: { findings: "Not indicated." }
      },
      {
        id: 'AM013', title: 'Severe Sepsis', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(40, 80),
        patientProfileTemplate: "A {age}-year-old {sex} with fever and confusion. History of UTI.",
        presentingComplaint: 'Fever, Rigors, Hypotension.',
        scenarioDetails: ['Hot to touch.', 'Mottled skin.', 'Lactate 6.0.'],
        vitalsMod: { hr: 125, bpSys: 85, bpDia: 45, spO2: 94, rr: 26, temp: 39.2 },
        deterioration: { active: true, rate: 0.05, type: 'shock' },
        stabilisers: ['Fluids', 'Antibiotics', 'Oxygen'],
        vbgClinicalState: "septic_shock",
        ecg: { type: "Sinus Tach", findings: "Rate 125." },
        chestXray: { findings: "Clear (if UTI source)." },
        ultrasound: { type: "IVC", findings: "Collapsing IVC." },
        ct: { findings: "CT AP: Pyelonephritis/Obstructed ureter." }
      },
      {
        id: 'AM014', title: 'Status Epilepticus', category: 'Medical', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 50),
        patientProfileTemplate: "A {age}-year-old {sex}, known epilepsy. Seizing for 20 mins.",
        presentingComplaint: 'Continuous Seizure.',
        scenarioDetails: ['Tonic-clonic activity.', 'Airway compromised.', 'Hypoxic.'],
        vitalsMod: { hr: 140, bpSys: 130, spO2: 88, rr: 30, gcs: 3 },
        deterioration: { active: true, rate: 0.05, type: 'respiratory' },
        stabilisers: ['Benzos', 'Oxygen'],
        vbgClinicalState: "respiratory_acidosis_acute", // & lactic acidosis
        ecg: { type: "Sinus Tach", findings: "Artefact from seizure." },
        chestXray: { findings: "Aspiration?" },
        ultrasound: { type: "N/A", findings: "N/A" },
        ct: { findings: "CT Head: Normal/Previous changes." }
      },
      {
        id: 'AM015', title: 'Severe Overdose (Opiate)', category: 'Toxicology', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 40),
        patientProfileTemplate: "A {age}-year-old {sex} found unresponsive with needle.",
        presentingComplaint: 'Unconscious, Apnoea.',
        scenarioDetails: ['Pinpoint pupils.', 'Resp rate 4.', 'Skin cool.'],
        vitalsMod: { hr: 60, bpSys: 100, spO2: 80, rr: 4, gcs: 3 },
        deterioration: { active: true, rate: 0.1, type: 'respiratory' },
        stabilisers: ['Naloxone', 'Oxygen'],
        vbgClinicalState: "respiratory_acidosis_acute",
        ecg: { type: "Sinus Brady", findings: "Normal intervals." },
        chestXray: { findings: "Aspiration?" },
        ultrasound: { type: "N/A", findings: "N/A" },
        ct: { findings: "CT Head: Normal." }
      },
      {
        id: 'AM016', title: 'Acute Behavioural Disturbance', category: 'Psychiatry', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 40),
        patientProfileTemplate: "A {age}-year-old {sex}, extremely agitated and aggressive. Restrained by police.",
        presentingComplaint: 'Agitation, Delirium.',
        scenarioDetails: ['Sweating profusely.', 'Shouting incoherent.', 'High risk of hyperthermia/rhabdo.'],
        vitalsMod: { hr: 140, bpSys: 160, spO2: 96, rr: 30, temp: 38.5 },
        deterioration: { active: true, rate: 0.05, type: 'metabolic' },
        stabilisers: ['Benzos', 'Fluids'],
        vbgClinicalState: "metabolic_acidosis_severe", // Lactate high
        ecg: { type: "Sinus Tach", findings: "Rate 140." },
        chestXray: { findings: "Normal." },
        ultrasound: { type: "N/A", findings: "N/A" },
        ct: { findings: "CT Head: Normal." }
      },

      // === OBSTETRIC ===
      {
        id: 'OB001', title: 'Maternal Collapse (Eclampsia)', category: 'Obstetric & Gynae Emergencies', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 40),
        patientProfileTemplate: "A {age}-year-old female, 36 weeks pregnant. Seizing.",
        presentingComplaint: 'Seizure in pregnancy.',
        scenarioDetails: ['Tonic-clonic seizure.', 'Hypertensive prior to seizure.', 'Proteinuria +++.'],
        vitalsMod: { hr: 130, bpSys: 180, bpDia: 110, spO2: 90, rr: 24, gcs: 3 },
        deterioration: { active: true, rate: 0.1, type: 'neuro' },
        stabilisers: ['Magnesium', 'Oxygen', 'Benzos'],
        vbgClinicalState: "normal",
        ecg: { type: "Sinus Tach", findings: "Rate 130." },
        chestXray: { findings: "Shield gravid uterus." },
        ultrasound: { type: "Fetal Heart", findings: "Fetal bradycardia." },
        ct: { findings: "CT Head: Posterior Reversible Encephalopathy Syndrome (PRES)." }
      },
       {
        id: 'OB002', title: 'Maternal Collapse (PPH)', category: 'Obstetric & Gynae Emergencies', ageRange: 'Adult',
        ageGenerator: () => getRandomInt(20, 40),
        patientProfileTemplate: "A {age}-year-old female, 1 hour post-partum (home birth). Massive PV bleeding.",
        presentingComplaint: 'Post-Partum Haemorrhage.',
        scenarioDetails: ['Pale, shut down.', 'Uterus boggy.', 'Est blood loss > 1500ml.'],
        vitalsMod: { hr: 140, bpSys: 70, bpDia: 30, spO2: 94, rr: 28 },
        deterioration: { active: true, rate: 0.2, type: 'shock' },
        stabilisers: ['MHP', 'TXA', 'Fluids'],
        vbgClinicalState: "haemorrhagic_shock",
        ecg: { type: "Sinus Tach", findings: "Rate 140." },
        chestXray: { findings: "Normal." },
        ultrasound: { type: "FAST", findings: "Free fluid abdomen." },
        ct: { findings: "Not indicated - theatre." }
      }
    ];

    // --- 2. COMPONENTS ---

    const { useState, useEffect, useRef } = React;
    
    const Lucide = ({ icon, className }) => <i data-lucide={icon} className={className}></i>;

    // --- REUSABLE UI COMPONENTS ---
    const Button = ({ onClick, children, variant = 'primary', className = '', disabled = false }) => {
        // Increased touch target sizes and font size slightly for mobile
        const base = "px-4 py-3 rounded font-semibold transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm text-sm touch-manipulation relative overflow-hidden";
        const variants = {
            primary: "bg-sky-600 hover:bg-sky-500 text-white",
            secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
            danger: "bg-red-600 hover:bg-red-500 text-white",
            success: "bg-emerald-600 hover:bg-emerald-500 text-white",
            outline: "border border-slate-600 text-slate-300 hover:bg-slate-800"
        };
        return <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>{children}</button>;
    };

    const Card = ({ title, icon, children, className = "" }) => (
        <div className={`bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-lg ${className}`}>
            {title && (
                <div className="bg-slate-800/50 p-3 border-b border-slate-700 flex items-center gap-2">
                    {icon && <Lucide icon={icon} className="w-5 h-5 text-sky-400" />}
                    <h3 className="font-bold text-slate-200">{title}</h3>
                </div>
            )}
            <div className="p-4">{children}</div>
        </div>
    );

    // --- SIMULATION ENGINE ---
    const useSimulation = (initialScenario) => {
        const [scenario, setScenario] = useState(initialScenario);
        const [time, setTime] = useState(0);
        const [isRunning, setIsRunning] = useState(false);
        const [vitals, setVitals] = useState({ ...initialScenario.vitals });
        const [prevVitals, setPrevVitals] = useState({ ...initialScenario.vitals });
        const [log, setLog] = useState([]);
        const [flash, setFlash] = useState(null); 
        const [investigationsRevealed, setInvestigationsRevealed] = useState({}); // Track revealed investigations
        const [loadingInvestigations, setLoadingInvestigations] = useState({}); // NEW: Track loading state for buttons

        // NEW: History state for graph
        const [history, setHistory] = useState([]);

        const timerRef = useRef(null);
        const tickRef = useRef(null);

        const addLogEntry = (msg, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString('en-GB');
            const simTime = `${Math.floor(time/60).toString().padStart(2,'0')}:${(time%60).toString().padStart(2,'0')}`;
            const logEntry = { time: timestamp, simTime, msg, type, timeSeconds: time };
            setLog(prev => [...prev, logEntry]);
            
            // If it's an action/intervention, mark it in history for graph
            if (type === 'action' || type === 'success') {
                setHistory(prev => {
                    if (prev.length === 0) return prev;
                    const lastIdx = prev.length - 1;
                    const newHist = [...prev];
                    // Add annotation to last history point
                    if (!newHist[lastIdx].actions) newHist[lastIdx].actions = [];
                    newHist[lastIdx].actions.push(msg.split(' ')[0]); // Short label
                    return newHist;
                });
            }
        };

        const applyIntervention = (key) => {
            const action = INTERVENTIONS[key];
            if (!action) return;

            setPrevVitals({ ...vitals });
            const newVitals = { ...vitals };
            
            // Branching Logic
            if (key === 'Fluids' && scenario.id === 'AM005') { // Acute HF
                 newVitals.spO2 = Math.max(70, newVitals.spO2 - 5); // Worsens
                 newVitals.rr += 4;
                 addLogEntry("Warning: Fluids caused respiratory deterioration!", 'danger');
                 setFlash('red');
            } else {
                // Standard Effects
                if (action.effect.SpO2) newVitals.spO2 = Math.min(100, newVitals.spO2 + action.effect.SpO2);
                if (action.effect.BP) newVitals.bpSys += action.effect.BP;
                if (action.effect.HR) newVitals.hr += action.effect.HR;
                if (action.effect.RR) newVitals.rr += action.effect.RR;
                if (action.effect.gcs) newVitals.gcs = Math.max(3, Math.min(15, newVitals.gcs + action.effect.gcs));

                if (scenario.stabilisers && scenario.stabilisers.includes(key)) {
                    setScenario(prev => ({
                        ...prev,
                        deterioration: { ...prev.deterioration, rate: Math.max(0, prev.deterioration.rate - 0.05) } // Slower reduction
                    }));
                    addLogEntry(`${action.log} (Effective)`, 'success');
                    setFlash('green');
                } else {
                    addLogEntry(action.log, 'action');
                }
            }

            setVitals(newVitals);
            setTimeout(() => setFlash(null), 1000);
        };

        // Manual Update Function
        const manualUpdateVital = (key, value) => {
            setPrevVitals({...vitals});
            setVitals(prev => ({ ...prev, [key]: value }));
            addLogEntry(`Manual override: ${key} set to ${value}`, 'manual');
        };

        const toggleDeterioration = () => {
            setScenario(prev => {
                const newState = !prev.deterioration.active;
                addLogEntry(`Deterioration ${newState ? 'Resumed' : 'Paused'}`, 'manual');
                return { ...prev, deterioration: { ...prev.deterioration, active: newState } };
            });
        };

        const triggerArrest = () => {
            setPrevVitals({...vitals});
            setVitals(prev => ({ ...prev, hr: 0, bpSys: 0, bpDia: 0, spO2: 0, rr: 0, gcs: 3 }));
            addLogEntry('CARDIAC ARREST', 'manual');
            setFlash('red');
        };

        const revealInvestigation = (type) => {
             if (investigationsRevealed[type] || loadingInvestigations[type]) return;
             
             setLoadingInvestigations(prev => ({ ...prev, [type]: true }));
             
             // Simulate delay (2 seconds)
             setTimeout(() => {
                 setLoadingInvestigations(prev => ({ ...prev, [type]: false }));
                 setInvestigationsRevealed(prev => ({ ...prev, [type]: true }));
                 addLogEntry(`${type} Result Available`, 'success');
             }, 2000);
        };

        const tick = () => {
            setVitals(current => {
                const next = { ...current };
                next.hr += getRandomInt(-1, 1);
                next.bpSys += getRandomInt(-2, 2);
                next.bpDia = Math.floor(next.bpSys * 0.65) + getRandomInt(-2, 2); // Update diastolic relative to systolic
                next.spO2 += Math.random() > 0.9 ? getRandomInt(-1, 1) : 0;

                if (scenario.deterioration?.active && scenario.deterioration.rate > 0) {
                    const rate = scenario.deterioration.rate;
                    // Slower tick rate check (every 3s)
                    if (Math.random() < rate) {
                        if (scenario.deterioration.type === 'shock') {
                            next.bpSys -= 1;
                            next.hr += 1;
                        } else if (scenario.deterioration.type === 'respiratory') {
                            next.spO2 -= 1;
                            next.rr += (Math.random() > 0.8 ? 1 : 0);
                        } else if (scenario.deterioration.type === 'cardiac') {
                            next.bpSys -= 1;
                        } else if (scenario.deterioration.type === 'neuro') {
                            next.hr -= 1; // Cushing's (brady)
                            next.bpSys += 1; // Cushing's (HTN)
                        } else if (scenario.deterioration.type === 'metabolic') {
                            next.hr += 1;
                            next.temp = parseFloat((next.temp + 0.1).toFixed(1));
                        }
                    }
                }
                next.spO2 = Math.min(100, Math.max(0, next.spO2));
                next.hr = Math.max(0, next.hr);
                
                // Record History
                setHistory(h => [...h, {
                    time: time,
                    hr: next.hr,
                    bp: next.bpSys,
                    spo2: next.spO2,
                    rr: next.rr,
                    actions: [] 
                }]);

                return next;
            });
        };
        
        // Dynamic Investigation Evolution
        useEffect(() => {
            if (time > 300 && scenario.id === 'AM001' && !scenario.ecg.findings.includes('Evolving')) {
                 // Evolve STEMI ECG after 5 mins if not sorted
                 setScenario(prev => ({
                     ...prev,
                     ecg: { ...prev.ecg, findings: "Massive Anterior STE. Tombstoning. (Evolving)" }
                 }));
                 addLogEntry("ECG Changes noted on monitor", "info");
            }
        }, [time, scenario.id]);

        useEffect(() => {
            if (vitals.spO2 < 85 || vitals.bpSys < 80 || vitals.hr > 160 || (vitals.hr < 40 && vitals.hr > 0)) {
                if (time % 5 === 0 && isRunning) setFlash('red');
                else setFlash(null);
            }
        }, [vitals, time, isRunning]);

        const start = () => {
            if (isRunning) return;
            setIsRunning(true);
            addLogEntry("Simulation Started", 'system');
            timerRef.current = setInterval(() => setTime(t => t + 1), 1000);
            tickRef.current = setInterval(tick, 3000);
        };

        const pause = () => {
            setIsRunning(false);
            addLogEntry("Simulation Paused", 'system');
            clearInterval(timerRef.current);
            clearInterval(tickRef.current);
        };

        const stop = () => {
            pause();
            addLogEntry("Simulation Ended", 'system');
        };

        return {
            scenario, time, isRunning, vitals, prevVitals, log, flash, history, investigationsRevealed, loadingInvestigations,
            start, pause, stop, applyIntervention, addLogEntry, manualUpdateVital, toggleDeterioration, triggerArrest, revealInvestigation
        };
    };

    // --- SUB-SCREENS ---

    const SetupScreen = ({ onGenerate, initialParams }) => {
        const [category, setCategory] = useState(initialParams?.category || 'Any');
        const [age, setAge] = useState(initialParams?.age || 'Any');
        const [hf, setHf] = useState(initialParams?.hf || 'hf0');
        const [loading, setLoading] = useState(false);
        const [customMode, setCustomMode] = useState(initialParams?.customMode || false);
        
        const [customScenario, setCustomScenario] = useState({
            title: "Custom Scenario",
            age: 40,
            sex: "male",
            complaint: "Shortness of breath",
            profile: "A 40-year-old male with no past medical history.",
            hr: 80, bpSys: 120, rr: 16, spO2: 98, temp: 37.0, gcs: 15, bm: 5.5,
            ecgType: "Sinus Rhythm", ecgFindings: "Normal",
            cxrFindings: "Clear",
            vbgState: "normal"
        });

        const handleGenerate = () => {
            setLoading(true);
            setTimeout(() => {
                let generatedScenario;
                const currentParams = { category, age, hf, customMode };

                if (customMode) {
                    generatedScenario = {
                        id: 'CUSTOM',
                        title: customScenario.title,
                        category: 'Custom',
                        ageRange: 'Custom',
                        patientAge: customScenario.age,
                        profile: customScenario.profile,
                        presentingComplaint: customScenario.complaint,
                        scenarioDetails: ['Custom scenario generated by user.'],
                        vitals: {
                            hr: parseInt(customScenario.hr),
                            bpSys: parseInt(customScenario.bpSys),
                            bpDia: Math.floor(parseInt(customScenario.bpSys) * 0.65),
                            rr: parseInt(customScenario.rr),
                            spO2: parseInt(customScenario.spO2),
                            temp: parseFloat(customScenario.temp),
                            gcs: parseInt(customScenario.gcs),
                            bm: parseFloat(customScenario.bm)
                        },
                        vbg: generateVbg(customScenario.vbgState),
                        hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf),
                        ecg: { type: customScenario.ecgType, findings: customScenario.ecgFindings },
                        chestXray: { findings: customScenario.cxrFindings },
                        deterioration: { active: false, rate: 0 },
                        stabilisers: [],
                        interventions: ['Oxygen', 'Fluids', 'Analgesia']
                    };
                } else {
                    let pool = ALL_SCENARIOS.filter(s => 
                        (category === 'Any' || s.category === category) &&
                        (age === 'Any' || s.ageRange === age)
                    );
                    if (pool.length === 0) pool = ALL_SCENARIOS;

                    const base = pool[Math.floor(Math.random() * pool.length)];
                    const patientAge = base.ageGenerator();
                    const ranges = getBaseVitals(patientAge);
                    
                    let startVitals = {
                        hr: base.vitalsMod?.hr || ranges.hr,
                        bpSys: base.vitalsMod?.bpSys || ranges.bpSys,
                        bpDia: base.vitalsMod?.bpDia || ranges.bpDia || Math.floor((base.vitalsMod?.bpSys || ranges.bpSys) * 0.65),
                        rr: base.vitalsMod?.rr || ranges.rr,
                        spO2: base.vitalsMod?.spO2 || 98,
                        temp: base.vitalsMod?.temp || ranges.temp,
                        gcs: base.vitalsMod?.gcs || 15,
                        bm: ranges.bm
                    };

                    const profile = base.patientProfileTemplate
                        .replace(/{age}/g, patientAge)
                        .replace(/{sex}/g, Math.random() > 0.5 ? 'male' : 'female')
                        .replace(/{durationPain}/g, getRandomInt(1,4));

                    generatedScenario = {
                        ...base,
                        patientAge,
                        profile,
                        vitals: startVitals,
                        vbg: generateVbg(base.vbgClinicalState),
                        hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf)
                    };
                }
                
                // Calculate Weight if Paediatric (UK Practice: APLS/WETFLAG style estimations)
                if (generatedScenario.ageRange === 'Paediatric' || generatedScenario.patientAge < 18) {
                     generatedScenario.weight = estimateWeight(generatedScenario.patientAge);
                }

                setLoading(false);
                onGenerate(generatedScenario, currentParams);
            }, 600);
        };

        useEffect(() => {
            if (initialParams && initialParams.autoGenerate) {
                handleGenerate();
            }
        }, []);

        return (
            <div className="max-w-2xl mx-auto space-y-6 p-2">
                <div className="bg-slate-800 p-4 md:p-6 rounded-lg border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-sky-400 mb-4 flex items-center gap-2"><Lucide icon="settings" className="w-5 h-5"/> Simulation Parameters</h2>
                    
                    <div className="flex gap-4 mb-6 border-b border-slate-700 pb-2 overflow-x-auto">
                        <button onClick={() => setCustomMode(false)} className={`text-sm font-bold uppercase pb-1 whitespace-nowrap ${!customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Random Scenario</button>
                        <button onClick={() => setCustomMode(true)} className={`text-sm font-bold uppercase pb-1 whitespace-nowrap ${customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Custom Scenario</button>
                    </div>

                    {!customMode ? (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label className="text-xs uppercase text-slate-500 font-bold">Category</label>
                                <select value={category} onChange={e=>setCategory(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm">
                                    <option value="Any">Any</option>
                                    <option value="Medical">Medical</option>
                                    <option value="Trauma">Trauma</option>
                                    <option value="Toxicology">Toxicology</option>
                                    <option value="Psychiatry">Psychiatry</option>
                                    <option value="Obstetric & Gynae Emergencies">Obs & Gynae</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-xs uppercase text-slate-500 font-bold">Age</label>
                                <select value={age} onChange={e=>setAge(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm">
                                    <option value="Any">Any</option>
                                    <option value="Adult">Adult</option>
                                    <option value="Elderly">Elderly</option>
                                    <option value="Paediatric">Paediatric</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-xs uppercase text-slate-500 font-bold">Human Factor</label>
                                <select value={hf} onChange={e=>setHf(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm">
                                    {HUMAN_FACTOR_CHALLENGES.map(h => <option key={h.id} value={h.id}>{h.type}</option>)}
                                </select>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4 mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-slate-500 font-bold">Title</label>
                                    <input type="text" value={customScenario.title} onChange={e => setCustomScenario({...customScenario, title: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm"/>
                                </div>
                                {/* ... other inputs ... */}
                            </div>
                        </div>
                    )}

                    <Button onClick={handleGenerate} disabled={loading} className="w-full py-4 text-lg">
                        {loading ? <Lucide icon="loader-2" className="animate-spin"/> : <Lucide icon="play"/>}
                        {loading ? "Building Scenario..." : "Generate Scenario"}
                    </Button>
                </div>
            </div>
        );
    };

    const BriefingScreen = ({ scenario, onStart, onBack, onNewScenario }) => (
        <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-2">
            <div className="bg-slate-800 p-4 md:p-6 rounded-lg border-l-4 border-sky-500 shadow-lg">
                <div className="flex flex-col md:flex-row justify-between items-start gap-4">
                    <div>
                        <h2 className="text-2xl md:text-3xl font-bold text-white">{scenario.title}</h2>
                        <span className="inline-block bg-slate-700 text-sky-300 text-xs px-2 py-1 rounded mt-2">{scenario.category}</span>
                    </div>
                    <div className="text-left md:text-right">
                        <p className="text-2xl font-mono font-bold text-emerald-400">GCS {scenario.vitals.gcs}</p>
                        <p className="text-sm text-slate-400">Initial Status</p>
                    </div>
                </div>
                <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-1">Patient Profile</h3>
                        <p className="text-lg leading-relaxed">{scenario.profile}</p>
                        {scenario.weight && <div className="mt-2 p-2 bg-sky-900/30 border border-sky-700/50 rounded inline-block">
                            <p className="text-xs text-sky-400 font-bold uppercase">Est. Weight (APLS)</p>
                            <p className="text-lg font-mono text-white">{scenario.weight} kg</p>
                        </div>}
                        <div className="mt-4 p-3 bg-slate-700/50 rounded border border-slate-600">
                            <p className="font-bold text-sky-300"><Lucide icon="alert-circle" className="inline w-4 h-4 mr-1"/> PC: {scenario.presentingComplaint}</p>
                        </div>
                    </div>
                    <div className="space-y-2">
                        {scenario.scenarioDetails.map((d, i) => (
                            <div key={i} className="flex items-start gap-2 text-slate-300">
                                <Lucide icon="chevron-right" className="w-4 h-4 mt-1 text-slate-500 flex-shrink-0"/>
                                <p>{d}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {scenario.hf.id !== 'hf0' && (
                <div className="bg-purple-900/20 border border-purple-500/50 p-4 rounded flex items-center gap-3">
                    <Lucide icon="users" className="text-purple-400 w-6 h-6"/>
                    <div>
                        <h4 className="font-bold text-purple-200">{scenario.hf.type}</h4>
                        <p className="text-sm text-purple-300">{scenario.hf.description}</p>
                    </div>
                </div>
            )}

            <div className="flex flex-col md:flex-row justify-center gap-4 pt-4">
                <Button onClick={onBack} variant="secondary" className="w-full md:w-1/3 py-4 text-lg">
                    <Lucide icon="arrow-left"/> Back
                </Button>
                <Button onClick={onNewScenario} variant="secondary" className="w-full md:w-1/3 py-4 text-lg">
                    <Lucide icon="refresh-cw"/> New Scenario
                </Button>
                <Button onClick={onStart} className="w-full md:w-1/3 py-4 text-lg shadow-sky-900/20 shadow-xl">
                    <Lucide icon="activity"/> Start Live Simulation
                </Button>
            </div>
        </div>
    );

    const LiveSimScreen = ({ sim, onFinish, onBack }) => {
        const { scenario, time, isRunning, vitals, prevVitals, log, flash, start, pause, applyIntervention, addLogEntry, manualUpdateVital, toggleDeterioration, triggerArrest, revealInvestigation, investigationsRevealed, loadingInvestigations } = sim;
        const logEndRef = useRef(null);
        const [manualLog, setManualLog] = useState("");
        const [manualNotes, setManualNotes] = useState("");
        const [activeTab, setActiveTab] = useState("Airway"); 

        useEffect(() => {
            if (logEndRef.current) logEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }, [log]);

        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        const getTrend = (curr, prev) => curr > prev ? '' : curr < prev ? '' : '';
        const getTrendColor = (curr, prev, lowIsBad = true) => {
            if (curr === prev) return 'text-slate-500';
            if (lowIsBad) return curr > prev ? 'text-emerald-400' : 'text-red-400';
            return curr > prev ? 'text-red-400' : 'text-emerald-400';
        };

        // Updated VitalDisplay with Manual Override Input (now handles internal edit state correctly)
        const VitalDisplay = ({ label, value, prev, unit, lowIsBad = true, onUpdate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editVal, setEditVal] = useState(value);

            // Sync editVal only when NOT editing to prevent overwrites
            useEffect(() => {
                if (!isEditing) setEditVal(value);
            }, [value, isEditing]);

            const handleBlur = () => {
                setIsEditing(false);
                if (editVal !== value) onUpdate(parseInt(editVal));
            };

            return (
                <div className="bg-slate-900/50 p-3 rounded border border-slate-700 flex flex-col items-center justify-center h-28 relative touch-manipulation">
                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">{label}</span>
                    {isEditing ? (
                        <input 
                            type="number" 
                            value={editVal} 
                            onChange={(e) => setEditVal(e.target.value)}
                            onBlur={handleBlur}
                            onKeyDown={(e) => e.key === 'Enter' && handleBlur()}
                            className="text-2xl font-mono font-bold text-white bg-slate-800 border border-slate-500 rounded w-20 text-center"
                            autoFocus
                        />
                    ) : (
                        <div className="flex items-baseline gap-1 cursor-pointer hover:bg-slate-800/50 rounded px-2 py-2" onClick={() => { setEditVal(value); setIsEditing(true); }}>
                            <span className="text-3xl font-mono font-bold text-white">{Math.round(value)}</span>
                            <span className={`text-sm font-bold ${getTrendColor(value, prev, lowIsBad)}`}>
                                {getTrend(value, prev)}
                            </span>
                        </div>
                    )}
                    <span className="text-[10px] text-slate-600 mt-1">{unit}</span>
                </div>
            );
        };

        const getInterventionsByCat = (cat) => {
            return Object.keys(INTERVENTIONS).filter(key => INTERVENTIONS[key].category === cat);
        };

        // Helper for investigation buttons
        const InvestigationButton = ({ type, icon, label }) => {
            const isRevealed = investigationsRevealed[type];
            const isLoading = loadingInvestigations[type];
            const hasData = (type === 'ECG' && scenario.ecg) || (type === 'CXR' && scenario.chestXray) || (type === 'POCUS' && scenario.ultrasound) || (type === 'VBG' && scenario.vbg) || (type === 'CT' && scenario.ct);
            
            return (
                <div className="flex flex-col gap-2">
                    <Button 
                        variant={isRevealed ? "secondary" : "outline"} 
                        onClick={() => revealInvestigation(type)} 
                        disabled={!isRunning || isRevealed || isLoading}
                        className="h-10 text-xs relative overflow-hidden"
                    >
                        {isLoading && <div className="loading-bar"></div>}
                        <div className="relative z-10 flex items-center gap-2">
                            <Lucide icon={icon} className="w-3 h-3"/> {isLoading ? `Requesting...` : (isRevealed ? `View ${type}` : `Request ${type}`)}
                        </div>
                    </Button>
                    {isRevealed && (
                        <div className="p-3 bg-slate-700/30 rounded text-xs border-l-2 border-sky-500 animate-fadeIn">
                            {hasData ? (
                                type === 'VBG' ? 
                                    `pH ${scenario.vbg.pH.toFixed(2)} | pCO2 ${scenario.vbg.pCO2} | Lac ${scenario.vbg.Lac} | K ${scenario.vbg.K}` :
                                type === 'ECG' ? `${scenario.ecg.type} - ${scenario.ecg.findings}` :
                                type === 'CXR' ? scenario.chestXray.findings :
                                type === 'POCUS' ? scenario.ultrasound.findings : 
                                type === 'CT' ? scenario.ct.findings : 'Normal / Not Indicated'
                            ) : 'Normal / Not Indicated'}
                        </div>
                    )}
                </div>
            );
        }

        return (
            <div className={`max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 transition-colors duration-500 ${flash === 'red' ? 'flash-red' : (flash === 'green' ? 'flash-green' : '')}`}>
                
                <div className="lg:col-span-2 space-y-6 order-1">
                    {/* Patient Summary Card */}
                    <Card className="bg-slate-800 border-slate-700">
                        <div className="flex justify-between items-start flex-wrap gap-2">
                            <div>
                                <h3 className="font-bold text-lg text-white mb-1">{scenario.title} ({scenario.patientAge})</h3>
                                <p className="text-sm text-slate-300">{scenario.profile}</p>
                                {scenario.weight && <p className="text-xs text-sky-400 mt-1 font-bold">Est. Weight: {scenario.weight}kg</p>}
                            </div>
                            <div className="bg-sky-900/50 border border-sky-700 px-3 py-1 rounded">
                                <p className="text-xs font-bold text-sky-300 uppercase">Presenting Complaint</p>
                                <p className="text-sm text-white">{scenario.presentingComplaint}</p>
                            </div>
                        </div>
                    </Card>

                    <Card className="bg-slate-900 border-slate-800">
                        {/* MOVED CONTROLS TO TOP OF MONITOR - Stack on mobile */}
                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 border-b border-slate-800 pb-2 gap-3">
                            <div className="flex gap-2 w-full md:w-auto">
                                <Button variant="secondary" onClick={onBack} disabled={isRunning} className="h-10 md:h-8 text-xs px-3 flex-1 md:flex-none"><Lucide icon="arrow-left" className="w-3 h-3"/> Back</Button>
                                {!isRunning ? (
                                    // Changed height to h-12, text to base, and px-6 to make it bigger
                                    <Button variant="success" onClick={start} className="h-12 text-base px-6 font-bold shadow-lg flex-grow md:flex-none"><Lucide icon="play" className="w-5 h-5"/> START</Button>
                                ) : (
                                    <Button variant="danger" onClick={pause} className="h-10 md:h-8 text-xs px-3 flex-1 md:flex-none"><Lucide icon="pause" className="w-3 h-3"/> Pause</Button>
                                )}
                                <Button variant="primary" onClick={onFinish} className="h-10 md:h-8 text-xs px-3 flex-1 md:flex-none"><Lucide icon="square" className="w-3 h-3"/> Finish</Button>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className={`w-3 h-3 rounded-full ${isRunning ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`}></div>
                                <div className="font-mono text-2xl font-bold text-emerald-400 bg-black/40 px-4 py-1 rounded">
                                    {formatTime(time)}
                                </div>
                            </div>
                        </div>
                        
                        {/* Updated Vitals Grid with BP fix and Manual Input - 2 cols on mobile */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <VitalDisplay label="Heart Rate" value={vitals.hr} prev={prevVitals.hr} unit="bpm" lowIsBad={false} onUpdate={(v) => manualUpdateVital('hr', v)}/>
                            <div className="bg-slate-900/50 p-3 rounded border border-slate-700 flex flex-col items-center justify-center h-28">
                                <span className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">BP</span>
                                <span className="text-2xl font-mono font-bold text-white">{Math.round(vitals.bpSys)}/{Math.round(vitals.bpDia)}</span>
                                <span className="text-[10px] text-slate-600 mt-1">mmHg</span>
                            </div>
                            <VitalDisplay label="SpO2" value={vitals.spO2} prev={prevVitals.spO2} unit="%" onUpdate={(v) => manualUpdateVital('spO2', v)}/>
                            <VitalDisplay label="Resp Rate" value={vitals.rr} prev={prevVitals.rr} unit="/min" lowIsBad={false} onUpdate={(v) => manualUpdateVital('rr', v)}/>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-slate-900/30 p-2 rounded text-center border border-slate-700">
                                <span className="text-xs text-slate-500 block">GCS</span>
                                <span className="font-mono font-bold text-lg">{vitals.gcs}</span>
                            </div>
                            <div className="bg-slate-900/30 p-2 rounded text-center border border-slate-700">
                                <span className="text-xs text-slate-500 block">Temp</span>
                                <span className="font-mono font-bold text-lg">{vitals.temp}C</span>
                            </div>
                            <div className="bg-slate-900/30 p-2 rounded text-center border border-slate-700">
                                <span className="text-xs text-slate-500 block">Glucose</span>
                                <span className="font-mono font-bold text-lg">{vitals.bm}</span>
                            </div>
                        </div>
                    </Card>

                    <Card title="Clinical Actions" icon="activity">
                        {/* New Instructor Override Controls */}
                        <div className="flex justify-end gap-2 mb-4 border-b border-slate-700 pb-2">
                            <Button variant="secondary" onClick={toggleDeterioration} className="text-xs h-10 border border-slate-600">
                                <Lucide icon={scenario.deterioration.active ? "pause-circle" : "play-circle"} className="w-3 h-3"/> 
                                {scenario.deterioration.active ? "Pause Det" : "Resume Det"}
                            </Button>
                            <Button variant="danger" onClick={triggerArrest} className="text-xs h-10">
                                <Lucide icon="alert-triangle" className="w-3 h-3"/> Arrest
                            </Button>
                        </div>

                        <div className="flex space-x-2 mb-4 overflow-x-auto pb-2 border-b border-slate-700 no-scrollbar">
                            {['Airway', 'Circulation', 'Drugs', 'Procedures'].map(cat => (
                                <button 
                                    key={cat} 
                                    onClick={() => setActiveTab(cat)}
                                    className={`px-4 py-2 text-sm font-bold rounded transition-colors whitespace-nowrap ${activeTab === cat ? 'bg-sky-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                >
                                    {cat}
                                </button>
                            ))}
                        </div>

                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4">
                            {getInterventionsByCat(activeTab).map(key => (
                                <Button key={key} variant="secondary" onClick={() => applyIntervention(key)} disabled={!isRunning} className="text-xs h-12 touch-manipulation">
                                    {INTERVENTIONS[key]?.label || key}
                                </Button>
                            ))}
                        </div>

                        <div className="mt-4 pt-4 border-t border-slate-700">
                            <form onSubmit={(e) => { e.preventDefault(); if(manualLog.trim()){ addLogEntry(manualLog, 'manual'); setManualLog(""); } }} className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={manualLog}
                                    onChange={(e) => setManualLog(e.target.value)}
                                    placeholder="Log action..." 
                                    className="flex-grow bg-slate-900 border border-slate-600 rounded px-3 py-3 text-sm focus:outline-none focus:border-sky-500"
                                    disabled={!isRunning}
                                />
                                <Button type="submit" variant="outline" disabled={!isRunning || !manualLog.trim()} className="h-12">Log</Button>
                            </form>
                        </div>
                    </Card>

                    {/* New Dynamic Investigations Section */}
                    <Card title="Investigations" icon="file-search">
                         <div className="grid grid-cols-2 gap-3">
                             <InvestigationButton type="ECG" icon="activity" />
                             <InvestigationButton type="VBG" icon="droplet" />
                             <InvestigationButton type="CXR" icon="image" />
                             <InvestigationButton type="POCUS" icon="wifi" />
                             <InvestigationButton type="CT" icon="layers" />
                         </div>
                    </Card>

                    <Card title="Instructor Notes" icon="clipboard">
                        <form onSubmit={(e) => { e.preventDefault(); if(manualNotes.trim()){ addLogEntry(`Note: ${manualNotes}`, 'note'); setManualNotes(""); } }} className="flex gap-2">
                            <input 
                                type="text" 
                                value={manualNotes}
                                onChange={(e) => setManualNotes(e.target.value)}
                                placeholder="Add note..." 
                                className="flex-grow bg-slate-900 border border-slate-600 rounded px-3 py-3 text-sm focus:outline-none focus:border-purple-500"
                                disabled={!isRunning}
                            />
                            <Button type="submit" variant="secondary" disabled={!isRunning || !manualNotes.trim()} className="h-12">Add</Button>
                        </form>
                    </Card>
                </div>

                <div className="space-y-6 flex flex-col h-full order-2 lg:order-2">
                    
                    <Card className="flex-grow flex flex-col bg-slate-800 h-96 lg:h-auto">
                        <div className="flex items-center gap-2 mb-3 border-b border-slate-700 pb-2">
                            <Lucide icon="list" className="w-5 h-5 text-sky-400" />
                            <h3 className="font-bold text-slate-200">Incident Log</h3>
                        </div>

                        <div className="flex-grow overflow-y-auto space-y-2 pr-2 text-sm font-mono">
                            {log.length === 0 && <p className="text-slate-500 italic text-center mt-10">Simulation ready...</p>}
                            {log.map((l, i) => (
                                <div key={i} className={`p-2 rounded border-l-2 ${l.type === 'success' ? 'bg-emerald-900/20 border-emerald-500' : l.type === 'action' ? 'bg-sky-900/20 border-sky-500' : l.type === 'manual' ? 'bg-purple-900/20 border-purple-500' : l.type === 'note' ? 'bg-yellow-900/20 border-yellow-500' : 'bg-slate-700/30 border-slate-500'}`}>
                                    <span className="text-xs text-slate-500 block">{l.simTime}</span>
                                    <p className="text-slate-200">{l.msg}</p>
                                </div>
                            ))}
                            <div ref={logEndRef} />
                        </div>
                    </Card>
                </div>
            </div>
        );
    };

    const DebriefScreen = ({ sim, onRestart }) => {
        const { log, scenario, history } = sim; 
        const chartRef = useRef(null);

        useEffect(() => {
            if (!chartRef.current || !history.length) return;

            const labels = history.map(h => h.time); 
            
            const hrData = history.map(h => h.hr);
            const bpData = history.map(h => h.bp);
            const spo2Data = history.map(h => h.spo2);
            const rrData = history.map(h => h.rr);

            const chart = new window.Chart(chartRef.current, {
                type: 'line',
                data: {
                    labels: labels.map(t => `${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`),
                    datasets: [
                        { label: 'HR', data: hrData, borderColor: '#ef4444', tension: 0.4 },
                        { label: 'Sys BP', data: bpData, borderColor: '#3b82f6', tension: 0.4 },
                        { label: 'SpO2', data: spo2Data, borderColor: '#10b981', tension: 0.4, yAxisID: 'y1' },
                        { label: 'RR', data: rrData, borderColor: '#a855f7', tension: 0.4, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Vital Signs Trend' },
                        tooltip: {
                            callbacks: {
                                afterBody: (items) => {
                                    const idx = items[0].dataIndex;
                                    const acts = history[idx].actions;
                                    return acts && acts.length ? `Actions: ${acts.join(', ')}` : '';
                                }
                            }
                        },
                        annotation: {
                            annotations: history.reduce((acc, h, i) => {
                                if (h.actions && h.actions.length) {
                                    acc[`act_${i}`] = {
                                        type: 'line',
                                        xMin: i,
                                        xMax: i,
                                        borderColor: 'rgba(255, 165, 0, 0.7)', // Orange color for visibility
                                        borderWidth: 2,
                                        label: {
                                            display: true,
                                            content: h.actions[0], 
                                            position: 'start',
                                            backgroundColor: 'rgba(255, 165, 0, 0.7)',
                                            color: 'white',
                                            font: { size: 10 }
                                        }
                                    };
                                }
                                return acc;
                            }, {})
                        }
                    },
                    scales: {
                        y: { position: 'left', min: 0, title: {display:true, text:'HR / BP', color: '#cbd5e1'} },
                        y1: { position: 'right', min: 0, max: 100, grid: {drawOnChartArea: false}, title: {display:true, text:'SpO2 / RR', color: '#cbd5e1'} },
                        x: { ticks: { color: '#cbd5e1' } }
                    }
                }
            });

            return () => chart.destroy();
        }, [history]);

        const handleExport = () => {
            const doc = new window.jspdf.jsPDF();
            doc.setFontSize(18);
            doc.text(`Simulation Debrief: ${scenario.title}`, 10, 10);
            doc.setFontSize(12);
            doc.text(`Scenario ID: ${scenario.id} | Category: ${scenario.category}`, 10, 20);
            
            let y = 30;
            log.forEach(l => {
                if (y > 280) { doc.addPage(); y = 10; }
                doc.text(`[${l.simTime}] ${l.msg}`, 10, y);
                y += 7;
            });
            doc.save("sim-debrief.pdf");
        };

        return (
            <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-2">
                <div className="flex flex-col md:flex-row justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700 gap-4">
                    <h2 className="text-2xl font-bold text-white">Simulation Debrief</h2>
                    <div className="flex gap-2 w-full md:w-auto">
                        <Button onClick={handleExport} variant="secondary" className="flex-1 md:flex-none h-12"><Lucide icon="download"/> Export PDF</Button>
                        <Button onClick={onRestart} variant="primary" className="flex-1 md:flex-none h-12"><Lucide icon="rotate-ccw"/> New Scenario</Button>
                    </div>
                </div>

                {/* New Graph Section */}
                <Card title="Physiological Trends" icon="activity">
                    <div className="bg-slate-900 p-4 rounded h-80 relative">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </Card>

                <Card title="Learning Objectives" icon="book-open">
                    <ul className="list-disc pl-5 space-y-1 text-slate-300">
                        {scenario.learningObjectives && scenario.learningObjectives.map((o,i) => <li key={i}>{o}</li>)}
                    </ul>
                </Card>

                <Card title="Action Timeline" icon="clock">
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                        {log.map((l, i) => (
                            <div key={i} className="flex gap-4 border-b border-slate-700 pb-2">
                                <span className="font-mono text-sky-400 w-16 flex-shrink-0">{l.simTime}</span>
                                <span className="text-slate-300">{l.msg}</span>
                            </div>
                        ))}
                    </div>
                </Card>
            </div>
        );
    };

    const App = () => {
        const [view, setView] = useState('setup'); 
        const [currentScenario, setCurrentScenario] = useState(null);
        const [lastSetupParams, setLastSetupParams] = useState(null);

        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        }); 

        const regenerateScenario = () => {
            if (!lastSetupParams) return;
            setView('setup_regen'); 
        };

        return (
            <div className="min-h-screen flex flex-col p-2 md:p-6 max-w-7xl mx-auto">
                <header className="flex items-center justify-between mb-8 pb-4 border-b border-slate-800">
                    <div className="flex items-center gap-4">
                        <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" className="h-12 md:h-16 object-contain" />
                        <div>
                            <h1 className="text-xl md:text-3xl font-bold text-sky-400">Sim Generator v6.0</h1>
                            <p className="text-slate-500 text-xs md:text-sm">West Midlands Evidence Based Emergency Medicine</p>
                        </div>
                    </div>
                    <div className="hidden md:block text-right">
                        <p className="text-xs text-slate-600">In-situ Simulation Tool</p>
                        <p className="text-xs text-slate-600">UK Clinical Guidelines</p>
                    </div>
                </header>

                <main className="flex-grow">
                    {view === 'setup' && (
                        <SetupScreen onGenerate={(s, params) => { 
                            setCurrentScenario(s); 
                            setLastSetupParams(params); 
                            setView('briefing'); 
                        }} />
                    )}

                    {view === 'setup_regen' && (
                        <SetupScreen 
                            initialParams={{ ...lastSetupParams, autoGenerate: true }}
                            onGenerate={(s, params) => { 
                                setCurrentScenario(s); 
                                setLastSetupParams(params); 
                                setView('briefing'); 
                            }} 
                        />
                    )}
                    
                    {view === 'briefing' && currentScenario && (
                        <BriefingScreen 
                            scenario={currentScenario} 
                            onStart={() => setView('live')} 
                            onBack={() => setView('setup')}
                            onNewScenario={regenerateScenario}
                        />
                    )}

                    {(view === 'live' || view === 'debrief') && currentScenario && (
                        <LiveSimContainer 
                            scenario={currentScenario} 
                            view={view} 
                            setView={setView} 
                            onRestart={() => { setCurrentScenario(null); setView('setup'); }}
                        />
                    )}
                </main>

                <footer className="mt-12 text-center text-slate-600 text-xs py-4 border-t border-slate-800">
                    <p> {new Date().getFullYear()} WMEBEM (West Midlands Evidence Based Emergency Medicine). All rights reserved.</p>
                    <p className="mt-1">This tool is for educational simulation purposes only and should not be used for live clinical decision making. Content can be used or modified with permission.</p>
                </footer>
            </div>
        );
    };

    const LiveSimContainer = ({ scenario, view, setView, onRestart }) => {
        const sim = useSimulation(scenario);

        if (view === 'live') return <LiveSimScreen sim={sim} onFinish={() => { sim.stop(); setView('debrief'); }} onBack={() => setView('briefing')} />;
        if (view === 'debrief') return <DebriefScreen sim={sim} onRestart={onRestart} />;
        return null;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
