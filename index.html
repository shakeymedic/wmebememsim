<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Sim Generator v13.0 (Expanded DB)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for Exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js Annotation Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .flash-red { animation: flashRed 1.5s ease-in-out infinite; }
        @keyframes flashRed {
            0%, 100% { background-color: rgba(30, 41, 59, 1); } 
            50% { background-color: rgba(127, 29, 29, 0.5); } 
        }
        
        .flash-green { animation: flashGreen 1s ease-in-out; }
        @keyframes flashGreen {
            0%, 100% { border-color: #334155; }
            50% { border-color: #10b981; }
        }
        
        html, body { height: 100%; overflow: hidden; }
        body { background-color: #0f172a; color: #f1f5f9; display: flex; flex-direction: column; }
        #root { height: 100%; display: flex; flex-direction: column; }

        @keyframes loadProgress { from { width: 0%; } to { width: 100%; } }
        .loading-bar {
            position: absolute; bottom: 0; left: 0; height: 100%;
            background-color: rgba(16, 185, 129, 0.2);
            animation: loadProgress 2s linear forwards; z-index: 0;
        }
        
        .pea-warning { animation: pulseText 1s infinite; }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Diamond Debrief Shape CSS */
        .diamond-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .mobile-stack { flex-direction: column; }
            .mobile-h-full { height: 100%; }
            .diamond-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="antialiased selection:bg-sky-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
    
    // --- 1. HELPER FUNCTIONS & DATA ---

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getRandomFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
    const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

    const generateHistory = (age, sex = 'Male') => {
        if (age < 20) return { pmh: ["Nil significant"], dhx: ["Nil"], allergies: ["Nil"] };
        
        const commonPMH = ["Hypertension", "Type 2 Diabetes", "Asthma", "Hyperlipidaemia", "GORD", "Depression", "Anxiety", "Previous MI", "AF", "CKD Stage 3"];
        const femalePMH = ["PCOS", "Endometriosis", "Previous C-Section"];
        const elderlyPMH = ["Dementia", "Osteoporosis", "Parkinson's", "IHD", "CCF"];
        
        let pmh = [];
        let dhx = [];
        
        const pmhCount = age > 70 ? getRandomInt(3, 6) : age > 40 ? getRandomInt(1, 3) : getRandomInt(0, 1);
        
        for(let i=0; i<pmhCount; i++) {
            const source = age > 70 ? [...commonPMH, ...elderlyPMH] : commonPMH;
            const item = getRandomItem(source);
            if(!pmh.includes(item)) pmh.push(item);
        }
        
        if (sex === 'Female' && Math.random() > 0.8) pmh.push(getRandomItem(femalePMH));

        if (pmh.includes("Hypertension")) dhx.push("Ramipril 5mg OD");
        if (pmh.includes("Type 2 Diabetes")) dhx.push("Metformin 1g BD");
        if (pmh.includes("Asthma")) dhx.push("Salbutamol PRN", "Beclometasone BD");
        if (pmh.includes("Hyperlipidaemia")) dhx.push("Atorvastatin 20mg ON");
        if (pmh.includes("GORD")) dhx.push("Omeprazole 20mg OD");
        if (pmh.includes("AF")) dhx.push("Bisoprolol 2.5mg OD", "Edoxaban 60mg OD");
        if (pmh.includes("Previous MI")) dhx.push("Aspirin 75mg OD", "Atorvastatin 80mg ON", "Bisoprolol 2.5mg OD");
        if (pmh.includes("Osteoporosis")) dhx.push("Alendronic Acid");

        if (pmh.length === 0) pmh.push("Nil significant");
        if (dhx.length === 0) dhx.push("Nil regular medications");

        return {
            pmh: pmh,
            dhx: dhx,
            allergies: [Math.random() > 0.8 ? getRandomItem(["Penicillin", "Latex", "NSAIDs", "Trimethoprim"]) : "NKDA"]
        };
    };

    const getBaseVitals = (age) => {
        let v = { hr: 75, rr: 16, bpSys: 120, bpDia: 75, temp: 36.8, bm: 5.8, gcs: 15, pupils: '3mm' }; 
        if (age < 1) v = { hr: 145, rr: 45, bpSys: 75, bpDia: 45, temp: 37.0, bm: 4.5, gcs: 15, pupils: '3mm' }; 
        else if (age <= 2) v = { hr: 125, rr: 30, bpSys: 90, bpDia: 55, temp: 37.0, bm: 5.0, gcs: 15, pupils: '3mm' }; 
        else if (age <= 5) v = { hr: 110, rr: 25, bpSys: 95, bpDia: 60, temp: 37.0, bm: 5.0, gcs: 15, pupils: '3mm' }; 
        else if (age <= 12) v = { hr: 90, rr: 20, bpSys: 105, bpDia: 65, temp: 36.8, bm: 5.5, gcs: 15, pupils: '4mm' }; 
        else if (age > 75) v = { hr: 70, rr: 18, bpSys: 140, bpDia: 75, temp: 36.4, bm: 6.0, gcs: 15, pupils: '3mm' }; // Elderly baseline
        return v;
    };

    const estimateWeight = (age) => {
        if (age === 0) return 3.5; 
        if (age < 1) return 6; 
        if (age >= 1 && age <= 10) return (age + 4) * 2; 
        if (age > 10) return (age * 3) + 7; 
        return 70; 
    };

    const generateVbg = (clinicalState = "normal") => {
        let vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.0, K: 4.0, Glu: 5.5 };
        vbg.pH += getRandomFloat(-0.03, 0.03, 2);
        switch (clinicalState) {
            case "dka_severe": vbg = { pH: 6.95, pCO2: 2.5, HCO3: 5, BE: -24, Lac: 2.5, K: 5.4, Glu: 28.0 }; break;
            case "septic_shock": vbg = { pH: 7.25, pCO2: 4.5, HCO3: 16, BE: -8, Lac: 6.5, K: 4.2, Glu: 4.0 }; break;
            case "haemorrhagic_shock": vbg = { pH: 7.20, pCO2: 4.8, HCO3: 14, BE: -10, Lac: 8.0, K: 3.8, Glu: 9.0 }; break;
            case "copd_retainer": vbg = { pH: 7.30, pCO2: 9.5, HCO3: 34, BE: 8, Lac: 1.2, K: 4.0, Glu: 6.0 }; break;
            case "respiratory_acidosis_acute": vbg = { pH: 7.15, pCO2: 9.5, HCO3: 24, BE: 0, Lac: 1.5, K: 4.1, Glu: 6.2 }; break;
            case "metabolic_acidosis_severe": vbg = { pH: 6.90, pCO2: 6.0, HCO3: 10, BE: -22, Lac: 12.0, K: 6.5, Glu: 6.0 }; break;
            case "metabolic_alkalosis": vbg = { pH: 7.50, pCO2: 5.8, HCO3: 30, BE: 6, Lac: 1.0, K: 3.0, Glu: 5.5 }; break;
            case "hyperkalemia": vbg = { pH: 7.35, pCO2: 5.0, HCO3: 22, BE: -2, Lac: 1.5, K: 7.5, Glu: 6.0 }; break;
            case "hyponatremia": vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.2, K: 4.0, Na: 115, Glu: 5.5 }; break;
            case "gi_bleed": vbg = { pH: 7.32, pCO2: 4.8, HCO3: 20, BE: -4, Lac: 3.5, K: 4.1, Glu: 6.5 }; break; 
            default: break;
        }
        return vbg;
    };

    const HUMAN_FACTOR_CHALLENGES = [
      { id: 'hf0', type: 'Standard Simulation', description: 'Manage effectively.' },
      { id: 'hf1', type: 'Blindfolded Lead', description: 'Leader blindfolded. Tests closed-loop comms.' },
      { id: 'hf2', type: 'Silent Team', description: 'Only leader speaks.' },
      { id: 'hf3', type: 'New Junior', description: 'Junior member needs explicit instructions.' },
      { id: 'hf4', type: 'Missing Kit', description: 'Crucial equipment missing.' },
      { id: 'hf5', type: 'Distracted Senior', description: 'Consultant on phone, dismissive.' },
    ];

    // INTERVENTIONS
    const INTERVENTIONS = {
        // COMMON
        'Obs': { label: 'Apply Monitoring', effect: {}, category: 'Common', log: 'Full monitoring applied.', type: 'continuous', duration: 10 },
        'Oxygen': { label: 'High Flow O2', effect: { SpO2: 10 }, category: 'Common', log: 'High flow oxygen applied (15L NRB).', type: 'continuous', duration: 5 },
        'IV Access': { label: 'IV/IO Access', effect: {}, category: 'Common', log: 'IV/IO access secured.', type: 'continuous', duration: 30 },
        'Fluids': { label: 'Fluid Bolus', effect: { BP: 8, HR: -3 }, category: 'Common', log: 'Fluid bolus given.', type: 'bolus', duration: 60 },
        'Analgesia': { label: 'Morphine 5mg', effect: { HR: -5, RR: -3, BP: -2 }, category: 'Common', log: 'IV Morphine 5mg administered.', type: 'bolus', duration: 10 },
        'Fentanyl': { label: 'Fentanyl 50mcg', effect: { HR: -2, RR: -3, BP: -2 }, category: 'Common', log: 'IV Fentanyl 50mcg administered.', type: 'bolus', duration: 10 },
        'Antiemetic': { label: 'Ondansetron 4mg', effect: {}, category: 'Common', log: 'IV Ondansetron 4mg administered.', type: 'bolus', duration: 10 },
        
        // AIRWAY & BREATHING
        'Manoeuvres': { label: 'Head Tilt / Jaw Thrust', effect: { SpO2: 5 }, category: 'Airway', log: 'Airway manoeuvres applied.', type: 'continuous', duration: 5 },
        'OPA': { label: 'Guedel / OPA', effect: { SpO2: 5 }, category: 'Airway', log: 'Oropharyngeal airway inserted.', type: 'continuous', duration: 10 },
        'NPA': { label: 'Nasopharyngeal', effect: { SpO2: 5 }, category: 'Airway', log: 'Nasopharyngeal airway inserted.', type: 'continuous', duration: 15 },
        'i-gel': { label: 'i-gel / LMA', effect: { SpO2: 15, RR: 'vent' }, category: 'Airway', log: 'Supraglottic airway (i-gel) inserted.', type: 'continuous', duration: 30 },
        'Bagging': { label: 'Bag-Valve-Mask', effect: { SpO2: 25, RR: 'vent' }, category: 'Airway', log: 'Manual ventilation (BVM) started.', type: 'continuous', duration: 5 },
        'Nebs': { label: 'Nebs (Salb/Iprat)', effect: { HR: 10, RR: -3, SpO2: 5 }, category: 'Airway', log: 'Nebulisers (Salb/Iprat) running.', type: 'bolus', duration: 300 },
        'Needle': { label: 'Needle Decompression', effect: { SpO2: 20, BP: 15, RR: -8 }, category: 'Airway', log: 'Needle thoracocentesis performed.', type: 'bolus', duration: 30 },
        'CPAP': { label: 'CPAP', effect: { SpO2: 10, RR: -5, BP: -5 }, category: 'Airway', log: 'CPAP initiated.', type: 'continuous', duration: 60 },
        'NIV': { label: 'NIV (BiPAP)', effect: { SpO2: 12, RR: -5, BP: -5 }, category: 'Airway', log: 'NIV (BiPAP) initiated.', type: 'continuous', duration: 60 },
        'NebAdrenaline': { label: 'Neb Adrenaline', effect: { HR: 10, RR: -5, SpO2: 5 }, category: 'Airway', log: 'Nebulised Adrenaline (5mg) administered.', type: 'bolus', duration: 300 },
        'Dexamethasone': { label: 'Dexamethasone', effect: { RR: -2 }, category: 'Drugs', log: 'PO/IV Dexamethasone administered.', type: 'bolus', duration: 10 },

        // RSI & INTUBATION
        'RSI': { label: 'Perform RSI', effect: { SpO2: 99, RR: 'vent', BP: -15, gcs: 'sedated' }, category: 'Airway', log: 'Rapid Sequence Induction performed. Patient intubated.', type: 'continuous', duration: 120 },
        'Ketamine': { label: 'Ketamine (Induction)', effect: { gcs: -5, BP: 5, HR: 5 }, category: 'Drugs', log: 'IV Ketamine administered.', type: 'bolus', duration: 15 },
        'Roc': { label: 'Rocuronium', effect: { RR: 0, paralysed: true }, category: 'Drugs', log: 'IV Rocuronium administered.', type: 'bolus', duration: 10 },
        'Sux': { label: 'Suxamethonium', effect: { RR: 0, paralysed: true }, category: 'Drugs', log: 'IV Suxamethonium administered.', type: 'bolus', duration: 10 },
        'Propofol': { label: 'Propofol', effect: { gcs: -5, BP: -10, RR: -5 }, category: 'Drugs', log: 'IV Propofol administered.', type: 'bolus', duration: 10 },

        // CIRCULATION & TRAUMA
        'Blood': { label: 'Blood (O Neg)', effect: { BP: 12, HR: -5 }, category: 'Circulation', log: '1 Unit O-Negative Blood initiated.', type: 'bolus', duration: 300 },
        'FFP': { label: 'FFP (Octaplas)', effect: { BP: 5 }, category: 'Circulation', log: 'FFP initiated.', type: 'bolus', duration: 300 },
        'Platelets': { label: 'Platelets', effect: {}, category: 'Circulation', log: 'Pool of Platelets initiated.', type: 'bolus', duration: 300 },
        'TXA': { label: 'TXA 1g', effect: {}, category: 'Circulation', log: 'IV Tranexamic Acid 1g administered.', type: 'bolus', duration: 60 },
        'Binder': { label: 'Pelvic Binder', effect: { BP: 8 }, category: 'Circulation', log: 'Pelvic binder applied.', type: 'continuous', duration: 60 },
        'Splinting': { label: 'Splint Limb', effect: { HR: -2 }, category: 'Circulation', log: 'Limb splinted.', type: 'continuous', duration: 120 },
        'Reduction': { label: 'Reduce Fracture', effect: { HR: -5, BP: -2 }, category: 'Procedures', log: 'Fracture reduction performed.', type: 'bolus', duration: 60 },
        'Plaster': { label: 'Apply Backslab', effect: {}, category: 'Procedures', log: 'Backslab/Plaster applied.', type: 'continuous', duration: 300 },
        'Collar': { label: 'C-Spine Collar', effect: {}, category: 'Procedures', log: 'C-spine collar applied.', type: 'continuous', duration: 30 },

        // CARDIAC DRUGS
        'Adrenaline': { label: 'Adrenaline 1:1000', effect: { HR: 20, BP: 15 }, category: 'Drugs', log: 'IM Adrenaline 500mcg administered.', type: 'bolus', duration: 5 },
        'AdrenalineIV': { label: 'Adrenaline 1:10,000', effect: { changeRhythm: 'chance' }, category: 'Drugs', log: 'IV Adrenaline 1mg administered.', type: 'bolus', duration: 5 },
        'Amiodarone': { label: 'Amiodarone 300mg', effect: { changeRhythm: 'chance' }, category: 'Drugs', log: 'IV Amiodarone 300mg administered.', type: 'bolus', duration: 60 },
        'Antibiotics': { label: 'Antibiotics (IV)', effect: { BP: 5 }, category: 'Drugs', log: 'IV Antibiotics administered.', type: 'bolus', duration: 20 },
        'Atropine': { label: 'Atropine 600mcg', effect: { HR: 20 }, category: 'Drugs', log: 'IV Atropine 600mcg administered.', type: 'bolus', duration: 10 },
        'Adenosine': { label: 'Adenosine', effect: { HR: 'reset' }, category: 'Drugs', log: 'IV Adenosine rapid bolus administered.', type: 'bolus', duration: 2 },
        'Aspirin': { label: 'Aspirin 300mg', effect: {}, category: 'Drugs', log: 'Aspirin 300mg PO administered.', type: 'bolus', duration: 10 },
        'GTN': { label: 'GTN Spray', effect: { BP: -8 }, category: 'Drugs', log: 'GTN Spray sublingual administered.', type: 'bolus', duration: 5 },
        'GTNInfusion': { label: 'GTN Infusion', effect: { BP: -20 }, category: 'Drugs', log: 'GTN Infusion started (5ml/hr).', type: 'continuous', duration: 300 },
        'Furosemide': { label: 'Furosemide 40mg', effect: { BP: -5 }, category: 'Drugs', log: 'IV Furosemide 40mg administered.', type: 'bolus', duration: 30 },
        'Clopidogrel': { label: 'Clopidogrel 300mg', effect: {}, category: 'Drugs', log: 'Clopidogrel 300mg PO administered.', type: 'bolus', duration: 10 },
        'Metaraminol': { label: 'Metaraminol', effect: { BP: 15 }, category: 'Drugs', log: 'IV Metaraminol bolus administered.', type: 'bolus', duration: 10 },
        'Midazolam': { label: 'Midazolam', effect: { gcs: -2, HR: -5 }, category: 'Drugs', log: 'Buccal/IV Midazolam administered.', type: 'bolus', duration: 15 },
        'Lorazepam': { label: 'Lorazepam', effect: { gcs: -3, HR: -5 }, category: 'Drugs', log: 'IV Lorazepam administered.', type: 'bolus', duration: 15 },
        'Pabrinex': { label: 'Pabrinex', effect: {}, category: 'Drugs', log: 'IV Pabrinex pair administered.', type: 'bolus', duration: 10 },
        'Naloxone': { label: 'Naloxone', effect: { RR: 10, gcs: 5 }, category: 'Drugs', log: 'IV Naloxone 400mcg administered.', type: 'bolus', duration: 5 },
        'ActivatedCharcoal': { label: 'Activated Charcoal', effect: {}, category: 'Drugs', log: 'Activated Charcoal administered.', type: 'bolus', duration: 10 },
        
        // OBSTETRICS & GYNAE
        'Oxytocin': { label: 'Oxytocin 10u', effect: { BP: -5 }, category: 'Obs/Gynae', log: 'IM Oxytocin 10u administered.', type: 'bolus', duration: 10 },
        'Ergometrine': { label: 'Ergometrine 500mcg', effect: { BP: 15 }, category: 'Obs/Gynae', log: 'IM Ergometrine 500mcg administered.', type: 'bolus', duration: 10 },
        'Carboprost': { label: 'Carboprost 250mcg', effect: { BP: 5 }, category: 'Obs/Gynae', log: 'IM Carboprost 250mcg administered.', type: 'bolus', duration: 10 },
        'Misoprostol': { label: 'Misoprostol 800mcg', effect: {}, category: 'Obs/Gynae', log: 'PR Misoprostol 800mcg administered.', type: 'bolus', duration: 30 },
        'Labetalol': { label: 'Labetalol 50mg', effect: { BP: -15, HR: -5 }, category: 'Obs/Gynae', log: 'IV Labetalol 50mg administered.', type: 'bolus', duration: 15 },
        'MagSulph': { label: 'Magnesium Sulph 4g', effect: { BP: -5, RR: -2 }, category: 'Obs/Gynae', log: 'IV Magnesium Sulphate 4g loading dose.', type: 'bolus', duration: 600 },
        'AntiD': { label: 'Anti-D Ig', effect: {}, category: 'Obs/Gynae', log: 'IM Anti-D administered.', type: 'bolus', duration: 10 },

        // PROCEDURES
        'Defib': { label: 'Defibrillation', effect: { changeRhythm: 'defib' }, category: 'Procedures', log: 'Shock Delivered.', type: 'bolus', duration: 5 },
        'Pacing': { label: 'External Pacing', effect: { HR: 'pace' }, category: 'Procedures', log: 'External Pacing initiated @ 80bpm.', type: 'continuous', duration: 10 },
        'Cardioversion': { label: 'Sync Cardioversion', effect: { changeRhythm: 'sync' }, category: 'Procedures', log: 'Synchronised DC Shock delivered.', type: 'bolus', duration: 5 },
        'Lucas': { label: 'Lucas/AutoPulse', effect: { BP: 30 }, category: 'Procedures', log: 'Mechanical Chest Compression device applied.', type: 'continuous', duration: 30 },
        'CPR': { label: 'Manual CPR', effect: {}, category: 'Procedures', log: 'CPR in progress (30:2).', type: 'continuous', duration: 5 },
        'Surgery': { label: 'Surgical Consult', effect: {}, category: 'Procedures', log: 'Surgeons contacted urgently.', type: 'bolus', duration: 30 },
        'Delivery': { label: 'Emergency Delivery', effect: {}, category: 'Obs/Gynae', log: 'Preparation for emergency delivery.', type: 'continuous', duration: 300 },
        'SurgicalDrain': { label: 'Chest Drain (Surgical)', effect: { SpO2: 15, BP: 10, RR: -5 }, category: 'Procedures', log: 'Surgical chest drain inserted.', type: 'continuous', duration: 600 },
        'SeldingerDrain': { label: 'Chest Drain (Seldinger)', effect: { SpO2: 15, BP: 10, RR: -5 }, category: 'Procedures', log: 'Seldinger chest drain inserted.', type: 'continuous', duration: 450 },
        'FingerThoracostomy': { label: 'Finger Thoracostomy', effect: { SpO2: 20, BP: 15, RR: -8 }, category: 'Procedures', log: 'Finger thoracostomy performed.', type: 'bolus', duration: 30 },
        'Pericardiocentesis': { label: 'Pericardiocentesis', effect: { BP: 20, HR: -10 }, category: 'Procedures', log: 'Pericardiocentesis performed.', type: 'bolus', duration: 30 },
    };
    
    // === SCENARIO DATABASE ---
    const ALL_SCENARIOS = [
      // ADULT - MEDICAL
      { id: 'AM001', title: 'Acute STEMI', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(45, 75), patientProfileTemplate: "A {age}-year-old {sex}. Crushing chest pain > 1 hr.", presentingComplaint: 'Chest Pain', instructorBrief: { progression: "Classic STEMI. Risk of VF.", interventions: ["PPCI", "Aspirin", "Ticagrelor/Clopidogrel", "Heparin"], learningObjectives: ["Identify STEMI", "Manage ACS"] }, vitalsMod: { hr: 95, bpSys: 145, spO2: 96 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, ecg: { type: "STEMI", findings: "Anterior ST Elevation" } },
      { id: 'AM002', title: 'Severe Sepsis (Pneumonia)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(60, 90), patientProfileTemplate: "A {age}-year-old. Productive cough, confusion, fever.", presentingComplaint: 'Confusion & Fever', instructorBrief: { progression: "Septic shock. Needs Sepsis 6.", interventions: ["Oxygen", "Fluids", "Antibiotics"], learningObjectives: ["Sepsis 6", "Fluid Resus"] }, vitalsMod: { hr: 125, bpSys: 85, spO2: 88, temp: 39.2 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, ecg: { type: "Sinus Tachy", findings: "Sinus Tachycardia" } },
      { id: 'AM003', title: 'Acute Severe Asthma', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 40), patientProfileTemplate: "A {age}-year-old asthmatic. Short of breath.", presentingComplaint: 'Dyspnoea', instructorBrief: { progression: "Life threatening. Silent chest.", interventions: ["Nebs", "Magnesium", "Steroids"], learningObjectives: ["Asthma Management"] }, vitalsMod: { hr: 130, bpSys: 110, spO2: 88, rr: 35 }, deterioration: { active: true, rate: 0.08, type: 'respiratory' }, stabilisers: ['Nebs', 'Magnesium'], ecg: { type: "Sinus Tachy", findings: "Sinus Tachycardia" } },
      { id: 'AM004', title: 'Hyperkalaemia (Renal)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "A {age}-year-old dialysis patient. Missed dialysis.", presentingComplaint: 'Weakness', instructorBrief: { progression: "Broad complex bradycardia. Risk of arrest.", interventions: ["Calcium Gluconate", "Insulin/Dextrose"], learningObjectives: ["Hyperkalaemia treatment"] }, vitalsMod: { hr: 40, bpSys: 90, spO2: 95 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, ecg: { type: "Sinus Rhythm", findings: "Broad complex, Tented T waves" }, vbgClinicalState: "hyperkalemia" },
      { id: 'AM005', title: 'Tricyclic Overdose', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Found with empty Amitriptyline packet.", presentingComplaint: 'Overdose', instructorBrief: { progression: "Anticholinergic toxidrome. Na channel blockade.", interventions: ["Sodium Bicarbonate", "Intubation"], learningObjectives: ["TCA Toxicity", "ECG changes"] }, vitalsMod: { hr: 130, bpSys: 90, spO2: 96, gcs: 10 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, ecg: { type: "Sinus Tachy", findings: "Wide QRS, Dominant R in aVR" } },
      { id: 'AM006', title: 'Opioid Overdose', category: 'Toxicology', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Found unresponsive. Pinpoint pupils.", presentingComplaint: 'Unresponsive', instructorBrief: { progression: "Respiratory depression.", interventions: ["Naloxone", "Ventilatory Support"], learningObjectives: ["Opioid Toxidrome", "Naloxone dosing"] }, vitalsMod: { hr: 60, bpSys: 100, spO2: 85, rr: 4, gcs: 6 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Naloxone', 'Bagging'], ecg: { type: "Sinus Rhythm", findings: "NSR" } },
      { id: 'AM007', title: 'Paracetamol Overdose', category: 'Toxicology', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(18, 40), patientProfileTemplate: "A {age}-year-old. Took 30g Paracetamol 4 hours ago.", presentingComplaint: 'Overdose', instructorBrief: { progression: "Asymptomatic phase but high risk.", interventions: ["NAC", "Blood Levels"], learningObjectives: ["Paracetamol nomogram", "NAC indications"] }, vitalsMod: { hr: 80, bpSys: 120, spO2: 98, gcs: 15 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Rhythm", findings: "NSR" } },
      { id: 'AM008', title: 'Acute Alcohol Withdrawal', category: 'Psychiatric', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old alcoholic. Stopped drinking 2 days ago.", presentingComplaint: 'Tremors & Hallucinations', instructorBrief: { progression: "Delirium Tremens. Seizure risk.", interventions: ["Benzodiazepines", "Pabrinex"], learningObjectives: ["CIWA scoring", "Safe sedation"] }, vitalsMod: { hr: 130, bpSys: 160, spO2: 96, temp: 38.0 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, ecg: { type: "Sinus Tachy", findings: "Sinus Tachycardia" } },
      { id: 'AM009', title: 'Psychiatric Emergency (Manic)', category: 'Psychiatric', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Aggressive, flight of ideas.", presentingComplaint: 'Aggression', instructorBrief: { progression: "Risk of violence. Rapid Tranquillisation required.", interventions: ["De-escalation", "Lorazepam/Haloperidol"], learningObjectives: ["Rapid Tranq guidelines", "Mental Capacity Act"] }, vitalsMod: { hr: 110, bpSys: 140, spO2: 99 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Tachy", findings: "NSR" } },
      
      // ADULT - TRAUMA
      { id: 'AT001', title: 'Major Trauma (RTC)', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old driver. High speed RTC. Trapped 30 mins.", presentingComplaint: 'Polytrauma', instructorBrief: { progression: "Haemorrhagic shock. Pelvic/Chest injuries.", interventions: ["Binder", "TXA", "Blood"], learningObjectives: ["Major Trauma Call", "Permissive Hypotension"] }, vitalsMod: { hr: 130, bpSys: 80, spO2: 92, rr: 30, gcs: 13 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Blood', 'Binder'], vbgClinicalState: "haemorrhagic_shock" },
      { id: 'AT002', title: 'Stab Wound Chest', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 35), patientProfileTemplate: "A {age}-year-old male. Stabbed in right chest.", presentingComplaint: 'Stab Wound', instructorBrief: { progression: "Tension Pneumothorax.", interventions: ["Decompression", "Drain"], learningObjectives: ["Chest decompression"] }, vitalsMod: { hr: 140, bpSys: 70, spO2: 80, rr: 40 }, deterioration: { active: true, rate: 0.2, type: 'arrest' }, stabilisers: ['Needle', 'FingerThoracostomy', 'SurgicalDrain'], chestXray: { findings: "Tension Pneumothorax" } },
      { id: 'AT003', title: 'Isolated Head Injury', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 60), patientProfileTemplate: "A {age}-year-old. Fell down stairs. GCS dropped.", presentingComplaint: 'Head Injury', instructorBrief: { progression: "Extradural haematoma. Cushing's response.", interventions: ["RSI", "Neuroprotective measures", "CT Head"], learningObjectives: ["Raised ICP management", "Cushing's Triad"] }, vitalsMod: { hr: 50, bpSys: 180, spO2: 96, gcs: 8, pupils: 'Fixed/Dilated R' }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, ecg: { type: "Sinus Brady", findings: "Sinus Bradycardia" } },
      { id: 'AT004', title: 'Burns (Thermal)', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. House fire. 40% TBSA burns.", presentingComplaint: 'Burns', instructorBrief: { progression: "Airway oedema risk. Fluid loss.", interventions: ["Intubation (Early)", "Parkland Fluid"], learningObjectives: ["Burn airway assessment", "Fluid calculation"] }, vitalsMod: { hr: 120, bpSys: 100, spO2: 90, rr: 28, gcs: 15 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Fluids', 'RSI'] },
      
      // ELDERLY
      { id: 'EL001', title: 'NOF Fracture', category: 'Trauma', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(75, 95), patientProfileTemplate: "A {age}-year-old. Fall from standing. Shortened/Rotated leg.", presentingComplaint: 'Hip Pain', instructorBrief: { progression: "Pain management critical. Check for medical cause of fall.", interventions: ["Fascia Iliaca Block", "Analgesia"], learningObjectives: ["NOF management", "Frailty assessment"] }, vitalsMod: { hr: 90, bpSys: 150, spO2: 95 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Rhythm", findings: "NSR or AF" } },
      { id: 'EL002', title: 'Elderly Sepsis (UTI)', category: 'Medical', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(80, 99), patientProfileTemplate: "A {age}-year-old. Confusion and off legs.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Urosepsis. Subtle presentation.", interventions: ["Antibiotics", "Fluids (Caution)"], learningObjectives: ["Sepsis in elderly", "Delirium"] }, vitalsMod: { hr: 105, bpSys: 100, spO2: 93, temp: 35.8, gcs: 13 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, vbgClinicalState: "septic_shock" },
      { id: 'EL003', title: 'Subdural Haemorrhage', category: 'Trauma', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(75, 90), patientProfileTemplate: "A {age}-year-old. Minor head bump 2 weeks ago. Now confused.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Chronic Subdural. Slow deterioration.", interventions: ["CT Head", "Reverse Anticoagulation"], learningObjectives: ["Head injury in elderly", "Anticoagulation reversal"] }, vitalsMod: { hr: 70, bpSys: 130, spO2: 96, gcs: 12 }, deterioration: { active: true, rate: 0.05, type: 'neuro' } },

      // PAEDIATRIC - MEDICAL
      { id: 'PA001', title: 'Meningococcal Sepsis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 5), patientProfileTemplate: "A {age}-year-old. High fever, purpuric rash.", presentingComplaint: 'Fever & Rash', instructorBrief: { progression: "Septic shock. Rapid decline.", interventions: ["IM/IV Ceftriaxone", "Fluids", "IO Access"], learningObjectives: ["Paeds Sepsis", "IO Access"] }, vitalsMod: { hr: 160, bpSys: 70, spO2: 92, temp: 39.5, rr: 45 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Antibiotics', 'Fluids'], vbgClinicalState: "septic_shock" },
      { id: 'PA002', title: 'Severe Croup', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 3), patientProfileTemplate: "A {age}-year-old. Barking cough, stridor.", presentingComplaint: 'Stridor', instructorBrief: { progression: "Upper airway obstruction. Keep calm.", interventions: ["Neb Adrenaline", "Dexamethasone"], learningObjectives: ["Croup scoring", "Neb Adrenaline indications"] }, vitalsMod: { hr: 150, bpSys: 95, spO2: 93, rr: 50 }, deterioration: { active: true, rate: 0.08, type: 'respiratory' }, stabilisers: ['NebAdrenaline', 'Dexamethasone'] },
      { id: 'PA003', title: 'Status Epilepticus', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(2, 10), patientProfileTemplate: "A {age}-year-old. Seizing > 10 mins.", presentingComplaint: 'Seizure', instructorBrief: { progression: "Prolonged seizure. Hypoxia risk.", interventions: ["Midazolam/Lorazepam", "RSI"], learningObjectives: ["APLS Seizure Algorithm"] }, vitalsMod: { hr: 140, bpSys: 100, spO2: 88, rr: 10, gcs: 3 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Midazolam', 'Lorazepam', 'RSI'] },
      { id: 'PA004', title: 'Anaphylaxis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(4, 12), patientProfileTemplate: "A {age}-year-old. Nut allergy. Swollen lips, wheeze.", presentingComplaint: 'Anaphylaxis', instructorBrief: { progression: "Airway compromise.", interventions: ["IM Adrenaline", "Nebs", "Fluids"], learningObjectives: ["Paeds Anaphylaxis"] }, vitalsMod: { hr: 155, bpSys: 80, spO2: 91, rr: 35 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Adrenaline', 'Nebs'] },
      { id: 'PA005', title: 'Bronchiolitis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => 0, patientProfileTemplate: "A 4-month-old. 3 days coryza. Breathless.", presentingComplaint: 'DIB', instructorBrief: { progression: "Resp failure. Apnoeas.", interventions: ["High Flow/CPAP", "Suction"], learningObjectives: ["Bronchiolitis escalation"] }, vitalsMod: { hr: 170, bpSys: 80, spO2: 86, rr: 65 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Oxygen', 'CPAP', 'NIV'] },
      { id: 'PA006', title: 'Paediatric DKA', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(6, 16), patientProfileTemplate: "A {age}-year-old. New onset polyuria/polydipsia. Vomiting.", presentingComplaint: 'Vomiting & Lethargy', instructorBrief: { progression: "Severe Acidosis. Cerebral Edema risk.", interventions: ["Slow Fluids", "Insulin (Delay)"], learningObjectives: ["Paeds DKA Fluids", "Cerebral Edema"] }, vitalsMod: { hr: 130, bpSys: 95, spO2: 98, rr: 30, bm: 28 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, vbgClinicalState: "dka_severe" },
      { id: 'PA007', title: 'SVT', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(0, 12), patientProfileTemplate: "A {age}-year-old. Pale, irritable. HR > 220.", presentingComplaint: 'Palpitations/Poor Feeding', instructorBrief: { progression: "Stable vs Unstable SVT.", interventions: ["Vagal Manoeuvres", "Adenosine", "Cardioversion"], learningObjectives: ["Paeds SVT management"] }, vitalsMod: { hr: 240, bpSys: 85, spO2: 95 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, ecg: { type: "SVT", findings: "Narrow Complex Tachycardia > 220bpm" } },
      
      // PAEDIATRIC - TRAUMA
      { id: 'PT001', title: 'NAI (Non-Accidental)', category: 'Trauma', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(0, 2), patientProfileTemplate: "A {age}-year-old. 'Fell off sofa'. Bruising to ears/neck.", presentingComplaint: 'Injury', instructorBrief: { progression: "Safeguarding concern. Thorough survey needed.", interventions: ["Skeletal Survey", "Social Services"], learningObjectives: ["Recognising NAI", "Safeguarding"] }, vitalsMod: { hr: 110, bpSys: 90, spO2: 99 }, deterioration: { active: false, rate: 0 } },
      { id: 'PT002', title: 'Paediatric Head Injury', category: 'Trauma', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(2, 8), patientProfileTemplate: "A {age}-year-old. Fall 2m onto concrete. Vomiting.", presentingComplaint: 'Head Injury', instructorBrief: { progression: "Intracranial bleed.", interventions: ["CT Head", "Neuroobs", "RSI"], learningObjectives: ["PECARN Rules", "Paeds Head Injury"] }, vitalsMod: { hr: 90, bpSys: 110, spO2: 98, gcs: 13 }, deterioration: { active: true, rate: 0.1, type: 'neuro' } },
      
      // CARDIAC ARREST (ALL)
      { id: 'CA001', title: 'Adult VF Arrest', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "Adult Male. Collapsed. Witnessed.", presentingComplaint: 'Cardiac Arrest', instructorBrief: { progression: "VF Arrest.", interventions: ["CPR", "Shock", "Adrenaline", "Amiodarone"], learningObjectives: ["ALS Algorithm"] }, vitalsMod: { hr: 0, bpSys: 0, spO2: 0, gcs: 3 }, deterioration: { active: false, rate: 0 }, ecg: { type: "VF", findings: "VF" } },
      { id: 'CA002', title: 'Paediatric PEA Arrest', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 8), patientProfileTemplate: "Child. Found unresponsive in bed.", presentingComplaint: 'Cardiac Arrest', instructorBrief: { progression: "PEA Arrest. Hypoxia likely cause.", interventions: ["CPR", "Airway", "Adrenaline"], learningObjectives: ["APLS Arrest", "4Hs 4Ts"] }, vitalsMod: { hr: 40, bpSys: 0, spO2: 0, gcs: 3 }, deterioration: { active: false, rate: 0 }, ecg: { type: "PEA", findings: "Slow electrical activity, no pulse" } },
      
      // OBSTETRICS
      { id: 'OB001', title: 'Cord Prolapse', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "38 weeks pregnant. Waters broke. Loop of cord visible.", presentingComplaint: 'Cord Prolapse', instructorBrief: { progression: "Fetal hypoxia. Obstetric emergency.", interventions: ["Elevate presenting part", "Emergency C-Section"], learningObjectives: ["Cord prolapse management"] }, vitalsMod: { hr: 100, bpSys: 120, spO2: 99 }, deterioration: { active: false, rate: 0 } },
      { id: 'OB002', title: 'Shoulder Dystocia', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "In labour. Head delivered, body stuck.", presentingComplaint: 'Stuck Baby', instructorBrief: { progression: "Turtle sign. Fetal compromise.", interventions: ["McRoberts", "Suprapubic Pressure"], learningObjectives: ["HELPERR Mnemonic"] }, vitalsMod: { hr: 110, bpSys: 130, spO2: 98 }, deterioration: { active: false, rate: 0 } }
    ];

    // --- 2. COMPONENTS ---

    const { useState, useEffect, useRef, useReducer } = React;
    
    // OPTIMIZED: Wrapped in React.memo
    const Lucide = React.memo(({ icon, className }) => {
        useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [icon]); 
        return <i data-lucide={icon} className={className}></i>;
    });

    const Button = ({ onClick, children, variant = 'primary', className = '', disabled = false, progress = 0 }) => {
        let variants = {
            primary: "bg-sky-600 hover:bg-sky-500 text-white",
            secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
            danger: "bg-red-600 hover:bg-red-500 text-white",
            success: "bg-emerald-600 hover:bg-emerald-500 text-white",
            warning: "bg-amber-500 hover:bg-amber-600 text-white",
            outline: "border border-slate-600 text-slate-300 hover:bg-slate-800"
        };
        let base = "px-4 py-3 rounded font-semibold transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm relative overflow-hidden touch-manipulation z-0";
        if (className.includes("h-16")) { base += " text-xl px-8"; } 
        else if (className.includes("h-14")) { base += " text-lg px-4"; } 
        else { base += " text-xs"; }

        return (
            <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>
                {progress > 0 && (
                    <div className="absolute top-0 left-0 bottom-0 bg-emerald-500/50 z-[-1] transition-all duration-1000 ease-linear" style={{ width: `${progress}%` }}></div>
                )}
                <span className="relative z-10 flex items-center gap-2 whitespace-nowrap w-full justify-center">{children}</span>
            </button>
        );
    };

    const Card = ({ title, icon, children, className = "", collapsible = false, defaultOpen = true }) => {
        const [isOpen, setIsOpen] = useState(defaultOpen);
        return (
            <div className={`bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-lg flex flex-col ${className}`}>
                {title && (
                    <div 
                        className={`bg-slate-800/50 p-3 border-b border-slate-700 flex items-center justify-between flex-shrink-0 ${collapsible ? 'cursor-pointer hover:bg-slate-700/50 transition-colors' : ''}`}
                        onClick={() => collapsible && setIsOpen(!isOpen)}
                    >
                        <div className="flex items-center gap-2">
                            {icon && <Lucide icon={icon} className="w-5 h-5 text-sky-400" />}
                            <h3 className="font-bold text-slate-200">{title}</h3>
                        </div>
                        {collapsible && (
                            <Lucide icon="chevron-down" className={`w-4 h-4 text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                        )}
                    </div>
                )}
                {(!collapsible || isOpen) && (
                    <div className="p-4 animate-fadeIn flex-grow overflow-auto min-h-0">{children}</div>
                )}
            </div>
        );
    };
    
    // Improved VitalDisplay to include robust trend indication (30s)
    const VitalDisplay = ({ label, value, value2, history, unit, lowIsBad = true, onUpdate, alert, isText = false }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editVal, setEditVal] = useState(value);
        useEffect(() => { if (!isEditing) setEditVal(value); }, [value, isEditing]);
        const handleBlur = () => { setIsEditing(false); if (editVal !== value) onUpdate(isText ? editVal : parseFloat(editVal)); };

        const isBP = label === "BP";
        
        // Trend Logic: Compare current vs ~30 seconds ago (index 10 in buffer, as buffer pushes every 3s)
        // history is array of {hr, bp, spo2...}
        let trend = 'flat';
        if (history && history.length > 10 && !isText && value !== '?') {
            const oldVal = label === "Heart Rate" ? history[history.length - 10].hr : 
                           label === "BP" ? history[history.length - 10].bp :
                           label === "SpO2" ? history[history.length - 10].spo2 : 
                           label === "RR" ? history[history.length - 10].rr : value;
                           
            if (value > oldVal + (isBP ? 5 : 2)) trend = 'up';
            else if (value < oldVal - (isBP ? 5 : 2)) trend = 'down';
        }

        return (
            <div className={`bg-slate-900/50 p-2 md:p-3 rounded border flex flex-col items-center justify-center h-24 md:h-28 relative touch-manipulation transition-colors duration-300 ${alert ? 'border-red-500 bg-red-900/20' : 'border-slate-700'}`}>
                <span className="text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">{label}</span>
                {isEditing ? (
                    <input type={isText ? "text" : "number"} value={editVal} onChange={(e) => setEditVal(e.target.value)} onBlur={handleBlur} onKeyDown={(e) => e.key === 'Enter' && handleBlur()} className="text-xl md:text-2xl font-mono font-bold text-white bg-slate-800 border border-slate-500 rounded w-full text-center" autoFocus />
                ) : (
                    <div className="flex items-baseline gap-1 cursor-pointer hover:bg-slate-800/50 rounded px-2 py-1" onClick={() => { setEditVal(value); setIsEditing(true); }}>
                        <span className={`font-mono font-bold text-white ${isText ? 'text-lg md:text-xl' : 'text-2xl md:text-3xl'}`}>
                            {value === '?' ? '--' : (isText ? value : Math.round(value * 10) / 10)}
                            {isBP && value2 !== undefined && `/${Math.round(value2)}`}
                        </span>
                        {!isText && !isBP && value !== '?' && (
                            <span className={`text-xs md:text-sm font-bold ${trend === 'flat' ? 'text-slate-500' : (lowIsBad ? (trend === 'up' ? 'text-emerald-400' : 'text-red-400') : (trend === 'up' ? 'text-red-400' : 'text-emerald-400'))}`}>
                                {trend === 'up' ? '▲' : trend === 'down' ? '▼' : '▬'}
                            </span>
                        )}
                    </div>
                )}
                <span className="text-[9px] md:text-[10px] text-slate-600 mt-1">{unit}</span>
            </div>
        );
    };

    // Paediatric Calculator Component
    const PaedsCalculator = ({ weight, age }) => {
        if (!weight) return null;
        const w = parseFloat(weight);
        return (
            <Card title="WETFAG Calculator" icon="calculator" collapsible={true} className="mb-4 border-pink-500/50">
                <div className="grid grid-cols-2 gap-2 text-xs">
                    <div className="bg-slate-900/50 p-2 rounded"><span className="text-slate-500 block">Weight</span><span className="text-lg font-bold text-pink-400">{w} kg</span></div>
                    <div className="bg-slate-900/50 p-2 rounded"><span className="text-slate-500 block">Energy (4J/kg)</span><span className="text-lg font-bold text-yellow-400">{Math.round(w * 4)} J</span></div>
                    <div className="bg-slate-900/50 p-2 rounded"><span className="text-slate-500 block">Tube (Uncuffed)</span><span className="text-lg font-bold text-sky-400">{(age/4)+4} mm</span></div>
                    <div className="bg-slate-900/50 p-2 rounded"><span className="text-slate-500 block">Fluid (10ml/kg)</span><span className="text-lg font-bold text-blue-400">{Math.round(w * 10)} ml</span></div>
                    <div className="bg-slate-900/50 p-2 rounded"><span className="text-slate-500 block">Adrenaline (10mcg/kg)</span><span className="text-lg font-bold text-purple-400">{Math.round(w * 0.1 * 100)/100} ml (1:10k)</span></div>
                    <div className="bg-slate-900/50 p-2 rounded"><span className="text-slate-500 block">Glucose 10% (2ml/kg)</span><span className="text-lg font-bold text-white">{Math.round(w * 2)} ml</span></div>
                </div>
            </Card>
        );
    };

    const ECGMonitor = ({ rhythmType, hr, isPaused, showEtco2, rr, pathology }) => {
        const canvasRef = useRef(null);
        const requestRef = useRef(null);
        
        // --- PERSISTENT STATE ---
        const drawState = useRef({
            x: 0, lastY: 50, beatProgress: 0, breathProgress: 0, lastTime: 0, lastYCO2: 0 
        });

        const propsRef = useRef({ rhythmType, hr, rr, showEtco2, pathology, isPaused });

        useEffect(() => {
            propsRef.current = { rhythmType, hr, rr, showEtco2, pathology, isPaused };
        }, [rhythmType, hr, rr, showEtco2, pathology, isPaused]);

        const getWaveform = (type, t) => {
            const noise = (Math.random() - 0.5) * 2;
            if (type === 'Asystole' || type === 'PEA') return 50 + noise; // PEA is electrical activity but functionally asystole on line if disconnected, or complex if not. Let's treat simple PEA as rhythm but we usually check pulse. For simple graphic, keep it simple. Actually PEA should show rhythm but user must check pulse.
            if (type === 'VF') { return 50 + Math.sin(t * 20) * 15 + Math.sin(t * 7) * 25 + noise * 2; }
            if (type === 'VT') {
                let y = 50; if (t < 0.2) y += Math.sin(t * 5 * Math.PI) * 40; else if (t < 0.6) y -= Math.sin((t-0.2) * 2.5 * Math.PI) * 40; return y + noise;
            }
            if (type === 'AF') {
                let y = 50; 
                if (t > 0.4 && t < 0.44) y -= 40;
                else if (t >= 0.44 && t < 0.46) y += 10;
                y += Math.sin(t * 50) * 2;
                return y + noise;
            }
            if (type === 'STEMI') {
                let y = 50; if (t < 0.15) y -= Math.sin(t / 0.15 * Math.PI) * 3; else if (t >= 0.15 && t < 0.20) y -= 2; else if (t >= 0.20 && t < 0.24) y -= 45; else if (t >= 0.24 && t < 0.26) y += 10; else if (t >= 0.26 && t < 0.55) { y -= 10; y -= Math.sin((t-0.26)/0.29 * Math.PI) * 8; } return y + noise;
            }
            if (type === 'SVT') {
                 let y = 50; if (t < 0.1) y -= Math.sin(t/0.1 * Math.PI) * 3; else if (t > 0.12 && t < 0.14) y += 2; else if (t >= 0.14 && t < 0.18) y -= 40; else if (t >= 0.18 && t < 0.20) y += 8; return y + noise;
            }
            // Normal / Sinus Tachy
            let y = 50; if (t < 0.1) y -= Math.sin(t/0.1 * Math.PI) * 3; else if (t > 0.12 && t < 0.14) y += 2; else if (t >= 0.14 && t < 0.18) y -= 40; else if (t >= 0.18 && t < 0.20) y += 8; else if (t > 0.3 && t < 0.5) y -= Math.sin((t-0.3)/0.2 * Math.PI) * 6; return y + noise;
        };

        const getEtco2Wave = (t, pathology, rr, rhythm) => {
            if (rr <= 0) return 0; 
            
            const isCardiacArrest = ['VF', 'VT', 'Asystole', 'PEA'].includes(rhythm);
            const baseAmplitude = isCardiacArrest ? 0.3 : 1.0; 

            if (t < 0.1 || t > 0.6) return 0; 
            
            if (t >= 0.1 && t < 0.15) {
                return ((t - 0.1) / 0.05) * baseAmplitude;
            }
            
            if (t >= 0.15 && t < 0.5) {
                const plateauBase = 1.0;
                const plateauEnd = 0.9;
                const p = (t - 0.15) / 0.35;
                
                if (pathology === 'respiratory') {
                    return (0.5 + (p * 0.5)) * baseAmplitude; 
                }
                return (plateauBase - (p * (plateauBase - plateauEnd))) * baseAmplitude;
            }
            
            if (t >= 0.5 && t <= 0.6) {
                const startVal = (pathology === 'respiratory' ? 1.0 : 0.9);
                const p = (t - 0.5) / 0.1;
                return (startVal * (1 - p)) * baseAmplitude;
            }
            return 0;
        };

        useEffect(() => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            
            const setSize = () => {
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                drawState.current.lastYCO2 = canvas.height - 2;
                ctx.fillStyle = '#000000';
                ctx.fillRect(0,0, canvas.width, canvas.height);
            };
            setSize();
            window.addEventListener('resize', setSize);

            const animate = (timestamp) => {
                const state = drawState.current;
                const props = propsRef.current;
                
                if (!state.lastTime) state.lastTime = timestamp;
                const dt = (timestamp - state.lastTime) / 1000;
                state.lastTime = timestamp;

                if (props.isPaused) {
                    requestRef.current = requestAnimationFrame(animate);
                    return;
                }

                let currentRhythm = props.rhythmType || 'Sinus Rhythm'; 
                let currentRate = props.hr || 60;
                
                if (currentRhythm === 'AF' && state.beatProgress >= 1) { 
                    currentRate = props.hr + (Math.random() * 60 - 30); 
                }
                let beatDuration = 60 / Math.max(10, currentRate);
                if (currentRhythm === 'VF' || currentRhythm === 'SVT') beatDuration = 60/Math.max(150, currentRate); // Fast rhythms

                const ecgSpeed = 150; 
                const dx = ecgSpeed * dt;
                const prevX = state.x;
                state.x += dx;

                if (state.x > canvas.width) {
                    state.x = 0;
                    state.lastY = getWaveform(currentRhythm, state.beatProgress);
                    state.lastYCO2 = canvas.height - 2;
                }

                const eraserWidth = 20;
                if (state.x + eraserWidth < canvas.width) {
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(state.x, 0, eraserWidth + 5, canvas.height); 
                } else {
                     ctx.fillStyle = '#000000';
                     ctx.fillRect(state.x, 0, canvas.width - state.x, canvas.height);
                     ctx.fillRect(0, 0, eraserWidth, canvas.height);
                }

                state.beatProgress += dt / beatDuration;
                if (state.beatProgress >= 1) state.beatProgress = 0;

                const yECG = getWaveform(currentRhythm, state.beatProgress);
                
                if (state.x > prevX) {
                    ctx.strokeStyle = '#00ff00'; 
                    ctx.lineWidth = 2; 
                    ctx.lineJoin = 'round';
                    ctx.beginPath();
                    ctx.moveTo(prevX, state.lastY);
                    ctx.lineTo(state.x, yECG);
                    ctx.stroke();
                }
                state.lastY = yECG;

                if (props.showEtco2) {
                    let breathDuration = 60 / (Math.max(1, props.rr) || 12);
                    state.breathProgress += dt / breathDuration;
                    if (state.breathProgress >= 1) state.breathProgress = 0;

                    const normalizedHeight = getEtco2Wave(state.breathProgress, props.pathology, props.rr, currentRhythm);
                    const co2MaxHeight = 35; 
                    const co2BaseY = canvas.height - 2; 
                    const yCO2 = co2BaseY - (normalizedHeight * co2MaxHeight);

                    if (state.x > prevX) {
                         ctx.fillStyle = 'rgba(250, 204, 21, 0.4)'; 
                         ctx.beginPath();
                         ctx.moveTo(prevX, state.lastYCO2);
                         ctx.lineTo(state.x, yCO2);
                         ctx.lineTo(state.x, co2BaseY);
                         ctx.lineTo(prevX, co2BaseY);
                         ctx.fill();

                         ctx.strokeStyle = '#facc15'; 
                         ctx.lineWidth = 2;
                         ctx.beginPath();
                         ctx.moveTo(prevX, state.lastYCO2);
                         ctx.lineTo(state.x, yCO2);
                         ctx.stroke();
                    }
                    state.lastYCO2 = yCO2;
                }

                requestRef.current = requestAnimationFrame(animate);
            };

            requestRef.current = requestAnimationFrame(animate);
            return () => {
                window.removeEventListener('resize', setSize);
                cancelAnimationFrame(requestRef.current);
            };
        }, []); 

        return (
            <div className="w-full h-32 bg-black rounded border border-slate-700 relative overflow-hidden">
                <canvas ref={canvasRef} className="block w-full h-full"></canvas>
                <div className="absolute top-1 right-2 text-xs font-mono text-green-500 font-bold">{rhythmType}</div>
                {showEtco2 && <div className="absolute bottom-1 right-2 text-xs font-mono text-yellow-500 font-bold">ETCO2</div>}
            </div>
        );
    };

    const InvestigationButton = ({ type, icon, label, isRevealed, isLoading, revealInvestigation, isRunning, scenario }) => {
        const hasData = (type === 'ECG' && scenario.ecg) || (type === 'X-ray' && scenario.chestXray) || (type === 'POCUS' && scenario.ultrasound) || (type === 'VBG' && scenario.vbg) || (type === 'CT' && scenario.ct) || (type === 'Urine' && scenario.urine);
        return (
            <div className="flex flex-col gap-2">
                <Button variant={isRevealed ? "secondary" : "outline"} onClick={() => revealInvestigation(type)} disabled={!isRunning || isRevealed || isLoading} className="h-10 text-xs relative overflow-hidden">
                    {isLoading && <div className="loading-bar"></div>}
                    <div className="relative z-10 flex items-center gap-2"><Lucide icon={icon} className="w-3 h-3"/> {isLoading ? `Requesting...` : (isRevealed ? `View ${type}` : `Request ${type}`)}</div>
                </Button>
                {isRevealed && (
                    <div className="p-3 bg-slate-700/30 rounded text-xs border-l-2 border-sky-500 animate-fadeIn">
                        {hasData ? (
                            type === 'VBG' ? <div className="font-mono space-y-1"><div>pH: {scenario.vbg.pH.toFixed(2)}</div><div>pCO2: {scenario.vbg.pCO2} kPa</div><div>pO2: 12.0 kPa</div><div>HCO3: {scenario.vbg.HCO3}</div><div>BE: {scenario.vbg.BE}</div><div>Lac: {scenario.vbg.Lac}</div><div>K+: {scenario.vbg.K}</div><div className="font-bold text-sky-400">Glu: {scenario.vbg.Glu} mmol/L</div></div> : 
                            type === 'ECG' ? <div><p className="mb-1 font-bold">{scenario.ecg.findings}</p><p className="italic text-slate-400">See monitor for rhythm.</p></div> : 
                            type === 'X-ray' ? <div className="text-slate-200">{scenario.chestXray.findings}</div> : 
                            type === 'POCUS' ? <div className="text-slate-200">{scenario.ultrasound.findings}</div> : 
                            type === 'Urine' ? <div className="text-slate-200 font-mono">{scenario.urine.findings}</div> :
                            type === 'CT' ? <div className="text-slate-200">{scenario.ct.findings}</div> : 'Normal / Not Indicated'
                        ) : 'Normal / Not Indicated'}
                    </div>
                )}
            </div>
        );
    };

    // --- 3. REDUCER & SIMULATION ENGINE ---
    
    const initialState = {
        scenario: null,
        time: 0,
        isRunning: false,
        vitals: {},
        prevVitals: {},
        rhythm: "Sinus Rhythm", 
        log: [],
        flash: null,
        history: [],
        investigationsRevealed: {},
        loadingInvestigations: {},
        activeInterventions: new Set(),
        interventionCounts: {},
        activeDurations: {},
        processedEvents: new Set(),
        isMuted: false,
        etco2Enabled: false,
        isParalysed: false,
        queuedRhythm: null,
        metronomeActive: false,
    };

    const simReducer = (state, action) => {
        switch (action.type) {
            case 'START_SIM':
                return { ...state, isRunning: true, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: '00:00', msg: "Simulation Started", type: 'system' }] };
            case 'PAUSE_SIM':
                return { ...state, isRunning: false, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: `${Math.floor(state.time/60)}:${(state.time%60).toString().padStart(2,'0')}`, msg: "Simulation Paused", type: 'system' }] };
            case 'LOAD_SCENARIO':
                const initialRhythm = (action.payload.ecg && action.payload.ecg.type) ? action.payload.ecg.type : "Sinus Rhythm";
                return { ...initialState, scenario: action.payload, vitals: {...action.payload.vitals}, prevVitals: {...action.payload.vitals}, rhythm: initialRhythm, processedEvents: new Set(), activeInterventions: new Set() };
            case 'RESTORE_SESSION':
                const restored = action.payload;
                return { ...restored, activeInterventions: new Set(restored.activeInterventions || []), processedEvents: new Set(restored.processedEvents || []), isRunning: false };
            case 'TICK_TIME':
                const newDurations = { ...state.activeDurations };
                let durChanged = false;
                Object.keys(newDurations).forEach(key => {
                    const elapsed = state.time + 1 - newDurations[key].startTime;
                    if (elapsed >= newDurations[key].duration) { delete newDurations[key]; durChanged = true; }
                });
                return { ...state, time: state.time + 1, activeDurations: durChanged ? newDurations : state.activeDurations };
            case 'UPDATE_VITALS': 
                const newHist = [...state.history, { time: state.time, hr: action.payload.hr, bp: action.payload.bpSys, spo2: action.payload.spO2, rr: action.payload.rr, actions: [] }];
                // Keep history size reasonable
                if (newHist.length > 60) newHist.shift();
                return { ...state, vitals: action.payload, history: newHist };
            case 'UPDATE_RHYTHM': return { ...state, rhythm: action.payload };
            case 'ADD_LOG':
                const timestamp = new Date().toLocaleTimeString('en-GB');
                const simTime = `${Math.floor(state.time/60).toString().padStart(2,'0')}:${(state.time%60).toString().padStart(2,'0')}`;
                const entry = { time: timestamp, simTime, msg: action.payload.msg, type: action.payload.type, timeSeconds: state.time };
                return { ...state, log: [...state.log, entry] };
            case 'SET_FLASH': return { ...state, flash: action.payload };
            case 'START_INTERVENTION_TIMER': return { ...state, activeDurations: { ...state.activeDurations, [action.payload.key]: { startTime: state.time, duration: action.payload.duration } } };
            case 'UPDATE_INTERVENTION_STATE': return { ...state, activeInterventions: action.payload.active, interventionCounts: action.payload.counts };
            case 'SET_PARALYSIS': return { ...state, isParalysed: action.payload };
            case 'REVEAL_INVESTIGATION': return { ...state, investigationsRevealed: { ...state.investigationsRevealed, [action.payload]: true }, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: false } };
            case 'SET_LOADING_INVESTIGATION': return { ...state, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: true } };
            case 'SET_MUTED': return { ...state, isMuted: action.payload };
            case 'TOGGLE_ETCO2': return { ...state, etco2Enabled: !state.etco2Enabled };
            case 'SET_QUEUED_RHYTHM': return { ...state, queuedRhythm: action.payload };
            case 'FAST_FORWARD': return { ...state, time: state.time + action.payload };
            case 'MANUAL_VITAL_UPDATE': return { ...state, vitals: { ...state.vitals, [action.payload.key]: action.payload.value }, prevVitals: { ...state.vitals } };
            case 'UPDATE_SCENARIO': return { ...state, scenario: action.payload };
            case 'TOGGLE_METRONOME': return { ...state, metronomeActive: !state.metronomeActive };
            case 'MARK_EVENT_PROCESSED': const newEvents = new Set(state.processedEvents); newEvents.add(action.payload); return { ...state, processedEvents: newEvents };
            default: return state;
        }
    };

    const useSimulation = (initialScenario) => {
        const [state, dispatch] = useReducer(simReducer, initialState);
        const timerRef = useRef(null);
        const tickRef = useRef(null);
        const audioCtxRef = useRef(null);
        const stateRef = useRef(state);
        const metronomeRef = useRef(null);
        
        useEffect(() => { stateRef.current = state; }, [state]);
        
        useEffect(() => {
            if (state.scenario && state.log.length > 0) {
                const serializableState = { ...state, activeInterventions: Array.from(state.activeInterventions), processedEvents: Array.from(state.processedEvents) };
                localStorage.setItem('wmebem_sim_state', JSON.stringify(serializableState));
            }
        }, [state.vitals, state.log]);

        useEffect(() => { if (!audioCtxRef.current) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtxRef.current = new AudioContext(); } }, []);

        // Monitor Audio (Beeps)
        useEffect(() => {
            let timerId;
            if (state.isRunning && state.vitals.hr > 0 && state.rhythm !== 'VF' && state.rhythm !== 'Asystole') {
                const ctx = audioCtxRef.current;
                if (ctx.state === 'suspended') ctx.resume();
                const playBeep = () => {
                    if (state.isMuted) { timerId = setTimeout(playBeep, 60000 / (state.vitals.hr || 60)); return; }
                    const osc = ctx.createOscillator(); const gain = ctx.createGain();
                    osc.type = 'sine';
                    const freq = state.vitals.spO2 >= 95 ? 880 : state.vitals.spO2 >= 85 ? 600 : 400;
                    osc.frequency.value = freq;
                    osc.connect(gain); gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now + 0.01); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15); 
                    osc.start(now); osc.stop(now + 0.2);
                    timerId = setTimeout(playBeep, 60000 / (Math.max(20, state.vitals.hr) || 60));
                };
                playBeep();
            }
            return () => clearTimeout(timerId);
        }, [state.isRunning, state.isMuted, state.vitals.hr, state.vitals.spO2, state.rhythm]);

        // Metronome Audio
        useEffect(() => {
            if (state.metronomeActive && state.isRunning) {
                const ctx = audioCtxRef.current;
                if (ctx.state === 'suspended') ctx.resume();
                const bpm = 110;
                const interval = 60000 / bpm;
                
                const playClick = () => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = 800;
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                };
                
                metronomeRef.current = setInterval(playClick, interval);
            } else {
                if (metronomeRef.current) clearInterval(metronomeRef.current);
            }
            return () => { if (metronomeRef.current) clearInterval(metronomeRef.current); };
        }, [state.metronomeActive, state.isRunning]);

        const addLogEntry = (msg, type = 'info') => dispatch({ type: 'ADD_LOG', payload: { msg, type } });

        const applyIntervention = (key) => {
            const action = INTERVENTIONS[key];
            if (!action) return;
            
            const newVitals = { ...state.vitals };
            let newActive = new Set(state.activeInterventions);
            let newCounts = { ...state.interventionCounts };
            
            if (action.duration && !state.activeDurations[key]) {
                dispatch({ type: 'START_INTERVENTION_TIMER', payload: { key, duration: action.duration } });
            }

            if (action.type === 'continuous') {
                if (newActive.has(key)) { newActive.delete(key); addLogEntry(`${key} removed/stopped.`, 'action'); } 
                else { newActive.add(key); addLogEntry(action.log, 'action'); }
            } else {
                newCounts[key] = (newCounts[key] || 0) + 1;
                addLogEntry(action.log, 'action');
            }
            dispatch({ type: 'UPDATE_INTERVENTION_STATE', payload: { active: newActive, counts: newCounts } });

            // Effects
            if (action.effect.changeRhythm === 'defib' && (state.rhythm === 'VF' || state.rhythm === 'VT')) {
                // Defib logic now relies on queued rhythm if set, else chance
                if (state.queuedRhythm) {
                    dispatch({ type: 'UPDATE_RHYTHM', payload: state.queuedRhythm });
                    if (state.queuedRhythm === 'Sinus Rhythm') triggerROSC();
                    else addLogEntry(`Rhythm changed to ${state.queuedRhythm}`, 'manual');
                    dispatch({ type: 'SET_QUEUED_RHYTHM', payload: null });
                } else if (Math.random() < 0.6) {
                     addLogEntry('Defib: No change in rhythm.', 'warning');
                } else {
                     dispatch({ type: 'UPDATE_RHYTHM', payload: 'Asystole' });
                     addLogEntry('Rhythm changed to Asystole', 'warning');
                }
            }

            if (key === 'Roc' || key === 'Sux') dispatch({ type: 'SET_PARALYSIS', payload: true });
            
            // Drugs Logic
            const isArrest = state.vitals.bpSys < 10 && (state.rhythm === 'VF' || state.rhythm === 'VT' || state.rhythm === 'Asystole');
            if (!isArrest) {
                if (action.effect.HR) { 
                    if (action.effect.HR === 'reset') newVitals.hr = 80; 
                    else newVitals.hr = clamp(newVitals.hr + action.effect.HR, 0, 250); 
                }
                if (action.effect.BP) newVitals.bpSys = clamp(newVitals.bpSys + action.effect.BP, 0, 300);
                if (action.effect.RR && action.effect.RR !== 'vent') newVitals.rr = clamp(newVitals.rr + action.effect.RR, 0, 60);
            }
            if (action.effect.SpO2) newVitals.spO2 = clamp(newVitals.spO2 + action.effect.SpO2, 0, 100);
            if (action.effect.gcs) newVitals.gcs = clamp(newVitals.gcs + action.effect.gcs, 3, 15);

            // Scenario stabilisers
            if (state.scenario.stabilisers && state.scenario.stabilisers.includes(key)) {
                dispatch({ type: 'UPDATE_SCENARIO', payload: { ...state.scenario, deterioration: { ...state.scenario.deterioration, rate: Math.max(0, state.scenario.deterioration.rate - 0.05) } } });
                dispatch({ type: 'SET_FLASH', payload: 'green' });
            }

            dispatch({ type: 'UPDATE_VITALS', payload: newVitals });
        };

        const manualUpdateVital = (key, value) => { dispatch({ type: 'MANUAL_VITAL_UPDATE', payload: { key, value } }); addLogEntry(`Manual: ${key} -> ${value}`, 'manual'); };
        
        const triggerArrest = () => { 
            dispatch({ type: 'UPDATE_VITALS', payload: { ...state.vitals, hr: 0, bpSys: 0, bpDia: 0, spO2: 0, rr: 0, gcs: 3, pupils: 'Dilated' } }); 
            dispatch({ type: 'UPDATE_RHYTHM', payload: 'VF' }); 
            addLogEntry('CARDIAC ARREST - VF', 'manual'); 
            dispatch({ type: 'SET_FLASH', payload: 'red' }); 
        };
        
        const triggerROSC = () => { 
            dispatch({ type: 'UPDATE_VITALS', payload: { ...state.vitals, hr: 90, bpSys: 110, bpDia: 70, spO2: 96, rr: 16, gcs: 6, pupils: '3mm' } }); 
            dispatch({ type: 'UPDATE_RHYTHM', payload: 'Sinus Rhythm' }); 
            // Disable deterioration to prevent immediate re-arrest unless instructor re-enables
            const updatedScenario = { ...state.scenario, deterioration: { ...state.scenario.deterioration, active: false } };
            dispatch({ type: 'UPDATE_SCENARIO', payload: updatedScenario });
            addLogEntry('ROSC achieved. Deterioration paused.', 'success'); 
            dispatch({ type: 'SET_FLASH', payload: 'green' }); 
        };
        
        const revealInvestigation = (type) => { if (state.investigationsRevealed[type] || state.loadingInvestigations[type]) return; dispatch({ type: 'SET_LOADING_INVESTIGATION', payload: type }); setTimeout(() => { dispatch({ type: 'REVEAL_INVESTIGATION', payload: type }); addLogEntry(`${type} Result Available`, 'success'); }, 2000); };
        
        const nextCycle = () => {
            dispatch({ type: 'FAST_FORWARD', payload: 120 });
            addLogEntry('Fast Forward: +2 Minutes (Next Cycle)', 'system');
            if (state.queuedRhythm) {
                dispatch({ type: 'UPDATE_RHYTHM', payload: state.queuedRhythm });
                if (state.queuedRhythm === 'Sinus Rhythm') triggerROSC();
                else addLogEntry(`Rhythm Check: Changed to ${state.queuedRhythm}`, 'manual');
                dispatch({ type: 'SET_QUEUED_RHYTHM', payload: null });
            }
        };

        const tick = () => {
            const current = stateRef.current;
            let next = { ...current.vitals };
            
            // ARREST LOGIC: HR 0 -> ARREST
            if (next.hr <= 0 && current.rhythm !== 'Asystole' && current.rhythm !== 'VF' && current.rhythm !== 'VT' && current.rhythm !== 'PEA') {
                dispatch({ type: 'UPDATE_RHYTHM', payload: 'Asystole' });
                addLogEntry("Cardiac Arrest Detected (HR 0). Rhythm: Asystole.", 'danger');
                dispatch({ type: 'SET_FLASH', payload: 'red' });
                next.hr = 0;
            }

            if (current.rhythm === 'Asystole' || current.rhythm === 'VF') { 
                next.hr = 0; next.bpSys = 0; next.bpDia = 0; 
                next.spO2 = Math.max(0, next.spO2 - 2); 
            } else {
                next.hr += getRandomInt(-1, 1); 
                next.bpSys += getRandomInt(-2, 2); 
                next.bpDia += getRandomInt(-2, 2); 
                next.spO2 += Math.random() > 0.9 ? getRandomInt(-1, 1) : 0;
            }

            if (current.activeInterventions.has('Bagging') || current.activeInterventions.has('RSI') || current.activeInterventions.has('i-gel')) {
                next.rr = 12; // Controlled ventilation
                if (current.rhythm !== 'Asystole' && current.rhythm !== 'VF') next.spO2 = Math.min(100, next.spO2 + 2);
            } else if (current.isParalysed) {
                next.rr = 0; // Paralysed and not ventilated
                next.spO2 -= 5; // Hypoxia
            }

            if (current.scenario?.deterioration?.active && current.scenario.deterioration.rate > 0 && current.rhythm !== 'VF' && current.rhythm !== 'Asystole') {
                if (Math.random() < current.scenario.deterioration.rate) {
                    if (current.scenario.deterioration.type === 'shock') { next.bpSys -= 2; next.hr += 1; }
                    else if (current.scenario.deterioration.type === 'neuro') { 
                        // Cushing's: Widening pulse pressure (Sys up, Dia stable/up slightly), Bradycardia, Irregular RR
                        next.bpSys += 2; 
                        next.bpDia += 0.5; 
                        next.hr = Math.max(40, next.hr - 1); 
                    }
                    else if (current.scenario.deterioration.type === 'respiratory') { next.spO2 -= 1; next.rr += 1; }
                    else if (current.scenario.deterioration.type === 'cardiac') { next.bpSys -= 2; }
                }
            }

            // Safety Checks: Clamp to realistic values to prevent "ludicrous" obs
            next.hr = clamp(next.hr, 0, 250);
            next.bpSys = clamp(next.bpSys, 0, 300);
            next.bpDia = clamp(next.bpDia, 0, 250);
            next.rr = clamp(next.rr, 0, 60);
            next.spO2 = clamp(next.spO2, 0, 100);
            next.temp = clamp(next.temp, 32, 43);
            next.bm = clamp(next.bm, 1, 40);
            
            dispatch({ type: 'UPDATE_VITALS', payload: next });
        };

        const start = () => { 
            if (state.isRunning) return; 
            dispatch({ type: 'START_SIM' }); 
            timerRef.current = setInterval(() => dispatch({ type: 'TICK_TIME' }), 1000); 
            tickRef.current = setInterval(tick, 3000); 
            if (audioCtxRef.current && audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume(); 
        };
        
        const pause = () => { dispatch({ type: 'PAUSE_SIM' }); clearInterval(timerRef.current); clearInterval(tickRef.current); };
        const stop = () => { pause(); addLogEntry("Simulation Ended", 'system'); localStorage.removeItem('wmebem_sim_state'); };

        return { state, dispatch, start, pause, stop, applyIntervention, addLogEntry, manualUpdateVital, triggerArrest, triggerROSC, revealInvestigation, nextCycle };
    };

    // --- UI SCREENS ---

    const SetupScreen = ({ onGenerate, initialParams, savedState, onResume }) => {
        const [category, setCategory] = useState(initialParams?.category || 'Any');
        const [age, setAge] = useState(initialParams?.age || 'Any');
        const [hf, setHf] = useState(initialParams?.hf || 'hf0');
        const [acuity, setAcuity] = useState('Any'); 
        const [loading, setLoading] = useState(false);
        const [customMode, setCustomMode] = useState(initialParams?.customMode || false);
        const [error, setError] = useState("");
        const [customScenario, setCustomScenario] = useState({ title: "Custom Case", age: 40, complaint: "Unwell", profile: "History...", hr: 80, bpSys: 120, rr: 16, spO2: 98, temp: 37.0, gcs: 15, bm: 5.5, ecgType: "Sinus Rhythm", ecgFindings: "NSR", cxrFindings: "Normal", urineFindings: "Clear", ctFindings: "Normal" });

        // NEW: Load preset scenario into custom fields
        const loadPreset = (id) => {
            if (!id) return;
            const preset = ALL_SCENARIOS.find(s => s.id === id);
            if (preset) {
                const age = preset.ageGenerator();
                const vitals = preset.vitalsMod || getBaseVitals(age);
                setCustomScenario({
                    title: preset.title,
                    age: age,
                    complaint: preset.presentingComplaint,
                    profile: preset.patientProfileTemplate.replace('{age}', age).replace('{sex}', 'Male'),
                    hr: vitals.hr,
                    bpSys: vitals.bpSys,
                    rr: vitals.rr,
                    spO2: vitals.spO2,
                    temp: vitals.temp || 36.8,
                    gcs: vitals.gcs || 15,
                    bm: vitals.bm || 5.5,
                    ecgType: preset.ecg ? preset.ecg.type : "Sinus Rhythm",
                    ecgFindings: preset.ecg ? preset.ecg.findings : "NSR",
                    cxrFindings: preset.chestXray ? preset.chestXray.findings : "Normal",
                    urineFindings: preset.urine ? preset.urine.findings : "Clear",
                    ctFindings: preset.ct ? preset.ct.findings : "Normal"
                });
            }
        };

        const handleGenerate = () => {
            setError(""); setLoading(true);
            setTimeout(() => {
                let generatedScenario;
                if (customMode) {
                    const history = generateHistory(customScenario.age);
                    generatedScenario = { id: 'CUSTOM', title: customScenario.title, category: 'Custom', ageRange: 'Custom', patientAge: customScenario.age, profile: customScenario.profile, presentingComplaint: customScenario.complaint, scenarioDetails: ['Custom scenario.'], instructorBrief: { progression: "Custom.", interventions: [], equipment: "Standard", debriefPoints: [] }, recommendedActions: [], vitals: { hr: parseInt(customScenario.hr), bpSys: parseInt(customScenario.bpSys), bpDia: Math.floor(parseInt(customScenario.bpSys) * 0.65), rr: parseInt(customScenario.rr), spO2: parseInt(customScenario.spO2), temp: parseFloat(customScenario.temp), gcs: parseInt(customScenario.gcs), bm: parseFloat(customScenario.bm), pupils: '3mm' }, vbg: generateVbg("normal"), hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf), ecg: { type: customScenario.ecgType, findings: customScenario.ecgFindings }, chestXray: { findings: customScenario.cxrFindings }, deterioration: { active: false, rate: 0 }, stabilisers: [], interventions: [], pmh: history.pmh, dhx: history.dhx, allergies: history.allergies, urine: { findings: customScenario.urineFindings }, ct: { findings: customScenario.ctFindings } };
                } else {
                    let pool = ALL_SCENARIOS.filter(s => (category === 'Any' || s.category === category) && (age === 'Any' || s.ageRange === age) && (acuity === 'Any' || s.acuity === acuity));
                    if (pool.length === 0) { setLoading(false); setError(`No scenarios found for ${category} + ${age} + ${acuity}.`); return; }
                    const base = pool[Math.floor(Math.random() * pool.length)];
                    const patientAge = base.ageGenerator();
                    const ranges = getBaseVitals(patientAge);
                    const history = generateHistory(patientAge, base.category === 'Obstetrics & Gynae' ? 'Female' : 'Male');
                    let startVitals = { hr: base.vitalsMod?.hr || ranges.hr, bpSys: base.vitalsMod?.bpSys || ranges.bpSys, bpDia: base.vitalsMod?.bpDia || ranges.bpDia || Math.floor((base.vitalsMod?.bpSys || ranges.bpSys) * 0.65), rr: base.vitalsMod?.rr || ranges.rr, spO2: base.vitalsMod?.spO2 || 98, temp: base.vitalsMod?.temp || ranges.temp, gcs: base.vitalsMod?.gcs || 15, bm: ranges.bm, pupils: ranges.pupils };
                    const profile = base.patientProfileTemplate.replace(/{age}/g, patientAge).replace(/{sex}/g, 'male');
                    generatedScenario = { ...base, patientAge, profile, vitals: startVitals, vbg: generateVbg(base.vbgClinicalState), hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf), pmh: base.pmh || history.pmh, dhx: base.dhx || history.dhx, allergies: base.allergies || history.allergies };
                }
                if (generatedScenario.ageRange === 'Paediatric' || generatedScenario.patientAge < 18) { generatedScenario.weight = estimateWeight(generatedScenario.patientAge); }
                setLoading(false); onGenerate(generatedScenario, { category, age, hf, customMode, acuity });
            }, 600);
        };

        useEffect(() => { if (initialParams && initialParams.autoGenerate) { handleGenerate(); } }, []);

        return (
            <div className="max-w-2xl mx-auto space-y-6 p-4 w-full h-full overflow-y-auto">
                {savedState && (
                    <div className="bg-emerald-900/30 border border-emerald-500 p-4 rounded-lg flex items-center justify-between">
                        <div><h3 className="font-bold text-emerald-400">Previous Session Found</h3><p className="text-sm text-slate-300">Resume {savedState.scenario.title}?</p></div>
                        <Button onClick={onResume} variant="success">Resume</Button>
                    </div>
                )}
                <div className="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-sky-400 mb-4 flex items-center gap-2"><Lucide icon="settings"/> Simulation Parameters</h2>
                    <div className="flex gap-4 mb-6 border-b border-slate-700 pb-2">
                        <button onClick={() => setCustomMode(false)} className={`text-sm font-bold uppercase pb-1 ${!customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Random</button>
                        <button onClick={() => setCustomMode(true)} className={`text-sm font-bold uppercase pb-1 ${customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Custom</button>
                    </div>
                    {!customMode ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Category</label><select value={category} onChange={e=>setCategory(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Medical">Medical</option><option value="Trauma">Trauma</option><option value="Obstetrics & Gynae">Obs & Gynae</option><option value="Toxicology">Toxicology</option><option value="Psychiatric">Psychiatric</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Age</label><select value={age} onChange={e=>setAge(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Adult">Adult</option><option value="Elderly">Elderly</option><option value="Paediatric">Paediatric</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Acuity</label><select value={acuity} onChange={e=>setAcuity(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Majors">Majors</option><option value="Resus">Resus</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Human Factor</label><select value={hf} onChange={e=>setHf(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm">{HUMAN_FACTOR_CHALLENGES.map(h => <option key={h.id} value={h.id}>{h.type}</option>)}</select></div>
                        </div>
                    ) : (
                        <div className="space-y-4 mb-6">
                            <div className="mb-4 bg-slate-900/50 p-3 rounded border border-slate-600">
                                <label className="text-xs uppercase text-sky-400 font-bold block mb-2">Load Preset Scenario (Optional)</label>
                                <select onChange={(e) => loadPreset(e.target.value)} className="w-full bg-slate-800 border border-slate-500 rounded p-2 text-sm text-white">
                                    <option value="">Select a preset to auto-fill...</option>
                                    {ALL_SCENARIOS.map(s => <option key={s.id} value={s.id}>{s.title} ({s.category})</option>)}
                                </select>
                            </div>
                            <input type="text" placeholder="Title" value={customScenario.title} onChange={e => setCustomScenario({...customScenario, title: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-3"/>
                            <div className="grid grid-cols-2 gap-2">
                                <select value={customScenario.ecgType} onChange={e => setCustomScenario({...customScenario, ecgType: e.target.value})} className="bg-slate-900 border border-slate-600 rounded p-3"><option>Sinus Rhythm</option><option>Sinus Tachy</option><option>AF</option><option>VT</option><option>VF</option><option>STEMI</option><option>Asystole</option></select>
                                <input type="number" placeholder="HR" value={customScenario.hr} onChange={e => setCustomScenario({...customScenario, hr: e.target.value})} className="bg-slate-900 border border-slate-600 rounded p-3"/>
                            </div>
                        </div>
                    )}
                    {error && <div className="mb-4 p-3 bg-red-900/30 border border-red-500 rounded text-red-200 text-sm font-bold flex items-center gap-2"><Lucide icon="alert-circle" className="w-4 h-4"/>{error}</div>}
                    <Button onClick={handleGenerate} disabled={loading} className="w-full py-4 text-lg">{loading ? "Building Scenario..." : "Generate Scenario"}</Button>
                </div>
            </div>
        );
    };

    const BriefingScreen = ({ scenario, onStart, onBack, onNewScenario }) => (
        <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-4 overflow-y-auto h-full">
            <div className="bg-slate-800 p-6 rounded-lg border-l-4 border-sky-500 shadow-lg">
                <div className="flex justify-between items-start mb-4">
                    <div><h2 className="text-3xl font-bold text-white">{scenario.title}</h2><span className="inline-block bg-slate-700 text-sky-300 text-xs px-2 py-1 rounded mt-2">{scenario.category}</span></div>
                    <div className="text-right"><p className="text-2xl font-mono font-bold text-emerald-400">GCS {scenario.vitals.gcs}</p></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-1">Patient Profile</h3>
                        <p className="text-lg leading-relaxed mb-4">{scenario.profile}</p>
                        
                        <div className="space-y-2 mb-4">
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700">
                                <span className="text-xs text-slate-500 uppercase font-bold block">PMH</span>
                                <span className="text-sm text-slate-200">{scenario.pmh ? scenario.pmh.join(", ") : 'Nil'}</span>
                            </div>
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700">
                                <span className="text-xs text-slate-500 uppercase font-bold block">Drug History</span>
                                <span className="text-sm text-slate-200">{scenario.dhx ? scenario.dhx.join(", ") : 'Nil'}</span>
                            </div>
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700">
                                <span className="text-xs text-slate-500 uppercase font-bold block">Allergies</span>
                                <span className="text-sm text-red-300 font-bold">{scenario.allergies ? scenario.allergies.join(", ") : 'Nil'}</span>
                            </div>
                        </div>

                        <div className="p-3 bg-slate-700/50 rounded border border-slate-600"><p className="font-bold text-sky-300">PC: {scenario.presentingComplaint}</p></div>
                    </div>
                    <div className="space-y-4">
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-amber-400 uppercase mb-2">Progression</h4>
                            <p className="text-sm text-slate-300">{scenario.instructorBrief.progression}</p>
                        </div>
                        
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-sky-400 uppercase mb-2">Learning Objectives</h4>
                            <ul className="list-disc pl-4 text-sm text-slate-300">
                                {scenario.instructorBrief.learningObjectives && scenario.instructorBrief.learningObjectives.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                        
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-emerald-400 uppercase mb-2">Key Interventions</h4>
                            <ul className="list-disc pl-4 text-sm text-slate-300">
                                {scenario.instructorBrief.interventions && scenario.instructorBrief.interventions.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                        
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-purple-400 uppercase mb-2">Debrief Points</h4>
                            <ul className="list-disc pl-4 text-sm text-slate-300">
                                {scenario.instructorBrief.debriefPoints && scenario.instructorBrief.debriefPoints.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>

                        {scenario.hf.id !== 'hf0' && (
                             <div className="bg-purple-900/30 p-3 rounded border border-purple-500">
                                <h4 className="text-sm font-bold text-purple-300 uppercase mb-1">Human Factor Challenge</h4>
                                <p className="font-bold text-white mb-1">{scenario.hf.type}</p>
                                <p className="text-xs text-purple-200">{scenario.hf.description}</p>
                             </div>
                        )}
                    </div>
                </div>
            </div>
            <div className="flex flex-col md:flex-row gap-4">
                <Button onClick={onBack} variant="secondary" className="flex-1">Back</Button>
                <Button onClick={onNewScenario} variant="secondary" className="flex-1">New Scenario</Button>
                <Button onClick={onStart} className="flex-1 shadow-sky-900/20 shadow-xl">Start Simulation</Button>
            </div>
        </div>
    );

    const LiveSimScreen = ({ sim, onFinish, onBack }) => {
        const { state, start, pause, applyIntervention, addLogEntry, manualUpdateVital, triggerArrest, triggerROSC, revealInvestigation, nextCycle } = sim;
        const { scenario, time, isRunning, vitals, prevVitals, log, flash, activeInterventions, interventionCounts, activeDurations, isMuted, rhythm, etco2Enabled, queuedRhythm, history, metronomeActive } = state;
        const [activeTab, setActiveTab] = useState("Common");
        const [customDrug, setCustomDrug] = useState("");

        const getInterventionsByCat = (cat) => Object.keys(INTERVENTIONS).filter(key => INTERVENTIONS[key].category === cat);
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

        // MTP Ratio Calculation
        const unitsBlood = interventionCounts['Blood'] || 0;
        const unitsFFP = interventionCounts['FFP'] || 0;
        const unitsPlt = interventionCounts['Platelets'] || 0;
        const showMTP = unitsBlood > 0 || scenario.category === 'Trauma';

        return (
            <div className={`h-full grid grid-cols-1 lg:grid-cols-3 gap-4 p-2 md:p-4 transition-colors duration-500 ${flash === 'red' ? 'flash-red' : (flash === 'green' ? 'flash-green' : '')}`}>
                
                {/* LEFT COL: Monitor & Actions */}
                <div className="lg:col-span-2 flex flex-col gap-4 overflow-hidden h-full">
                    
                    {/* MONITOR HEADER */}
                    <Card className="bg-slate-900 border-slate-800 flex-shrink-0">
                        <div className="flex justify-between items-center mb-2 border-b border-slate-800 pb-2">
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={onBack} className="h-8 text-xs px-2"><Lucide icon="arrow-left"/> Back</Button>
                                {!isRunning ? <Button variant="success" onClick={start} className="h-8 px-4 font-bold"><Lucide icon="play"/> START</Button> : <Button variant="danger" onClick={pause} className="h-8 px-4"><Lucide icon="pause"/> Pause</Button>}
                                <Button variant="primary" onClick={onFinish} className="h-8 px-4"><Lucide icon="square"/> Finish</Button>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => sim.dispatch({type: 'SET_MUTED', payload: !isMuted})} className={`p-1.5 rounded-full ${isMuted ? 'bg-red-900 text-white' : 'bg-slate-800 text-slate-400'}`}><Lucide icon={isMuted ? "volume-x" : "volume-2"} className="w-4 h-4" /></button>
                                <div className="font-mono text-xl font-bold text-emerald-400 bg-black/40 px-3 py-1 rounded">{formatTime(time)}</div>
                            </div>
                        </div>

                        {/* WAVEFORMS */}
                        <div className="mb-2 relative">
                             <ECGMonitor rhythmType={rhythm} hr={vitals.hr} rr={vitals.rr} isPaused={!isRunning} showEtco2={etco2Enabled} pathology={scenario.deterioration.type} />
                             {(!['VF','VT','Asystole'].includes(rhythm) && vitals.bpSys < 30) && (
                                <div className="absolute top-0 left-0 right-0 bottom-0 flex items-center justify-center pointer-events-none">
                                    <div className="bg-red-600/80 text-white font-bold text-lg px-6 py-2 rounded pea-warning border-2 border-white">PEA - CHECK PULSE</div>
                                </div>
                             )}
                        </div>

                        {/* NUMERICS GRID (Expanded) */}
                        <div className="grid grid-cols-4 gap-2">
                            <VitalDisplay label="Heart Rate" value={vitals.hr} prev={prevVitals.hr} history={history} unit="bpm" lowIsBad={false} onUpdate={(v) => manualUpdateVital('hr', v)} alert={vitals.hr > 140 || vitals.hr < 40}/>
                            <VitalDisplay label="BP" value={vitals.bpSys} value2={vitals.bpDia} prev={prevVitals.bpSys} history={history} unit="mmHg" onUpdate={(v) => manualUpdateVital('bpSys', v)} alert={vitals.bpSys < 90}/>
                            <VitalDisplay label="SpO2" value={vitals.spO2} prev={prevVitals.spO2} history={history} unit="%" onUpdate={(v) => manualUpdateVital('spO2', v)} alert={vitals.spO2 < 90}/>
                            <VitalDisplay label="RR" value={vitals.rr} prev={prevVitals.rr} history={history} unit="/min" lowIsBad={false} onUpdate={(v) => manualUpdateVital('rr', v)} alert={vitals.rr > 30 || vitals.rr < 8}/>
                            
                            {/* Row 2: Obs */}
                            <VitalDisplay label="Temp" value={vitals.temp} prev={prevVitals.temp} history={history} unit="°C" onUpdate={(v) => manualUpdateVital('temp', v)} alert={vitals.temp > 38}/>
                            <VitalDisplay label="Glucose" value={vitals.bm} prev={prevVitals.bm} history={history} unit="mmol/L" onUpdate={(v) => manualUpdateVital('bm', v)} alert={vitals.bm < 4}/>
                            <VitalDisplay label="Pupils" value={vitals.pupils || "3mm"} unit="" isText={true} onUpdate={(v) => manualUpdateVital('pupils', v)} />
                            {etco2Enabled ? (
                                <div className="bg-slate-900/50 p-2 md:p-3 rounded border border-yellow-500/50 flex flex-col items-center justify-center h-24 md:h-28 relative">
                                    <span className="text-[10px] md:text-xs font-bold text-yellow-500 uppercase tracking-wider mb-1">ETCO2</span>
                                    <span className="text-2xl md:text-3xl font-mono font-bold text-yellow-500">
                                        {vitals.hr > 0 ? (scenario.deterioration.type === 'respiratory' ? '6.5' : '4.5') : '1.0'}
                                    </span>
                                    <span className="text-[9px] md:text-[10px] text-slate-600 mt-1">kPa</span>
                                </div>
                            ) : (
                                <div className="bg-slate-900/20 p-2 md:p-3 rounded border border-slate-800 flex flex-col items-center justify-center h-24 md:h-28 opacity-50">
                                    <span className="text-[10px] md:text-xs font-bold text-slate-600 uppercase tracking-wider">ETCO2</span>
                                    <span className="text-lg text-slate-700">OFF</span>
                                </div>
                            )}
                        </div>
                    </Card>

                    {/* ACTIONS PANEL */}
                    <Card title="Clinical Actions" icon="activity" className="flex-1 min-h-0 bg-slate-800">
                        {/* Sim Controls */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 bg-slate-900/50 p-2 rounded">
                             <Button variant="danger" onClick={triggerArrest} className="text-xs h-8">VF Arrest</Button>
                             <Button variant="success" onClick={triggerROSC} className="text-xs h-8">ROSC</Button>
                             <select className="bg-slate-700 text-white text-xs rounded px-2 h-8 border border-slate-600" value={queuedRhythm || ""} onChange={(e) => sim.dispatch({type: 'SET_QUEUED_RHYTHM', payload: e.target.value})}>
                                 <option value="">Next Rhythm...</option>
                                 <option value="Sinus Rhythm">ROSC (Sinus)</option>
                                 <option value="VF">VF</option>
                                 <option value="Asystole">Asystole</option>
                                 <option value="PEA">PEA</option>
                             </select>
                             <Button variant={metronomeActive ? "warning" : "secondary"} onClick={() => sim.dispatch({type: 'TOGGLE_METRONOME'})} className="text-xs h-8">{metronomeActive ? "Stop Metronome" : "110bpm Metronome"}</Button>
                        </div>

                        {/* MTP Ratio Monitor */}
                        {showMTP && (
                            <div className="mb-4 bg-red-900/20 border border-red-600/50 p-2 rounded-lg flex justify-between items-center">
                                <h4 className="text-[10px] font-bold text-red-400 uppercase flex items-center gap-2"><Lucide icon="droplet" className="w-3 h-3"/> Massive Transfusion</h4>
                                <div className="flex gap-4 text-xs">
                                    <span>Blood: <b className="text-white">{unitsBlood}</b></span>
                                    <span>FFP: <b className="text-white">{unitsFFP}</b></span>
                                    <span>Plt: <b className="text-white">{unitsPlt}</b></span>
                                    <span className="text-slate-400 ml-2">Ratio: {unitsBlood}:{unitsFFP}:{unitsPlt}</span>
                                </div>
                            </div>
                        )}

                        {/* Recommended Actions (Restored) */}
                        {scenario.recommendedActions && (
                            <div className="mb-4 bg-sky-900/20 border border-sky-600/50 p-2 rounded-lg">
                                <h4 className="text-[10px] font-bold text-sky-400 uppercase mb-2 flex items-center gap-2"><Lucide icon="check-square" className="w-3 h-3"/> Recommended</h4>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    {scenario.recommendedActions.map(key => {
                                        const action = INTERVENTIONS[key];
                                        if(!action) return null;
                                        const isActive = activeInterventions.has(key);
                                        let progress = 0;
                                        if(activeDurations[key]) {
                                            const elapsed = time - activeDurations[key].startTime;
                                            progress = Math.min(100, Math.max(0, 100 - (elapsed / activeDurations[key].duration * 100)));
                                        }
                                        return (
                                            <Button key={`rec-${key}`} variant={isActive ? "success" : "secondary"} onClick={() => applyIntervention(key)} disabled={!isRunning} className="text-xs h-8 relative border border-sky-500/30" progress={progress}>
                                                {action.label}
                                                {interventionCounts[key] > 0 && action.type !== 'continuous' && <span className="bg-white/20 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-1">x{interventionCounts[key]}</span>}
                                            </Button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        
                        {/* Tabs */}
                        <div className="flex space-x-2 mb-2 overflow-x-auto pb-1 no-scrollbar">
                            {['Common', 'Airway', 'Circulation', 'Drugs', 'Obs/Gynae', 'Procedures'].map(cat => (
                                <button key={cat} onClick={() => setActiveTab(cat)} className={`px-3 py-1 text-xs font-bold rounded transition-colors whitespace-nowrap ${activeTab === cat ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-400'}`}>{cat}</button>
                            ))}
                        </div>

                        {/* Grid */}
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 overflow-y-auto min-h-0 flex-1 content-start">
                            {activeTab === 'Airway' && (
                                <Button variant={etco2Enabled ? "success" : "secondary"} onClick={() => sim.dispatch({type: 'TOGGLE_ETCO2'})} className="text-xs h-10">
                                    {etco2Enabled ? "Disconnect ETCO2" : "Connect ETCO2"}
                                </Button>
                            )}
                            {getInterventionsByCat(activeTab).map(key => {
                                const isActive = activeInterventions.has(key);
                                let progress = 0;
                                if(activeDurations[key]) {
                                    const elapsed = time - activeDurations[key].startTime;
                                    progress = Math.min(100, Math.max(0, 100 - (elapsed / activeDurations[key].duration * 100)));
                                }
                                return (
                                    <Button key={key} variant={isActive ? "success" : "secondary"} onClick={() => applyIntervention(key)} disabled={!isRunning} className="text-xs h-10 relative" progress={progress}>
                                        {INTERVENTIONS[key]?.label || key}
                                        {interventionCounts[key] > 0 && INTERVENTIONS[key].type !== 'continuous' && <span className="bg-white/20 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-1">x{interventionCounts[key]}</span>}
                                    </Button>
                                )
                            })}
                        </div>
                        
                        {/* Manual Log */}
                        <div className="mt-2 flex gap-2 pt-2 border-t border-slate-700">
                             <input type="text" className="bg-slate-900 border border-slate-600 rounded px-2 text-xs flex-1 text-white" placeholder="Custom Drug / Note..." value={customDrug} onChange={e=>setCustomDrug(e.target.value)} onKeyDown={e => e.key === 'Enter' && (addLogEntry(`Custom: ${customDrug}`, 'manual') || setCustomDrug(""))} />
                             <Button onClick={() => {addLogEntry(`Custom: ${customDrug}`, 'manual'); setCustomDrug("");}} className="h-8 text-xs">Add Entry</Button>
                        </div>
                    </Card>
                </div>

                {/* RIGHT COL: Info & Log */}
                <div className="flex flex-col gap-4 h-full overflow-hidden">
                    <Card title="Scenario Info" icon="info" collapsible={true} className="flex-shrink-0">
                         <h3 className="font-bold text-white mb-1">{scenario.title}</h3>
                         <p className="text-xs text-slate-300 mb-2">{scenario.patientProfileTemplate.replace('{age}', scenario.patientAge).replace('{sex}', 'Male')}</p>
                         <div className="grid grid-cols-2 gap-2">
                             {['ECG', 'VBG', 'X-ray', 'POCUS', 'CT', 'Urine'].map(t => (
                                 <InvestigationButton key={t} type={t} icon="activity" label={t} isRevealed={state.investigationsRevealed[t]} isLoading={state.loadingInvestigations[t]} revealInvestigation={revealInvestigation} isRunning={isRunning} scenario={scenario}/>
                             ))}
                         </div>
                    </Card>
                    
                    {(scenario.ageRange === 'Paediatric' || scenario.patientAge < 18) && (
                        <PaedsCalculator weight={scenario.weight} age={scenario.patientAge} />
                    )}
                    
                    <Card title="Clinical Guidelines" icon="book" collapsible={true} defaultOpen={false} className="flex-shrink-0">
                        <div className="flex flex-col gap-2">
                            {scenario.learningLinks && scenario.learningLinks.map((link, i) => (
                                <a key={i} href={link.url} target="_blank" rel="noopener noreferrer" className="p-3 bg-slate-700/50 hover:bg-slate-700 rounded border border-slate-600 flex flex-col gap-1 text-xs">
                                    <div className="font-bold text-sky-400 flex items-center gap-2"><Lucide icon="external-link" className="w-3 h-3"/> {link.label}</div>
                                </a>
                            ))}
                            {!scenario.learningLinks && <p className="text-xs text-slate-400 italic">No specific guidelines linked.</p>}
                        </div>
                    </Card>

                    <Card className="flex-1 min-h-0 bg-slate-800 flex flex-col">
                        <div className="flex items-center gap-2 mb-2 border-b border-slate-700 pb-2"><Lucide icon="list" className="w-4 h-4 text-sky-400" /><h3 className="font-bold text-slate-200 text-sm">Incident Log</h3></div>
                        <div className="flex-1 overflow-y-auto space-y-1 pr-1 text-xs font-mono">
                            {log.map((l, i) => (<div key={i} className={`p-1.5 rounded border-l-2 ${l.type === 'success' ? 'bg-emerald-900/20 border-emerald-500' : l.type === 'action' ? 'bg-sky-900/20 border-sky-500' : l.type === 'manual' ? 'bg-purple-900/20 border-purple-500' : l.type === 'danger' ? 'bg-red-900/30 border-red-500' : 'bg-slate-700/30 border-slate-500'}`}><span className="text-slate-500 mr-2">{l.simTime}</span><span className="text-slate-200">{l.msg}</span></div>))}
                        </div>
                    </Card>
                </div>
            </div>
        );
    };

    const DebriefScreen = ({ sim, onRestart }) => {
        const { state } = sim;
        const { log, scenario, history } = state; 
        const chartRef = useRef(null);

        useEffect(() => {
            if (!chartRef.current || !history.length) return;
            
            // Fix: Deterministic y-offset calculation to prevent jitter
            const interventions = log
                .filter(l => l.type === 'action' || l.type === 'manual')
                .map((l, index) => ({ 
                    x: `${Math.floor(l.timeSeconds/60)}:${(l.timeSeconds%60).toString().padStart(2,'0')}`, 
                    label: l.msg,
                    yOffset: 10 + (index % 5) * 15 // Static offset based on index
                }));

            const chart = new window.Chart(chartRef.current, {
                type: 'line',
                data: {
                    labels: history.map(h => `${Math.floor(h.time/60)}:${(h.time%60).toString().padStart(2,'0')}`),
                    datasets: [ 
                        { label: 'HR', data: history.map(h => h.hr), borderColor: '#ef4444', borderWidth: 2, pointRadius: 0, tension: 0.1 }, 
                        { label: 'Sys BP', data: history.map(h => h.bp), borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, tension: 0.1 }, 
                        { label: 'SpO2', data: history.map(h => h.spo2), borderColor: '#10b981', borderWidth: 2, pointRadius: 0, tension: 0.1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // FIX: Interaction mode 'index' with intersect false to prevent label jumping
                    interaction: { mode: 'index', intersect: false },
                    animation: false, // Disable animation to prevent flickering updates
                    hover: { animationDuration: 0 }, // Specific fix for flickering tooltips
                    plugins: { 
                        title: { display: true, text: 'Vital Signs Trend' },
                        tooltip: { position: 'nearest' }, // Helps stability
                        annotation: {
                            // Basic support via custom plugin below if official plugin missing
                        }
                    },
                    scales: { y: { position: 'left', min: 0 }, y1: { position: 'right', min: 0, max: 100, grid: {drawOnChartArea: false} } }
                },
                plugins: [{
                    id: 'verticalLines',
                    afterDatasetsDraw(chart) {
                        const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
                        ctx.save();
                        interventions.forEach(item => {
                            const xPos = x.getPixelForValue(item.x);
                            if (xPos) {
                                ctx.beginPath();
                                ctx.moveTo(xPos, top);
                                ctx.lineTo(xPos, bottom);
                                ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                                
                                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                                ctx.font = '10px sans-serif';
                                // Use pre-calculated offset to prevent jitter
                                ctx.fillText(item.label.substring(0, 15), xPos + 2, top + item.yOffset);
                            }
                        });
                        ctx.restore();
                    }
                }]
            });
            return () => chart.destroy();
        }, [history, log]);

        const handleExport = () => {
            const doc = new window.jspdf.jsPDF();
            doc.setFontSize(16); doc.text(`Simulation Debrief: ${scenario.title}`, 10, 10);
            doc.setFontSize(10);
            let y = 30;
            log.forEach(l => { 
                if (y > 280) { doc.addPage(); y = 10; } 
                doc.text(`[${l.simTime}] ${l.msg}`, 10, y); y += 6; 
            });
            doc.save("sim-debrief.pdf");
        };

        return (
            <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-4 h-full overflow-y-auto">
                <div className="flex flex-col md:flex-row justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700 gap-4">
                    <h2 className="text-2xl font-bold text-white">Simulation Debrief</h2>
                    <div className="flex gap-2">
                        <Button onClick={handleExport} variant="secondary"><Lucide icon="download"/> PDF</Button>
                        <Button onClick={onRestart} variant="primary"><Lucide icon="rotate-ccw"/> New Sim</Button>
                    </div>
                </div>

                {/* DIAMOND DEBRIEF */}
                <Card title="Diamond Debrief Model" icon="message-circle">
                    <div className="diamond-grid">
                        <div className="bg-sky-900/20 p-4 rounded border border-sky-600/30">
                            <h4 className="text-sky-400 font-bold mb-2 uppercase text-sm">1. Description</h4>
                            <p className="text-slate-300 text-xs italic mb-2">What happened? How did it feel?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Clarify clinical facts.</li>
                                <li>Allow team to vent emotions.</li>
                                <li>Establish shared mental model.</li>
                            </ul>
                        </div>
                        <div className="bg-amber-900/20 p-4 rounded border border-amber-600/30">
                            <h4 className="text-amber-400 font-bold mb-2 uppercase text-sm">2. Analysis</h4>
                            <p className="text-slate-300 text-xs italic mb-2">Why did it happen?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Explore decision making.</li>
                                <li>Discuss guidelines ({scenario.learningLinks && scenario.learningLinks.length > 0 ? 'Review Links' : 'Check Guidelines'}).</li>
                                <li>Review differential diagnoses.</li>
                            </ul>
                        </div>
                        <div className="bg-purple-900/20 p-4 rounded border border-purple-600/30">
                            <h4 className="text-purple-400 font-bold mb-2 uppercase text-sm">3. Human Factors</h4>
                            <p className="text-slate-300 text-xs italic mb-2">Non-technical skills?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Leadership & Followership.</li>
                                <li>Communication (Closed Loop).</li>
                                <li>Specific Challenge: <span className="text-white font-bold">{scenario.hf.type}</span></li>
                            </ul>
                        </div>
                        <div className="bg-emerald-900/20 p-4 rounded border border-emerald-600/30">
                            <h4 className="text-emerald-400 font-bold mb-2 uppercase text-sm">4. Application</h4>
                            <p className="text-slate-300 text-xs italic mb-2">What will we do next time?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Identify take-home messages.</li>
                                <li>Plan for system changes.</li>
                                <li>Personal learning goals.</li>
                            </ul>
                        </div>
                    </div>
                </Card>

                <Card title="Physiological Trends" icon="activity">
                    <div className="bg-slate-900 p-2 rounded h-64 md:h-96 relative">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </Card>
                <Card title="Action Timeline" icon="clock"><div className="space-y-1 max-h-64 overflow-y-auto font-mono text-xs">{log.map((l, i) => (<div key={i} className="flex gap-4 border-b border-slate-700 pb-1"><span className="text-sky-400 w-12 flex-shrink-0">{l.simTime}</span><span className="text-slate-300">{l.msg}</span></div>))}</div></Card>
            </div>
        );
    };

    const App = () => {
        const [view, setView] = useState('setup'); 
        const [currentScenario, setCurrentScenario] = useState(null);
        const [lastSetupParams, setLastSetupParams] = useState(null);
        const [resumeState, setResumeState] = useState(null);

        useEffect(() => { 
            const saved = localStorage.getItem('wmebem_sim_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.scenario && parsed.vitals) setResumeState(parsed);
                } catch(e) { console.error("Save state corrupt", e); }
            }
        }, []); 

        const handleResume = () => { setCurrentScenario(resumeState.scenario); setView('resume'); };

        return (
            <div className="h-full flex flex-col bg-slate-900 text-slate-100 font-sans">
                <header className="flex items-center justify-between p-2 md:p-4 border-b border-slate-800 bg-slate-900 flex-shrink-0">
                    <div className="flex items-center gap-3"><img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" className="h-8 md:h-12 object-contain" /><div><h1 className="text-lg md:text-2xl font-bold text-sky-400">Sim Generator v13.0</h1></div></div>
                    <div className="hidden md:block text-right"><p className="text-[10px] text-slate-500">In-situ Simulation Tool</p></div>
                </header>
                <main className="flex-grow overflow-hidden relative">
                    {view === 'setup' && (<SetupScreen onGenerate={(s, params) => { setCurrentScenario(s); setLastSetupParams(params); setView('briefing'); }} savedState={resumeState} onResume={handleResume} />)}
                    {view === 'setup_regen' && (<SetupScreen initialParams={{ ...lastSetupParams, autoGenerate: true }} onGenerate={(s, params) => { setCurrentScenario(s); setLastSetupParams(params); setView('briefing'); }} />)}
                    {view === 'briefing' && currentScenario && (<BriefingScreen scenario={currentScenario} onStart={() => setView('live')} onBack={() => setView('setup')} onNewScenario={() => setView('setup_regen')} />)}
                    {(view === 'live' || view === 'debrief' || view === 'resume') && currentScenario && (<LiveSimContainer scenario={currentScenario} view={view} setView={setView} resumeData={view === 'resume' ? resumeState : null} onRestart={() => { setCurrentScenario(null); setView('setup'); setResumeState(null); localStorage.removeItem('wmebem_sim_state'); }} />)}
                </main>
            </div>
        );
    };

    const LiveSimContainer = ({ scenario, view, setView, resumeData, onRestart }) => {
        const sim = useSimulation(scenario);
        useEffect(() => {
            if (view === 'resume' && resumeData) { sim.dispatch({ type: 'RESTORE_SESSION', payload: resumeData }); setView('live'); } 
            else if (view !== 'debrief' && !sim.state.scenario) { sim.dispatch({ type: 'LOAD_SCENARIO', payload: scenario }); }
        }, []);
        
        if (!sim.state.scenario) return <div className="flex flex-col items-center justify-center h-full text-slate-400 animate-pulse"><Lucide icon="loader-2" className="w-8 h-8 mb-4 animate-spin text-sky-500" /></div>;

        if (view === 'live' || view === 'resume') return <LiveSimScreen sim={sim} onFinish={() => { sim.stop(); setView('debrief'); }} onBack={() => setView('briefing')} />;
        if (view === 'debrief') return <DebriefScreen sim={sim} onRestart={onRestart} />;
        return null;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
