<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Sim Generator v12.8 (Mobile Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .flash-red { animation: flashRed 1.5s ease-in-out infinite; }
        @keyframes flashRed {
            0%, 100% { background-color: rgba(30, 41, 59, 1); } 
            50% { background-color: rgba(127, 29, 29, 0.5); } 
        }
        
        .flash-green { animation: flashGreen 1s ease-in-out; }
        @keyframes flashGreen {
            0%, 100% { border-color: #334155; }
            50% { border-color: #10b981; }
        }
        
        html, body { height: 100%; overflow: hidden; }
        body { background-color: #0f172a; color: #f1f5f9; display: flex; flex-direction: column; }
        #root { height: 100%; display: flex; flex-direction: column; }

        @keyframes loadProgress { from { width: 0%; } to { width: 100%; } }
        .loading-bar {
            position: absolute; bottom: 0; left: 0; height: 100%;
            background-color: rgba(16, 185, 129, 0.2);
            animation: loadProgress 2s linear forwards; z-index: 0;
        }
        
        .pea-warning { animation: pulseText 1s infinite; }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .diamond-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .mobile-stack { flex-direction: column; }
            .mobile-h-full { height: 100%; }
            .diamond-grid { grid-template-columns: 1fr; }
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased selection:bg-sky-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
    
    // --- 1. HELPER FUNCTIONS & DATA ---

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getRandomFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
    const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

    // Medical Generators
    const generateHistory = (age, sex = 'Male') => {
        if (age < 20) return { pmh: ["Nil significant"], dhx: ["Nil"], allergies: ["Nil"] };
        
        const commonPMH = ["Hypertension", "Type 2 Diabetes", "Asthma", "Hyperlipidaemia", "GORD", "Depression", "Anxiety", "Previous MI", "AF", "CKD Stage 3"];
        const femalePMH = ["PCOS", "Endometriosis", "Previous C-Section"];
        
        let pmh = [];
        let dhx = [];
        
        const pmhCount = age > 60 ? getRandomInt(1, 4) : age > 40 ? getRandomInt(0, 2) : getRandomInt(0, 1);
        
        for(let i=0; i<pmhCount; i++) {
            const item = getRandomItem(commonPMH);
            if(!pmh.includes(item)) pmh.push(item);
        }
        
        if (sex === 'Female' && Math.random() > 0.8) pmh.push(getRandomItem(femalePMH));

        if (pmh.includes("Hypertension")) dhx.push("Ramipril 5mg OD");
        if (pmh.includes("Type 2 Diabetes")) dhx.push("Metformin 1g BD");
        if (pmh.includes("Asthma")) dhx.push("Salbutamol PRN", "Beclometasone BD");
        if (pmh.includes("Hyperlipidaemia")) dhx.push("Atorvastatin 20mg ON");
        if (pmh.includes("GORD")) dhx.push("Omeprazole 20mg OD");
        if (pmh.includes("AF")) dhx.push("Bisoprolol 2.5mg OD", "Edoxaban 60mg OD");
        if (pmh.includes("Previous MI")) dhx.push("Aspirin 75mg OD", "Atorvastatin 80mg ON", "Bisoprolol 2.5mg OD");

        if (pmh.length === 0) pmh.push("Nil significant");
        if (dhx.length === 0) dhx.push("Nil regular medications");

        return {
            pmh: pmh,
            dhx: dhx,
            allergies: [Math.random() > 0.8 ? getRandomItem(["Penicillin", "Latex", "NSAIDs", "Trimethoprim"]) : "NKDA"]
        };
    };

    const getBaseVitals = (age) => {
        let v = { hr: 75, rr: 16, bpSys: 120, bpDia: 75, temp: 36.8, bm: 5.8, gcs: 15, pupils: '3mm' }; 
        if (age < 1) v = { hr: 145, rr: 45, bpSys: 75, bpDia: 45, temp: 37.0, bm: 4.5, gcs: 15, pupils: '3mm' }; 
        else if (age <= 2) v = { hr: 125, rr: 30, bpSys: 90, bpDia: 55, temp: 37.0, bm: 5.0, gcs: 15, pupils: '3mm' }; 
        else if (age <= 5) v = { hr: 110, rr: 25, bpSys: 95, bpDia: 60, temp: 37.0, bm: 5.0, gcs: 15, pupils: '3mm' }; 
        else if (age <= 12) v = { hr: 90, rr: 20, bpSys: 105, bpDia: 65, temp: 36.8, bm: 5.5, gcs: 15, pupils: '4mm' }; 
        else if (age > 65) v = { hr: 70, rr: 18, bpSys: 135, bpDia: 80, temp: 36.5, bm: 6.0, gcs: 15, pupils: '3mm' }; 
        return v;
    };

    const estimateWeight = (age) => {
        if (age === 0) return "3.5"; 
        if (age < 1) return "6.0"; // Averaged for WETFLAG
        if (age >= 1 && age <= 10) return ((age + 4) * 2).toFixed(1); 
        if (age > 10) return (age * 3 + 7).toFixed(1); 
        return null; 
    };

    // WETFLAG Calculator
    const calculateWetflag = (age, weightStr) => {
        const weight = parseFloat(weightStr);
        if (isNaN(weight)) return null;

        return {
            weight: weight,
            energy: Math.round(weight * 4), // 4 J/kg
            tube: age < 1 ? "3.5-4.0" : ((age / 4) + 4).toFixed(1), // Tube size
            fluids: Math.round(weight * 10), // 10 ml/kg
            lorazepam: (weight * 0.1).toFixed(1), // 0.1 mg/kg
            adrenaline: (weight * 0.1).toFixed(1), // 0.1 ml/kg of 1:10,000
            glucose: Math.round(weight * 2) // 2 ml/kg of 10%
        };
    };

    const generateVbg = (clinicalState = "normal") => {
        let vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.0, K: 4.0, Glu: 5.5 };
        vbg.pH += getRandomFloat(-0.03, 0.03, 2);
        switch (clinicalState) {
            case "dka_severe": vbg = { pH: 6.95, pCO2: 2.5, HCO3: 5, BE: -24, Lac: 2.5, K: 5.4, Glu: 28.0 }; break;
            case "septic_shock": vbg = { pH: 7.25, pCO2: 4.5, HCO3: 16, BE: -8, Lac: 6.5, K: 4.2, Glu: 4.0 }; break;
            case "haemorrhagic_shock": vbg = { pH: 7.20, pCO2: 4.8, HCO3: 14, BE: -10, Lac: 8.0, K: 3.8, Glu: 9.0 }; break;
            case "copd_retainer": vbg = { pH: 7.30, pCO2: 9.5, HCO3: 34, BE: 8, Lac: 1.2, K: 4.0, Glu: 6.0 }; break;
            case "respiratory_acidosis_acute": vbg = { pH: 7.15, pCO2: 9.5, HCO3: 24, BE: 0, Lac: 1.5, K: 4.1, Glu: 6.2 }; break;
            case "metabolic_acidosis_severe": vbg = { pH: 6.90, pCO2: 6.0, HCO3: 10, BE: -22, Lac: 12.0, K: 6.5, Glu: 6.0 }; break;
            case "metabolic_alkalosis": vbg = { pH: 7.50, pCO2: 5.8, HCO3: 30, BE: 6, Lac: 1.0, K: 3.0, Glu: 5.5 }; break;
            case "hyperkalemia": vbg = { pH: 7.35, pCO2: 5.0, HCO3: 22, BE: -2, Lac: 1.5, K: 7.5, Glu: 6.0 }; break;
            case "hyponatremia": vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.2, K: 4.0, Na: 115, Glu: 5.5 }; break;
            case "gi_bleed": vbg = { pH: 7.32, pCO2: 4.8, HCO3: 20, BE: -4, Lac: 3.5, K: 4.1, Glu: 6.5 }; break; 
            case "hypercalcemia": vbg = { pH: 7.42, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.2, K: 4.0, Ca: 3.5, Glu: 5.5 }; break;
            case "hypothermia": vbg = { pH: 7.30, pCO2: 5.0, HCO3: 22, BE: -2, Lac: 2.5, K: 3.5, Glu: 4.5 }; break;
            case "co_poisoning": vbg = { pH: 7.35, pCO2: 5.0, HCO3: 18, BE: -6, Lac: 4.0, K: 4.0, Glu: 6.0 }; break;
            default: break;
        }
        return vbg;
    };

    const HUMAN_FACTOR_CHALLENGES = [
      { id: 'hf0', type: 'Standard Simulation', description: 'Manage effectively.' },
      { id: 'hf1', type: 'Blindfolded Lead', description: 'Leader blindfolded. Tests closed-loop comms.' },
      { id: 'hf2', type: 'Silent Team', description: 'Only leader speaks.' },
      { id: 'hf3', type: 'New Junior', description: 'Junior member needs explicit instructions.' },
      { id: 'hf4', type: 'Missing Kit', description: 'Crucial equipment missing.' },
      { id: 'hf5', type: 'Distracted Senior', description: 'Consultant on phone, dismissive.' },
    ];

    const INTERVENTIONS = {
        // --- AIRWAY ---
        'Manoeuvres': { label: 'Head Tilt / Jaw Thrust', effect: { SpO2: 5 }, category: 'Airway', log: 'Airway manoeuvres applied.', type: 'continuous', duration: 5 },
        'OPA': { label: 'Guedel / OPA', effect: { SpO2: 5 }, category: 'Airway', log: 'Oropharyngeal airway inserted.', type: 'continuous', duration: 10 },
        'NPA': { label: 'Nasopharyngeal', effect: { SpO2: 5 }, category: 'Airway', log: 'Nasopharyngeal airway inserted.', type: 'continuous', duration: 15 },
        'i-gel': { label: 'i-gel / LMA', effect: { SpO2: 15, RR: 'vent' }, category: 'Airway', log: 'Supraglottic airway (i-gel) inserted.', type: 'continuous', duration: 30 },
        'Suction': { label: 'Suction Airway', effect: { SpO2: 5 }, category: 'Airway', log: 'Airway suctioned.', type: 'bolus', duration: 15 },
        'RSI': { label: 'Perform RSI', effect: { SpO2: 99, RR: 'vent', BP: -15, gcs: 'sedated' }, category: 'Airway', log: 'Rapid Sequence Induction performed. Patient intubated.', type: 'continuous', duration: 120 },
        'FONA': { label: 'FONA (Front of Neck)', effect: { SpO2: 95, RR: 'vent' }, category: 'Airway', log: 'Emergency FONA performed. Airway secured.', type: 'continuous', duration: 60 },
        'Magills': { label: 'Magill Forceps', effect: { SpO2: 10 }, category: 'Airway', log: 'Foreign body removed with Magills.', type: 'bolus', duration: 15 },

        // --- BREATHING ---
        'Obs': { label: 'Monitoring (SpO2/ECG/BP)', effect: {}, category: 'Exposure', log: 'Full monitoring applied.', type: 'continuous', duration: 10 },
        'Oxygen': { label: 'High Flow O2', effect: { SpO2: 10 }, category: 'Breathing', log: 'High flow oxygen applied.', type: 'continuous', duration: 5 },
        'Bagging': { label: 'Bag-Valve-Mask', effect: { SpO2: 25, RR: 'vent' }, category: 'Breathing', log: 'Manual ventilation (BVM) started.', type: 'continuous', duration: 5 },
        'Nebs': { label: 'Nebulisers', effect: { HR: 10, RR: -3, SpO2: 5 }, category: 'Breathing', log: 'Nebulisers administered.', type: 'bolus', duration: 300 },
        'NebAdrenaline': { label: 'Neb Adrenaline', effect: { HR: 10, RR: -5, SpO2: 5 }, category: 'Breathing', log: 'Nebulised Adrenaline running.', type: 'bolus', duration: 300 },
        'CPAP': { label: 'CPAP', effect: { SpO2: 10, RR: -5, BP: -5 }, category: 'Breathing', log: 'CPAP initiated.', type: 'continuous', duration: 60 },
        'NIV': { label: 'NIV (BiPAP)', effect: { SpO2: 12, RR: -5, BP: -5 }, category: 'Breathing', log: 'NIV (BiPAP) initiated.', type: 'continuous', duration: 60 },
        'Needle': { label: 'Needle Decompression', effect: { SpO2: 20, BP: 15, RR: -8 }, category: 'Breathing', log: 'Needle thoracocentesis performed.', type: 'bolus', duration: 30 },
        'FingerThoracostomy': { label: 'Finger Thoracostomy', effect: { SpO2: 20, BP: 15, RR: -8 }, category: 'Breathing', log: 'Finger thoracostomy performed.', type: 'bolus', duration: 60 },
        'SeldingerDrain': { label: 'Chest Drain (Seldinger)', effect: { SpO2: 15, BP: 10, RR: -5 }, category: 'Breathing', log: 'Seldinger chest drain inserted.', type: 'continuous', duration: 450 },
        'SurgicalDrain': { label: 'Chest Drain (Surgical)', effect: { SpO2: 15, BP: 10, RR: -5 }, category: 'Breathing', log: 'Surgical chest drain inserted.', type: 'continuous', duration: 600 },

        // --- CIRCULATION ---
        'IV Access': { label: 'IV/IO Access', effect: {}, category: 'Circulation', log: 'IV/IO access secured.', type: 'continuous', duration: 30 },
        'SubclavianLine': { label: 'Central Line (Subclavian)', effect: {}, category: 'Circulation', log: 'Subclavian central line inserted (US guided).', type: 'continuous', duration: 300 },
        'Fluids': { label: 'Fluid Bolus', effect: { BP: 8, HR: -3 }, category: 'Circulation', log: 'Fluid bolus administered.', type: 'bolus', duration: 60 },
        'Blood': { label: 'Blood (O Neg)', effect: { BP: 12, HR: -5 }, category: 'Circulation', log: 'O-Negative Blood administered.', type: 'bolus', duration: 300 },
        'TXA': { label: 'TXA', effect: {}, category: 'Circulation', log: 'IV Tranexamic Acid administered.', type: 'bolus', duration: 60 },
        'AdrenalineIV': { label: 'Adrenaline (IV)', effect: { changeRhythm: 'chance' }, category: 'Circulation', log: 'IV Adrenaline administered.', type: 'bolus', duration: 5 },
        'Amiodarone': { label: 'Amiodarone', effect: { changeRhythm: 'chance' }, category: 'Circulation', log: 'IV Amiodarone administered.', type: 'bolus', duration: 60 },
        'Atropine': { label: 'Atropine', effect: { HR: 20 }, category: 'Circulation', log: 'IV Atropine administered.', type: 'bolus', duration: 10 },
        'Adenosine': { label: 'Adenosine', effect: { HR: 'reset' }, category: 'Circulation', log: 'IV Adenosine rapid bolus administered.', type: 'bolus', duration: 2 },
        'MagSulph': { label: 'Magnesium Sulphate', effect: { BP: -5, RR: -2 }, category: 'Circulation', log: 'IV Magnesium Sulphate administered.', type: 'bolus', duration: 600 },
        'Calcium': { label: 'Calcium Gluconate', effect: { BP: 5 }, category: 'Circulation', log: 'IV Calcium Gluconate administered.', type: 'bolus', duration: 30 },
        'Metaraminol': { label: 'Metaraminol', effect: { BP: 15 }, category: 'Circulation', log: 'IV Metaraminol bolus administered.', type: 'bolus', duration: 10 },
        'GTN': { label: 'GTN Spray', effect: { BP: -8 }, category: 'Circulation', log: 'GTN Spray sublingual administered.', type: 'bolus', duration: 5 },
        'GTNInfusion': { label: 'GTN Infusion', effect: { BP: -20 }, category: 'Circulation', log: 'GTN Infusion started.', type: 'continuous', duration: 300 },
        'Furosemide': { label: 'Furosemide', effect: { BP: -5 }, category: 'Circulation', log: 'IV Furosemide administered.', type: 'bolus', duration: 30 },
        'Labetalol': { label: 'Labetalol', effect: { BP: -15, HR: -5 }, category: 'Circulation', log: 'IV Labetalol administered.', type: 'bolus', duration: 15 },
        'Defib': { label: 'Defibrillation', effect: { changeRhythm: 'defib' }, category: 'Circulation', log: 'Shock Delivered.', type: 'bolus', duration: 5 },
        'Cardioversion': { label: 'Sync Cardioversion', effect: { changeRhythm: 'sync' }, category: 'Circulation', log: 'Synchronised DC Shock delivered.', type: 'bolus', duration: 5 },
        'Pacing': { label: 'External Pacing', effect: { HR: 'pace' }, category: 'Circulation', log: 'External Pacing initiated.', type: 'continuous', duration: 10 },
        'CPR': { label: 'Manual CPR', effect: {}, category: 'Circulation', log: 'CPR in progress (30:2).', type: 'continuous', duration: 5 },
        'Lucas': { label: 'Lucas/AutoPulse', effect: { BP: 30 }, category: 'Circulation', log: 'Mechanical Chest Compression device applied.', type: 'continuous', duration: 30 },
        'Binder': { label: 'Pelvic Binder', effect: { BP: 8 }, category: 'Circulation', log: 'Pelvic binder applied.', type: 'continuous', duration: 60 },
        'Tourniquet': { label: 'Tourniquet', effect: { BP: 5 }, category: 'Circulation', log: 'Tourniquet applied.', type: 'continuous', duration: 10 },
        'Pericardiocentesis': { label: 'Pericardiocentesis', effect: { BP: 20, HR: -10 }, category: 'Circulation', log: 'Pericardiocentesis performed.', type: 'bolus', duration: 30 },
        'Thoracotomy': { label: 'Resus Thoracotomy', effect: { BP: 30, HR: 20 }, category: 'Circulation', log: 'Clamshell Thoracotomy performed. Internal cardiac massage started.', type: 'bolus', duration: 120 },
        'Hysterotomy': { label: 'Resus Hysterotomy', effect: { BP: 15 }, category: 'Circulation', log: 'Perimortem C-Section (Hysterotomy) performed. Baby delivered.', type: 'bolus', duration: 60 },
        'Oxytocin': { label: 'Oxytocin', effect: { BP: -5 }, category: 'Circulation', log: 'IM/IV Oxytocin administered.', type: 'bolus', duration: 10 },
        'Ergometrine': { label: 'Ergometrine', effect: { BP: 15 }, category: 'Circulation', log: 'IM Ergometrine administered.', type: 'bolus', duration: 10 },
        'Carboprost': { label: 'Carboprost', effect: { BP: 5 }, category: 'Circulation', log: 'IM Carboprost administered.', type: 'bolus', duration: 10 },
        'Lipid': { label: 'Intralipid 20%', effect: { BP: 10 }, category: 'Circulation', log: 'Intralipid 20% administered.', type: 'bolus', duration: 60 },

        // --- DISABILITY (Drugs/Neuro) ---
        'Adrenaline': { label: 'Adrenaline (IM)', effect: { HR: 20, BP: 15 }, category: 'Disability', log: 'IM Adrenaline administered.', type: 'bolus', duration: 5 },
        'Analgesia': { label: 'Morphine', effect: { HR: -5, RR: -3, BP: -2 }, category: 'Disability', log: 'IV Morphine administered.', type: 'bolus', duration: 10 },
        'Fentanyl': { label: 'Fentanyl', effect: { HR: -2, RR: -3, BP: -2 }, category: 'Disability', log: 'IV Fentanyl administered.', type: 'bolus', duration: 10 },
        'Paracetamol': { label: 'Paracetamol', effect: {}, category: 'Disability', log: 'IV Paracetamol administered.', type: 'bolus', duration: 10 },
        'Ketamine': { label: 'Ketamine', effect: { gcs: -5, BP: 5, HR: 5 }, category: 'Disability', log: 'IV Ketamine administered.', type: 'bolus', duration: 15 },
        'Midazolam': { label: 'Midazolam', effect: { gcs: -3 }, category: 'Disability', log: 'IV Midazolam administered.', type: 'bolus', duration: 10 },
        'Lorazepam': { label: 'Lorazepam', effect: { gcs: -2 }, category: 'Disability', log: 'IV Lorazepam administered.', type: 'bolus', duration: 10 },
        'Levetiracetam': { label: 'Levetiracetam', effect: {}, category: 'Disability', log: 'IV Levetiracetam administered.', type: 'bolus', duration: 30 },
        'Phenytoin': { label: 'Phenytoin', effect: {}, category: 'Disability', log: 'IV Phenytoin administered.', type: 'bolus', duration: 60 },
        'Naloxone': { label: 'Naloxone', effect: { RR: 10, gcs: 5 }, category: 'Disability', log: 'IV Naloxone administered.', type: 'bolus', duration: 5 },
        'Glucagon': { label: 'Glucagon', effect: { HR: 15, BP: 5 }, category: 'Disability', log: 'IV Glucagon administered.', type: 'bolus', duration: 10 },
        'InsulinDextrose': { label: 'Insulin/Dextrose', effect: { BM: -5 }, category: 'Disability', log: 'Insulin/Dextrose infusion started.', type: 'bolus', duration: 60 },
        'Antibiotics': { label: 'IV Antibiotics', effect: {}, category: 'Disability', log: 'Broad spectrum IV Antibiotics administered.', type: 'bolus', duration: 60 },
        'Aspirin': { label: 'Aspirin', effect: {}, category: 'Disability', log: 'Aspirin PO administered.', type: 'bolus', duration: 10 },
        'Clopidogrel': { label: 'Clopidogrel', effect: {}, category: 'Disability', log: 'Clopidogrel PO administered.', type: 'bolus', duration: 10 },
        'Dexamethasone': { label: 'Dexamethasone', effect: {}, category: 'Disability', log: 'IV Dexamethasone administered.', type: 'bolus', duration: 10 },
        'Hydrocortisone': { label: 'Hydrocortisone', effect: { BP: 5 }, category: 'Disability', log: 'IV Hydrocortisone administered.', type: 'bolus', duration: 10 },
        'Antiemetic': { label: 'Ondansetron', effect: {}, category: 'Disability', log: 'IV Ondansetron administered.', type: 'bolus', duration: 10 },
        'Pabrinex': { label: 'Pabrinex', effect: {}, category: 'Disability', log: 'IV Pabrinex administered.', type: 'bolus', duration: 30 },
        'Heparin': { label: 'LMWH / Heparin', effect: {}, category: 'Disability', log: 'Anticoagulation administered.', type: 'bolus', duration: 10 },
        'Terlipressin': { label: 'Terlipressin', effect: { BP: 5 }, category: 'Disability', log: 'IV Terlipressin administered.', type: 'bolus', duration: 10 },
        'Octreotide': { label: 'Octreotide', effect: {}, category: 'Disability', log: 'IV Octreotide administered.', type: 'bolus', duration: 10 },
        'Roc': { label: 'Rocuronium', effect: { RR: 0, paralysed: true }, category: 'Disability', log: 'IV Rocuronium administered.', type: 'bolus', duration: 10 },
        'Sux': { label: 'Suxamethonium', effect: { RR: 0, paralysed: true }, category: 'Disability', log: 'IV Suxamethonium administered.', type: 'bolus', duration: 10 },
        'Propofol': { label: 'Propofol', effect: { gcs: -5, BP: -10, RR: -5 }, category: 'Disability', log: 'IV Propofol administered.', type: 'bolus', duration: 10 },
        'Bisphosphonate': { label: 'Bisphosphonate', effect: {}, category: 'Disability', log: 'IV Bisphosphonate administered.', type: 'bolus', duration: 60 },
        'T3T4': { label: 'Liothyronine', effect: { HR: 10, BP: 10, Temp: 1 }, category: 'Disability', log: 'IV Liothyronine administered.', type: 'bolus', duration: 60 },
        'Prostin': { label: 'Dinoprostone', effect: { SpO2: 10 }, category: 'Disability', log: 'Prostin infusion started.', type: 'continuous', duration: 60 },
        'Nimodipine': { label: 'Nimodipine', effect: {}, category: 'Disability', log: 'Oral/NG Nimodipine administered.', type: 'bolus', duration: 10 },
        'Desferrioxamine': { label: 'Desferrioxamine', effect: {}, category: 'Disability', log: 'IV Desferrioxamine infusion started.', type: 'continuous', duration: 60 },
        'Fomepizole': { label: 'Fomepizole', effect: {}, category: 'Disability', log: 'IV Fomepizole administered.', type: 'bolus', duration: 30 },
        'Pralidoxime': { label: 'Pralidoxime', effect: {}, category: 'Disability', log: 'IV Pralidoxime administered.', type: 'bolus', duration: 30 },
        'Rasburicase': { label: 'Rasburicase', effect: {}, category: 'Disability', log: 'IV Rasburicase administered.', type: 'bolus', duration: 30 },
        'Dantrolene': { label: 'Dantrolene', effect: { Temp: -1, HR: -5 }, category: 'Disability', log: 'IV Dantrolene administered.', type: 'bolus', duration: 15 },
        'Phentolamine': { label: 'Phentolamine', effect: { BP: -20 }, category: 'Disability', log: 'IV Phentolamine administered.', type: 'bolus', duration: 10 },
        'Digibind': { label: 'Digibind', effect: { HR: 10 }, category: 'Disability', log: 'Digibind administered.', type: 'bolus', duration: 30 },
        'Cyproheptadine': { label: 'Cyproheptadine', effect: {}, category: 'Disability', log: 'NG Cyproheptadine administered.', type: 'bolus', duration: 10 },
        'Acetazolamide': { label: 'Acetazolamide', effect: {}, category: 'Disability', log: 'IV Acetazolamide administered.', type: 'bolus', duration: 10 },
        'Mannitol': { label: 'Mannitol', effect: { gcs: 1 }, category: 'Disability', log: 'IV Mannitol administered.', type: 'bolus', duration: 15 },
        'HypertonicSaline': { label: 'Hypertonic Saline', effect: { BP: 5, gcs: 1 }, category: 'Disability', log: 'Hypertonic Saline administered.', type: 'bolus', duration: 30 },
        'Thrombolysis': { label: 'Thrombolysis', effect: { BP: -5, SpO2: 5 }, category: 'Disability', log: 'Thrombolytic (Alteplase) administered.', type: 'bolus', duration: 60 },
        'Misoprostol': { label: 'Misoprostol', effect: {}, category: 'Disability', log: 'PR Misoprostol administered.', type: 'bolus', duration: 30 },
        'AntiD': { label: 'Anti-D Ig', effect: {}, category: 'Disability', log: 'IM Anti-D administered.', type: 'bolus', duration: 10 },
        'VitaminA': { label: 'Vitamin A', effect: {}, category: 'Disability', log: 'Vitamin A administered.', type: 'bolus', duration: 10 },
        'Rifaximin': { label: 'Rifaximin', effect: {}, category: 'Disability', log: 'Rifaximin administered.', type: 'bolus', duration: 10 },
        'Lactulose': { label: 'Lactulose', effect: {}, category: 'Disability', log: 'Lactulose administered.', type: 'bolus', duration: 60 },
        'Charcoal': { label: 'Activated Charcoal', effect: {}, category: 'Disability', log: 'Activated Charcoal administered.', type: 'bolus', duration: 10 },

        // --- EXPOSURE / PROCEDURES / OTHER ---
        'Splinting': { label: 'Splint Limb', effect: { HR: -2 }, category: 'Exposure', log: 'Limb splinted.', type: 'continuous', duration: 120 },
        'Reduction': { label: 'Reduce Fracture', effect: { HR: -5, BP: -2 }, category: 'Exposure', log: 'Fracture reduction performed.', type: 'bolus', duration: 60 },
        'Plaster': { label: 'Apply Backslab', effect: {}, category: 'Exposure', log: 'Backslab/Plaster applied.', type: 'continuous', duration: 300 },
        'Collar': { label: 'C-Spine Collar', effect: {}, category: 'Exposure', log: 'C-spine collar applied.', type: 'continuous', duration: 30 },
        'Warming': { label: 'Active Warming', effect: { Temp: 1 }, category: 'Exposure', log: 'Bair hugger/Warming blanket applied.', type: 'continuous', duration: 300 },
        'Cooling': { label: 'Active Cooling', effect: { Temp: -1 }, category: 'Exposure', log: 'Active cooling measures started.', type: 'continuous', duration: 300 },
        'Irrigation': { label: 'Eye/Wound Irrigation', effect: {}, category: 'Exposure', log: 'Copious irrigation started.', type: 'continuous', duration: 300 },
        'Escharotomy': { label: 'Escharotomy', effect: { SpO2: 5 }, category: 'Exposure', log: 'Escharotomy performed on chest/limbs.', type: 'bolus', duration: 45 },
        'Surgery': { label: 'Surgical Consult', effect: {}, category: 'Exposure', log: 'Surgeons contacted urgently.', type: 'bolus', duration: 30 },
        'Delivery': { label: 'Emergency Delivery', effect: {}, category: 'Exposure', log: 'Preparation for emergency delivery.', type: 'continuous', duration: 300 },
        'AirEnema': { label: 'Air Enema (Radio)', effect: {}, category: 'Exposure', log: 'Radiology performing Air Enema.', type: 'bolus', duration: 300 },
        'Phototherapy': { label: 'Phototherapy', effect: {}, category: 'Exposure', log: 'Phototherapy initiated.', type: 'continuous', duration: 60 },
        'NerveBlock': { label: 'Fascia Iliaca Block', effect: { HR: -5 }, category: 'Exposure', log: 'Fascia Iliaca Compartment Block performed.', type: 'bolus', duration: 20 },
        'TopicalEyeDrops': { label: 'Topical Eye Drops', effect: {}, category: 'Exposure', log: 'Eye drops applied.', type: 'bolus', duration: 5 },
        'Canthotomy': { label: 'Lat. Canthotomy', effect: {}, category: 'Exposure', log: 'Lateral Canthotomy performed.', type: 'bolus', duration: 20 },
    };
    
    // === SCENARIO DATABASE ---
    const RAW_SCENARIOS = [
      { id: 'AM001', title: 'Acute STEMI', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(45, 75), patientProfileTemplate: "A {age}-year-old {sex}. Crushing chest pain > 1 hr.", presentingComplaint: 'Chest Pain', instructorBrief: { progression: "Classic STEMI. Risk of VF.", interventions: ["PPCI", "Aspirin", "Ticagrelor/Clopidogrel", "Heparin"], learningObjectives: ["Identify STEMI", "Manage ACS"] }, vitalsMod: { hr: 95, bpSys: 145, spO2: 96 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, ecg: { type: "STEMI", findings: "Anterior ST Elevation" }, recommendedActions: ['Obs', 'IV Access', 'Aspirin', 'Clopidogrel', 'GTN', 'Analgesia', 'Oxygen'] },
      { id: 'AM002', title: 'Severe Sepsis (Pneumonia)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(60, 90), patientProfileTemplate: "A {age}-year-old. Productive cough, confusion, fever.", presentingComplaint: 'Confusion & Fever', instructorBrief: { progression: "Septic shock. Needs Sepsis 6.", interventions: ["Oxygen", "Fluids", "Antibiotics"], learningObjectives: ["Sepsis 6", "Fluid Resus"] }, vitalsMod: { hr: 125, bpSys: 85, spO2: 88, temp: 39.2 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, ecg: { type: "Sinus Tachy", findings: "Sinus Tachycardia" }, recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Fluids', 'Antibiotics'] },
      { id: 'AM003', title: 'Acute Severe Asthma', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 40), patientProfileTemplate: "A {age}-year-old asthmatic. Short of breath.", presentingComplaint: 'Dyspnoea', instructorBrief: { progression: "Life threatening. Silent chest.", interventions: ["Nebs", "Magnesium", "Steroids"], learningObjectives: ["Asthma Management"] }, vitalsMod: { hr: 130, bpSys: 110, spO2: 88, rr: 35 }, deterioration: { active: true, rate: 0.08, type: 'respiratory' }, stabilisers: ['Nebs', 'Magnesium'], ecg: { type: "Sinus Tachy", findings: "Sinus Tachycardia" }, recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Nebs', 'Dexamethasone', 'MagSulph'] },
      { id: 'AM004', title: 'Hyperkalaemia (Renal)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "A {age}-year-old dialysis patient. Missed dialysis.", presentingComplaint: 'Weakness', instructorBrief: { progression: "Broad complex bradycardia. Risk of arrest.", interventions: ["Calcium Gluconate", "Insulin/Dextrose"], learningObjectives: ["Hyperkalaemia treatment"] }, vitalsMod: { hr: 40, bpSys: 90, spO2: 95 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, ecg: { type: "Sinus Rhythm", findings: "Broad complex, Tented T waves" }, vbgClinicalState: "hyperkalemia", recommendedActions: ['Obs', 'IV Access', 'Calcium', 'InsulinDextrose', 'Nebs'] },
      { id: 'AM011', title: 'Acute Pulmonary Oedema', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(65, 85), patientProfileTemplate: "A {age}-year-old with heart failure history. Sudden onset severe breathlessness.", presentingComplaint: 'Severe Dyspnoea', instructorBrief: { progression: "Flash pulmonary oedema. Severe respiratory distress.", interventions: ["GTN (SL/IV)", "Furosemide", "CPAP"], learningObjectives: ["Manage acute heart failure", "CPAP Indications"] }, vitalsMod: { hr: 110, bpSys: 180, spO2: 85, rr: 32 }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['GTN', 'GTNInfusion', 'CPAP', 'Furosemide'], ecg: { type: "Sinus Tachy", findings: "Sinus Tachy, LVH" }, recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'CPAP', 'GTN', 'Furosemide'] },
      { id: 'AM012', title: 'COPD Exacerbation (Infective)', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(55, 80), patientProfileTemplate: "A {age}-year-old smoker. 3 days productive cough and increasing wheeze.", presentingComplaint: 'Wheeze & DIB', instructorBrief: { progression: "Type 2 Respiratory Failure. CO2 retainer.", interventions: ["Nebs (Air)", "Steroids", "Antibiotics", "Consider NIV"], learningObjectives: ["Oxygen targets in COPD", "NIV indications"] }, vitalsMod: { hr: 100, bpSys: 130, spO2: 84, rr: 28 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Nebs', 'Dexamethasone', 'NIV'], vbgClinicalState: "copd_retainer", recommendedActions: ['Obs', 'IV Access', 'Nebs', 'Dexamethasone', 'Antibiotics', 'NIV'] },
      { id: 'AM013', title: 'Diabetic Ketoacidosis (DKA)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 35), patientProfileTemplate: "A {age}-year-old Type 1 Diabetic. Vomiting and abdo pain for 24hrs.", presentingComplaint: 'Vomiting & Abdo Pain', instructorBrief: { progression: "Severe metabolic acidosis. Dehydration.", interventions: ["Fluids (0.9% Saline)", "Fixed Rate Insulin", "Potassium Replacement"], learningObjectives: ["DKA Protocol", "Fluid management"] }, vitalsMod: { hr: 115, bpSys: 100, spO2: 97, rr: 28, bm: 26 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, stabilisers: ['Fluids'], vbgClinicalState: "dka_severe", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'InsulinDextrose'] },
      { id: 'AM014', title: 'HHS', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(60, 85), patientProfileTemplate: "A {age}-year-old Type 2 Diabetic. Confused and lethargic over 1 week.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Severe dehydration and hyperosmolality.", interventions: ["Aggressive Fluids", "Conservative Insulin", "LMWH"], learningObjectives: ["HHS vs DKA", "Osmolality"] }, vitalsMod: { hr: 110, bpSys: 95, spO2: 94, rr: 20, gcs: 12, bm: 48 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, stabilisers: ['Fluids'], vbgClinicalState: "hhs", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'InsulinDextrose', 'Heparin'] },
      { id: 'AM015', title: 'Massive Pulmonary Embolism', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 65), patientProfileTemplate: "A {age}-year-old. Recent long haul flight. Sudden collapse and chest pain.", presentingComplaint: 'Collapse & SOB', instructorBrief: { progression: "Obstructive shock. Peri-arrest.", interventions: ["Thrombolysis", "Oxygen", "Fluid (Cautious)"], learningObjectives: ["Massive PE recognition", "Thrombolysis indications"] }, vitalsMod: { hr: 135, bpSys: 80, spO2: 82, rr: 30 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Oxygen'], ecg: { type: "Sinus Tachy", findings: "Sinus Tachy, S1Q3T3, RBBB" }, recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Fluids', 'Thrombolysis'] },
      { id: 'AM016', title: 'Upper GI Bleed (Variceal)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(40, 65), patientProfileTemplate: "A {age}-year-old with chronic liver disease. Vomiting large amounts of fresh blood.", presentingComplaint: 'Haematemesis', instructorBrief: { progression: "Haemorrhagic shock. Airway risk.", interventions: ["Blood Protocol", "Terlipressin", "Antibiotics", "Intubation"], learningObjectives: ["Major Haemorrhage Protocol", "Variceal bleed management"] }, vitalsMod: { hr: 125, bpSys: 85, spO2: 95, rr: 22 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Blood', 'TXA'], vbgClinicalState: "gi_bleed", recommendedActions: ['Obs', 'IV Access', 'Blood', 'TXA', 'Antibiotics', 'Terlipressin', 'RSI'] },
      { id: 'AM017', title: 'Bacterial Meningitis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 30), patientProfileTemplate: "A {age}-year-old student. Severe headache, photophobia, and non-blanching rash.", presentingComplaint: 'Headache & Rash', instructorBrief: { progression: "Septic shock and raised ICP.", interventions: ["IV Ceftriaxone", "Dexamethasone", "Fluids"], learningObjectives: ["Meningitis recognition", "Lumbar Puncture contraindications"] }, vitalsMod: { hr: 120, bpSys: 100, spO2: 98, temp: 39.5, gcs: 13 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Antibiotics', 'Dexamethasone', 'Fluids'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Antibiotics', 'Dexamethasone', 'Fluids'] },
      { id: 'AM018', title: 'Addisonian Crisis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Known Addison's. Vomiting for 2 days. Stopped steroids.", presentingComplaint: 'Collapse', instructorBrief: { progression: "Distributive shock. Hypoglycaemia risk.", interventions: ["IV Hydrocortisone", "Fluids (Saline)", "Dextrose"], learningObjectives: ["Adrenal crisis management", "Steroid sick days"] }, vitalsMod: { hr: 115, bpSys: 80, spO2: 96, bm: 3.2 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Fluids'], vbgClinicalState: "hyponatremia", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Hydrocortisone', 'InsulinDextrose'] },
      { id: 'AM019', title: 'Thyrotoxic Storm', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Agitated, sweating profusely, palpitations.", presentingComplaint: 'Palpitations & Confusion', instructorBrief: { progression: "High output cardiac failure. Hyperthermia.", interventions: ["Beta-blockers", "Fluids", "Cooling", "Carbimazole"], learningObjectives: ["Thyroid storm recognition", "Burch-Wartofsky score"] }, vitalsMod: { hr: 150, bpSys: 160, spO2: 96, temp: 39.8 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, ecg: { type: "AF", findings: "Fast AF" }, recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Labetalol', 'Hydrocortisone', 'Cooling'] },
      { id: 'AM020', title: 'Subarachnoid Haemorrhage', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(40, 60), patientProfileTemplate: "A {age}-year-old. Sudden onset occipital headache 'like being hit with a bat'.", presentingComplaint: 'Thunderclap Headache', instructorBrief: { progression: "Risk of re-bleed and hydrocephalus. Cushing's response.", interventions: ["CT Head", "Nimodipine", "BP Control", "Neuro Obs"], learningObjectives: ["SAH presentation", "Cushing's Triad"] }, vitalsMod: { hr: 55, bpSys: 170, spO2: 98, gcs: 14 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, stabilisers: ['Analgesia'], recommendedActions: ['Obs', 'IV Access', 'Analgesia', 'Labetalol', 'Nimodipine'] },
      { id: 'AM021', title: 'Acute Ischaemic Stroke', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(55, 80), patientProfileTemplate: "A {age}-year-old. Sudden onset right sided weakness and slurred speech 1 hour ago.", presentingComplaint: 'Stroke Symptoms', instructorBrief: { progression: "Time critical. Thrombolysis candidate.", interventions: ["CT Head", "Thrombolysis (if bleed excluded)", "BP Control"], learningObjectives: ["FAST positive", "Thrombolysis window"] }, vitalsMod: { hr: 80, bpSys: 165, spO2: 96, gcs: 13 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, recommendedActions: ['Obs', 'IV Access', 'Aspirin'] },
      { id: 'AM022', title: 'Status Epilepticus (Adult)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Seizing for 15 minutes.", presentingComplaint: 'Seizure', instructorBrief: { progression: "Exhaustion and hypoxia. Refractory status.", interventions: ["Benzodiazepines (Lorazepam)", "Phenytoin/Levetiracetam", "RSI"], learningObjectives: ["Status epilepticus algorithm"] }, vitalsMod: { hr: 130, bpSys: 140, spO2: 88, rr: 10, gcs: 3 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Lorazepam', 'RSI', 'Oxygen'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Lorazepam', 'RSI'] },
      { id: 'AM023', title: 'Complete Heart Block', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(60, 90), patientProfileTemplate: "A {age}-year-old. Collapsed. Feeling dizzy.", presentingComplaint: 'Syncope', instructorBrief: { progression: "Unstable bradycardia. Risk of asystole.", interventions: ["Atropine (Likely ineffective)", "Pacing (External)", "Isoprenaline"], learningObjectives: ["Bradycardia algorithm", "Pacing indications"] }, vitalsMod: { hr: 32, bpSys: 75, spO2: 94 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, stabilisers: ['Pacing', 'Metaraminol'], ecg: { type: "Sinus Rhythm", findings: "3rd Degree AV Block (Dissociation)" }, recommendedActions: ['Obs', 'IV Access', 'Atropine', 'Pacing', 'Metaraminol'] },
      { id: 'AM024', title: 'VT with Pulse', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 75), patientProfileTemplate: "A {age}-year-old. Palpitations and chest tightness.", presentingComplaint: 'Palpitations', instructorBrief: { progression: "Unstable broad complex tachycardia.", interventions: ["Synchronised Cardioversion", "Amiodarone"], learningObjectives: ["Tachycardia algorithm", "Safe cardioversion"] }, vitalsMod: { hr: 170, bpSys: 90, spO2: 95 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, stabilisers: ['Amiodarone', 'Cardioversion'], ecg: { type: "VT", findings: "Monomorphic VT" }, recommendedActions: ['Obs', 'IV Access', 'Amiodarone', 'Cardioversion'] },
      { id: 'AM025', title: 'SVT (Adult)', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Sudden onset racing heart.", presentingComplaint: 'Palpitations', instructorBrief: { progression: "Narrow complex tachycardia.", interventions: ["Vagal Manoeuvres", "Adenosine"], learningObjectives: ["Adenosine administration", "ECG recognition"] }, vitalsMod: { hr: 190, bpSys: 110, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Adenosine'], ecg: { type: "SVT", findings: "SVT" }, recommendedActions: ['Obs', 'IV Access', 'Manoeuvres', 'Adenosine'] },
      { id: 'AM026', title: 'Anaphylaxis (Adult)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Bee sting. Swollen face and difficulty breathing.", presentingComplaint: 'Anaphylaxis', instructorBrief: { progression: "Airway swelling and shock.", interventions: ["IM Adrenaline", "Fluids", "Nebs"], learningObjectives: ["Anaphylaxis algorithm"] }, vitalsMod: { hr: 130, bpSys: 80, spO2: 90, rr: 30 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Adrenaline', 'Fluids', 'Nebs'], recommendedActions: ['Obs', 'IV Access', 'Adrenaline', 'Fluids', 'Nebs', 'Hydrocortisone', 'Chlorphenamine'] },
      { id: 'AM027', title: 'Aortic Dissection (Type A)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 75), patientProfileTemplate: "A {age}-year-old. Tearing chest pain radiating to back.", presentingComplaint: 'Chest Pain', instructorBrief: { progression: "Hypertensive emergency. Risk of rupture.", interventions: ["BP Control (Labetalol)", "Analgesia", "CT Aorta"], learningObjectives: ["Dissection recognition", "BP targets"] }, vitalsMod: { hr: 100, bpSys: 190, spO2: 98 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Labetalol', 'Analgesia'], ecg: { type: "Sinus Rhythm", findings: "NSR" }, recommendedActions: ['Obs', 'IV Access', 'Labetalol', 'Analgesia', 'Surgery'] },
      { id: 'AM028', title: 'Severe Hyponatremia', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(60, 85), patientProfileTemplate: "A {age}-year-old. Confused and vomiting. On diuretics.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Cerebral oedema and seizures.", interventions: ["Hypertonic Saline (if seizing)", "Fluid Restriction"], learningObjectives: ["Hyponatremia correction", "Seizure management"] }, vitalsMod: { hr: 90, bpSys: 130, spO2: 96, gcs: 11 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, vbgClinicalState: "hyponatremia", recommendedActions: ['Obs', 'IV Access', 'HypertonicSaline'] },
      { id: 'AM029', title: 'Ascending Cholangitis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "A {age}-year-old. RUQ pain, fever, and rigors.", presentingComplaint: 'Abdo Pain & Fever', instructorBrief: { progression: "Biliary sepsis (Charcot's Triad).", interventions: ["Antibiotics", "Fluids", "Surgical/ERCP referral"], learningObjectives: ["Sepsis Source", "Charcot's Triad"] }, vitalsMod: { hr: 120, bpSys: 95, spO2: 95, temp: 39.0 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Antibiotics', 'Fluids'], vbgClinicalState: "septic_shock", recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Fluids', 'Analgesia', 'Surgery'] },
      { id: 'AM030', title: 'Community Acquired Pneumonia', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(30, 70), patientProfileTemplate: "A {age}-year-old. 1 week cough, now breathless.", presentingComplaint: 'Cough & DIB', instructorBrief: { progression: "Type 1 Respiratory failure.", interventions: ["Oxygen", "Antibiotics", "Fluids"], learningObjectives: ["CURB-65", "Oxygen therapy"] }, vitalsMod: { hr: 110, bpSys: 115, spO2: 88, rr: 28, temp: 38.5 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Antibiotics', 'Oxygen'], recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Oxygen', 'Fluids'] },
      { id: 'AM031', title: 'Tension Pneumothorax', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Sudden onset pleuritic pain and severe breathlessness. History of Marfan's.", presentingComplaint: 'Severe Dyspnoea', instructorBrief: { progression: "Obstructive shock. Tracheal deviation.", interventions: ["Needle Decompression", "Chest Drain"], learningObjectives: ["Needle Thoracocentesis location", "Obstructive Shock signs"] }, vitalsMod: { hr: 135, bpSys: 75, spO2: 82, rr: 38 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Needle', 'SeldingerDrain', 'FingerThoracostomy'], ecg: { type: "Sinus Tachy", findings: "Sinus Tachycardia" }, recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Needle', 'FingerThoracostomy', 'SurgicalDrain'] },
      { id: 'AM032', title: 'Myxoedema Coma', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(60, 85), patientProfileTemplate: "A {age}-year-old female. Found confused and cold. History of hypothyroidism.", presentingComplaint: 'Confusion & Hypothermia', instructorBrief: { progression: "Profound bradycardia and hypothermia.", interventions: ["T3/T4 (Liothyronine)", "Steroids", "Passive Warming"], learningObjectives: ["Myxoedema recognition", "Warming caution"] }, vitalsMod: { hr: 38, bpSys: 85, spO2: 92, temp: 34.2, gcs: 10 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, stabilisers: ['T3T4', 'Hydrocortisone', 'Warming'], ecg: { type: "Sinus Brady", findings: "Sinus Brady, Low Voltage" }, recommendedActions: ['Obs', 'IV Access', 'T3T4', 'Hydrocortisone', 'Warming'] },
      { id: 'AM033', title: 'Severe Hypercalcaemia', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "A {age}-year-old. 'Bones, stones, groans'. Profound dehydration and confusion.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Renal failure and arrhythmia risk.", interventions: ["Aggressive Fluids", "Bisphosphonates"], learningObjectives: ["Hypercalcaemia management", "Fluid targets"] }, vitalsMod: { hr: 95, bpSys: 100, spO2: 96, gcs: 13 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, stabilisers: ['Fluids', 'Bisphosphonate'], vbgClinicalState: "hypercalcemia", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Bisphosphonate'] },
      { id: 'AM034', title: 'Boerhaave\'s Syndrome', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(40, 60), patientProfileTemplate: "A {age}-year-old. Severe vomiting after alcohol binge, then sudden tearing chest pain.", presentingComplaint: 'Chest Pain', instructorBrief: { progression: "Mackler's Triad. Sepsis/Mediastinitis.", interventions: ["Antibiotics", "Fluids", "Surgical Referral"], learningObjectives: ["Oesophageal rupture signs", "Mackler's Triad"] }, vitalsMod: { hr: 120, bpSys: 100, spO2: 94, rr: 28 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Antibiotics', 'Fluids', 'Surgery'], recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Fluids', 'Surgery', 'Analgesia'] },
      { id: 'AM035', title: 'CO Poisoning', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 80), patientProfileTemplate: "A {age}-year-old. Found in garage with car running. Headache and nausea.", presentingComplaint: 'Headache', instructorBrief: { progression: "False SpO2 reading. Neuro toxicity.", interventions: ["High Flow Oxygen", "Hyperbaric Referral?"], learningObjectives: ["CO half-life", "SpO2 limitations"] }, vitalsMod: { hr: 105, bpSys: 130, spO2: 100, rr: 20, gcs: 14 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, stabilisers: ['Oxygen'], vbgClinicalState: "co_poisoning", recommendedActions: ['Obs', 'IV Access', 'Oxygen'] },
      { id: 'AM036', title: 'Serotonin Syndrome', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Started new antidepressant. Agitated, hyperthermic, clonus.", presentingComplaint: 'Agitation', instructorBrief: { progression: "Hyperthermia and rhabdomyolysis.", interventions: ["Benzodiazepines", "Cooling", "Cyproheptadine"], learningObjectives: ["Serotonin toxicity criteria", "Cooling methods"] }, vitalsMod: { hr: 140, bpSys: 160, spO2: 96, temp: 39.5, gcs: 13 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Midazolam', 'Lorazepam', 'Warming'], recommendedActions: ['Obs', 'IV Access', 'Lorazepam', 'Midazolam', 'Cooling', 'Fluids', 'Cyproheptadine'] },
      { id: 'AM037', title: 'Cholinergic Crisis', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old farmer. Found collapsed near pesticides. SLUDGE symptoms.", presentingComplaint: 'Collapse & Salivation', instructorBrief: { progression: "Bradycardia, Bronchorrhoea. Organophosphate poisoning.", interventions: ["Atropine (High Dose)", "Pralidoxime"], learningObjectives: ["SLUDGE mnemonic", "Atropine dosing"] }, vitalsMod: { hr: 45, bpSys: 90, spO2: 88, rr: 28, pupils: "Pinpoint" }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['Atropine'], recommendedActions: ['Obs', 'IV Access', 'Atropine', 'Suction', 'Oxygen', 'Pralidoxime'] },
      { id: 'AM038', title: 'Guillain-Barr Syndrome', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(30, 70), patientProfileTemplate: "A {age}-year-old. 2 weeks post viral illness. Ascending weakness/paraesthesia.", presentingComplaint: 'Weakness', instructorBrief: { progression: "Respiratory failure due to diaphragm weakness.", interventions: ["FVC Monitoring", "Intubation (Early)"], learningObjectives: ["GBS recognition", "Respiratory monitoring"] }, vitalsMod: { hr: 80, bpSys: 130, spO2: 95, rr: 14 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, recommendedActions: ['Obs', 'IV Access', 'RSI'] },
      { id: 'AM005', title: 'Tricyclic Overdose', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Found with empty Amitriptyline packet.", presentingComplaint: 'Overdose', instructorBrief: { progression: "Anticholinergic toxidrome. Na channel blockade.", interventions: ["Sodium Bicarbonate", "Intubation"], learningObjectives: ["TCA Toxicity", "ECG changes"] }, vitalsMod: { hr: 130, bpSys: 90, spO2: 96, gcs: 10 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, ecg: { type: "Sinus Tachy", findings: "Wide QRS, Dominant R in aVR" }, recommendedActions: ['Obs', 'IV Access', 'Fluids', 'RSI', 'SodiumBicarb'] },
      { id: 'AM006', title: 'Opioid Overdose', category: 'Toxicology', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Found unresponsive. Pinpoint pupils.", presentingComplaint: 'Unresponsive', instructorBrief: { progression: "Respiratory depression.", interventions: ["Naloxone", "Ventilatory Support"], learningObjectives: ["Opioid Toxidrome", "Naloxone dosing"] }, vitalsMod: { hr: 60, bpSys: 100, spO2: 85, rr: 4, gcs: 6 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Naloxone', 'Bagging'], ecg: { type: "Sinus Rhythm", findings: "NSR" }, recommendedActions: ['Obs', 'IV Access', 'Naloxone', 'Bagging', 'Oxygen'] },
      { id: 'AM007', title: 'Paracetamol Overdose', category: 'Toxicology', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(18, 40), patientProfileTemplate: "A {age}-year-old. Took 30g Paracetamol 4 hours ago.", presentingComplaint: 'Overdose', instructorBrief: { progression: "Asymptomatic phase but high risk.", interventions: ["NAC", "Blood Levels"], learningObjectives: ["Paracetamol nomogram", "NAC indications"] }, vitalsMod: { hr: 80, bpSys: 120, spO2: 98, gcs: 15 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Rhythm", findings: "NSR" }, recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Pabrinex'] },
      { id: 'AM008', title: 'Acute Alcohol Withdrawal', category: 'Psychiatric', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old alcoholic. Stopped drinking 2 days ago.", presentingComplaint: 'Tremors & Hallucinations', instructorBrief: { progression: "Delirium Tremens. Seizure risk.", interventions: ["Benzodiazepines", "Pabrinex"], learningObjectives: ["CIWA scoring", "Safe sedation"] }, vitalsMod: { hr: 130, bpSys: 160, spO2: 96, temp: 38.0 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, ecg: { type: "Sinus Tachy", findings: "Sinus Tachycardia" }, recommendedActions: ['Obs', 'IV Access', 'Lorazepam', 'Pabrinex', 'Fluids'] },
      { id: 'AM009', title: 'Psychiatric Emergency (Manic)', category: 'Psychiatric', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Aggressive, flight of ideas.", presentingComplaint: 'Aggression', instructorBrief: { progression: "Risk of violence. Rapid Tranquillisation required.", interventions: ["De-escalation", "Lorazepam/Haloperidol"], learningObjectives: ["Rapid Tranq guidelines", "Mental Capacity Act"] }, vitalsMod: { hr: 110, bpSys: 140, spO2: 99 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Tachy", findings: "NSR" }, recommendedActions: ['Obs', 'IV Access', 'Lorazepam', 'Midazolam'] },
      { id: 'AT001', title: 'Major Trauma (RTC)', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old driver. High speed RTC. Trapped 30 mins.", presentingComplaint: 'Polytrauma', instructorBrief: { progression: "Haemorrhagic shock. Pelvic/Chest injuries.", interventions: ["Binder", "TXA", "Blood"], learningObjectives: ["Major Trauma Call", "Permissive Hypotension"] }, vitalsMod: { hr: 130, bpSys: 80, spO2: 92, rr: 30, gcs: 13 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Blood', 'Binder'], vbgClinicalState: "haemorrhagic_shock", recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Blood', 'TXA', 'Binder', 'Splinting'] },
      { id: 'AT002', title: 'Stab Wound Chest', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 35), patientProfileTemplate: "A {age}-year-old male. Stabbed in right chest.", presentingComplaint: 'Stab Wound', instructorBrief: { progression: "Tension Pneumothorax.", interventions: ["Decompression", "Drain"], learningObjectives: ["Chest decompression"] }, vitalsMod: { hr: 140, bpSys: 70, spO2: 80, rr: 40 }, deterioration: { active: true, rate: 0.2, type: 'arrest' }, stabilisers: ['Needle', 'FingerThoracostomy', 'SurgicalDrain'], chestXray: { findings: "Tension Pneumothorax" }, recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Needle', 'FingerThoracostomy', 'SurgicalDrain', 'Blood'] },
      { id: 'AT003', title: 'Isolated Head Injury', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 60), patientProfileTemplate: "A {age}-year-old. Fell down stairs. GCS dropped.", presentingComplaint: 'Head Injury', instructorBrief: { progression: "Extradural haematoma. Cushing's response.", interventions: ["RSI", "Neuroprotective measures", "CT Head"], learningObjectives: ["Raised ICP management", "Cushing's Triad"] }, vitalsMod: { hr: 50, bpSys: 180, spO2: 96, gcs: 8, pupils: 'Fixed/Dilated R' }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, ecg: { type: "Sinus Brady", findings: "Sinus Bradycardia" }, recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'RSI', 'TXA', 'Collar'] },
      { id: 'AT004', title: 'Burns (Thermal)', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. House fire. 40% TBSA burns.", presentingComplaint: 'Burns', instructorBrief: { progression: "Airway oedema risk. Fluid loss.", interventions: ["Intubation (Early)", "Parkland Fluid"], learningObjectives: ["Burn airway assessment", "Fluid calculation"] }, vitalsMod: { hr: 120, bpSys: 100, spO2: 90, rr: 28, gcs: 15 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Fluids', 'RSI'], recommendedActions: ['Obs', 'IV Access', 'Fluids', 'RSI', 'Analgesia', 'Warming', 'Escharotomy'] },
      { id: 'AT005', title: 'Neurogenic Shock', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Rugby tackle injury. Can't move legs. Priapism.", presentingComplaint: 'Paralysis', instructorBrief: { progression: "Hypotension with Bradycardia (autonomic mismatch).", interventions: ["Vasopressors", "Spinal Immobilisation", "Fluids"], learningObjectives: ["Neurogenic vs Spinal shock", "Vasopressor choice"] }, vitalsMod: { hr: 48, bpSys: 75, spO2: 96, gcs: 15, temp: 35.8 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, stabilisers: ['Metaraminol', 'AdrenalineIV', 'Fluids'], ecg: { type: "Sinus Brady", findings: "Sinus Bradycardia" }, recommendedActions: ['Obs', 'IV Access', 'Metaraminol', 'Fluids', 'Collar', 'Splinting'] },
      { id: 'AT006', title: 'Flail Chest', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Kicked by horse. Paradoxical chest wall movement.", presentingComplaint: 'Chest Pain & DIB', instructorBrief: { progression: "Respiratory failure due to pain/mechanics.", interventions: ["Analgesia (Blocks)", "Oxygen", "NIV?"], learningObjectives: ["Flail chest mechanics", "Pain management importance"] }, vitalsMod: { hr: 110, bpSys: 120, spO2: 91, rr: 28 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Analgesia', 'Fentanyl', 'Oxygen'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Analgesia', 'Fentanyl', 'NerveBlock'] },
      { id: 'AT007', title: 'Penetrating Neck Injury', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 40), patientProfileTemplate: "A {age}-year-old. Stabbed in Zone 2 of neck. Expanding haematoma.", presentingComplaint: 'Stab Wound', instructorBrief: { progression: "Airway compromise. Hard signs of vascular injury.", interventions: ["Early Intubation", "Direct Pressure", "Surgery"], learningObjectives: ["Neck trauma zones", "Hard vs Soft signs"] }, vitalsMod: { hr: 125, bpSys: 95, spO2: 96, rr: 24, gcs: 14 }, deterioration: { active: true, rate: 0.1, type: 'airway' }, stabilisers: ['RSI', 'Surgery', 'Blood'], recommendedActions: ['Obs', 'IV Access', 'RSI', 'Blood', 'Surgery', 'FONA'] },
      { id: 'AT008', title: 'Crush Syndrome', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(25, 55), patientProfileTemplate: "A {age}-year-old worker. Legs trapped under concrete slab for 4 hours.", presentingComplaint: 'Trapped Limb', instructorBrief: { progression: "Reperfusion injury. Hyperkalaemia upon release.", interventions: ["Fluid Loading (Pre-release)", "Calcium/Insulin", "Bicarb"], learningObjectives: ["Crush syndrome physiology", "Hyperkalaemia management"] }, vitalsMod: { hr: 110, bpSys: 100, spO2: 98 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, stabilisers: ['Fluids', 'Calcium', 'InsulinDextrose'], ecg: { type: "Sinus Rhythm", findings: "Peaked T Waves" }, vbgClinicalState: "hyperkalemia", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Calcium', 'InsulinDextrose', 'SodiumBicarb'] },
      { id: 'EL001', title: 'NOF Fracture', category: 'Trauma', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(75, 95), patientProfileTemplate: "A {age}-year-old. Fall from standing. Shortened/Rotated leg.", presentingComplaint: 'Hip Pain', instructorBrief: { progression: "Pain management critical. Check for medical cause of fall.", interventions: ["Fascia Iliaca Block", "Analgesia"], learningObjectives: ["NOF management", "Frailty assessment"] }, vitalsMod: { hr: 90, bpSys: 150, spO2: 95 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Rhythm", findings: "NSR or AF" }, recommendedActions: ['Obs', 'IV Access', 'Analgesia', 'Fentanyl', 'NerveBlock'] },
      { id: 'EL002', title: 'Elderly Sepsis (UTI)', category: 'Medical', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(80, 99), patientProfileTemplate: "A {age}-year-old. Confusion and off legs.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Urosepsis. Subtle presentation.", interventions: ["Antibiotics", "Fluids (Caution)"], learningObjectives: ["Sepsis in elderly", "Delirium"] }, vitalsMod: { hr: 105, bpSys: 100, spO2: 93, temp: 35.8, gcs: 13 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, vbgClinicalState: "septic_shock", recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Fluids', 'Oxygen'] },
      { id: 'EL003', title: 'Subdural Haemorrhage', category: 'Trauma', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(75, 90), patientProfileTemplate: "A {age}-year-old. Minor head bump 2 weeks ago. Now confused.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Chronic Subdural. Slow deterioration.", interventions: ["CT Head", "Reverse Anticoagulation"], learningObjectives: ["Head injury in elderly", "Anticoagulation reversal"] }, vitalsMod: { hr: 70, bpSys: 130, spO2: 96, gcs: 12 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, recommendedActions: ['Obs', 'IV Access', 'VitaminK', 'Octaplex'] },
      { id: 'EL004', title: 'Ruptured AAA', category: 'Medical', ageRange: 'Elderly', acuity: 'Resus', ageGenerator: () => getRandomInt(70, 90), patientProfileTemplate: "A {age}-year-old. Sudden onset severe back pain and collapse.", presentingComplaint: 'Back Pain & Syncope', instructorBrief: { progression: "Catastrophic haemorrhage.", interventions: ["Permissive Hypotension", "Massive Transfusion", "Immediate Theatre"], learningObjectives: ["AAA presentation", "Hypotension targets"] }, vitalsMod: { hr: 110, bpSys: 80, spO2: 94, rr: 24, gcs: 14 }, deterioration: { active: true, rate: 0.2, type: 'shock' }, stabilisers: ['Blood', 'Surgery'], vbgClinicalState: "haemorrhagic_shock", recommendedActions: ['Obs', 'IV Access', 'Blood', 'Surgery', 'Analgesia', 'TXA'] },
      { id: 'EL005', title: 'Severe Hypothermia', category: 'Medical', ageRange: 'Elderly', acuity: 'Resus', ageGenerator: () => getRandomInt(75, 95), patientProfileTemplate: "A {age}-year-old. Found on floor after 12 hours. Cold to touch.", presentingComplaint: 'Collapse', instructorBrief: { progression: "Risk of VF with handling. Coagulopathy.", interventions: ["Passive/Active Warming", "Gentle Handling"], learningObjectives: ["Swiss staging", "Resus modification"] }, vitalsMod: { hr: 40, bpSys: 85, spO2: 90, temp: 29.5, gcs: 9 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, stabilisers: ['Warming'], ecg: { type: "Sinus Brady", findings: "Osborn J Waves" }, vbgClinicalState: "hypothermia", recommendedActions: ['Obs', 'IV Access', 'Warming', 'Fluids'] },
      { id: 'PA001', title: 'Meningococcal Sepsis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 5), patientProfileTemplate: "A {age}-year-old. High fever, purpuric rash.", presentingComplaint: 'Fever & Rash', instructorBrief: { progression: "Septic shock. Rapid decline.", interventions: ["IM/IV Ceftriaxone", "Fluids", "IO Access"], learningObjectives: ["Paeds Sepsis", "IO Access"] }, vitalsMod: { hr: 160, bpSys: 70, spO2: 92, temp: 39.5, rr: 45 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Antibiotics', 'Fluids'], vbgClinicalState: "septic_shock", recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Fluids', 'Oxygen'] },
      { id: 'PA002', title: 'Severe Croup', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 3), patientProfileTemplate: "A {age}-year-old. Barking cough, stridor.", presentingComplaint: 'Stridor', instructorBrief: { progression: "Upper airway obstruction. Keep calm.", interventions: ["Neb Adrenaline", "Dexamethasone"], learningObjectives: ["Croup scoring", "Neb Adrenaline indications"] }, vitalsMod: { hr: 150, bpSys: 95, spO2: 93, rr: 50 }, deterioration: { active: true, rate: 0.08, type: 'respiratory' }, stabilisers: ['NebAdrenaline', 'Dexamethasone'], recommendedActions: ['Obs', 'Oxygen', 'NebAdrenaline', 'Dexamethasone'] },
      { id: 'PA003', title: 'Status Epilepticus', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(2, 10), patientProfileTemplate: "A {age}-year-old. Seizing > 10 mins.", presentingComplaint: 'Seizure', instructorBrief: { progression: "Prolonged seizure. Hypoxia risk.", interventions: ["Midazolam/Lorazepam", "RSI"], learningObjectives: ["APLS Seizure Algorithm"] }, vitalsMod: { hr: 140, bpSys: 100, spO2: 88, rr: 10, gcs: 3 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Midazolam', 'Lorazepam', 'RSI'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Midazolam', 'Lorazepam', 'RSI'] },
      { id: 'PA004', title: 'Anaphylaxis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(4, 12), patientProfileTemplate: "A {age}-year-old. Nut allergy. Swollen lips, wheeze.", presentingComplaint: 'Anaphylaxis', instructorBrief: { progression: "Airway compromise.", interventions: ["IM Adrenaline", "Nebs", "Fluids"], learningObjectives: ["Paeds Anaphylaxis"] }, vitalsMod: { hr: 155, bpSys: 80, spO2: 91, rr: 35 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Adrenaline', 'Nebs'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Adrenaline', 'Nebs', 'Fluids', 'Hydrocortisone'] },
      { id: 'PA005', title: 'Bronchiolitis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => 0, patientProfileTemplate: "A 4-month-old. 3 days coryza. Breathless.", presentingComplaint: 'DIB', instructorBrief: { progression: "Resp failure. Apnoeas.", interventions: ["High Flow/CPAP", "Suction"], learningObjectives: ["Bronchiolitis escalation"] }, vitalsMod: { hr: 170, bpSys: 80, spO2: 86, rr: 65 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, stabilisers: ['Oxygen', 'CPAP', 'NIV'], recommendedActions: ['Obs', 'IV Access', 'Suction', 'Oxygen', 'CPAP', 'Fluids'] },
      { id: 'PA006', title: 'Paediatric DKA', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(6, 16), patientProfileTemplate: "A {age}-year-old. New onset polyuria/polydipsia. Vomiting.", presentingComplaint: 'Vomiting & Lethargy', instructorBrief: { progression: "Severe Acidosis. Cerebral Edema risk.", interventions: ["Slow Fluids", "Insulin (Delay)"], learningObjectives: ["Paeds DKA Fluids", "Cerebral Edema"] }, vitalsMod: { hr: 130, bpSys: 95, spO2: 98, rr: 30, bm: 28 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, vbgClinicalState: "dka_severe", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'InsulinDextrose'] },
      { id: 'PA007', title: 'SVT', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(0, 12), patientProfileTemplate: "A {age}-year-old. Pale, irritable. HR > 220.", presentingComplaint: 'Palpitations/Poor Feeding', instructorBrief: { progression: "Stable vs Unstable SVT.", interventions: ["Vagal Manoeuvres", "Adenosine", "Cardioversion"], learningObjectives: ["Paeds SVT management"] }, vitalsMod: { hr: 240, bpSys: 85, spO2: 95 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, ecg: { type: "SVT", findings: "Narrow Complex Tachycardia > 220bpm" }, recommendedActions: ['Obs', 'IV Access', 'Manoeuvres', 'Adenosine', 'Cardioversion'] },
      { id: 'PA008', title: 'Intussusception', category: 'Medical', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(0, 2), patientProfileTemplate: "A {age}-year-old. Episodic crying, drawing up legs. 'Redcurrant jelly' stool.", presentingComplaint: 'Abdo Pain', instructorBrief: { progression: "Fluid depletion and shock. Bowel ischaemia.", interventions: ["Fluids", "Air Enema (Radiology)", "Surgery"], learningObjectives: ["Intussusception diagnosis", "Fluid resus"] }, vitalsMod: { hr: 160, bpSys: 85, spO2: 98, rr: 35 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, stabilisers: ['Fluids', 'AirEnema', 'Surgery'], recommendedActions: ['Obs', 'IV Access', 'Fluids', 'AirEnema', 'Analgesia', 'Surgery'] },
      { id: 'PA009', title: 'Button Battery Ingestion', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 4), patientProfileTemplate: "A {age}-year-old. Swallowed 'something shiny' 2hrs ago. Hematemesis.", presentingComplaint: 'Haematemesis', instructorBrief: { progression: "Aorto-oesophageal fistula. Catastrophic bleed.", interventions: ["Massive Haemorrhage Protocol", "Theatre"], learningObjectives: ["Button battery time-criticality", "Fistula risk"] }, vitalsMod: { hr: 150, bpSys: 80, spO2: 94, rr: 30 }, deterioration: { active: true, rate: 0.2, type: 'shock' }, stabilisers: ['Blood', 'TXA', 'Surgery'], recommendedActions: ['Obs', 'IV Access', 'Blood', 'TXA', 'Surgery'] },
      { id: 'PA010', title: 'Duct Dependent Collapse', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => 0, patientProfileTemplate: "A 5-day-old neonate. Sudden collapse at home. Pale and mottled.", presentingComplaint: 'Collapse', instructorBrief: { progression: "Closing ductus arteriosus. Cardiac failure.", interventions: ["Prostaglandin (Dinoprostone)", "Intubation", "Fluids"], learningObjectives: ["Neonatal collapse diff dx", "Prostin use"] }, vitalsMod: { hr: 180, bpSys: 55, spO2: 80, rr: 60, bm: 3.5 }, deterioration: { active: true, rate: 0.15, type: 'cardiac' }, stabilisers: ['Prostin', 'Fluids', 'RSI'], ecg: { type: "Sinus Tachy", findings: "Sinus Tachy" }, recommendedActions: ['Obs', 'IV Access', 'Prostin', 'Fluids', 'RSI', 'Antibiotics'] },
      { id: 'PT001', title: 'NAI (Non-Accidental)', category: 'Trauma', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(0, 2), patientProfileTemplate: "A {age}-year-old. 'Fell off sofa'. Bruising to ears/neck.", presentingComplaint: 'Injury', instructorBrief: { progression: "Safeguarding concern. Thorough survey needed.", interventions: ["Skeletal Survey", "Social Services"], learningObjectives: ["Recognising NAI", "Safeguarding"] }, vitalsMod: { hr: 110, bpSys: 90, spO2: 99 }, deterioration: { active: false, rate: 0 }, recommendedActions: ['Obs', 'Analgesia'] },
      { id: 'PT002', title: 'Paediatric Head Injury', category: 'Trauma', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(2, 8), patientProfileTemplate: "A {age}-year-old. Fall 2m onto concrete. Vomiting.", presentingComplaint: 'Head Injury', instructorBrief: { progression: "Intracranial bleed.", interventions: ["CT Head", "Neuroobs", "RSI"], learningObjectives: ["PECARN Rules", "Paeds Head Injury"] }, vitalsMod: { hr: 90, bpSys: 110, spO2: 98, gcs: 13 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, recommendedActions: ['Obs', 'IV Access', 'RSI', 'TXA', 'Oxygen'] },
      { id: 'CA001', title: 'Adult VF Arrest', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "Adult Male. Collapsed. Witnessed.", presentingComplaint: 'Cardiac Arrest', instructorBrief: { progression: "VF Arrest.", interventions: ["CPR", "Shock", "Adrenaline", "Amiodarone"], learningObjectives: ["ALS Algorithm"] }, vitalsMod: { hr: 0, bpSys: 0, spO2: 0, gcs: 3 }, deterioration: { active: false, rate: 0 }, ecg: { type: "VF", findings: "VF" }, recommendedActions: ['Obs', 'CPR', 'Defib', 'AdrenalineIV', 'Amiodarone'] },
      { id: 'CA002', title: 'Paediatric PEA Arrest', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 8), patientProfileTemplate: "Child. Found unresponsive in bed.", presentingComplaint: 'Cardiac Arrest', instructorBrief: { progression: "PEA Arrest. Hypoxia likely cause.", interventions: ["CPR", "Airway", "Adrenaline"], learningObjectives: ["APLS Arrest", "4Hs 4Ts"] }, vitalsMod: { hr: 40, bpSys: 0, spO2: 0, gcs: 3 }, deterioration: { active: false, rate: 0 }, ecg: { type: "PEA", findings: "Slow electrical activity, no pulse" }, recommendedActions: ['Obs', 'CPR', 'AdrenalineIV', 'Bagging', 'Fluids'] },
      { id: 'OB001', title: 'Cord Prolapse', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "38 weeks pregnant. Waters broke. Loop of cord visible.", presentingComplaint: 'Cord Prolapse', instructorBrief: { progression: "Fetal hypoxia. Obstetric emergency.", interventions: ["Elevate presenting part", "Emergency C-Section"], learningObjectives: ["Cord prolapse management"] }, vitalsMod: { hr: 100, bpSys: 120, spO2: 99 }, deterioration: { active: false, rate: 0 }, recommendedActions: ['Obs', 'IV Access', 'Delivery', 'Manoeuvres', 'Oxygen', 'Fluids', 'Surgery'] },
      { id: 'OB002', title: 'Shoulder Dystocia', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "In labour. Head delivered, body stuck.", presentingComplaint: 'Stuck Baby', instructorBrief: { progression: "Turtle sign. Fetal compromise.", interventions: ["McRoberts", "Suprapubic Pressure"], learningObjectives: ["HELPERR Mnemonic"] }, vitalsMod: { hr: 110, bpSys: 130, spO2: 98 }, deterioration: { active: false, rate: 0 }, recommendedActions: ['Obs', 'IV Access', 'Manoeuvres', 'Delivery', 'Oxytocin', 'Analgesia'] },
      { id: 'OB003', title: 'Ruptured Ectopic', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 35), patientProfileTemplate: "A {age}-year-old female. Severe RIF pain and syncope. Positive pregnancy test.", presentingComplaint: 'Abdo Pain & Collapse', instructorBrief: { progression: "Intra-abdominal haemorrhage. Shock.", interventions: ["Blood", "Surgery", "Anti-D"], learningObjectives: ["Ectopic recognition", "Haemorrhage management"] }, vitalsMod: { hr: 130, bpSys: 85, spO2: 98, rr: 24, gcs: 14 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Blood', 'Surgery', 'Fluids'], vbgClinicalState: "haemorrhagic_shock", recommendedActions: ['Obs', 'IV Access', 'Blood', 'Surgery', 'AntiD', 'Fluids', 'Analgesia'] },
      { id: 'OB004', title: 'Eclampsia', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "36 weeks pregnant. Brought in seizing.", presentingComplaint: 'Seizure', instructorBrief: { progression: "Eclamptic seizure. Airway risk.", interventions: ["Magnesium Sulphate", "BP Control", "Delivery"], learningObjectives: ["Eclampsia management", "Mag Sulph dosing"] }, vitalsMod: { hr: 120, bpSys: 170, spO2: 92, rr: 10, gcs: 3 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['MagSulph', 'Labetalol', 'RSI'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'MagSulph', 'Labetalol', 'Delivery', 'RSI'] },
      { id: 'OB005', title: 'Amniotic Fluid Embolism', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "In active labour. Sudden collapse and cyanosis.", presentingComplaint: 'Collapse', instructorBrief: { progression: "Cardiovascular collapse and coagulopathy (DIC).", interventions: ["CPR (if arrest)", "Massive Transfusion", "Perimortem C-Section?"], learningObjectives: ["AFE recognition", "Maternal arrest modification"] }, vitalsMod: { hr: 150, bpSys: 60, spO2: 75, rr: 35, gcs: 8 }, deterioration: { active: true, rate: 0.2, type: 'shock' }, stabilisers: ['Blood', 'TXA', 'Delivery'], recommendedActions: ['Obs', 'IV Access', 'Blood', 'TXA', 'Delivery', 'CPR', 'Hysterotomy'] },
      { id: 'AM039', title: 'Pericardial Tamponade', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. 2 weeks post-viral illness. Severe dyspnoea and chest heaviness.", presentingComplaint: 'Dyspnoea & Syncope', instructorBrief: { progression: "Beck's Triad. Obstructive Shock.", interventions: ["Fluids (Temporising)", "Pericardiocentesis", "Surgery"], learningObjectives: ["Beck's Triad", "Electrical Alternans"] }, vitalsMod: { hr: 130, bpSys: 85, spO2: 92, rr: 30 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Pericardiocentesis', 'Surgery'], ecg: { type: "Sinus Tachy", findings: "Small voltages, Electrical Alternans" }, recommendedActions: ['Obs', 'IV Access', 'Pericardiocentesis', 'Fluids', 'Surgery'] },
      { id: 'AM040', title: 'Wellens Syndrome', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(45, 65), patientProfileTemplate: "A {age}-year-old. Had chest pain earlier, now pain free.", presentingComplaint: 'Resolved Chest Pain', instructorBrief: { progression: "Critical LAD stenosis. Risk of massive anterior MI if stressed.", interventions: ["Aspirin", "PPCI Referral (Urgent)", "Avoid Stress Test"], learningObjectives: ["Wellens ECG signs", "Do not exercise test"] }, vitalsMod: { hr: 70, bpSys: 130, spO2: 98 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Rhythm", findings: "Deeply inverted T waves V2-V3 (Type B)" }, recommendedActions: ['Obs', 'IV Access', 'Aspirin', 'Clopidogrel'] },
      { id: 'AM041', title: 'Massive Haemoptysis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 75), patientProfileTemplate: "A {age}-year-old smoker. Coughing up cup-fulls of bright red blood.", presentingComplaint: 'Haemoptysis', instructorBrief: { progression: "Airway obstruction and hypovolaemia.", interventions: ["Intubation (Large tube)", "Lay on affected side", "TXA"], learningObjectives: ["Bronchial artery anatomy", "Positioning"] }, vitalsMod: { hr: 125, bpSys: 100, spO2: 88, rr: 28 }, deterioration: { active: true, rate: 0.15, type: 'airway' }, stabilisers: ['RSI', 'TXA'], recommendedActions: ['Obs', 'IV Access', 'RSI', 'TXA', 'Blood', 'Suction', 'Oxygen'] },
      { id: 'AM042', title: 'Brugada Syndrome', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(25, 45), patientProfileTemplate: "A {age}-year-old. Syncope while resting/sleeping. Family history of sudden death.", presentingComplaint: 'Syncope', instructorBrief: { progression: "Risk of polymorphic VT/VF.", interventions: ["Avoid fever/certain drugs", "Cardiology Referral", "ICD consideration"], learningObjectives: ["Brugada ECG types", "Sodium channel blockers"] }, vitalsMod: { hr: 75, bpSys: 120, spO2: 99 }, deterioration: { active: false, rate: 0 }, ecg: { type: "Sinus Rhythm", findings: "Coved ST elevation V1-V2 (Type 1)" }, recommendedActions: ['Obs', 'IV Access'] },
      { id: 'AM043', title: 'Myasthenia Gravis Crisis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old with Myasthenia Gravis. Increasing shortness of breath and swallowing difficulty.", presentingComplaint: 'Dyspnoea & Weakness', instructorBrief: { progression: "Type 2 Respiratory Failure (Neuromuscular).", interventions: ["NIV", "Intubation", "IVIG/Plasma Exchange"], learningObjectives: ["FVC monitoring", "Cholinergic vs Myasthenic"] }, vitalsMod: { hr: 110, bpSys: 140, spO2: 92, rr: 30 }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['NIV', 'RSI'], recommendedActions: ['Obs', 'IV Access', 'NIV', 'RSI'] },
      { id: 'AM044', title: 'Vertebral Artery Dissection', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(25, 45), patientProfileTemplate: "A {age}-year-old. Neck pain after yoga/chiropractor. Vertigo and ataxia.", presentingComplaint: 'Neck Pain & Dizziness', instructorBrief: { progression: "Posterior circulation stroke.", interventions: ["CT Angiogram", "Antiplatelets/Anticoagulation"], learningObjectives: ["Dissection risk factors", "Cerebellar signs"] }, vitalsMod: { hr: 80, bpSys: 145, spO2: 98, gcs: 14 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, recommendedActions: ['Obs', 'IV Access', 'Aspirin', 'Analgesia'] },
      { id: 'AM045', title: 'Phaeochromocytoma Crisis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Sudden thunderclap headache, palpitations, profuse sweating.", presentingComplaint: 'Headache', instructorBrief: { progression: "Hypertensive crisis. End organ damage.", interventions: ["Alpha Blockers (Phentolamine)", "Beta Blockers (AFTER Alpha)"], learningObjectives: ["Alpha before Beta rule", "Catecholamine surge"] }, vitalsMod: { hr: 160, bpSys: 240, bpDia: 130, spO2: 96 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, stabilisers: ['Labetalol', 'MagSulph'], recommendedActions: ['Obs', 'IV Access', 'Labetalol', 'MagSulph', 'Phentolamine'] },
      { id: 'AM046', title: 'Pituitary Apoplexy', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Sudden severe headache and visual loss (bitemporal).", presentingComplaint: 'Headache & Blindness', instructorBrief: { progression: "Adrenal insufficiency and mass effect.", interventions: ["Hydrocortisone", "Urgent Neurosurgery"], learningObjectives: ["Pituitary anatomy", "Steroid replacement"] }, vitalsMod: { hr: 110, bpSys: 90, spO2: 98, gcs: 14 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, stabilisers: ['Hydrocortisone', 'Surgery'], recommendedActions: ['Obs', 'IV Access', 'Hydrocortisone', 'Surgery', 'Fluids'] },
      { id: 'AM047', title: 'Ludwig\'s Angina', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Dental abscess. 'Hot potato' voice, woody neck swelling.", presentingComplaint: 'Sore Throat & Swelling', instructorBrief: { progression: "Airway obstruction.", interventions: ["Antibiotics", "Awake Fibreoptic Intubation", "Surgical Airway"], learningObjectives: ["Airway assessment", "FONA anticipation"] }, vitalsMod: { hr: 120, bpSys: 130, spO2: 94, rr: 26, temp: 39.0 }, deterioration: { active: true, rate: 0.15, type: 'airway' }, stabilisers: ['Antibiotics', 'RSI'], recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'NebAdrenaline', 'Dexamethasone', 'RSI', 'FONA'] },
      { id: 'AM048', title: 'Severe Malaria', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 60), patientProfileTemplate: "A {age}-year-old. Returned from Kenya 1 week ago. Flu-like symptoms, now confused.", presentingComplaint: 'Fever & Confusion', instructorBrief: { progression: "Cerebral Malaria. Haemolysis.", interventions: ["Artesunate/Quinine", "Fluids", "Glucose"], learningObjectives: ["Travel history", "Parasitaemia"] }, vitalsMod: { hr: 130, bpSys: 90, spO2: 92, temp: 40.2, gcs: 11 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Antibiotics', 'Fluids'], vbgClinicalState: "metabolic_acidosis_severe", recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Fluids', 'InsulinDextrose'] },
      { id: 'AM049', title: 'Necrotising Fasciitis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(40, 70), patientProfileTemplate: "A {age}-year-old. Minor scratch on leg. Now severe pain out of proportion to exam.", presentingComplaint: 'Leg Pain', instructorBrief: { progression: "Rapid spread. Septic shock.", interventions: ["Immediate Surgery (Debridement)", "Broad Spectrum Abx"], learningObjectives: ["LRINEC Score", "Pain out of proportion"] }, vitalsMod: { hr: 140, bpSys: 85, spO2: 94, temp: 39.5 }, deterioration: { active: true, rate: 0.2, type: 'shock' }, stabilisers: ['Surgery', 'Antibiotics'], vbgClinicalState: "septic_shock", recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Antibiotics', 'Fluids', 'Analgesia'] },
      { id: 'TX001', title: 'Beta-Blocker Overdose', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Took 2 months supply of Bisoprolol.", presentingComplaint: 'Overdose', instructorBrief: { progression: "Profound bradycardia and shock.", interventions: ["Glucagon", "High Dose Insulin", "Lipid Emulsion"], learningObjectives: ["HDI protocol", "Glucagon dosing"] }, vitalsMod: { hr: 35, bpSys: 65, spO2: 94, gcs: 12, bm: 3.5 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, stabilisers: ['Glucagon', 'InsulinDextrose', 'Pacing'], ecg: { type: "Sinus Brady", findings: "Severe Bradycardia, 1st deg block" }, recommendedActions: ['Obs', 'IV Access', 'Glucagon', 'InsulinDextrose', 'Lipid', 'Pacing'] },
      { id: 'TX002', title: 'Digoxin Toxicity', category: 'Toxicology', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(70, 90), patientProfileTemplate: "A {age}-year-old. Confused, vomiting, seeing yellow halos.", presentingComplaint: 'Confusion & Vomiting', instructorBrief: { progression: "Arrhythmias (Bidirectional VT).", interventions: ["Digibind (Fab fragments)", "Magnesium", "Atropine"], learningObjectives: ["Digoxin ECG effects", "Salvador Dali moustache"] }, vitalsMod: { hr: 45, bpSys: 100, spO2: 96 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, ecg: { type: "Sinus Brady", findings: "Reverse tick appearance, frequent VEs" }, recommendedActions: ['Obs', 'IV Access', 'Atropine', 'MagSulph', 'Digibind'] },
      { id: 'TX003', title: 'Iron Overdose', category: 'Toxicology', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(2, 6), patientProfileTemplate: "A {age}-year-old. Ate 'red sweets' (Ferrous Sulphate) 4 hours ago. Vomiting blood.", presentingComplaint: 'Haematemesis', instructorBrief: { progression: "Corrosive GI injury. Severe metabolic acidosis.", interventions: ["Desferrioxamine", "Whole Bowel Irrigation"], learningObjectives: ["Iron toxicity stages", "Opaque pills on X-ray"] }, vitalsMod: { hr: 150, bpSys: 80, spO2: 95, rr: 40 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, vbgClinicalState: "metabolic_acidosis_severe", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Lactulose', 'Desferrioxamine'] },
      { id: 'TX004', title: 'Local Anaesthetic Toxicity', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Had nerve block. Now ringing in ears and perioral numbness.", presentingComplaint: 'Tinnitus & Numbness', instructorBrief: { progression: "Seizures then Cardiac Arrest (LAST).", interventions: ["Intralipid 20%", "Stop injection"], learningObjectives: ["LAST protocol", "Lipid dosing"] }, vitalsMod: { hr: 110, bpSys: 140, spO2: 99 }, deterioration: { active: true, rate: 0.15, type: 'neuro' }, stabilisers: ['Lipid', 'Midazolam'], recommendedActions: ['Obs', 'IV Access', 'Lipid', 'Midazolam', 'Oxygen'] },
      { id: 'TX005', title: 'Ethylene Glycol', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Drank antifreeze. Appears drunk but breath smells sweet.", presentingComplaint: 'Intoxication', instructorBrief: { progression: "High anion gap acidosis. Renal failure.", interventions: ["Fomepizole/Ethanol", "Dialysis"], learningObjectives: ["Osmolar gap", "Wood's lamp urine"] }, vitalsMod: { hr: 100, bpSys: 130, spO2: 96, rr: 28 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, vbgClinicalState: "metabolic_acidosis_severe", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Fomepizole'] },
      { id: 'AT009', title: 'Traumatic Amputation', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Industrial accident. Hand amputated at wrist.", presentingComplaint: 'Amputation', instructorBrief: { progression: "Exsanguination.", interventions: ["Tourniquet", "Direct Pressure", "Stump retrieval"], learningObjectives: ["Tourniquet application", "Amputated part care"] }, vitalsMod: { hr: 130, bpSys: 90, spO2: 98 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Blood', 'TXA', 'Surgery'], recommendedActions: ['Obs', 'IV Access', 'Blood', 'TXA', 'Surgery', 'Analgesia', 'Tourniquet'] },
      { id: 'AT010', title: 'Compartment Syndrome', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Tib/Fib fracture 4 hours ago (casted). Increasing severe pain.", presentingComplaint: 'Leg Pain', instructorBrief: { progression: "Ischaemia and necrosis.", interventions: ["Split Cast/Dressings", "Fasciotomy"], learningObjectives: ["6 Ps of ischaemia", "Pain on passive stretch"] }, vitalsMod: { hr: 110, bpSys: 140, spO2: 99 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Surgery', 'Analgesia'], recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Analgesia'] },
      { id: 'AT011', title: 'Electrical Injury', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old electrician. Thrown across room by high voltage.", presentingComplaint: 'Electrocution', instructorBrief: { progression: "Rhabdomyolysis and arrhythmias.", interventions: ["ECG Monitoring", "Fluid (high target)", "CK check"], learningObjectives: ["AC vs DC injury", "Fluid targets in burns"] }, vitalsMod: { hr: 120, bpSys: 130, spO2: 98, ecg: "Ectopics" }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, ecg: { type: "AF", findings: "Irregular with burns evident" }, recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Analgesia'] },
      { id: 'AT012', title: 'Suspension Trauma', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(25, 55), patientProfileTemplate: "A {age}-year-old climber. Stuck in harness for 2 hours. Conscious.", presentingComplaint: 'Leg Numbness', instructorBrief: { progression: "Reflow syndrome/Cardiac arrest upon lying flat.", interventions: ["Sit up/crouch", "Gradual recline", "Fluids"], learningObjectives: ["Suspension syncope", "Rescue death"] }, vitalsMod: { hr: 115, bpSys: 90, spO2: 96 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, recommendedActions: ['Obs', 'IV Access', 'Fluids'] },
      { id: 'AT013', title: 'Open Chest Wound', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Stabbed chest. Bubbling wound.", presentingComplaint: 'Stab Wound', instructorBrief: { progression: "Sucking chest wound. Pneumothorax.", interventions: ["3-sided dressing", "Chest Drain"], learningObjectives: ["Occlusive dressing logic", "Drain insertion"] }, vitalsMod: { hr: 130, bpSys: 95, spO2: 88, rr: 32 }, deterioration: { active: true, rate: 0.15, type: 'respiratory' }, stabilisers: ['SeldingerDrain', 'SurgicalDrain'], recommendedActions: ['Obs', 'IV Access', 'SurgicalDrain', 'Oxygen', 'Analgesia', 'SeldingerDrain'] },
      { id: 'PA011', title: 'Kawasaki Disease', category: 'Medical', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(2, 5), patientProfileTemplate: "A {age}-year-old. Fever > 5 days. Strawberry tongue, peeling fingers.", presentingComplaint: 'Fever & Rash', instructorBrief: { progression: "Coronary artery aneurysms.", interventions: ["IVIG", "Aspirin (High dose)", "Echo"], learningObjectives: ["CRASH and Burn criteria", "Aspirin in paeds"] }, vitalsMod: { hr: 140, bpSys: 95, spO2: 98, temp: 39.5 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Paracetamol'], recommendedActions: ['Obs', 'IV Access', 'Aspirin', 'Fluids', 'Analgesia'] },
      { id: 'PA012', title: 'Sickle Cell Crisis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(5, 12), patientProfileTemplate: "A {age}-year-old. Known Sickle Cell. Severe chest pain and hypoxia.", presentingComplaint: 'Chest Pain', instructorBrief: { progression: "Acute Chest Syndrome.", interventions: ["Oxygen", "Opioids", "Antibiotics", "Exchange Transfusion"], learningObjectives: ["Acute Chest recognition", "Analgesia ladder"] }, vitalsMod: { hr: 150, bpSys: 100, spO2: 85, rr: 40 }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['Oxygen', 'Analgesia', 'Antibiotics'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'Analgesia', 'Antibiotics', 'Fluids'] },
      { id: 'PA013', title: 'Foreign Body Aspiration', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(2, 4), patientProfileTemplate: "A {age}-year-old. Playing with lego. Sudden onset cough/stridor.", presentingComplaint: 'Choking', instructorBrief: { progression: "Total obstruction. Arrest.", interventions: ["Back blows", "Magill's forceps", "RSI (Push tube)"], learningObjectives: ["Choking algorithm", "Unilateral wheeze"] }, vitalsMod: { hr: 160, bpSys: 90, spO2: 88, rr: 45 }, deterioration: { active: true, rate: 0.2, type: 'airway' }, stabilisers: ['Manoeuvres'], recommendedActions: ['Obs', 'Oxygen', 'Manoeuvres', 'RSI', 'Magills'] },
      { id: 'PA014', title: 'Testicular Torsion', category: 'Medical', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(10, 16), patientProfileTemplate: "A {age}-year-old. Sudden severe groin pain and vomiting.", presentingComplaint: 'Testicular Pain', instructorBrief: { progression: "Ischaemia/Loss of testis.", interventions: ["Urgent Urology/Surgery", "Analgesia"], learningObjectives: ["Time to theatre (<6hrs)", "Do not wait for Ultrasound"] }, vitalsMod: { hr: 110, bpSys: 120, spO2: 99 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Surgery', 'Analgesia'], recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Analgesia'] },
      { id: 'PA015', title: 'Septic Arthritis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(3, 8), patientProfileTemplate: "A {age}-year-old. High fever. Refusing to walk on right leg.", presentingComplaint: 'Limp & Fever', instructorBrief: { progression: "Joint destruction. Sepsis.", interventions: ["IV Antibiotics", "Orthopaedic Washout", "Kocher's Criteria"], learningObjectives: ["Kocher's Criteria", "Transient synovitis diff dx"] }, vitalsMod: { hr: 130, bpSys: 100, spO2: 98, temp: 39.2 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, stabilisers: ['Antibiotics', 'Surgery'], recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Surgery', 'Analgesia'] },
      { id: 'OB006', title: 'Postpartum Haemorrhage', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Just delivered baby. Continuous heavy bleeding.", presentingComplaint: 'Haemorrhage', instructorBrief: { progression: "Major Haemorrhage (4 Ts).", interventions: ["Uterine Massage", "Oxytocin/Ergometrine", "TXA", "MTP"], learningObjectives: ["4 Ts of PPH", "Bimanual compression"] }, vitalsMod: { hr: 140, bpSys: 70, spO2: 94, rr: 28 }, deterioration: { active: true, rate: 0.2, type: 'shock' }, stabilisers: ['Oxytocin', 'Ergometrine', 'Blood', 'TXA'], vbgClinicalState: "haemorrhagic_shock", recommendedActions: ['Obs', 'IV Access', 'Oxytocin', 'Ergometrine', 'Blood', 'TXA', 'Carboprost'] },
      { id: 'OB007', title: 'Ovarian Torsion', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 35), patientProfileTemplate: "A {age}-year-old. Sudden onset severe unilateral iliac fossa pain. Vomiting.", presentingComplaint: 'Abdo Pain', instructorBrief: { progression: "Ovarian ischaemia.", interventions: ["Analgesia", "Gynae Referral (Laparoscopy)"], learningObjectives: ["Ultrasound utility", "Torsion risk factors"] }, vitalsMod: { hr: 115, bpSys: 130, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Surgery', 'Analgesia'], recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Analgesia'] },
      { id: 'OB008', title: 'Peripartum Cardiomyopathy', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(25, 40), patientProfileTemplate: "A {age}-year-old. 1 week post-partum. Severe orthopnoea and pedal oedema.", presentingComplaint: 'Heart Failure', instructorBrief: { progression: "Acute Pulmonary Oedema/Cardiogenic Shock.", interventions: ["Diuretics", "GTN", "Echo"], learningObjectives: ["PPCM diagnosis", "Fluid management in failure"] }, vitalsMod: { hr: 125, bpSys: 140, spO2: 88, rr: 30 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, stabilisers: ['Furosemide', 'GTN', 'CPAP'], ecg: { type: "Sinus Tachy", findings: "Global T wave inversion" }, recommendedActions: ['Obs', 'IV Access', 'Furosemide', 'GTN', 'CPAP', 'Oxygen'] },
      { id: 'EL006', title: 'Acute Mesenteric Ischaemia', category: 'Medical', ageRange: 'Elderly', acuity: 'Resus', ageGenerator: () => getRandomInt(75, 90), patientProfileTemplate: "A {age}-year-old with AF. Generalised abdo pain. Lactate 6.0.", presentingComplaint: 'Severe Abdo Pain', instructorBrief: { progression: "Bowel necrosis and perforation.", interventions: ["Surgery/IR", "Antibiotics", "Heparin"], learningObjectives: ["Pain out of proportion", "Lactate significance"] }, vitalsMod: { hr: 120, bpSys: 100, spO2: 94, rr: 26 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Surgery', 'Antibiotics'], vbgClinicalState: "metabolic_acidosis_severe", recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Antibiotics', 'Fluids', 'Analgesia', 'Heparin'] },
      { id: 'EL007', title: 'Temporal Arteritis', category: 'Medical', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(70, 85), patientProfileTemplate: "A {age}-year-old. Severe temporal headache and jaw claudication.", presentingComplaint: 'Headache', instructorBrief: { progression: "Permanent blindness (Ischaemic optic neuropathy).", interventions: ["High Dose Steroids (Prednisolone)", "Ophthalmology/Rheum"], learningObjectives: ["GCA symptoms", "Steroid urgency"] }, vitalsMod: { hr: 80, bpSys: 140, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Dexamethasone', 'Hydrocortisone'], recommendedActions: ['Obs', 'IV Access', 'Dexamethasone', 'Analgesia'] },
      { id: 'AM050', title: 'Severe Acute Pancreatitis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Severe epigastric pain radiating to back. Alcohol history.", presentingComplaint: 'Epigastric Pain', instructorBrief: { progression: "SIRS response. Hypocalcaemia. ARDS risk.", interventions: ["Aggressive Fluids", "Analgesia", "Calcium (if low)"], learningObjectives: ["Glasgow Score for Pancreatitis", "Fluid sequestration"] }, vitalsMod: { hr: 125, bpSys: 100, spO2: 94, rr: 24, temp: 38.2 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Fluids', 'Analgesia'], vbgClinicalState: "metabolic_acidosis_severe", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Analgesia', 'Calcium'] },
      { id: 'AM051', title: 'Hepatic Encephalopathy', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(45, 70), patientProfileTemplate: "A {age}-year-old with cirrhosis. Found confused and flapping tremor.", presentingComplaint: 'Confusion', instructorBrief: { progression: "Risk of airway compromise and cerebral oedema.", interventions: ["Lactulose (Enema)", "Rifaximin", "Treat precipitant"], learningObjectives: ["Ammonia levels", "West Haven Criteria"] }, vitalsMod: { hr: 90, bpSys: 110, spO2: 96, gcs: 12 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, stabilisers: ['Lactulose'], recommendedActions: ['Obs', 'IV Access', 'Lactulose', 'Fluids', 'Rifaximin'] },
      { id: 'AM052', title: 'Spontaneous Bacterial Peritonitis', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(40, 65), patientProfileTemplate: "A {age}-year-old with ascites. Abdominal pain and fever.", presentingComplaint: 'Abdo Pain & Fever', instructorBrief: { progression: "Septic shock.", interventions: ["Ascitic Tap (Urgent)", "IV Albumin", "Antibiotics"], learningObjectives: ["SBP diagnosis (Neutrophils >250)", "Albumin indications"] }, vitalsMod: { hr: 115, bpSys: 95, spO2: 95, temp: 38.5 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Antibiotics', 'Fluids'], vbgClinicalState: "septic_shock", recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Fluids', 'Analgesia'] },
      { id: 'AM053', title: 'Infective Endocarditis', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(25, 60), patientProfileTemplate: "A {age}-year-old IVDU. 3 weeks fever, new murmur, malaise.", presentingComplaint: 'Fever & SOB', instructorBrief: { progression: "Valve failure and heart failure. Embolic events.", interventions: ["Blood Cultures x3", "Antibiotics", "Echo"], learningObjectives: ["Duke Criteria", "Embolic phenomena"] }, vitalsMod: { hr: 110, bpSys: 110, spO2: 93, temp: 39.0 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, stabilisers: ['Antibiotics', 'Oxygen'], recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Oxygen', 'Fluids'] },
      { id: 'AM054', title: 'Severe Aortic Stenosis', category: 'Medical', ageRange: 'Elderly', acuity: 'Resus', ageGenerator: () => getRandomInt(75, 90), patientProfileTemplate: "A {age}-year-old. Collapsed on exertion. Systolic murmur.", presentingComplaint: 'Syncope', instructorBrief: { progression: "Cardiogenic shock. Pre-load dependent.", interventions: ["Cautious Fluids", "Treat Arrhythmia", "Avoid GTN"], learningObjectives: ["Fixed output state", "Medications to avoid"] }, vitalsMod: { hr: 90, bpSys: 95, spO2: 94 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, ecg: { type: "Sinus Rhythm", findings: "LVH with Strain" }, recommendedActions: ['Obs', 'IV Access', 'Fluids'] },
      { id: 'AM055', title: 'HOCM Arrest', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 30), patientProfileTemplate: "A {age}-year-old athlete. Collapsed mid-game.", presentingComplaint: 'Cardiac Arrest', instructorBrief: { progression: "VF Arrest. Post-ROSC care critical.", interventions: ["Defibrillation", "Amiodarone", "Cooling"], learningObjectives: ["Hypertrophic Cardiomyopathy", "Screening family"] }, vitalsMod: { hr: 0, bpSys: 0, spO2: 0, gcs: 3 }, deterioration: { active: false, rate: 0 }, ecg: { type: "VF", findings: "VF -> Deep Q waves post ROSC" }, recommendedActions: ['Obs', 'CPR', 'Defib', 'AdrenalineIV', 'Amiodarone'] },
      { id: 'AM056', title: 'Pre-excited AF (WPW)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Palpitations. Known WPW.", presentingComplaint: 'Palpitations', instructorBrief: { progression: "Irregular Broad Complex Tachycardia. Risk of VF.", interventions: ["DC Cardioversion", "Procainamide/Flecainide", "AVOID Adenosine/Blockers"], learningObjectives: ["FBI (Fast Broad Irregular)", "Contraindicated drugs"] }, vitalsMod: { hr: 180, bpSys: 90, spO2: 96 }, deterioration: { active: true, rate: 0.2, type: 'cardiac' }, ecg: { type: "AF", findings: "Irregular Broad Complex Tachycardia" }, recommendedActions: ['Obs', 'IV Access', 'Cardioversion', 'Amiodarone'] },
      { id: 'AM057', title: 'Acute Angle Closure Glaucoma', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "A {age}-year-old. Severe eye pain, vomiting, halos around lights.", presentingComplaint: 'Eye Pain & Vomiting', instructorBrief: { progression: "Permanent vision loss.", interventions: ["Acetazolamide", "Timolol/Pilocarpine", "Ophthalmology"], learningObjectives: ["Fixed mid-dilated pupil", "IOP reduction"] }, vitalsMod: { hr: 90, bpSys: 140, spO2: 98, pupils: "Fixed Mid-dilated R" }, deterioration: { active: false, rate: 0 }, stabilisers: ['Analgesia'], recommendedActions: ['Obs', 'IV Access', 'Analgesia', 'Antiemetic', 'Acetazolamide', 'TopicalEyeDrops'] },
      { id: 'AM058', title: 'Central Retinal Artery Occlusion', category: 'Medical', ageRange: 'Elderly', acuity: 'Majors', ageGenerator: () => getRandomInt(65, 85), patientProfileTemplate: "A {age}-year-old. Sudden painless loss of vision in one eye.", presentingComplaint: 'Vision Loss', instructorBrief: { progression: "Retinal infarction. Stroke workup needed.", interventions: ["Ocular Massage", "Timolol/Acetazolamide", "Stroke Team"], learningObjectives: ["Cherry red spot", "Embolic source"] }, vitalsMod: { hr: 75, bpSys: 150, spO2: 98 }, deterioration: { active: false, rate: 0 }, recommendedActions: ['Obs', 'IV Access', 'TopicalEyeDrops', 'Acetazolamide'] },
      { id: 'AM059', title: 'Adult Epiglottitis', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Severe sore throat, drooling, leaning forward.", presentingComplaint: 'Stridor & Drooling', instructorBrief: { progression: "Complete airway obstruction.", interventions: ["Neb Adrenaline", "Dexamethasone", "Awake Fibreoptic"], learningObjectives: ["Never examine throat", "Airway strategy"] }, vitalsMod: { hr: 120, bpSys: 130, spO2: 94, rr: 28, temp: 38.8 }, deterioration: { active: true, rate: 0.2, type: 'airway' }, stabilisers: ['NebAdrenaline', 'Dexamethasone', 'RSI'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'NebAdrenaline', 'Dexamethasone', 'RSI', 'FONA'] },
      { id: 'AM060', title: 'Quinsy', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(18, 35), patientProfileTemplate: "A {age}-year-old. Severe unilateral sore throat, trismus, uvula deviation.", presentingComplaint: 'Sore Throat', instructorBrief: { progression: "Airway compromise.", interventions: ["Needle Aspiration", "Antibiotics", "Dexamethasone"], learningObjectives: ["Quinsy vs Tonsillitis", "Drainage technique"] }, vitalsMod: { hr: 100, bpSys: 120, spO2: 98, temp: 38.5 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Antibiotics', 'Dexamethasone'], recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Dexamethasone', 'Analgesia'] },
      { id: 'AM061', title: 'PJP Pneumonia (HIV)', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(25, 50), patientProfileTemplate: "A {age}-year-old. Dry cough and exertional dyspnoea. HIV positive (non-compliant).", presentingComplaint: 'Dyspnoea', instructorBrief: { progression: "Hypoxia worsens significantly on exertion.", interventions: ["High Dose Co-trimoxazole", "Steroids (if hypoxic)"], learningObjectives: ["PJP presentation", "Exercise desaturation"] }, vitalsMod: { hr: 110, bpSys: 115, spO2: 92, rr: 24 }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['Antibiotics', 'Oxygen'], recommendedActions: ['Obs', 'IV Access', 'Antibiotics', 'Oxygen', 'Dexamethasone'] },
      { id: 'AM062', title: 'Tumour Lysis Syndrome', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 70), patientProfileTemplate: "A {age}-year-old. Started chemo yesterday for Leukaemia. Lethargic.", presentingComplaint: 'Lethargy', instructorBrief: { progression: "Hyperkalaemia, Hyperphosphataemia, Renal Failure.", interventions: ["Aggressive Hydration", "Rasburicase", "Calcium (if symptomatic)"], learningObjectives: ["Electrolyte disturbances", "Rasburicase indications"] }, vitalsMod: { hr: 90, bpSys: 100, spO2: 96 }, deterioration: { active: true, rate: 0.1, type: 'cardiac' }, vbgClinicalState: "hyperkalemia", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Calcium', 'InsulinDextrose', 'Rasburicase'] },
      { id: 'AM063', title: 'Exertional Rhabdomyolysis', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 35), patientProfileTemplate: "A {age}-year-old. First crossfit session yesterday. Severe muscle pain and dark urine.", presentingComplaint: 'Muscle Pain', instructorBrief: { progression: "AKI and Hyperkalaemia.", interventions: ["Aggressive IV Fluids (300ml/hr+)", "Monitor K+"], learningObjectives: ["CK levels", "Myoglobinuria"] }, vitalsMod: { hr: 100, bpSys: 125, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Fluids'], urine: { findings: "Blood +++ (Myoglobin)" }, recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Analgesia'] },
      { id: 'AM064', title: 'Hypertensive Emergency', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(40, 60), patientProfileTemplate: "A {age}-year-old. Headache, confusion, visual disturbance. BP 240/130.", presentingComplaint: 'Confusion', instructorBrief: { progression: "PRES or Intracranial Bleed.", interventions: ["Labetalol Infusion", "GTN Infusion", "CT Head"], learningObjectives: ["Rate of BP reduction (Max 25% first hour)"] }, vitalsMod: { hr: 90, bpSys: 240, bpDia: 130, spO2: 96, gcs: 13 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Labetalol', 'GTNInfusion'], recommendedActions: ['Obs', 'IV Access', 'Labetalol', 'GTNInfusion'] },
      { id: 'AT014', title: 'Blast Injury', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Explosion in closed space.", presentingComplaint: 'Polytrauma', instructorBrief: { progression: "Blast lung, tympanic rupture, bowel injury.", interventions: ["Airway support", "Chest Drain", "Trauma CT"], learningObjectives: ["Blast wave physics", "Blast lung management"] }, vitalsMod: { hr: 120, bpSys: 100, spO2: 88, rr: 30 }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['Oxygen', 'SurgicalDrain'], recommendedActions: ['Obs', 'IV Access', 'Oxygen', 'SurgicalDrain', 'Fluids', 'Analgesia'] },
      { id: 'AT015', title: 'Traumatic Aortic Rupture', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. High speed deceleration (RTC). Chest pain.", presentingComplaint: 'Chest Pain', instructorBrief: { progression: "Exsanguination.", interventions: ["Permissive Hypotension (strictly)", "Surgery/Stent"], learningObjectives: ["Widened mediastinum", "BP targets"] }, vitalsMod: { hr: 110, bpSys: 90, spO2: 94 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Surgery', 'Labetalol'], recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Labetalol', 'Blood', 'Analgesia'] },
      { id: 'AT016', title: 'Diaphragmatic Rupture', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Crush injury to abdomen. Bowel sounds in chest.", presentingComplaint: 'Dyspnoea', instructorBrief: { progression: "Respiratory compromise and bowel strangulation.", interventions: ["NG Tube (Caution)", "Surgery"], learningObjectives: ["CXR interpretation", "NGT path"] }, vitalsMod: { hr: 100, bpSys: 110, spO2: 92, rr: 26 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, chestXray: { findings: "NG tube coiling in chest, bowel loops visible" }, recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Analgesia'] },
      { id: 'AT017', title: 'Retrobulbar Haematoma', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 60), patientProfileTemplate: "A {age}-year-old. Punch to eye. Proptosis and loss of vision.", presentingComplaint: 'Eye Trauma', instructorBrief: { progression: "Permanent blindness < 2 hours.", interventions: ["Lateral Canthotomy (Immediate)", "Do not wait for CT"], learningObjectives: ["Canthotomy technique", "Orbital compartment syndrome"] }, vitalsMod: { hr: 90, bpSys: 140, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Surgery'], recommendedActions: ['Obs', 'IV Access', 'Canthotomy', 'Analgesia'] },
      { id: 'AT018', title: 'Knee Dislocation', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Rugby tackle. Deformity of knee. Foot cold.", presentingComplaint: 'Leg Injury', instructorBrief: { progression: "Popliteal artery injury.", interventions: ["Reduction (Immediate)", "Vascular Surgery"], learningObjectives: ["Vascular check pre/post reduction", "Hard signs of ischaemia"] }, vitalsMod: { hr: 110, bpSys: 130, spO2: 99 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Reduction'], recommendedActions: ['Obs', 'IV Access', 'Reduction', 'Surgery', 'Analgesia'] },
      { id: 'AT019', title: 'Ankle Fracture-Dislocation', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 60), patientProfileTemplate: "A {age}-year-old. Fall. Ankle severely deformed, skin tenting/blanching.", presentingComplaint: 'Ankle Injury', instructorBrief: { progression: "Skin necrosis and open fracture.", interventions: ["Immediate Reduction", "Backslab"], learningObjectives: ["Skin threat urgency", "Sedation reduction"] }, vitalsMod: { hr: 100, bpSys: 140, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Reduction', 'Plaster'], recommendedActions: ['Obs', 'IV Access', 'Reduction', 'Plaster', 'Analgesia'] },
      { id: 'AT020', title: 'Straddle Injury', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(10, 30), patientProfileTemplate: "A {age}-year-old. Fell onto bike crossbar. Blood at meatus.", presentingComplaint: 'Groin Pain', instructorBrief: { progression: "Urethral tear.", interventions: ["Do NOT catheterise", "Urology urgency", "Suprapubic Catheter"], learningObjectives: ["Urethral injury signs", "Retrograde urethrogram"] }, vitalsMod: { hr: 90, bpSys: 120, spO2: 99 }, deterioration: { active: false, rate: 0 }, recommendedActions: ['Obs', 'Analgesia'] },
      { id: 'AT021', title: 'Chemical Eye Burn', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Splashed industrial cleaner (Alkali) in eye.", presentingComplaint: 'Eye Pain', instructorBrief: { progression: "Corneal melting.", interventions: ["Irrigation (Litres!)", "Check pH"], learningObjectives: ["Alkali vs Acid", "Morgan lens"] }, vitalsMod: { hr: 100, bpSys: 130, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Fluids'], recommendedActions: ['Obs', 'Irrigation', 'Analgesia'] },
      { id: 'AT022', title: 'Severe Maxillofacial Trauma', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Dashboard injury. Mid-face floating.", presentingComplaint: 'Facial Trauma', instructorBrief: { progression: "Airway obstruction (Blood/Teeth).", interventions: ["Sit up (if C-spine cleared)", "Suction", "Intubation (Difficult)"], learningObjectives: ["Le Fort fractures", "Airway adjuncts"] }, vitalsMod: { hr: 120, bpSys: 110, spO2: 92, rr: 28 }, deterioration: { active: true, rate: 0.1, type: 'airway' }, stabilisers: ['RSI', 'Suction'], recommendedActions: ['Obs', 'IV Access', 'Suction', 'RSI', 'Analgesia', 'Oxygen', 'FONA'] },
      { id: 'AT023', title: 'Impaled Object', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Impaled on fence railing (Abdomen).", presentingComplaint: 'Impaled Object', instructorBrief: { progression: "Hemorrhage if removed.", interventions: ["Do NOT remove", "Stabilise object", "Theatre"], learningObjectives: ["Impaled object management"] }, vitalsMod: { hr: 115, bpSys: 105, spO2: 96 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Surgery'], recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Blood', 'Analgesia'] },
      { id: 'PA016', title: 'Pyloric Stenosis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => 0, patientProfileTemplate: "A 5-week-old. Projectile vomiting after feeds. Hungry.", presentingComplaint: 'Vomiting', instructorBrief: { progression: "Dehydration and Hypochloraemic Metabolic Alkalosis.", interventions: ["Fluid Resus", "Correction of Alkalosis", "Surgery"], learningObjectives: ["VBG interpretation", "Olive mass"] }, vitalsMod: { hr: 160, bpSys: 75, spO2: 98, rr: 40, bm: 3.8 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, vbgClinicalState: "metabolic_alkalosis", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Surgery'] },
      { id: 'PA017', title: 'Malrotation & Volvulus', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => 0, patientProfileTemplate: "A 3-day-old. Bilious vomiting and distended abdomen.", presentingComplaint: 'Bilious Vomiting', instructorBrief: { progression: "Gut ischaemia and necrosis.", interventions: ["NG Tube", "Fluid Resus", "Urgent Surgery"], learningObjectives: ["Bilious vomiting is red flag", "Upper GI Contrast"] }, vitalsMod: { hr: 180, bpSys: 60, spO2: 90, rr: 60 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Surgery', 'Fluids'], recommendedActions: ['Obs', 'IV Access', 'Surgery', 'Fluids', 'Analgesia'] },
      { id: 'PA018', title: 'Congenital Adrenal Hyperplasia', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => 0, patientProfileTemplate: "A 2-week-old. Vomiting, weight loss. Ambiguous genitalia.", presentingComplaint: 'Failure to Thrive', instructorBrief: { progression: "Salt-wasting crisis (Low Na, High K). Shock.", interventions: ["Hydrocortisone", "Saline Bolus", "Glucose"], learningObjectives: ["CAH pathophysiology", "Hyperkalaemia in neonate"] }, vitalsMod: { hr: 170, bpSys: 55, spO2: 94, bm: 2.5 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, vbgClinicalState: "hyperkalemia", recommendedActions: ['Obs', 'IV Access', 'Hydrocortisone', 'Fluids', 'InsulinDextrose'] },
      { id: 'PA019', title: 'Pertussis (Whooping Cough)', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => 0, patientProfileTemplate: "A 3-month-old. Coughing spells turning blue. Apnoeas.", presentingComplaint: 'Cough & Cyanosis', instructorBrief: { progression: "Apnoea and bradycardia.", interventions: ["Oxygen", "Suction", "Antibiotics (Macrolide)"], learningObjectives: ["Apnoea management", "Vaccination history"] }, vitalsMod: { hr: 160, bpSys: 80, spO2: 88, rr: 60 }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['Oxygen', 'Antibiotics'], recommendedActions: ['Obs', 'Oxygen', 'Antibiotics', 'Suction'] },
      { id: 'PA020', title: 'Measles', category: 'Medical', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(1, 5), patientProfileTemplate: "A {age}-year-old. High fever, coryza, conjunctivitis, rash.", presentingComplaint: 'Fever & Rash', instructorBrief: { progression: "Pneumonia or Encephalitis.", interventions: ["Vitamin A", "Isolation", "Supportive"], learningObjectives: ["Koplik spots", "Isolation protocols"] }, vitalsMod: { hr: 140, bpSys: 95, spO2: 94, temp: 40.0 }, deterioration: { active: true, rate: 0.05, type: 'respiratory' }, recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Analgesia', 'VitaminA'] },
      { id: 'PA021', title: 'Inborn Error of Metabolism', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => 0, patientProfileTemplate: "A 1-week-old. Encephalopathic, poor feeding, seizures.", presentingComplaint: 'Seizures', instructorBrief: { progression: "Hyperammonemia. Brain injury.", interventions: ["Stop feeds", "Glucose 10%", "Ammonia Scavengers"], learningObjectives: ["Ammonia measurement", "Sepsis mimic"] }, vitalsMod: { hr: 160, bpSys: 70, spO2: 95, gcs: 8 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['InsulinDextrose'], recommendedActions: ['Obs', 'IV Access', 'InsulinDextrose'] },
      { id: 'PA022', title: 'Supracondylar Fracture', category: 'Trauma', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => getRandomInt(4, 8), patientProfileTemplate: "A {age}-year-old. Fall from monkey bars. Pale hand.", presentingComplaint: 'Arm Injury', instructorBrief: { progression: "Vascular compromise (Brachial artery).", interventions: ["Urgent Reduction", "Orthopaedics"], learningObjectives: ["Gartland classification", "Pulse check"] }, vitalsMod: { hr: 120, bpSys: 100, spO2: 99 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Reduction'], recommendedActions: ['Obs', 'IV Access', 'Reduction', 'Surgery', 'Analgesia'] },
      { id: 'PA023', title: 'Severe Neonatal Jaundice', category: 'Medical', ageRange: 'Paediatric', acuity: 'Majors', ageGenerator: () => 0, patientProfileTemplate: "A 4-day-old. Yellow down to toes. Lethargic.", presentingComplaint: 'Jaundice', instructorBrief: { progression: "Kernicterus.", interventions: ["Phototherapy", "Exchange Transfusion (if critical)", "Hydration"], learningObjectives: ["Bilirubin nomogram", "Kernicterus signs"] }, vitalsMod: { hr: 150, bpSys: 70, spO2: 98, gcs: 12 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, recommendedActions: ['Obs', 'Fluids', 'Phototherapy'] },
      { id: 'PA024', title: 'Paediatric Scald', category: 'Trauma', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 3), patientProfileTemplate: "A {age}-year-old. Pulled kettle over. Burns to chest and face.", presentingComplaint: 'Burns', instructorBrief: { progression: "Airway oedema. Hypothermia.", interventions: ["Cooling (20 mins)", "Cling Film", "Ketamine"], learningObjectives: ["Lund and Browder", "Cooling limits"] }, vitalsMod: { hr: 160, bpSys: 90, spO2: 95, temp: 36.5 }, deterioration: { active: true, rate: 0.1, type: 'airway' }, stabilisers: ['Analgesia', 'Warming'], recommendedActions: ['Obs', 'IV Access', 'Analgesia', 'Warming', 'Ketamine', 'Fluids', 'Cooling'] },
      { id: 'PA025', title: 'Complex Febrile Convulsion', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 4), patientProfileTemplate: "A {age}-year-old. Seizure > 15 mins. Fever.", presentingComplaint: 'Seizure', instructorBrief: { progression: "Status Epilepticus.", interventions: ["Benzodiazepines", "Paracetamol (for comfort)", "Source hunt"], learningObjectives: ["Simple vs Complex", "Meningitis exclusion"] }, vitalsMod: { hr: 150, bpSys: 95, spO2: 92, temp: 39.8, gcs: 3 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Midazolam', 'Lorazepam'], recommendedActions: ['Obs', 'Oxygen', 'Midazolam', 'Lorazepam', 'Paracetamol'] },
      { id: 'OB009', title: 'Uterine Inversion', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Just delivered. Mass at introitus. Shock.", presentingComplaint: 'Collapse', instructorBrief: { progression: "Neurogenic and Haemorrhagic Shock.", interventions: ["Johnson Manoeuvre (Push back)", "Stop Oxytocin", "Fluids"], learningObjectives: ["Do not pull cord", "Reinvert immediately"] }, vitalsMod: { hr: 130, bpSys: 70, spO2: 94 }, deterioration: { active: true, rate: 0.15, type: 'shock' }, stabilisers: ['Fluids', 'Surgery'], recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Surgery', 'Manoeuvres'] },
      { id: 'OB010', title: 'Placental Abruption', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "34 weeks pregnant. Severe constant abdo pain. 'Woody' uterus.", presentingComplaint: 'Abdo Pain', instructorBrief: { progression: "Fetal distress and DIC.", interventions: ["Emergency C-Section", "Blood Products"], learningObjectives: ["Concealed abruption", "Pain disproportionate to bleed"] }, vitalsMod: { hr: 110, bpSys: 100, spO2: 98 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Delivery', 'Blood'], recommendedActions: ['Obs', 'IV Access', 'Delivery', 'Blood', 'Analgesia'] },
      { id: 'OB011', title: 'Placenta Previa Bleed', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "32 weeks pregnant. Sudden painless heavy vaginal bleeding.", presentingComplaint: 'PV Bleed', instructorBrief: { progression: "Exsanguination.", interventions: ["No PV Exam", "Blood", "C-Section"], learningObjectives: ["Painless bleed = Previa", "Digital exam contraindication"] }, vitalsMod: { hr: 120, bpSys: 90, spO2: 96 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Blood', 'Delivery'], recommendedActions: ['Obs', 'IV Access', 'Blood', 'Delivery'] },
      { id: 'OB012', title: 'Hyperemesis Gravidarum', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 35), patientProfileTemplate: "10 weeks pregnant. Vomiting 20x day. Ketotic.", presentingComplaint: 'Vomiting', instructorBrief: { progression: "Wernicke's Encephalopathy. AKI.", interventions: ["Thiamine", "Fluids", "Antiemetics"], learningObjectives: ["Wernicke's prevention", "PUQE score"] }, vitalsMod: { hr: 110, bpSys: 100, spO2: 98, bm: 3.2 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Fluids', 'Pabrinex'], recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Pabrinex', 'Antiemetic'] },
      { id: 'OB013', title: 'Breech Delivery', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "Term pregnancy. Legs delivered, head stuck.", presentingComplaint: 'Imminent Delivery', instructorBrief: { progression: "Head entrapment. Fetal hypoxia.", interventions: ["Mauriceau-Smellie-Veit", "Lovset Manoeuvre"], learningObjectives: ["Breech manoeuvres", "Hands off breech"] }, vitalsMod: { hr: 110, bpSys: 130, spO2: 98 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Delivery'], recommendedActions: ['Obs', 'IV Access', 'Delivery', 'Manoeuvres'] },
      { id: 'TX006', title: 'Calcium Channel Blocker OD', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Amlodipine overdose. Hypotensive and hyperglycaemic.", presentingComplaint: 'Overdose', instructorBrief: { progression: "Refractory shock.", interventions: ["High Dose Insulin", "Calcium", "Vasopressors"], learningObjectives: ["Hyperglycaemia in CCB OD", "Insulin euglycaemia"] }, vitalsMod: { hr: 100, bpSys: 70, spO2: 96, bm: 18.0 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['InsulinDextrose', 'Calcium', 'Metaraminol'], recommendedActions: ['Obs', 'IV Access', 'InsulinDextrose', 'Calcium', 'Metaraminol', 'Glucagon', 'Lipid'] },
      { id: 'TX007', title: 'Salicylate Toxicity', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Aspirin overdose. Tinnitus and hyperventilation.", presentingComplaint: 'Overdose', instructorBrief: { progression: "Respiratory Alkalosis -> Metabolic Acidosis. Cerebral Oedema.", interventions: ["Urinary Alkalinisation (Bicarb)", "Dialysis"], learningObjectives: ["Uncoupling oxidative phosphorylation", "pH trapping"] }, vitalsMod: { hr: 110, bpSys: 120, spO2: 98, rr: 35, temp: 38.5 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, vbgClinicalState: "metabolic_acidosis_severe", recommendedActions: ['Obs', 'IV Access', 'Fluids', 'SodiumBicarb', 'Charcoal'] },
      { id: 'TX008', title: 'MDMA Hyperpyrexia', category: 'Toxicology', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 30), patientProfileTemplate: "A {age}-year-old. Clubbing. Agitated, hot, seizure.", presentingComplaint: 'Seizure', instructorBrief: { progression: "Hyperthermia, Rhabdomyolysis, Hyponatremia.", interventions: ["Active Cooling", "Benzodiazepines", "Dantrolene?"], learningObjectives: ["Serotonin syndrome features", "Cooling urgency"] }, vitalsMod: { hr: 160, bpSys: 170, spO2: 94, temp: 41.5, gcs: 8 }, deterioration: { active: true, rate: 0.15, type: 'neuro' }, stabilisers: ['Warming', 'Midazolam'], recommendedActions: ['Obs', 'IV Access', 'Warming', 'Midazolam', 'Fluids', 'Dantrolene'] }, 
      { id: 'TX009', title: 'Cocaine Chest Pain', category: 'Toxicology', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 40), patientProfileTemplate: "A {age}-year-old. Cocaine use. Severe chest pain.", presentingComplaint: 'Chest Pain', instructorBrief: { progression: "Coronary vasospasm vs Dissection.", interventions: ["Benzodiazepines", "GTN", "Phentolamine", "NO Beta Blockers"], learningObjectives: ["Unopposed alpha stimulation", "Benzo utility"] }, vitalsMod: { hr: 130, bpSys: 180, spO2: 98 }, deterioration: { active: true, rate: 0.05, type: 'cardiac' }, stabilisers: ['Midazolam', 'GTN'], recommendedActions: ['Obs', 'IV Access', 'Midazolam', 'GTN', 'Phentolamine', 'Analgesia'] },
      { id: 'TX010', title: 'Adder Bite', category: 'Toxicology', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(10, 60), patientProfileTemplate: "A {age}-year-old. Walking in dunes. Bitten on hand. Swelling extending to forearm.", presentingComplaint: 'Snake Bite', instructorBrief: { progression: "Anaphylaxis or spreading venom.", interventions: ["Immobilise Limb", "Antivenom (if systemic)", "IV Fluids"], learningObjectives: ["UK Adder management", "Antivenom indications"] }, vitalsMod: { hr: 110, bpSys: 100, spO2: 98 }, deterioration: { active: true, rate: 0.05, type: 'shock' }, stabilisers: ['Fluids'], recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Analgesia', 'Splinting'] },
      { id: 'TX011', title: 'Drowning (Secondary)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Pulled from river. Initially fine, now breathless.", presentingComplaint: 'Dyspnoea', instructorBrief: { progression: "Surfactant wash-out. ARDS.", interventions: ["CPAP/PEEP", "Warming"], learningObjectives: ["Non-cardiogenic pulmonary oedema", "C-spine in drowning"] }, vitalsMod: { hr: 110, bpSys: 110, spO2: 86, rr: 30, temp: 35.0 }, deterioration: { active: true, rate: 0.1, type: 'respiratory' }, stabilisers: ['CPAP', 'Oxygen'], recommendedActions: ['Obs', 'IV Access', 'CPAP', 'Oxygen', 'Warming'] },
      { id: 'TX012', title: 'Heat Stroke', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old runner. Marathon day. Collapsed, hot dry skin.", presentingComplaint: 'Collapse', instructorBrief: { progression: "Multiorgan failure.", interventions: ["Rapid Cooling (Ice/Water)", "Fluids"], learningObjectives: ["Heat stroke vs exhaustion", "Cooling methods"] }, vitalsMod: { hr: 140, bpSys: 90, spO2: 96, temp: 41.0, gcs: 9 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Fluids'], recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Cooling'] },
      { id: 'PS001', title: 'Neuroleptic Malignant Syndrome', category: 'Psychiatric', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Schizophrenic. Rigid, fever, confused.", presentingComplaint: 'Confusion & Rigidity', instructorBrief: { progression: "Rhabdomyolysis and Autonomic Instability.", interventions: ["Stop Antipsychotics", "Bromocriptine/Dantrolene", "Fluids"], learningObjectives: ["NMS vs Serotonin Syndrome", "Lead pipe rigidity"] }, vitalsMod: { hr: 120, bpSys: 160, spO2: 96, temp: 39.5, gcs: 11 }, deterioration: { active: true, rate: 0.1, type: 'neuro' }, stabilisers: ['Fluids'], recommendedActions: ['Obs', 'IV Access', 'Fluids', 'Lorazepam', 'Dantrolene'] },
      { id: 'PS002', title: 'Lithium Toxicity', category: 'Psychiatric', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Coarse tremor, vomiting, ataxia.", presentingComplaint: 'Tremor & Vomiting', instructorBrief: { progression: "Seizures and renal failure.", interventions: ["Aggressive Hydration", "Dialysis (if severe)"], learningObjectives: ["Chronic vs Acute toxicity", "Dialysis indications"] }, vitalsMod: { hr: 90, bpSys: 130, spO2: 98, gcs: 14 }, deterioration: { active: true, rate: 0.05, type: 'neuro' }, stabilisers: ['Fluids'], recommendedActions: ['Obs', 'IV Access', 'Fluids'] },
      { id: 'PS003', title: 'Catatonia', category: 'Psychiatric', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old. Mute, immobile, holding awkward postures.", presentingComplaint: 'Unresponsive', instructorBrief: { progression: "Malnutrition/DVT risks.", interventions: ["Lorazepam Trial", "Exclude organic cause"], learningObjectives: ["Benzodiazepine response", "Waxy flexibility"] }, vitalsMod: { hr: 80, bpSys: 120, spO2: 98, gcs: 10 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Lorazepam'], recommendedActions: ['Obs', 'IV Access', 'Lorazepam', 'Fluids'] }  
    ];
        // --- AUTOMATICALLY ENRICH SCENARIOS WITH GUIDELINES & KIT ---
    const ALL_SCENARIOS = RAW_SCENARIOS.map(s => {
        let kit = ['Monitoring', 'IV Access'];
        let links = [];

        // Kit Logic
        if (s.acuity === 'Resus') kit = [...kit, 'Defibrillator', 'Airway Trolley', 'Drugs Bag', 'IO Drill', 'Ultrasound'];
        if (s.category === 'Trauma') kit = [...kit, 'Pelvic Binder', 'Splints', 'TXA', 'Blood Warmer'];
        if (s.ageRange === 'Paediatric') kit = [...kit, 'Broselow Tape', 'Paeds Drug Calc'];
        if (s.category === 'Obstetrics & Gynae') kit = [...kit, 'Obs Delivery Pack', 'Neonatal Resuscatire'];

        // Guidelines Logic
        if (s.ageRange === 'Paediatric') {
            links.push({ label: 'APLS Guidelines', url: 'https://www.resus.org.uk/library/2021-resuscitation-guidelines/paediatric-advanced-life-support-guidelines' });
        } else {
            links.push({ label: 'ALS Guidelines', url: 'https://www.resus.org.uk/library/2021-resuscitation-guidelines/adult-advanced-life-support-guidelines' });
        }

        if (s.category === 'Trauma') links.push({ label: 'NICE Trauma', url: 'https://www.nice.org.uk/guidance/ng39' });
        if (s.category === 'Toxicology') links.push({ label: 'TOXBASE (Sim)', url: 'https://www.toxbase.org/' });
        if (s.title.includes('Sepsis')) links.push({ label: 'Sepsis Trust', url: 'https://sepsistrust.org/' });
        
        return {
            ...s,
            equipment: s.instructorBrief.equipment || kit, // Prefer manual override if exists
            learningLinks: s.learningLinks || links
        };
    });

    // --- 2. COMPONENTS ---

    const { useState, useEffect, useRef, useReducer } = React;
    
    // SAFE LUCIDE COMPONENT - Fixed to prevent React reconciliation crashes
    const Lucide = React.memo(({ icon, className = "" }) => {
        const ref = useRef(null);

        useEffect(() => {
            if (!ref.current || !window.lucide) return;
            
            // Convert kebab-case (arrow-left) to PascalCase (ArrowLeft) for lookup if needed,
            // but lucide.icons usually stores them as PascalCase.
            // Some versions of Lucide global object have createIcons that scans DOM,
            // others provide createElement.
            
            // Clear container safely
            ref.current.innerHTML = '';

            const kebabToPascal = (str) => str.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
            const iconName = kebabToPascal(icon);
            
            if (window.lucide.icons && window.lucide.icons[iconName]) {
                 // Modern UMD approach if available
                 const iconNode = window.lucide.icons[iconName];
                 if (window.lucide.createElement) {
                     const svg = window.lucide.createElement(iconNode);
                     if (className) svg.setAttribute('class', className);
                     ref.current.appendChild(svg);
                     return;
                 }
            }

            // Fallback for older UMD or if direct lookup fails
            if (window.lucide.createIcons) {
                const i = document.createElement('i');
                i.setAttribute('data-lucide', icon);
                if (className) i.setAttribute('class', className);
                ref.current.appendChild(i);
                window.lucide.createIcons({ root: ref.current });
            }
        }, [icon, className]);

        return <span ref={ref} className="inline-flex items-center justify-center"></span>;
    });

    const Button = ({ onClick, children, variant = 'primary', className = '', disabled = false, progress = 0 }) => {
        let variants = {
            primary: "bg-sky-600 hover:bg-sky-500 text-white",
            secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
            danger: "bg-red-600 hover:bg-red-500 text-white",
            success: "bg-emerald-600 hover:bg-emerald-500 text-white",
            warning: "bg-amber-500 hover:bg-amber-600 text-white",
            outline: "border border-slate-600 text-slate-300 hover:bg-slate-800"
        };
        let base = "px-4 py-3 rounded font-semibold transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm relative overflow-hidden touch-manipulation z-0";
        if (className.includes("h-16")) { base += " text-xl px-8"; } 
        else if (className.includes("h-14")) { base += " text-lg px-4"; } 
        else { base += " text-xs"; }

        return (
            <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>
                {progress > 0 && (
                    <div className="absolute top-0 left-0 bottom-0 bg-emerald-500/50 z-[-1] transition-all duration-1000 ease-linear" style={{ width: `${progress}%` }}></div>
                )}
                <span className="relative z-10 flex items-center gap-2 whitespace-nowrap w-full justify-center">{children}</span>
            </button>
        );
    };

    const Card = ({ title, icon, children, className = "", collapsible = false, defaultOpen = true }) => {
        const [isOpen, setIsOpen] = useState(defaultOpen);
        return (
            <div className={`bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-lg flex flex-col ${className}`}>
                {title && (
                    <div 
                        className={`bg-slate-800/50 p-3 border-b border-slate-700 flex items-center justify-between flex-shrink-0 ${collapsible ? 'cursor-pointer hover:bg-slate-700/50 transition-colors' : ''}`}
                        onClick={() => collapsible && setIsOpen(!isOpen)}
                    >
                        <div className="flex items-center gap-2">
                            {icon && <Lucide icon={icon} className="w-5 h-5 text-sky-400" />}
                            <h3 className="font-bold text-slate-200">{title}</h3>
                        </div>
                        {collapsible && (
                            <Lucide icon="chevron-down" className={`w-4 h-4 text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                        )}
                    </div>
                )}
                {(!collapsible || isOpen) && (
                    <div className="p-4 animate-fadeIn flex-grow overflow-auto min-h-0">{children}</div>
                )}
            </div>
        );
    };
    
    // Updated VitalDisplay to handle BP explicitly
    const VitalDisplay = ({ label, value, value2, prev, unit, lowIsBad = true, onUpdate, alert, isText = false }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editVal, setEditVal] = useState(value);
        useEffect(() => { if (!isEditing) setEditVal(value); }, [value, isEditing]);
        const handleBlur = () => { setIsEditing(false); if (editVal !== value) onUpdate(isText ? editVal : parseFloat(editVal)); };

        const isBP = label === "BP";

        return (
            <div className={`bg-slate-900/50 p-2 md:p-3 rounded border flex flex-col items-center justify-center h-24 md:h-28 relative touch-manipulation transition-colors duration-300 ${alert ? 'border-red-500 bg-red-900/20' : 'border-slate-700'}`}>
                <span className="text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">{label}</span>
                {isEditing ? (
                    <input type={isText ? "text" : "number"} value={editVal} onChange={(e) => setEditVal(e.target.value)} onBlur={handleBlur} onKeyDown={(e) => e.key === 'Enter' && handleBlur()} className="text-xl md:text-2xl font-mono font-bold text-white bg-slate-800 border border-slate-500 rounded w-full text-center" autoFocus />
                ) : (
                    <div className="flex items-baseline gap-1 cursor-pointer hover:bg-slate-800/50 rounded px-2 py-1" onClick={() => { setEditVal(value); setIsEditing(true); }}>
                        <span className={`font-mono font-bold text-white ${isText ? 'text-lg md:text-xl' : 'text-2xl md:text-3xl'}`}>
                            {value === '?' ? '--' : (isText ? value : Math.round(value * 10) / 10)}
                            {isBP && value2 !== undefined && `/${Math.round(value2)}`}
                        </span>
                        {!isText && !isBP && value !== '?' && prev !== '?' && <span className={`text-xs md:text-sm font-bold ${value === prev ? 'text-slate-500' : (lowIsBad ? (value > prev ? 'text-emerald-400' : 'text-red-400') : (value > prev ? 'text-red-400' : 'text-emerald-400'))}`}>{value > prev ? '' : value < prev ? '' : ''}</span>}
                    </div>
                )}
                <span className="text-[9px] md:text-[10px] text-slate-600 mt-1">{unit}</span>
            </div>
        );
    };

    const ECGMonitor = ({ rhythmType, hr, isPaused, showEtco2, rr, pathology }) => {
        const canvasRef = useRef(null);
        const requestRef = useRef(null);
        
        // --- PERSISTENT STATE ---
        const drawState = useRef({
            x: 0,
            lastY: 50,
            beatProgress: 0,
            breathProgress: 0,
            lastTime: 0,
            lastYCO2: 0 // Will init in loop
        });

        const propsRef = useRef({ rhythmType, hr, rr, showEtco2, pathology, isPaused });

        useEffect(() => {
            propsRef.current = { rhythmType, hr, rr, showEtco2, pathology, isPaused };
        }, [rhythmType, hr, rr, showEtco2, pathology, isPaused]);

        const getWaveform = (type, t) => {
            const noise = (Math.random() - 0.5) * 2;
            if (type === 'Asystole') return 50 + noise;
            if (type === 'VF') { return 50 + Math.sin(t * 20) * 15 + Math.sin(t * 7) * 25 + noise * 2; }
            if (type === 'VT') {
                let y = 50; if (t < 0.2) y += Math.sin(t * 5 * Math.PI) * 40; else if (t < 0.6) y -= Math.sin((t-0.2) * 2.5 * Math.PI) * 40; return y + noise;
            }
            if (type === 'AF') {
                let y = 50; 
                if (t > 0.4 && t < 0.44) y -= 40;
                else if (t >= 0.44 && t < 0.46) y += 10;
                y += Math.sin(t * 50) * 2;
                return y + noise;
            }
            if (type === 'STEMI') {
                let y = 50; if (t < 0.15) y -= Math.sin(t / 0.15 * Math.PI) * 3; else if (t >= 0.15 && t < 0.20) y -= 2; else if (t >= 0.20 && t < 0.24) y -= 45; else if (t >= 0.24 && t < 0.26) y += 10; else if (t >= 0.26 && t < 0.55) { y -= 10; y -= Math.sin((t-0.26)/0.29 * Math.PI) * 8; } return y + noise;
            }
            let y = 50; if (t < 0.1) y -= Math.sin(t/0.1 * Math.PI) * 3; else if (t > 0.12 && t < 0.14) y += 2; else if (t >= 0.14 && t < 0.18) y -= 40; else if (t >= 0.18 && t < 0.20) y += 8; else if (t > 0.3 && t < 0.5) y -= Math.sin((t-0.3)/0.2 * Math.PI) * 6; return y + noise;
        };

        const getEtco2Wave = (t, pathology, rr, rhythm) => {
            if (rr <= 0) return 0; // Apnoea = Flatline
            const isCardiacArrest = ['VF', 'VT', 'Asystole', 'PEA'].includes(rhythm);
            const baseAmplitude = isCardiacArrest ? 0.3 : 1.0; // Low amplitude in arrest

            if (t < 0.1 || t > 0.6) return 0; 
            
            if (t >= 0.1 && t < 0.15) { // Upstroke
                return ((t - 0.1) / 0.05) * baseAmplitude;
            }
            if (t >= 0.15 && t < 0.5) { // Plateau
                const plateauBase = 1.0;
                const plateauEnd = 0.9;
                const p = (t - 0.15) / 0.35;
                if (pathology === 'respiratory') {
                    return (0.5 + (p * 0.5)) * baseAmplitude; 
                }
                return (plateauBase - (p * (plateauBase - plateauEnd))) * baseAmplitude;
            }
            if (t >= 0.5 && t <= 0.6) { // Downstroke
                const startVal = (pathology === 'respiratory' ? 1.0 : 0.9);
                const p = (t - 0.5) / 0.1;
                return (startVal * (1 - p)) * baseAmplitude;
            }
            return 0;
        };

        useEffect(() => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            
            const setSize = () => {
                const parent = canvas.parentElement;
                if(parent) {
                    canvas.width = parent.clientWidth;
                    canvas.height = parent.clientHeight;
                    drawState.current.lastYCO2 = canvas.height - 2;
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0,0, canvas.width, canvas.height);
                }
            };
            setSize();
            window.addEventListener('resize', setSize);

            const animate = (timestamp) => {
                const state = drawState.current;
                const props = propsRef.current;
                
                if (!state.lastTime) state.lastTime = timestamp;
                const dt = (timestamp - state.lastTime) / 1000;
                state.lastTime = timestamp;

                if (props.isPaused) {
                    requestRef.current = requestAnimationFrame(animate);
                    return;
                }

                // --- LOGIC ---
                let currentRhythm = props.rhythmType || 'Sinus Rhythm'; 
                let currentRate = props.hr || 60;
                
                if (currentRhythm === 'AF' && state.beatProgress >= 1) { 
                    currentRate = props.hr + (Math.random() * 60 - 30); 
                }
                let beatDuration = 60 / Math.max(10, currentRate);
                if (currentRhythm === 'VF') beatDuration = 60/300; // VF is fast

                // Move Cursor
                const ecgSpeed = 150; // pixels per sec
                const dx = ecgSpeed * dt;
                const prevX = state.x;
                state.x += dx;

                if (state.x > canvas.width) {
                    state.x = 0;
                    state.lastY = getWaveform(currentRhythm, state.beatProgress);
                    state.lastYCO2 = canvas.height - 2;
                }

                // Eraser Bar
                const eraserWidth = 20;
                if (state.x + eraserWidth < canvas.width) {
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(state.x, 0, eraserWidth + 5, canvas.height); 
                } else {
                     ctx.fillStyle = '#000000';
                     ctx.fillRect(state.x, 0, canvas.width - state.x, canvas.height);
                     ctx.fillRect(0, 0, eraserWidth, canvas.height);
                }

                // --- ECG DRAW ---
                state.beatProgress += dt / beatDuration;
                if (state.beatProgress >= 1) state.beatProgress = 0;

                const yECG = getWaveform(currentRhythm, state.beatProgress);
                
                if (state.x > prevX) {
                    ctx.strokeStyle = '#00ff00'; 
                    ctx.lineWidth = 2; 
                    ctx.lineJoin = 'round';
                    ctx.beginPath();
                    ctx.moveTo(prevX, state.lastY);
                    ctx.lineTo(state.x, yECG);
                    ctx.stroke();
                }
                state.lastY = yECG;

                // --- ETCO2 DRAW ---
                if (props.showEtco2) {
                    let breathDuration = 60 / (Math.max(1, props.rr) || 12);
                    state.breathProgress += dt / breathDuration;
                    if (state.breathProgress >= 1) state.breathProgress = 0;

                    const normalizedHeight = getEtco2Wave(state.breathProgress, props.pathology, props.rr, currentRhythm);
                    const co2MaxHeight = 35; 
                    const co2BaseY = canvas.height - 2; 
                    const yCO2 = co2BaseY - (normalizedHeight * co2MaxHeight);

                    if (state.x > prevX) {
                         ctx.fillStyle = 'rgba(250, 204, 21, 0.4)'; 
                         ctx.beginPath();
                         ctx.moveTo(prevX, state.lastYCO2);
                         ctx.lineTo(state.x, yCO2);
                         ctx.lineTo(state.x, co2BaseY);
                         ctx.lineTo(prevX, co2BaseY);
                         ctx.fill();

                         ctx.strokeStyle = '#facc15'; 
                         ctx.lineWidth = 2;
                         ctx.beginPath();
                         ctx.moveTo(prevX, state.lastYCO2);
                         ctx.lineTo(state.x, yCO2);
                         ctx.stroke();
                    }
                    state.lastYCO2 = yCO2;
                }

                requestRef.current = requestAnimationFrame(animate);
            };

            requestRef.current = requestAnimationFrame(animate);
            return () => {
                window.removeEventListener('resize', setSize);
                if (requestRef.current) cancelAnimationFrame(requestRef.current);
            };
        }, []);

        return (
            <div className="w-full h-32 bg-black rounded border border-slate-700 relative overflow-hidden">
                <canvas ref={canvasRef} className="block w-full h-full"></canvas>
                <div className="absolute top-1 right-2 text-xs font-mono text-green-500 font-bold">{rhythmType}</div>
                {showEtco2 && <div className="absolute bottom-1 right-2 text-xs font-mono text-yellow-500 font-bold">ETCO2</div>}
            </div>
        );
    };

    const InvestigationButton = ({ type, icon, label, isRevealed, isLoading, revealInvestigation, isRunning, scenario }) => {
        const hasData = (type === 'ECG' && scenario.ecg) || (type === 'X-ray' && scenario.chestXray) || (type === 'POCUS' && scenario.ultrasound) || (type === 'VBG' && scenario.vbg) || (type === 'CT' && scenario.ct) || (type === 'Urine' && scenario.urine);
        return (
            <div className="flex flex-col gap-2">
                <Button variant={isRevealed ? "secondary" : "outline"} onClick={() => revealInvestigation(type)} disabled={!isRunning || isRevealed || isLoading} className="h-10 text-xs relative overflow-hidden">
                    {isLoading && <div className="loading-bar"></div>}
                    <div className="relative z-10 flex items-center gap-2"><Lucide icon={icon} className="w-3 h-3"/> {isLoading ? `Requesting...` : (isRevealed ? `View ${type}` : `Request ${type}`)}</div>
                </Button>
                {isRevealed && (
                    <div className="p-3 bg-slate-700/30 rounded text-xs border-l-2 border-sky-500 animate-fadeIn">
                        {hasData ? (
                            type === 'VBG' ? <div className="font-mono space-y-1"><div>pH: {scenario.vbg.pH.toFixed(2)}</div><div>pCO2: {scenario.vbg.pCO2} kPa</div><div>pO2: 12.0 kPa</div><div>HCO3: {scenario.vbg.HCO3}</div><div>BE: {scenario.vbg.BE}</div><div>Lac: {scenario.vbg.Lac}</div><div>K+: {scenario.vbg.K}</div><div className="font-bold text-sky-400">Glu: {scenario.vbg.Glu} mmol/L</div></div> : 
                            type === 'ECG' ? <div><p className="mb-1 font-bold">{scenario.ecg.findings}</p><p className="italic text-slate-400">See monitor for rhythm.</p></div> : 
                            type === 'X-ray' ? <div className="text-slate-200">{scenario.chestXray.findings}</div> : 
                            type === 'POCUS' ? <div className="text-slate-200">{scenario.ultrasound.findings}</div> : 
                            type === 'Urine' ? <div className="text-slate-200 font-mono">{scenario.urine.findings}</div> :
                            type === 'CT' ? <div className="text-slate-200">{scenario.ct.findings}</div> : 'Normal / Not Indicated'
                        ) : 'Normal / Not Indicated'}
                    </div>
                )}
            </div>
        );
    };

    // --- 3. REDUCER & SIMULATION ENGINE ---
    
    const initialState = {
        scenario: null,
        time: 0,
        isRunning: false,
        vitals: {},
        prevVitals: {},
        rhythm: "Sinus Rhythm", 
        log: [],
        flash: null,
        history: [],
        investigationsRevealed: {},
        loadingInvestigations: {},
        activeInterventions: new Set(),
        interventionCounts: {},
        activeDurations: {},
        processedEvents: new Set(),
        isMuted: false,
        etco2Enabled: false,
        isParalysed: false,
        queuedRhythm: null,
    };

    const simReducer = (state, action) => {
        switch (action.type) {
            case 'START_SIM':
                return { ...state, isRunning: true, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: '00:00', msg: "Simulation Started", type: 'system' }] };
            case 'PAUSE_SIM':
                return { ...state, isRunning: false, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: `${Math.floor(state.time/60)}:${(state.time%60).toString().padStart(2,'0')}`, msg: "Simulation Paused", type: 'system' }] };
            case 'LOAD_SCENARIO':
                const initialRhythm = (action.payload.ecg && action.payload.ecg.type) ? action.payload.ecg.type : "Sinus Rhythm";
                return { ...initialState, scenario: action.payload, vitals: {...action.payload.vitals}, prevVitals: {...action.payload.vitals}, rhythm: initialRhythm, processedEvents: new Set(), activeInterventions: new Set() };
            case 'RESTORE_SESSION':
                const restored = action.payload;
                return { ...restored, activeInterventions: new Set(restored.activeInterventions || []), processedEvents: new Set(restored.processedEvents || []), isRunning: false };
            case 'TICK_TIME':
                const newDurations = { ...state.activeDurations };
                let durChanged = false;
                Object.keys(newDurations).forEach(key => {
                    const elapsed = state.time + 1 - newDurations[key].startTime;
                    if (elapsed >= newDurations[key].duration) { delete newDurations[key]; durChanged = true; }
                });
                return { ...state, time: state.time + 1, activeDurations: durChanged ? newDurations : state.activeDurations };
            case 'UPDATE_VITALS': 
                const newHist = [...state.history, { time: state.time, hr: action.payload.hr, bp: action.payload.bpSys, spo2: action.payload.spO2, rr: action.payload.rr, actions: [] }];
                return { ...state, vitals: action.payload, history: newHist };
            case 'UPDATE_RHYTHM': return { ...state, rhythm: action.payload };
            case 'ADD_LOG':
                const timestamp = new Date().toLocaleTimeString('en-GB');
                const simTime = `${Math.floor(state.time/60).toString().padStart(2,'0')}:${(state.time%60).toString().padStart(2,'0')}`;
                const entry = { time: timestamp, simTime, msg: action.payload.msg, type: action.payload.type, timeSeconds: state.time };
                return { ...state, log: [...state.log, entry] };
            case 'SET_FLASH': return { ...state, flash: action.payload };
            case 'START_INTERVENTION_TIMER': return { ...state, activeDurations: { ...state.activeDurations, [action.payload.key]: { startTime: state.time, duration: action.payload.duration } } };
            case 'UPDATE_INTERVENTION_STATE': return { ...state, activeInterventions: action.payload.active, interventionCounts: action.payload.counts };
            case 'SET_PARALYSIS': return { ...state, isParalysed: action.payload };
            case 'REVEAL_INVESTIGATION': return { ...state, investigationsRevealed: { ...state.investigationsRevealed, [action.payload]: true }, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: false } };
            case 'SET_LOADING_INVESTIGATION': return { ...state, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: true } };
            case 'SET_MUTED': return { ...state, isMuted: action.payload };
            case 'TOGGLE_ETCO2': return { ...state, etco2Enabled: !state.etco2Enabled };
            case 'SET_QUEUED_RHYTHM': return { ...state, queuedRhythm: action.payload };
            case 'FAST_FORWARD': return { ...state, time: state.time + action.payload };
            case 'MANUAL_VITAL_UPDATE': return { ...state, vitals: { ...state.vitals, [action.payload.key]: action.payload.value }, prevVitals: { ...state.vitals } };
            case 'UPDATE_SCENARIO': return { ...state, scenario: action.payload };
            case 'MARK_EVENT_PROCESSED': const newEvents = new Set(state.processedEvents); newEvents.add(action.payload); return { ...state, processedEvents: newEvents };
            default: return state;
        }
    };

    const useSimulation = (initialScenario) => {
        const [state, dispatch] = useReducer(simReducer, initialState);
        const timerRef = useRef(null);
        const tickRef = useRef(null);
        const audioCtxRef = useRef(null);
        const stateRef = useRef(state);
        
        // Update ref whenever state changes so loops can access fresh state
        useEffect(() => { stateRef.current = state; }, [state]);
        
        useEffect(() => {
            if (state.scenario && state.log.length > 0) {
                const serializableState = { ...state, activeInterventions: Array.from(state.activeInterventions), processedEvents: Array.from(state.processedEvents) };
                localStorage.setItem('wmebem_sim_state', JSON.stringify(serializableState));
            }
        }, [state.vitals, state.log]);

        useEffect(() => { if (!audioCtxRef.current) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtxRef.current = new AudioContext(); } }, []);

        // OPTIMIZED AUDIO LOOP: Avoids stopping/starting interval on every beat to reduce jitter
        useEffect(() => {
            let timerId;
            const ctx = audioCtxRef.current;

            const scheduleBeep = () => {
                const current = stateRef.current;
                
                if (!current.isRunning || current.vitals.hr <= 0 || current.rhythm === 'VF' || current.rhythm === 'Asystole') {
                     // Check back later if sim resumes or rhythm changes, handled by effect re-mount
                     return; 
                }

                if (!current.isMuted && ctx) {
                    const osc = ctx.createOscillator(); 
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    const freq = current.vitals.spO2 >= 95 ? 880 : current.vitals.spO2 >= 85 ? 600 : 400;
                    osc.frequency.value = freq;
                    osc.connect(gain); 
                    gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    gain.gain.setValueAtTime(0, now); 
                    gain.gain.linearRampToValueAtTime(0.1, now + 0.01); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15); 
                    osc.start(now); 
                    osc.stop(now + 0.2);
                }

                const delay = 60000 / (Math.max(20, current.vitals.hr) || 60);
                timerId = setTimeout(scheduleBeep, delay);
            };

            if (state.isRunning) {
                if (ctx && ctx.state === 'suspended') ctx.resume();
                scheduleBeep();
            }

            return () => clearTimeout(timerId);
        }, [state.isRunning]); 
        // We only restart the loop if running status changes. 
        // Pitch/Rate changes are picked up by stateRef inside the loop.

        const addLogEntry = (msg, type = 'info') => dispatch({ type: 'ADD_LOG', payload: { msg, type } });

        const applyIntervention = (key) => {
            const action = INTERVENTIONS[key];
            if (!action) return;
            
            const newVitals = { ...state.vitals };
            let newActive = new Set(state.activeInterventions);
            let newCounts = { ...state.interventionCounts };
            const count = (newCounts[key] || 0) + 1;
            
            if (action.duration && !state.activeDurations[key]) {
                dispatch({ type: 'START_INTERVENTION_TIMER', payload: { key, duration: action.duration } });
            }

            if (action.type === 'continuous') {
                if (newActive.has(key)) { newActive.delete(key); addLogEntry(`${key} removed/stopped.`, 'action'); } 
                else { newActive.add(key); addLogEntry(action.log, 'action'); }
            } else {
                newCounts[key] = count;
                addLogEntry(action.log, 'action');
            }
            dispatch({ type: 'UPDATE_INTERVENTION_STATE', payload: { active: newActive, counts: newCounts } });

            // --- STATE CHANGE LOGIC (NARRATIVE) ---
            // 1. SEIZURE CESSATION
            if (state.scenario.presentingComplaint === 'Seizure' || state.scenario.title.includes('Seizure') || state.scenario.title.includes('Eclampsia')) {
                const benzos = (newCounts['Lorazepam'] || 0) + (newCounts['Midazolam'] || 0);
                const secondLine = (newCounts['Levetiracetam'] || 0) + (newCounts['Phenytoin'] || 0) + (newCounts['MagSulph'] || 0); // Mag for Eclampsia
                
                // Logic: Stop if 2 doses benzo OR 1 benzo + 1 second line, OR RSI
                if ((benzos >= 2 || (benzos >= 1 && secondLine >= 1) || newActive.has('RSI')) && state.vitals.gcs < 10) {
                     addLogEntry("CLINICAL UPDATE: Seizure activity has ceased. Patient is post-ictal.", 'success');
                     newVitals.hr = Math.max(80, newVitals.hr - 30);
                     newVitals.rr = 18;
                     newVitals.spO2 = 96;
                     // Stop deterioration
                     const updatedScenario = { ...state.scenario, deterioration: { ...state.scenario.deterioration, active: false } };
                     dispatch({ type: 'UPDATE_SCENARIO', payload: updatedScenario });
                     dispatch({ type: 'SET_FLASH', payload: 'green' });
                }
            }

            // 2. TENSION PNEUMOTHORAX RESOLUTION
            if (state.scenario.title.includes('Tension') || state.scenario.title.includes('Stab')) {
                if (key === 'Needle' || key === 'FingerThoracostomy') {
                     addLogEntry("CLINICAL UPDATE: Hiss of air heard. Hemodynamics improving.", 'success');
                     newVitals.spO2 = 92; 
                     newVitals.bpSys = Math.max(90, newVitals.bpSys + 30);
                }
            }

            // 3. ANAPHYLAXIS RESOLUTION
            if (state.scenario.title.includes('Anaphylaxis')) {
                if (key === 'Adrenaline' && count >= 2) {
                    addLogEntry("CLINICAL UPDATE: Wheeze resolving. BP stabilizing.", 'success');
                    const updatedScenario = { ...state.scenario, deterioration: { ...state.scenario.deterioration, active: false } };
                    dispatch({ type: 'UPDATE_SCENARIO', payload: updatedScenario });
                }
            }

            // 4. HYPOGLYCAEMIA
            if (state.vitals.bm < 4.0 && (key === 'InsulinDextrose' || key === 'Glucagon')) {
                 newVitals.bm = 6.0;
                 newVitals.gcs = 14;
                 addLogEntry("CLINICAL UPDATE: GCS improving. BM 6.0.", 'success');
            }

            // --- PHYSIOLOGICAL EFFECTS ---
            if (action.effect.changeRhythm === 'defib' && (state.rhythm === 'VF' || state.rhythm === 'VT')) {
                if (state.queuedRhythm) {
                    dispatch({ type: 'UPDATE_RHYTHM', payload: state.queuedRhythm });
                    if (state.queuedRhythm === 'Sinus Rhythm') triggerROSC();
                    else addLogEntry(`Rhythm changed to ${state.queuedRhythm}`, 'manual');
                    dispatch({ type: 'SET_QUEUED_RHYTHM', payload: null });
                } else if (Math.random() < 0.6) {
                     addLogEntry('Defib: No change in rhythm.', 'warning');
                } else {
                     dispatch({ type: 'UPDATE_RHYTHM', payload: 'Asystole' });
                     addLogEntry('Rhythm changed to Asystole', 'warning');
                }
            }

            if (key === 'Roc' || key === 'Sux') dispatch({ type: 'SET_PARALYSIS', payload: true });
            
            // Standard Vital Adjustments
            const isArrest = state.vitals.bpSys < 10 && (state.rhythm === 'VF' || state.rhythm === 'VT' || state.rhythm === 'Asystole');
            
            // Thoracotomy in Arrest (Trauma) - Drastic improvement potential
            if (key === 'Thoracotomy' && isArrest && state.scenario.category === 'Trauma') {
                 newVitals.bpSys = 60;
                 addLogEntry("CLINICAL UPDATE: Output achieved with internal massage.", 'success');
            }

            if (!isArrest) {
                if (action.effect.HR) { 
                    if (action.effect.HR === 'reset') newVitals.hr = 80; 
                    else newVitals.hr = clamp(newVitals.hr + action.effect.HR, 0, 250); 
                }
                if (action.effect.BP) newVitals.bpSys = clamp(newVitals.bpSys + action.effect.BP, 0, 300);
                if (action.effect.RR && action.effect.RR !== 'vent') newVitals.rr = clamp(newVitals.rr + action.effect.RR, 0, 60);
            }
            if (action.effect.SpO2) newVitals.spO2 = clamp(newVitals.spO2 + action.effect.SpO2, 0, 100);
            if (action.effect.gcs) newVitals.gcs = clamp(newVitals.gcs + action.effect.gcs, 3, 15);

            // General Stabilisers pausing deterioration
            if (state.scenario.stabilisers && state.scenario.stabilisers.includes(key)) {
                dispatch({ type: 'UPDATE_SCENARIO', payload: { ...state.scenario, deterioration: { ...state.scenario.deterioration, rate: Math.max(0, state.scenario.deterioration.rate - 0.05) } } });
                dispatch({ type: 'SET_FLASH', payload: 'green' });
            }

            dispatch({ type: 'UPDATE_VITALS', payload: newVitals });
        };

        const manualUpdateVital = (key, value) => { dispatch({ type: 'MANUAL_VITAL_UPDATE', payload: { key, value } }); addLogEntry(`Manual: ${key} -> ${value}`, 'manual'); };
        
        const triggerArrest = () => { 
            dispatch({ type: 'UPDATE_VITALS', payload: { ...state.vitals, hr: 0, bpSys: 0, bpDia: 0, spO2: 0, rr: 0, gcs: 3, pupils: 'Dilated' } }); 
            dispatch({ type: 'UPDATE_RHYTHM', payload: 'VF' }); 
            addLogEntry('CARDIAC ARREST - VF', 'manual'); 
            dispatch({ type: 'SET_FLASH', payload: 'red' }); 
        };
        
        const triggerROSC = () => { 
            dispatch({ type: 'UPDATE_VITALS', payload: { ...state.vitals, hr: 90, bpSys: 110, bpDia: 70, spO2: 96, rr: 16, gcs: 6, pupils: '3mm' } }); 
            dispatch({ type: 'UPDATE_RHYTHM', payload: 'Sinus Rhythm' }); 
            // Disable deterioration to prevent immediate re-arrest unless instructor re-enables
            const updatedScenario = { ...state.scenario, deterioration: { ...state.scenario.deterioration, active: false } };
            dispatch({ type: 'UPDATE_SCENARIO', payload: updatedScenario });
            addLogEntry('ROSC achieved. Deterioration paused.', 'success'); 
            dispatch({ type: 'SET_FLASH', payload: 'green' }); 
        };
        
        const revealInvestigation = (type) => { if (state.investigationsRevealed[type] || state.loadingInvestigations[type]) return; dispatch({ type: 'SET_LOADING_INVESTIGATION', payload: type }); setTimeout(() => { dispatch({ type: 'REVEAL_INVESTIGATION', payload: type }); addLogEntry(`${type} Result Available`, 'success'); }, 2000); };
        
        const nextCycle = () => {
            dispatch({ type: 'FAST_FORWARD', payload: 120 });
            addLogEntry('Fast Forward: +2 Minutes (Next Cycle)', 'system');
            if (state.queuedRhythm) {
                dispatch({ type: 'UPDATE_RHYTHM', payload: state.queuedRhythm });
                if (state.queuedRhythm === 'Sinus Rhythm') triggerROSC();
                else addLogEntry(`Rhythm Check: Changed to ${state.queuedRhythm}`, 'manual');
                dispatch({ type: 'SET_QUEUED_RHYTHM', payload: null });
            }
        };

        const tick = () => {
            const current = stateRef.current;
            let next = { ...current.vitals };
            
            // ARREST LOGIC: HR 0 -> ARREST
            if (next.hr <= 0 && current.rhythm !== 'Asystole' && current.rhythm !== 'VF' && current.rhythm !== 'VT' && current.rhythm !== 'PEA') {
                dispatch({ type: 'UPDATE_RHYTHM', payload: 'Asystole' });
                addLogEntry("Cardiac Arrest Detected (HR 0). Rhythm: Asystole.", 'danger');
                dispatch({ type: 'SET_FLASH', payload: 'red' });
                next.hr = 0;
            }

            if (current.rhythm === 'Asystole' || current.rhythm === 'VF') { 
                next.hr = 0; next.bpSys = 0; next.bpDia = 0; 
                next.spO2 = Math.max(0, next.spO2 - 2); 
            } else {
                next.hr += getRandomInt(-1, 1); 
                next.bpSys += getRandomInt(-2, 2); 
                next.bpDia += getRandomInt(-2, 2); 
                next.spO2 += Math.random() > 0.9 ? getRandomInt(-1, 1) : 0;
            }

            if (current.activeInterventions.has('Bagging') || current.activeInterventions.has('RSI') || current.activeInterventions.has('i-gel')) {
                next.rr = 12; // Controlled ventilation
                if (current.rhythm !== 'Asystole' && current.rhythm !== 'VF') next.spO2 = Math.min(100, next.spO2 + 2);
            } else if (current.isParalysed) {
                next.rr = 0; // Paralysed and not ventilated
                next.spO2 -= 5; // Hypoxia
            }

            if (current.scenario?.deterioration?.active && current.scenario.deterioration.rate > 0 && current.rhythm !== 'VF' && current.rhythm !== 'Asystole') {
                if (Math.random() < current.scenario.deterioration.rate) {
                    if (current.scenario.deterioration.type === 'shock') { next.bpSys -= 2; next.hr += 1; }
                    else if (current.scenario.deterioration.type === 'neuro') { next.bpSys += 1; next.hr = Math.max(40, next.hr - 1); }
                    else if (current.scenario.deterioration.type === 'respiratory') { next.spO2 -= 1; next.rr += 1; }
                    else if (current.scenario.deterioration.type === 'cardiac') { next.bpSys -= 2; }
                }
            }

            // Safety Checks: Clamp to realistic values to prevent "ludicrous" obs
            next.hr = clamp(next.hr, 0, 250);
            next.bpSys = clamp(next.bpSys, 0, 300);
            next.bpDia = clamp(next.bpDia, 0, 250);
            next.rr = clamp(next.rr, 0, 60);
            next.spO2 = clamp(next.spO2, 0, 100);
            next.temp = clamp(next.temp, 32, 43);
            next.bm = clamp(next.bm, 1, 40);
            
            dispatch({ type: 'UPDATE_VITALS', payload: next });
        };

        const start = () => { 
            if (state.isRunning) return; 
            dispatch({ type: 'START_SIM' }); 
            timerRef.current = setInterval(() => dispatch({ type: 'TICK_TIME' }), 1000); 
            tickRef.current = setInterval(tick, 3000); 
            if (audioCtxRef.current && audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume(); 
        };
        
        const pause = () => { dispatch({ type: 'PAUSE_SIM' }); clearInterval(timerRef.current); clearInterval(tickRef.current); };
        const stop = () => { pause(); addLogEntry("Simulation Ended", 'system'); localStorage.removeItem('wmebem_sim_state'); };

        return { state, dispatch, start, pause, stop, applyIntervention, addLogEntry, manualUpdateVital, triggerArrest, triggerROSC, revealInvestigation, nextCycle };
    };
        
        // --- UI SCREENS ---

    const SetupScreen = ({ onGenerate, initialParams, savedState, onResume }) => {
        const [category, setCategory] = useState(initialParams?.category || 'Any');
        const [age, setAge] = useState(initialParams?.age || 'Any');
        const [hf, setHf] = useState(initialParams?.hf || 'hf0');
        const [acuity, setAcuity] = useState(initialParams?.acuity || 'Any'); 
        const [loading, setLoading] = useState(false);
        const [customMode, setCustomMode] = useState(initialParams?.customMode || false);
        const [error, setError] = useState("");
        const [baseTemplate, setBaseTemplate] = useState(""); // For picking a pre-made scenario
        
        const [customScenario, setCustomScenario] = useState({ 
            title: "Custom Case", age: 40, complaint: "Unwell", profile: "History...", 
            hr: 80, bpSys: 120, rr: 16, spO2: 98, temp: 37.0, gcs: 15, bm: 5.5, 
            ecgType: "Sinus Rhythm", ecgFindings: "NSR", cxrFindings: "Normal", 
            urineFindings: "Clear", ctFindings: "Normal" 
        });

        // Function to fill custom fields from a selected template
        const handleTemplateChange = (e) => {
            const templateId = e.target.value;
            setBaseTemplate(templateId);
            const tmpl = ALL_SCENARIOS.find(s => s.id === templateId);
            if (tmpl) {
                const pAge = tmpl.ageGenerator();
                const v = tmpl.vitalsMod || getBaseVitals(pAge);
                setCustomScenario({
                    title: tmpl.title,
                    age: pAge,
                    complaint: tmpl.presentingComplaint,
                    profile: tmpl.patientProfileTemplate.replace('{age}', pAge).replace('{sex}', 'Male'),
                    hr: v.hr || 80, bpSys: v.bpSys || 120, rr: v.rr || 16, spO2: v.spO2 || 98, temp: v.temp || 37, gcs: v.gcs || 15, bm: v.bm || 5.5,
                    ecgType: tmpl.ecg?.type || "Sinus Rhythm",
                    ecgFindings: tmpl.ecg?.findings || "NSR",
                    cxrFindings: tmpl.chestXray?.findings || "Normal",
                    urineFindings: tmpl.urine?.findings || "Normal",
                    ctFindings: tmpl.ct?.findings || "Normal"
                });
            }
        };

        const handleGenerate = () => {
            setError(""); setLoading(true);
            setTimeout(() => {
                let generatedScenario;
                if (customMode) {
                    const history = generateHistory(customScenario.age);
                    generatedScenario = { 
                        id: 'CUSTOM', title: customScenario.title, category: 'Custom', ageRange: 'Custom', 
                        patientAge: customScenario.age, profile: customScenario.profile, presentingComplaint: customScenario.complaint, 
                        scenarioDetails: ['Custom scenario.'], 
                        instructorBrief: { progression: "Custom.", interventions: [], equipment: "Standard", debriefPoints: [] }, 
                        recommendedActions: [], 
                        vitals: { hr: parseInt(customScenario.hr), bpSys: parseInt(customScenario.bpSys), bpDia: Math.floor(parseInt(customScenario.bpSys) * 0.65), rr: parseInt(customScenario.rr), spO2: parseInt(customScenario.spO2), temp: parseFloat(customScenario.temp), gcs: parseInt(customScenario.gcs), bm: parseFloat(customScenario.bm), pupils: '3mm' }, 
                        vbg: generateVbg("normal"), hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf), 
                        ecg: { type: customScenario.ecgType, findings: customScenario.ecgFindings }, 
                        chestXray: { findings: customScenario.cxrFindings }, deterioration: { active: false, rate: 0 }, 
                        stabilisers: [], interventions: [], pmh: history.pmh, dhx: history.dhx, allergies: history.allergies, 
                        urine: { findings: customScenario.urineFindings }, ct: { findings: customScenario.ctFindings } 
                    };
                } else {
                    let pool = ALL_SCENARIOS.filter(s => 
                        (category === 'Any' || s.category === category) && 
                        (age === 'Any' || s.ageRange === age) && 
                        (acuity === 'Any' || s.acuity === acuity)
                    );
                    
                    if (pool.length === 0) { setLoading(false); setError(`No scenarios found for ${category} + ${age} + ${acuity}.`); return; }
                    
                    const base = pool[Math.floor(Math.random() * pool.length)];
                    const patientAge = base.ageGenerator();
                    const ranges = getBaseVitals(patientAge);
                    const history = generateHistory(patientAge, base.category === 'Obstetrics & Gynae' ? 'Female' : 'Male');
                    let startVitals = { 
                        hr: base.vitalsMod?.hr || ranges.hr, 
                        bpSys: base.vitalsMod?.bpSys || ranges.bpSys, 
                        bpDia: base.vitalsMod?.bpDia || ranges.bpDia || Math.floor((base.vitalsMod?.bpSys || ranges.bpSys) * 0.65), 
                        rr: base.vitalsMod?.rr || ranges.rr, 
                        spO2: base.vitalsMod?.spO2 || 98, 
                        temp: base.vitalsMod?.temp || ranges.temp, 
                        gcs: base.vitalsMod?.gcs || 15, 
                        bm: ranges.bm, 
                        pupils: ranges.pupils 
                    };
                    const profile = base.patientProfileTemplate.replace(/{age}/g, patientAge).replace(/{sex}/g, 'male');
                    generatedScenario = { 
                        ...base, patientAge, profile, vitals: startVitals, 
                        vbg: generateVbg(base.vbgClinicalState), 
                        hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf), 
                        pmh: base.pmh || history.pmh, dhx: base.dhx || history.dhx, allergies: base.allergies || history.allergies 
                    };
                }
                
                // Add Paeds Weight/WETFLAG if applicable
                if (generatedScenario.ageRange === 'Paediatric' || generatedScenario.patientAge < 18) { 
                    generatedScenario.weight = estimateWeight(generatedScenario.patientAge);
                    generatedScenario.wetflag = calculateWetflag(generatedScenario.patientAge, generatedScenario.weight);
                }
                
                setLoading(false); 
                onGenerate(generatedScenario, { category, age, hf, customMode, acuity });
            }, 600);
        };

        useEffect(() => { if (initialParams && initialParams.autoGenerate) { handleGenerate(); } }, []);

        return (
            <div className="max-w-2xl mx-auto space-y-6 p-4 w-full h-full overflow-y-auto">
                {savedState && (
                    <div className="bg-emerald-900/30 border border-emerald-500 p-4 rounded-lg flex items-center justify-between">
                        <div><h3 className="font-bold text-emerald-400">Previous Session Found</h3><p className="text-sm text-slate-300">Resume {savedState.scenario.title}?</p></div>
                        <Button onClick={onResume} variant="success">Resume</Button>
                    </div>
                )}
                <div className="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-sky-400 mb-4 flex items-center gap-2"><Lucide icon="settings"/> Simulation Parameters</h2>
                    <div className="flex gap-4 mb-6 border-b border-slate-700 pb-2">
                        <button onClick={() => setCustomMode(false)} className={`text-sm font-bold uppercase pb-1 ${!customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Random</button>
                        <button onClick={() => setCustomMode(true)} className={`text-sm font-bold uppercase pb-1 ${customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Custom</button>
                    </div>
                    {!customMode ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Category</label><select value={category} onChange={e=>setCategory(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Medical">Medical</option><option value="Trauma">Trauma</option><option value="Obstetrics & Gynae">Obs & Gynae</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Age</label><select value={age} onChange={e=>setAge(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Adult">Adult</option><option value="Paediatric">Paediatric</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Acuity</label><select value={acuity} onChange={e=>setAcuity(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Majors">Majors</option><option value="Resus">Resus</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Human Factor</label><select value={hf} onChange={e=>setHf(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm">{HUMAN_FACTOR_CHALLENGES.map(h => <option key={h.id} value={h.id}>{h.type}</option>)}</select></div>
                        </div>
                    ) : (
                        <div className="space-y-4 mb-6">
                             <div>
                                <label className="text-xs uppercase text-slate-500 font-bold">Pre-fill from Scenario (Optional)</label>
                                <select value={baseTemplate} onChange={handleTemplateChange} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm">
                                    <option value="">-- Select Base --</option>
                                    {ALL_SCENARIOS.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                </select>
                            </div>
                            <input type="text" placeholder="Title" value={customScenario.title} onChange={e => setCustomScenario({...customScenario, title: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-3"/>
                            <div className="grid grid-cols-2 gap-2">
                                <select value={customScenario.ecgType} onChange={e => setCustomScenario({...customScenario, ecgType: e.target.value})} className="bg-slate-900 border border-slate-600 rounded p-3"><option>Sinus Rhythm</option><option>Sinus Tachy</option><option>AF</option><option>VT</option><option>VF</option><option>STEMI</option><option>Asystole</option></select>
                                <input type="number" placeholder="HR" value={customScenario.hr} onChange={e => setCustomScenario({...customScenario, hr: e.target.value})} className="bg-slate-900 border border-slate-600 rounded p-3"/>
                            </div>
                        </div>
                    )}
                    {error && <div className="mb-4 p-3 bg-red-900/30 border border-red-500 rounded text-red-200 text-sm font-bold flex items-center gap-2"><Lucide icon="alert-circle" className="w-4 h-4"/>{error}</div>}
                    <Button onClick={handleGenerate} disabled={loading} className="w-full py-4 text-lg">{loading ? "Building Scenario..." : "Generate Scenario"}</Button>
                </div>
            </div>
        );
    };

    const BriefingScreen = ({ scenario, onStart, onBack, onNewScenario }) => (
        <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-4 overflow-y-auto h-full">
            <div className="bg-slate-800 p-6 rounded-lg border-l-4 border-sky-500 shadow-lg">
                <div className="flex justify-between items-start mb-4">
                    <div><h2 className="text-3xl font-bold text-white">{scenario.title}</h2><span className="inline-block bg-slate-700 text-sky-300 text-xs px-2 py-1 rounded mt-2">{scenario.category}</span></div>
                    <div className="text-right"><p className="text-2xl font-mono font-bold text-emerald-400">GCS {scenario.vitals.gcs}</p></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 className="text-sm font-bold text-slate-500 uppercase mb-1">Patient Profile</h3>
                        <p className="text-lg leading-relaxed mb-4">{scenario.profile}</p>
                        <div className="space-y-2 mb-4">
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700">
                                <span className="text-xs text-slate-500 uppercase font-bold block">PMH</span>
                                <span className="text-sm text-slate-200">{scenario.pmh ? scenario.pmh.join(", ") : 'Nil'}</span>
                            </div>
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700">
                                <span className="text-xs text-slate-500 uppercase font-bold block">Drug History</span>
                                <span className="text-sm text-slate-200">{scenario.dhx ? scenario.dhx.join(", ") : 'Nil'}</span>
                            </div>
                            <div className="p-2 bg-slate-900/50 rounded border border-slate-700">
                                <span className="text-xs text-slate-500 uppercase font-bold block">Allergies</span>
                                <span className="text-sm text-red-300 font-bold">{scenario.allergies ? scenario.allergies.join(", ") : 'Nil'}</span>
                            </div>
                        </div>
                        <div className="p-3 bg-slate-700/50 rounded border border-slate-600"><p className="font-bold text-sky-300">PC: {scenario.presentingComplaint}</p></div>
                        
                        {/* RECOMMENDED EQUIPMENT SECTION */}
                        <div className="mt-4 p-3 bg-slate-900/30 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-2"><Lucide icon="briefcase" className="w-3 h-3 inline mr-1"/> Recommended Kit</h4>
                            <div className="flex flex-wrap gap-2">
                                {scenario.equipment && scenario.equipment.map((item, i) => (
                                    <span key={i} className="text-xs bg-slate-700 text-slate-200 px-2 py-1 rounded border border-slate-600">{item}</span>
                                ))}
                            </div>
                        </div>
                        
                        {/* CLINICAL GUIDELINES SECTION */}
                        <div className="mt-4 p-3 bg-slate-900/30 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-slate-400 uppercase mb-2"><Lucide icon="book-open" className="w-3 h-3 inline mr-1"/> Guidelines</h4>
                            <div className="flex flex-col gap-2">
                                {scenario.learningLinks && scenario.learningLinks.map((link, i) => (
                                    <a key={i} href={link.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs text-sky-400 hover:underline">
                                        <Lucide icon="external-link" className="w-3 h-3"/> {link.label}
                                    </a>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="space-y-4">
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-amber-400 uppercase mb-2">Progression</h4>
                            <p className="text-sm text-slate-300">{scenario.instructorBrief.progression}</p>
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-sky-400 uppercase mb-2">Learning Objectives</h4>
                            <ul className="list-disc pl-4 text-sm text-slate-300">
                                {scenario.instructorBrief.learningObjectives && scenario.instructorBrief.learningObjectives.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-emerald-400 uppercase mb-2">Key Interventions</h4>
                            <ul className="list-disc pl-4 text-sm text-slate-300">
                                {scenario.instructorBrief.interventions && scenario.instructorBrief.interventions.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-purple-400 uppercase mb-2">Debrief Points</h4>
                            <ul className="list-disc pl-4 text-sm text-slate-300">
                                {scenario.instructorBrief.debriefPoints && scenario.instructorBrief.debriefPoints.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div className="flex flex-col md:flex-row gap-4">
                <Button onClick={onBack} variant="secondary" className="flex-1">Back</Button>
                <Button onClick={onNewScenario} variant="secondary" className="flex-1">New Scenario</Button>
                <Button onClick={onStart} className="flex-1 shadow-sky-900/20 shadow-xl">Start Simulation</Button>
            </div>
        </div>
    );
    const LiveSimScreen = ({ sim, onFinish, onBack }) => {
        const { state, start, pause, applyIntervention, addLogEntry, manualUpdateVital, triggerArrest, triggerROSC, revealInvestigation, nextCycle } = sim;
        const { scenario, time, isRunning, vitals, prevVitals, log, flash, activeInterventions, interventionCounts, activeDurations, isMuted, rhythm, etco2Enabled, queuedRhythm } = state;
        const [activeTab, setActiveTab] = useState("Common");
        const [customLog, setCustomLog] = useState("");
        
        // MODAL STATES
        const [showChecklist, setShowChecklist] = useState(false);
        const [showDrugCalc, setShowDrugCalc] = useState(false);
        const [checklistItems, setChecklistItems] = useState({ cpr: false, pads: false, airway: false, access: false, adrenaline: false, amiodarone: false, shock: false });
        
        // DRUG CALC STATE
        const [drugCalc, setDrugCalc] = useState({ drug: 'Salbutamol', dose: '', weight: scenario.weight || 70 });

        const getInterventionsByCat = (cat) => Object.keys(INTERVENTIONS).filter(key => INTERVENTIONS[key].category === cat);
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
        const isArrest = ['VF', 'VT', 'Asystole', 'PEA'].includes(rhythm);

        const handleChecklistToggle = (item) => {
            const newState = !checklistItems[item];
            setChecklistItems({ ...checklistItems, [item]: newState });
            if(newState) addLogEntry(`Checklist: ${item.toUpperCase()} confirmed.`, 'action');
        };

        const handleDrugCalc = () => {
            if(!drugCalc.dose) return;
            const total = parseFloat(drugCalc.dose) * parseFloat(drugCalc.weight);
            addLogEntry(`Drug Prep: ${drugCalc.drug} ${drugCalc.dose}mg/kg -> Total ${total.toFixed(1)}mg prepared.`, 'action');
            setShowDrugCalc(false);
        };

        return (
            <div className={`h-full overflow-y-auto lg:overflow-hidden grid grid-cols-1 lg:grid-cols-3 gap-4 p-2 md:p-4 transition-colors duration-500 relative ${flash === 'red' ? 'flash-red' : (flash === 'green' ? 'flash-green' : '')}`}>
                
                {/* --- MODALS --- */}
                {showChecklist && (
                    <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-slate-800 border border-slate-600 rounded-lg p-6 w-full max-w-md shadow-2xl">
                            <h3 className="text-xl font-bold text-red-500 mb-4 flex items-center gap-2"><Lucide icon="clipboard-list"/> Cardiac Arrest Protocol</h3>
                            <div className="space-y-3">
                                {Object.keys(checklistItems).map(key => (
                                    <button key={key} onClick={() => handleChecklistToggle(key)} className={`w-full p-3 rounded flex items-center justify-between font-bold border ${checklistItems[key] ? 'bg-emerald-600/30 border-emerald-500 text-emerald-400' : 'bg-slate-700 border-slate-600 text-slate-300'}`}>
                                        <span className="uppercase">{key}</span>
                                        {checklistItems[key] && <Lucide icon="check" className="w-5 h-5"/>}
                                    </button>
                                ))}
                            </div>
                            <Button className="w-full mt-4" onClick={() => setShowChecklist(false)}>Close Checklist</Button>
                        </div>
                    </div>
                )}

                {showDrugCalc && (
                    <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-slate-800 border border-slate-600 rounded-lg p-6 w-full max-w-md shadow-2xl">
                            <h3 className="text-xl font-bold text-sky-500 mb-4 flex items-center gap-2"><Lucide icon="calculator"/> Drug Calculator</h3>
                            <div className="space-y-4">
                                <div><label className="text-xs font-bold text-slate-500">Patient Weight</label><input type="number" value={drugCalc.weight} onChange={e => setDrugCalc({...drugCalc, weight: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white" /></div>
                                <div><label className="text-xs font-bold text-slate-500">Drug</label>
                                    <select value={drugCalc.drug} onChange={e => setDrugCalc({...drugCalc, drug: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white">
                                        {['Salbutamol', 'Aminophylline', 'Magnesium Sulphate', 'Phenytoin', 'Levetiracetam', 'Ketamine', 'Propofol'].map(d => <option key={d}>{d}</option>)}
                                    </select>
                                </div>
                                <div><label className="text-xs font-bold text-slate-500">Dose (mg/kg)</label><input type="number" value={drugCalc.dose} onChange={e => setDrugCalc({...drugCalc, dose: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white" placeholder="e.g. 5" /></div>
                                {drugCalc.dose && <div className="p-3 bg-emerald-900/30 rounded border border-emerald-500 text-center"><p className="text-xs text-emerald-400 font-bold">TOTAL DOSE</p><p className="text-2xl font-bold text-white">{(parseFloat(drugCalc.dose) * parseFloat(drugCalc.weight)).toFixed(1)} mg</p></div>}
                            </div>
                            <div className="flex gap-2 mt-4">
                                <Button variant="secondary" className="flex-1" onClick={() => setShowDrugCalc(false)}>Cancel</Button>
                                <Button variant="success" className="flex-1" onClick={handleDrugCalc}>Log & Prep</Button>
                            </div>
                        </div>
                    </div>
                )}

                {/* LEFT COL: Monitor & Actions */}
                <div className="lg:col-span-2 flex flex-col gap-4 lg:overflow-hidden lg:h-full h-auto">
                    
                    {/* MONITOR HEADER */}
                    <Card className="bg-slate-900 border-slate-800 flex-shrink-0">
                        <div className="flex justify-between items-center mb-2 border-b border-slate-800 pb-2">
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={onBack} className="h-8 text-xs px-2"><Lucide icon="arrow-left"/> Back</Button>
                                {!isRunning ? <Button variant="success" onClick={start} className="h-8 px-4 font-bold"><Lucide icon="play"/> START</Button> : <Button variant="danger" onClick={pause} className="h-8 px-4"><Lucide icon="pause"/> Pause</Button>}
                                <Button variant="primary" onClick={onFinish} className="h-8 px-4"><Lucide icon="square"/> Finish</Button>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => sim.dispatch({type: 'SET_MUTED', payload: !isMuted})} className={`p-1.5 rounded-full ${isMuted ? 'bg-red-900 text-white' : 'bg-slate-800 text-slate-400'}`}><Lucide icon={isMuted ? "volume-x" : "volume-2"} className="w-4 h-4" /></button>
                                <div className="font-mono text-xl font-bold text-emerald-400 bg-black/40 px-3 py-1 rounded">{formatTime(time)}</div>
                            </div>
                        </div>

                        {/* WAVEFORMS */}
                        <div className="mb-2 relative">
                             <ECGMonitor rhythmType={rhythm} hr={vitals.hr} rr={vitals.rr} isPaused={!isRunning} showEtco2={etco2Enabled} pathology={scenario.deterioration.type} />
                             {(!['VF','VT','Asystole'].includes(rhythm) && vitals.bpSys < 30) && (
                                <div className="absolute top-0 left-0 right-0 bottom-0 flex items-center justify-center pointer-events-none">
                                    <div className="bg-red-600/80 text-white font-bold text-lg px-6 py-2 rounded pea-warning border-2 border-white">PEA - CHECK PULSE</div>
                                </div>
                             )}
                        </div>

                        {/* NUMERICS GRID */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <VitalDisplay label="Heart Rate" value={vitals.hr} prev={prevVitals.hr} unit="bpm" lowIsBad={false} onUpdate={(v) => manualUpdateVital('hr', v)} alert={vitals.hr > 140 || vitals.hr < 40}/>
                            <VitalDisplay label="BP" value={vitals.bpSys} value2={vitals.bpDia} prev={prevVitals.bpSys} unit="mmHg" onUpdate={(v) => manualUpdateVital('bpSys', v)} alert={vitals.bpSys < 90}/>
                            <VitalDisplay label="SpO2" value={vitals.spO2} prev={prevVitals.spO2} unit="%" onUpdate={(v) => manualUpdateVital('spO2', v)} alert={vitals.spO2 < 90}/>
                            <VitalDisplay label="RR" value={vitals.rr} prev={prevVitals.rr} unit="/min" lowIsBad={false} onUpdate={(v) => manualUpdateVital('rr', v)} alert={vitals.rr > 30 || vitals.rr < 8}/>
                            
                            <VitalDisplay label="Temp" value={vitals.temp} prev={prevVitals.temp} unit="C" onUpdate={(v) => manualUpdateVital('temp', v)} alert={vitals.temp > 38}/>
                            <VitalDisplay label="Glucose" value={vitals.bm} prev={prevVitals.bm} unit="mmol/L" onUpdate={(v) => manualUpdateVital('bm', v)} alert={vitals.bm < 4}/>
                            <VitalDisplay label="Pupils" value={vitals.pupils || "3mm"} unit="" isText={true} onUpdate={(v) => manualUpdateVital('pupils', v)} />
                            {etco2Enabled ? (
                                <div className="bg-slate-900/50 p-2 md:p-3 rounded border border-yellow-500/50 flex flex-col items-center justify-center h-24 md:h-28 relative">
                                    <span className="text-[10px] md:text-xs font-bold text-yellow-500 uppercase tracking-wider mb-1">ETCO2</span>
                                    <span className="text-2xl md:text-3xl font-mono font-bold text-yellow-500">
                                        {vitals.hr > 0 ? (scenario.deterioration.type === 'respiratory' ? '6.5' : '4.5') : '1.0'}
                                    </span>
                                    <span className="text-[9px] md:text-[10px] text-slate-600 mt-1">kPa</span>
                                </div>
                            ) : (
                                <div className="bg-slate-900/20 p-2 md:p-3 rounded border border-slate-800 flex flex-col items-center justify-center h-24 md:h-28 opacity-50">
                                    <span className="text-[10px] md:text-xs font-bold text-slate-600 uppercase tracking-wider">ETCO2</span>
                                    <span className="text-lg text-slate-700">OFF</span>
                                </div>
                            )}
                        </div>
                    </Card>

                    {/* ACTIONS PANEL */}
                    <Card title="Clinical Actions" icon="activity" className="flex-1 min-h-0 bg-slate-800">
                        {/* Sim Controls */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 bg-slate-900/50 p-2 rounded">
                             <Button variant="danger" onClick={triggerArrest} className="text-xs h-8">VF Arrest</Button>
                             <Button variant="success" onClick={triggerROSC} className="text-xs h-8">ROSC</Button>
                             <select className="bg-slate-700 text-white text-xs rounded px-2 h-8 border border-slate-600" value={queuedRhythm || ""} onChange={(e) => sim.dispatch({type: 'SET_QUEUED_RHYTHM', payload: e.target.value})}>
                                 <option value="">Next Rhythm...</option>
                                 <option value="Sinus Rhythm">ROSC (Sinus)</option>
                                 <option value="VF">VF</option>
                                 <option value="Asystole">Asystole</option>
                                 <option value="PEA">PEA</option>
                             </select>
                             <Button variant="warning" onClick={nextCycle} className="text-xs h-8">Next Cycle (+2m)</Button>
                        </div>

                        {/* DYNAMIC ALS BUTTONS */}
                        <div className="flex gap-2 mb-2">
                            {isArrest && (
                                <Button variant="danger" onClick={() => setShowChecklist(true)} className="flex-1 h-10 animate-pulse font-bold text-sm">
                                    <Lucide icon="clipboard-list"/> CARDIAC ARREST MODE
                                </Button>
                            )}
                            <Button variant="primary" onClick={() => setShowDrugCalc(true)} className="flex-1 h-10 text-xs">
                                <Lucide icon="calculator"/> Drug Infusion/Calc
                            </Button>
                        </div>

                        {/* Recommended Actions */}
                        {scenario.recommendedActions && (
                            <div className="mb-4 bg-sky-900/20 border border-sky-600/50 p-2 rounded-lg">
                                <h4 className="text-[10px] font-bold text-sky-400 uppercase mb-2 flex items-center gap-2"><Lucide icon="check-square" className="w-3 h-3"/> Recommended</h4>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    {scenario.recommendedActions.map(key => {
                                        const action = INTERVENTIONS[key];
                                        if(!action) return null;
                                        const isActive = activeInterventions.has(key);
                                        let progress = 0;
                                        if(activeDurations[key]) {
                                            const elapsed = time - activeDurations[key].startTime;
                                            progress = Math.min(100, Math.max(0, 100 - (elapsed / activeDurations[key].duration * 100)));
                                        }
                                        return (
                                            <Button key={`rec-${key}`} variant={isActive ? "success" : "secondary"} onClick={() => applyIntervention(key)} disabled={!isRunning} className="text-xs h-8 relative border border-sky-500/30" progress={progress}>
                                                {action.label}
                                                {interventionCounts[key] > 0 && action.type !== 'continuous' && <span className="bg-white/20 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-1">x{interventionCounts[key]}</span>}
                                            </Button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        
                        {/* Tabs */}
                        <div className="flex space-x-2 mb-2 overflow-x-auto pb-1 no-scrollbar">
                            {['Common', 'Airway', 'Circulation', 'Drugs', 'Obs/Gynae', 'Procedures'].map(cat => (
                                <button key={cat} onClick={() => setActiveTab(cat)} className={`px-3 py-1 text-xs font-bold rounded transition-colors whitespace-nowrap ${activeTab === cat ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-400'}`}>{cat}</button>
                            ))}
                        </div>

                        {/* Grid */}
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 overflow-y-auto min-h-0 flex-1 content-start">
                            {activeTab === 'Airway' && (
                                <Button variant={etco2Enabled ? "success" : "secondary"} onClick={() => sim.dispatch({type: 'TOGGLE_ETCO2'})} className="text-xs h-10">
                                    {etco2Enabled ? "Disconnect ETCO2" : "Connect ETCO2"}
                                </Button>
                            )}
                            {getInterventionsByCat(activeTab).map(key => {
                                const isActive = activeInterventions.has(key);
                                let progress = 0;
                                if(activeDurations[key]) {
                                    const elapsed = time - activeDurations[key].startTime;
                                    progress = Math.min(100, Math.max(0, 100 - (elapsed / activeDurations[key].duration * 100)));
                                }
                                
                                // DYNAMIC PAEDIATRIC LABELING
                                const isPaeds = scenario.ageRange === 'Paediatric' || scenario.patientAge < 18;
                                let label = INTERVENTIONS[key]?.label || key;
                                
                                if (isPaeds) {
                                    if (key === 'Fluids') label = `Fluid Bolus (10ml/kg)`; 
                                    else if (key === 'Adrenaline') label = `Adrenaline 1:1000 IM`;
                                    else if (key === 'Atropine') label = `Atropine (20mcg/kg)`;
                                    else if (key === 'Amidarone') label = `Amiodarone (5mg/kg)`;
                                    else if (key === 'Lorazepam') label = `Lorazepam (0.1mg/kg)`;
                                    else if (key === 'Midazolam') label = `Midazolam (0.5mg/kg)`;
                                    else if (key === 'TXA') label = `TXA (15mg/kg)`;
                                    else if (key === 'Blood') label = `Blood (10ml/kg)`;
                                }

                                return (
                                    <Button key={key} variant={isActive ? "success" : "secondary"} onClick={() => applyIntervention(key)} disabled={!isRunning} className="text-xs h-10 relative" progress={progress}>
                                        {label}
                                        {interventionCounts[key] > 0 && INTERVENTIONS[key].type !== 'continuous' && <span className="bg-white/20 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-1">x{interventionCounts[key]}</span>}
                                    </Button>
                                )
                            })}
                        </div>
                        
                        {/* Manual Log */}
                        <div className="mt-2 flex gap-2 pt-2 border-t border-slate-700">
                             <input type="text" className="bg-slate-900 border border-slate-600 rounded px-2 text-xs flex-1 text-white" placeholder="Custom Log Entry..." value={customLog} onChange={e=>setCustomLog(e.target.value)} onKeyDown={e => e.key === 'Enter' && (addLogEntry(customLog, 'manual') || setCustomLog(""))} />
                             <Button onClick={() => {addLogEntry(customLog, 'manual'); setCustomLog("");}} className="h-8 text-xs">Log</Button>
                        </div>
                    </Card>
                </div>

                {/* RIGHT COL: Info & Log */}
                <div className="flex flex-col gap-4 h-full overflow-hidden">
                    <Card title="Scenario Info" icon="info" collapsible={true} className="flex-shrink-0">
                         <h3 className="font-bold text-white mb-1">{scenario.title}</h3>
                         <p className="text-xs text-slate-300 mb-2">{scenario.patientProfileTemplate.replace('{age}', scenario.patientAge).replace('{sex}', 'Male')}</p>
                         <div className="grid grid-cols-2 gap-2">
                             {['ECG', 'VBG', 'X-ray', 'POCUS', 'CT', 'Urine'].map(t => (
                                 <InvestigationButton key={t} type={t} icon="activity" label={t} isRevealed={state.investigationsRevealed[t]} isLoading={state.loadingInvestigations[t]} revealInvestigation={revealInvestigation} isRunning={isRunning} scenario={scenario}/>
                             ))}
                         </div>
                        {scenario.wetflag && (
                            <div className="mt-4 bg-slate-900/50 rounded border border-slate-700 p-2">
                                <h4 className="text-[10px] font-bold text-sky-400 uppercase mb-1 border-b border-slate-700 pb-1">WETFLAG (Wt: {scenario.wetflag.weight}kg)</h4>
                                <table className="w-full text-[10px] text-left text-slate-300">
                                    <tbody>
                                        <tr><td className="py-0.5 text-slate-500 font-bold">Energy (4J/kg)</td><td className="py-0.5 text-right font-mono text-emerald-400">{scenario.wetflag.energy} J</td></tr>
                                        <tr><td className="py-0.5 text-slate-500 font-bold">Tube Size</td><td className="py-0.5 text-right font-mono text-emerald-400">{scenario.wetflag.tube}</td></tr>
                                        <tr><td className="py-0.5 text-slate-500 font-bold">Fluids (10ml/kg)</td><td className="py-0.5 text-right font-mono text-emerald-400">{scenario.wetflag.fluids} ml</td></tr>
                                        <tr><td className="py-0.5 text-slate-500 font-bold">Lorazepam</td><td className="py-0.5 text-right font-mono text-emerald-400">{scenario.wetflag.lorazepam} mg</td></tr>
                                        <tr><td className="py-0.5 text-slate-500 font-bold">Adren (1:10k)</td><td className="py-0.5 text-right font-mono text-emerald-400">{scenario.wetflag.adrenaline} ml</td></tr>
                                        <tr><td className="py-0.5 text-slate-500 font-bold">Glucose (10%)</td><td className="py-0.5 text-right font-mono text-emerald-400">{scenario.wetflag.glucose} ml</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </Card>
                    
                    <Card title="Clinical Guidelines" icon="book" collapsible={true} defaultOpen={false} className="flex-shrink-0">
                        <div className="flex flex-col gap-2">
                            {scenario.learningLinks && scenario.learningLinks.map((link, i) => (
                                <a key={i} href={link.url} target="_blank" rel="noopener noreferrer" className="p-3 bg-slate-700/50 hover:bg-slate-700 rounded border border-slate-600 flex flex-col gap-1 text-xs">
                                    <div className="font-bold text-sky-400 flex items-center gap-2"><Lucide icon="external-link" className="w-3 h-3"/> {link.label}</div>
                                </a>
                            ))}
                            {!scenario.learningLinks && <p className="text-xs text-slate-400 italic">No specific guidelines linked.</p>}
                        </div>
                    </Card>

                    <Card className="flex-1 min-h-0 bg-slate-800 flex flex-col">
                        <div className="flex items-center gap-2 mb-2 border-b border-slate-700 pb-2"><Lucide icon="list" className="w-4 h-4 text-sky-400" /><h3 className="font-bold text-slate-200 text-sm">Incident Log</h3></div>
                        <div className="flex-1 overflow-y-auto space-y-1 pr-1 text-xs font-mono">
                            {log.map((l, i) => (<div key={i} className={`p-1.5 rounded border-l-2 ${l.type === 'success' ? 'bg-emerald-900/20 border-emerald-500' : l.type === 'action' ? 'bg-sky-900/20 border-sky-500' : l.type === 'manual' ? 'bg-purple-900/20 border-purple-500' : l.type === 'danger' ? 'bg-red-900/30 border-red-500' : 'bg-slate-700/30 border-slate-500'}`}><span className="text-slate-500 mr-2">{l.simTime}</span><span className="text-slate-200">{l.msg}</span></div>))}
                        </div>
                    </Card>
                </div>
            </div>
        );
    };

    const DebriefScreen = ({ sim, onRestart }) => {
        const { state } = sim;
        const { log, scenario, history } = state; 
        const chartRef = useRef(null);

        useEffect(() => {
            if (!chartRef.current || !history.length) return;
            
            // Fix Jitter: Calculate Y-offset based on index (deterministic), not Math.random()
            const interventions = log
                .filter(l => l.type === 'action' || l.type === 'manual')
                .map((l, i) => ({ 
                    x: `${Math.floor(l.timeSeconds/60)}:${(l.timeSeconds%60).toString().padStart(2,'0')}`, 
                    label: l.msg,
                    yOffset: (i % 6) * 15 // Stagger labels cyclically to avoid overlap without random jumping
                }));

            const chart = new window.Chart(chartRef.current, {
                type: 'line',
                data: {
                    labels: history.map(h => `${Math.floor(h.time/60)}:${(h.time%60).toString().padStart(2,'0')}`),
                    datasets: [ 
                        { label: 'HR', data: history.map(h => h.hr), borderColor: '#ef4444', borderWidth: 2, pointRadius: 0, tension: 0.1 }, 
                        { label: 'Sys BP', data: history.map(h => h.bp), borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, tension: 0.1 }, 
                        { label: 'SpO2', data: history.map(h => h.spo2), borderColor: '#10b981', borderWidth: 2, pointRadius: 0, tension: 0.1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    animation: false, 
                    hover: { animationDuration: 0 },
                    plugins: { 
                        title: { display: true, text: 'Vital Signs Trend' },
                        tooltip: { position: 'nearest' }
                    },
                    scales: { y: { position: 'left', min: 0 }, y1: { position: 'right', min: 0, max: 100, grid: {drawOnChartArea: false} } }
                },
                plugins: [{
                    id: 'verticalLines',
                    afterDatasetsDraw(chart) {
                        const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
                        ctx.save();
                        interventions.forEach(item => {
                            const xPos = x.getPixelForValue(item.x);
                            if (xPos) {
                                ctx.beginPath();
                                ctx.moveTo(xPos, top);
                                ctx.lineTo(xPos, bottom);
                                ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                                
                                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                                ctx.font = '10px sans-serif';
                                // Use the pre-calculated deterministic offset
                                ctx.fillText(item.label.substring(0, 20) + (item.label.length>20?"...":""), xPos + 4, top + 10 + item.yOffset);
                            }
                        });
                        ctx.restore();
                    }
                }]
            });
            return () => chart.destroy();
        }, [history, log]);

        const handleExport = () => {
            const doc = new window.jspdf.jsPDF();
            doc.setFontSize(16); doc.text(`Simulation Debrief: ${scenario.title}`, 10, 10);
            doc.setFontSize(10);
            let y = 30;
            log.forEach(l => { 
                if (y > 280) { doc.addPage(); y = 10; } 
                doc.text(`[${l.simTime}] ${l.msg}`, 10, y); y += 6; 
            });
            doc.save("sim-debrief.pdf");
        };

        return (
            <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-4 h-full overflow-y-auto">
                <div className="flex flex-col md:flex-row justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700 gap-4">
                    <h2 className="text-2xl font-bold text-white">Simulation Debrief</h2>
                    <div className="flex gap-2">
                        <Button onClick={handleExport} variant="secondary"><Lucide icon="download"/> PDF</Button>
                        <Button onClick={onRestart} variant="primary"><Lucide icon="rotate-ccw"/> New Sim</Button>
                    </div>
                </div>

                <Card title="Physiological Trends" icon="activity">
                    <div className="bg-slate-900 p-2 rounded h-64 md:h-96 relative">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </Card>
                <Card title="Action Timeline" icon="clock"><div className="space-y-1 max-h-64 overflow-y-auto font-mono text-xs">{log.map((l, i) => (<div key={i} className="flex gap-4 border-b border-slate-700 pb-1"><span className="text-sky-400 w-12 flex-shrink-0">{l.simTime}</span><span className="text-slate-300">{l.msg}</span></div>))}</div></Card>
            </div>
        );
    };
        return (
            <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-4 h-full overflow-y-auto">
                <div className="flex flex-col md:flex-row justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700 gap-4">
                    <h2 className="text-2xl font-bold text-white">Simulation Debrief</h2>
                    <div className="flex gap-2">
                        <Button onClick={handleExport} variant="secondary"><Lucide icon="download"/> PDF</Button>
                        <Button onClick={onRestart} variant="primary"><Lucide icon="rotate-ccw"/> New Sim</Button>
                    </div>
                </div>

                {/* DIAMOND DEBRIEF */}
                <Card title="Diamond Debrief Model" icon="message-circle">
                    <div className="diamond-grid">
                        <div className="bg-sky-900/20 p-4 rounded border border-sky-600/30">
                            <h4 className="text-sky-400 font-bold mb-2 uppercase text-sm">1. Description</h4>
                            <p className="text-slate-300 text-xs italic mb-2">What happened? How did it feel?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Clarify clinical facts.</li>
                                <li>Allow team to vent emotions.</li>
                                <li>Establish shared mental model.</li>
                            </ul>
                        </div>
                        <div className="bg-amber-900/20 p-4 rounded border border-amber-600/30">
                            <h4 className="text-amber-400 font-bold mb-2 uppercase text-sm">2. Analysis</h4>
                            <p className="text-slate-300 text-xs italic mb-2">Why did it happen?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Explore decision making.</li>
                                <li>Discuss guidelines ({scenario.learningLinks && scenario.learningLinks.length > 0 ? 'Review Links' : 'Check Guidelines'}).</li>
                                <li>Review differential diagnoses.</li>
                            </ul>
                        </div>
                        <div className="bg-purple-900/20 p-4 rounded border border-purple-600/30">
                            <h4 className="text-purple-400 font-bold mb-2 uppercase text-sm">3. Human Factors</h4>
                            <p className="text-slate-300 text-xs italic mb-2">Non-technical skills?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Leadership & Followership.</li>
                                <li>Communication (Closed Loop).</li>
                                <li>Specific Challenge: <span className="text-white font-bold">{scenario.hf.type}</span></li>
                            </ul>
                        </div>
                        <div className="bg-emerald-900/20 p-4 rounded border border-emerald-600/30">
                            <h4 className="text-emerald-400 font-bold mb-2 uppercase text-sm">4. Application</h4>
                            <p className="text-slate-300 text-xs italic mb-2">What will we do next time?</p>
                            <ul className="list-disc pl-4 text-xs text-slate-300 space-y-1">
                                <li>Identify take-home messages.</li>
                                <li>Plan for system changes.</li>
                                <li>Personal learning goals.</li>
                            </ul>
                        </div>
                    </div>
                </Card>

                <Card title="Physiological Trends" icon="activity">
                    <div className="bg-slate-900 p-2 rounded h-64 md:h-96 relative">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </Card>
                <Card title="Action Timeline" icon="clock"><div className="space-y-1 max-h-64 overflow-y-auto font-mono text-xs">{log.map((l, i) => (<div key={i} className="flex gap-4 border-b border-slate-700 pb-1"><span className="text-sky-400 w-12 flex-shrink-0">{l.simTime}</span><span className="text-slate-300">{l.msg}</span></div>))}</div></Card>
            </div>
        );
    };

    const App = () => {
        const [view, setView] = useState('setup'); 
        const [currentScenario, setCurrentScenario] = useState(null);
        const [lastSetupParams, setLastSetupParams] = useState(null);
        const [resumeState, setResumeState] = useState(null);

        useEffect(() => { 
            const saved = localStorage.getItem('wmebem_sim_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.scenario && parsed.vitals) setResumeState(parsed);
                } catch(e) { console.error("Save state corrupt", e); }
            }
        }, []); 

        const handleResume = () => { setCurrentScenario(resumeState.scenario); setView('resume'); };

        return (
            <div className="h-full flex flex-col bg-slate-900 text-slate-100 font-sans">
                <header className="flex items-center justify-between p-2 md:p-4 border-b border-slate-800 bg-slate-900 flex-shrink-0">
                    <div className="flex items-center gap-3"><img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" className="h-8 md:h-12 object-contain" /><div><h1 className="text-lg md:text-2xl font-bold text-sky-400">Sim Generator v14</h1></div></div>
                    <div className="hidden md:block text-right"><p className="text-[10px] text-slate-500">In-situ Simulation Tool</p></div>
                </header>
                <main className="flex-grow overflow-hidden relative">
                    {view === 'setup' && (<SetupScreen onGenerate={(s, params) => { setCurrentScenario(s); setLastSetupParams(params); setView('briefing'); }} savedState={resumeState} onResume={handleResume} />)}
                    {view === 'setup_regen' && (<SetupScreen initialParams={{ ...lastSetupParams, autoGenerate: true }} onGenerate={(s, params) => { setCurrentScenario(s); setLastSetupParams(params); setView('briefing'); }} />)}
                    {view === 'briefing' && currentScenario && (<BriefingScreen scenario={currentScenario} onStart={() => setView('live')} onBack={() => setView('setup')} onNewScenario={() => setView('setup_regen')} />)}
                    {(view === 'live' || view === 'debrief' || view === 'resume') && currentScenario && (<LiveSimContainer scenario={currentScenario} view={view} setView={setView} resumeData={view === 'resume' ? resumeState : null} onRestart={() => { setCurrentScenario(null); setView('setup'); setResumeState(null); localStorage.removeItem('wmebem_sim_state'); }} />)}
                </main>
            </div>
        );
    };

    const LiveSimContainer = ({ scenario, view, setView, resumeData, onRestart }) => {
        const sim = useSimulation(scenario);
        useEffect(() => {
            if (view === 'resume' && resumeData) { sim.dispatch({ type: 'RESTORE_SESSION', payload: resumeData }); setView('live'); } 
            else if (view !== 'debrief' && !sim.state.scenario) { sim.dispatch({ type: 'LOAD_SCENARIO', payload: scenario }); }
        }, []);
        
        if (!sim.state.scenario) return <div className="flex flex-col items-center justify-center h-full text-slate-400 animate-pulse"><Lucide icon="loader-2" className="w-8 h-8 mb-4 animate-spin text-sky-500" /></div>;

        if (view === 'live' || view === 'resume') return <LiveSimScreen sim={sim} onFinish={() => { sim.stop(); setView('debrief'); }} onBack={() => setView('briefing')} />;
        if (view === 'debrief') return <DebriefScreen sim={sim} onRestart={onRestart} />;
        return null;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
