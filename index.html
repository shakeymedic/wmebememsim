<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Sim Generator v13.3</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for Exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js Annotation Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .flash-red { animation: flashRed 1.5s ease-in-out infinite; }
        @keyframes flashRed {
            0%, 100% { background-color: rgba(30, 41, 59, 1); } 
            50% { background-color: rgba(127, 29, 29, 0.5); } 
        }
        
        .flash-green { animation: flashGreen 1s ease-in-out; }
        @keyframes flashGreen {
            0%, 100% { border-color: #334155; }
            50% { border-color: #10b981; }
        }
        
        html, body { height: 100%; overflow: hidden; }
        body { background-color: #0f172a; color: #f1f5f9; display: flex; flex-direction: column; }
        #root { height: 100%; display: flex; flex-direction: column; }

        @keyframes loadProgress { from { width: 0%; } to { width: 100%; } }
        .loading-bar {
            position: absolute; bottom: 0; left: 0; height: 100%;
            background-color: rgba(16, 185, 129, 0.2);
            animation: loadProgress 2s linear forwards; z-index: 0;
        }
        
        .pea-warning { animation: pulseText 1s infinite; }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .diamond-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .mobile-stack { flex-direction: column; }
            .mobile-h-full { height: 100%; }
            .diamond-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="antialiased selection:bg-sky-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
    
    // --- 1. HELPER FUNCTIONS & DATA ---

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getRandomFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
    const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

    const generateHistory = (age, sex = 'Male') => {
        if (age < 20) return { pmh: ["Nil significant"], dhx: ["Nil"], allergies: ["Nil"] };
        
        const commonPMH = ["Hypertension", "Type 2 Diabetes", "Asthma", "Hyperlipidaemia", "GORD", "Depression", "Anxiety", "Previous MI", "AF", "CKD Stage 3"];
        const femalePMH = ["PCOS", "Endometriosis", "Previous C-Section"];
        const elderlyPMH = ["Dementia", "Osteoporosis", "Parkinson's", "IHD", "CCF"];
        
        let pmh = [];
        let dhx = [];
        
        const pmhCount = age > 70 ? getRandomInt(3, 6) : age > 40 ? getRandomInt(1, 3) : getRandomInt(0, 1);
        
        for(let i=0; i<pmhCount; i++) {
            const source = age > 70 ? [...commonPMH, ...elderlyPMH] : commonPMH;
            const item = getRandomItem(source);
            if(!pmh.includes(item)) pmh.push(item);
        }
        
        if (sex === 'Female' && Math.random() > 0.8) pmh.push(getRandomItem(femalePMH));

        if (pmh.includes("Hypertension")) dhx.push("Ramipril 5mg OD");
        if (pmh.includes("Type 2 Diabetes")) dhx.push("Metformin 1g BD");
        if (pmh.includes("Asthma")) dhx.push("Salbutamol PRN", "Beclometasone BD");
        if (pmh.includes("Hyperlipidaemia")) dhx.push("Atorvastatin 20mg ON");
        if (pmh.includes("GORD")) dhx.push("Omeprazole 20mg OD");
        if (pmh.includes("AF")) dhx.push("Bisoprolol 2.5mg OD", "Edoxaban 60mg OD");
        if (pmh.includes("Previous MI")) dhx.push("Aspirin 75mg OD", "Atorvastatin 80mg ON", "Bisoprolol 2.5mg OD");
        if (pmh.includes("Osteoporosis")) dhx.push("Alendronic Acid");

        if (pmh.length === 0) pmh.push("Nil significant");
        if (dhx.length === 0) dhx.push("Nil regular medications");

        return {
            pmh: pmh,
            dhx: dhx,
            allergies: [Math.random() > 0.8 ? getRandomItem(["Penicillin", "Latex", "NSAIDs", "Trimethoprim"]) : "NKDA"]
        };
    };

    const getBaseVitals = (age) => {
        let v = { hr: 75, rr: 16, bpSys: 120, bpDia: 75, temp: 36.8, bm: 5.8, gcs: 15, pupils: '3mm' }; 
        if (age < 1) v = { hr: 145, rr: 45, bpSys: 75, bpDia: 45, temp: 37.0, bm: 4.5, gcs: 15, pupils: '3mm' }; 
        else if (age <= 2) v = { hr: 125, rr: 30, bpSys: 90, bpDia: 55, temp: 37.0, bm: 5.0, gcs: 15, pupils: '3mm' }; 
        else if (age <= 5) v = { hr: 110, rr: 25, bpSys: 95, bpDia: 60, temp: 37.0, bm: 5.0, gcs: 15, pupils: '3mm' }; 
        else if (age <= 12) v = { hr: 90, rr: 20, bpSys: 105, bpDia: 65, temp: 36.8, bm: 5.5, gcs: 15, pupils: '4mm' }; 
        else if (age > 75) v = { hr: 70, rr: 18, bpSys: 140, bpDia: 75, temp: 36.4, bm: 6.0, gcs: 15, pupils: '3mm' };
        return v;
    };

    const estimateWeight = (age) => {
        if (age === 0) return 3.5; 
        if (age < 1) return 6; 
        if (age >= 1 && age <= 10) return (age + 4) * 2; 
        if (age > 10) return (age * 3) + 7; 
        return 70; 
    };

    const generateVbg = (clinicalState = "normal") => {
        let vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.0, K: 4.0, Glu: 5.5, Na: 140 };
        vbg.pH += getRandomFloat(-0.03, 0.03, 2);
        switch (clinicalState) {
            case "dka_severe": vbg = { pH: 6.95, pCO2: 2.5, HCO3: 5, BE: -24, Lac: 2.5, K: 5.4, Glu: 28.0, Na: 135 }; break;
            case "septic_shock": vbg = { pH: 7.25, pCO2: 4.5, HCO3: 16, BE: -8, Lac: 6.5, K: 4.2, Glu: 4.0, Na: 138 }; break;
            case "haemorrhagic_shock": vbg = { pH: 7.20, pCO2: 4.8, HCO3: 14, BE: -10, Lac: 8.0, K: 3.8, Glu: 9.0, Na: 140 }; break;
            case "copd_retainer": vbg = { pH: 7.30, pCO2: 9.5, HCO3: 34, BE: 8, Lac: 1.2, K: 4.0, Glu: 6.0, Na: 139 }; break;
            case "respiratory_acidosis_acute": vbg = { pH: 7.15, pCO2: 9.5, HCO3: 24, BE: 0, Lac: 1.5, K: 4.1, Glu: 6.2, Na: 140 }; break;
            case "metabolic_acidosis_severe": vbg = { pH: 6.90, pCO2: 6.0, HCO3: 10, BE: -22, Lac: 12.0, K: 6.5, Glu: 6.0, Na: 136 }; break;
            case "metabolic_alkalosis": vbg = { pH: 7.50, pCO2: 5.8, HCO3: 30, BE: 6, Lac: 1.0, K: 3.0, Glu: 5.5, Na: 140 }; break;
            case "hyperkalemia": vbg = { pH: 7.35, pCO2: 5.0, HCO3: 22, BE: -2, Lac: 1.5, K: 7.5, Glu: 6.0, Na: 138 }; break;
            case "hyponatremia": vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.2, K: 4.0, Na: 115, Glu: 5.5 }; break;
            case "hypercalcemia": vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.5, K: 4.0, Na: 140, Glu: 5.5 }; break;
            case "co_poisoning": vbg = { pH: 7.25, pCO2: 4.5, HCO3: 18, BE: -6, Lac: 4.0, K: 4.0, Na: 140, Glu: 6.0 }; break;
            case "gi_bleed": vbg = { pH: 7.32, pCO2: 4.8, HCO3: 20, BE: -4, Lac: 3.5, K: 4.1, Glu: 6.5, Na: 140 }; break;
            case "hhs": vbg = { pH: 7.38, pCO2: 5.0, HCO3: 22, BE: -2, Lac: 1.5, K: 4.5, Glu: 45.0, Na: 150 }; break; 
            case "hypothermia": vbg = { pH: 7.30, pCO2: 5.0, HCO3: 23, BE: -2, Lac: 2.0, K: 3.8, Glu: 4.0, Na: 138 }; break;
            default: break;
        }
        return vbg;
    };

    const HUMAN_FACTOR_CHALLENGES = [
      { id: 'hf0', type: 'Standard Simulation', description: 'Manage effectively.' },
      { id: 'hf1', type: 'Blindfolded Lead', description: 'Leader blindfolded. Tests closed-loop comms.' },
      { id: 'hf2', type: 'Silent Team', description: 'Only leader speaks.' },
      { id: 'hf3', type: 'New Junior', description: 'Junior member needs explicit instructions.' },
      { id: 'hf4', type: 'Missing Kit', description: 'Crucial equipment missing.' },
      { id: 'hf5', type: 'Distracted Senior', description: 'Consultant on phone, dismissive.' },
    ];

    const INTERVENTIONS = {
        'Obs': { label: 'Apply Monitoring', effect: {}, category: 'Common', log: 'Full monitoring applied.', type: 'continuous', duration: 10 },
        'Oxygen': { label: 'High Flow O2', effect: { SpO2: 10 }, category: 'Common', log: 'High flow oxygen applied (15L NRB).', type: 'continuous', duration: 5 },
        'NasalSpecs': { label: 'Nasal Specs O2', effect: { SpO2: 4 }, category: 'Common', log: 'Nasal specs applied (2-4L).', type: 'continuous', duration: 5 },
        'IV Access': { label: 'IV/IO Access', effect: {}, category: 'Common', log: 'IV/IO access secured.', type: 'continuous', duration: 30 },
        'Fluids': { label: 'Fluid Bolus (500ml)', effect: { BP: 8, HR: -3 }, category: 'Common', log: 'Fluid bolus (500ml) given.', type: 'bolus', duration: 60 },
        'FluidsPaeds': { label: 'Fluid Bolus (20ml/kg)', effect: { BP: 8, HR: -3 }, category: 'Common', log: 'Paediatric Fluid bolus (20ml/kg) given.', type: 'bolus', duration: 60 },
        'Analgesia': { label: 'Morphine 5mg', effect: { HR: -5, RR: -3, BP: -2 }, category: 'Common', log: 'IV Morphine 5mg administered.', type: 'bolus', duration: 10 },
        'ParacetamolIV': { label: 'Paracetamol IV', effect: { temp: -1 }, category: 'Common', log: 'IV Paracetamol 1g administered.', type: 'bolus', duration: 15 },
        'Fentanyl': { label: 'Fentanyl 50mcg', effect: { HR: -2, RR: -3, BP: -2 }, category: 'Common', log: 'IV Fentanyl 50mcg administered.', type: 'bolus', duration: 10 },
        'Antiemetic': { label: 'Ondansetron 4mg', effect: {}, category: 'Common', log: 'IV Ondansetron 4mg administered.', type: 'bolus', duration: 10 },
        'Cyclizine': { label: 'Cyclizine 50mg', effect: { HR: 5 }, category: 'Common', log: 'IV Cyclizine 50mg administered.', type: 'bolus', duration: 10 },
        'Manoeuvres': { label: 'Head Tilt / Jaw Thrust', effect: { SpO2: 5 }, category: 'Airway', log: 'Airway manoeuvres applied.', type: 'continuous', duration: 5 },
        'OPA': { label: 'Guedel / OPA', effect: { SpO2: 5 }, category: 'Airway', log: 'Oropharyngeal airway inserted.', type: 'continuous', duration: 10 },
        'NPA': { label: 'Nasopharyngeal', effect: { SpO2: 5 }, category: 'Airway', log: 'Nasopharyngeal airway inserted.', type: 'continuous', duration: 15 },
        'i-gel': { label: 'i-gel / LMA', effect: { SpO2: 15, RR: 'vent' }, category: 'Airway', log: 'Supraglottic airway (i-gel) inserted.', type: 'continuous', duration: 30 },
        'Bagging': { label: 'Bag-Valve-Mask', effect: { SpO2: 25, RR: 'vent' }, category: 'Airway', log: 'Manual ventilation (BVM) started.', type: 'continuous', duration: 5 },
        'Suction': { label: 'Suction Airway', effect: { SpO2: 5 }, category: 'Airway', log: 'Airway suctioned.', type: 'bolus', duration: 15 },
        'Nebs': { label: 'Nebs (Salb/Iprat)', effect: { HR: 10, RR: -3, SpO2: 5 }, category: 'Airway', log: 'Nebulisers (Salb/Iprat) running.', type: 'bolus', duration: 300 },
        'Needle': { label: 'Needle Decompression', effect: { SpO2: 20, BP: 15, RR: -8 }, category: 'Airway', log: 'Needle thoracocentesis performed.', type: 'bolus', duration: 30 },
        'CPAP': { label: 'CPAP', effect: { SpO2: 10, RR: -5, BP: -5 }, category: 'Airway', log: 'CPAP initiated.', type: 'continuous', duration: 60 },
        'NIV': { label: 'NIV (BiPAP)', effect: { SpO2: 12, RR: -5, BP: -5 }, category: 'Airway', log: 'NIV (BiPAP) initiated.', type: 'continuous', duration: 60 },
        'NebAdrenaline': { label: 'Neb Adrenaline', effect: { HR: 10, RR: -5, SpO2: 5 }, category: 'Airway', log: 'Nebulised Adrenaline (5mg) administered.', type: 'bolus', duration: 300 },
        'Dexamethasone': { label: 'Dexamethasone', effect: { RR: -2 }, category: 'Drugs', log: 'PO/IV Dexamethasone administered.', type: 'bolus', duration: 10 },
        'MagnesiumIV': { label: 'Magnesium IV (Asthma)', effect: { RR: -2, BP: -5 }, category: 'Drugs', log: 'IV Magnesium Sulphate 2g administered.', type: 'bolus', duration: 120 },
        'SalbutamolIV': { label: 'Salbutamol IV', effect: { HR: 15, RR: -5, potassium: -0.5 }, category: 'Drugs', log: 'IV Salbutamol bolus administered.', type: 'bolus', duration: 60 },
        'Aminophylline': { label: 'Aminophylline', effect: { HR: 10, RR: -2 }, category: 'Drugs', log: 'Aminophylline infusion started.', type: 'continuous', duration: 300 },
        'RSI': { label: 'Perform RSI', effect: { SpO2: 99, RR: 'vent', BP: -15, gcs: 'sedated' }, category: 'Airway', log: 'Rapid Sequence Induction performed. Patient intubated.', type: 'continuous', duration: 120 },
        'Ketamine': { label: 'Ketamine (Induction)', effect: { gcs: -5, BP: 5, HR: 5 }, category: 'Drugs', log: 'IV Ketamine (Induction dose) administered.', type: 'bolus', duration: 15 },
        'Propofol': { label: 'Propofol', effect: { gcs: -5, BP: -10, RR: -5 }, category: 'Drugs', log: 'IV Propofol administered.', type: 'bolus', duration: 10 },
        'Roc': { label: 'Rocuronium', effect: { RR: 0, paralysed: true }, category: 'Drugs', log: 'IV Rocuronium administered.', type: 'bolus', duration: 10 },
        'Sux': { label: 'Suxamethonium', effect: { RR: 0, paralysed: true }, category: 'Drugs', log: 'IV Suxamethonium administered.', type: 'bolus', duration: 10 },
        'Blood': { label: 'Blood (O Neg)', effect: { BP: 12, HR: -5 }, category: 'Circulation', log: '1 Unit O-Negative Blood initiated.', type: 'bolus', duration: 300 },
        'FFP': { label: 'FFP (Octaplas)', effect: { BP: 5 }, category: 'Circulation', log: 'FFP initiated.', type: 'bolus', duration: 300 },
        'Platelets': { label: 'Platelets', effect: {}, category: 'Circulation', log: 'Pool of Platelets initiated.', type: 'bolus', duration: 300 },
        'Cryo': { label: 'Cryoprecipitate', effect: {}, category: 'Circulation', log: 'Cryoprecipitate pool administered.', type: 'bolus', duration: 300 },
        'TXA': { label: 'TXA 1g', effect: {}, category: 'Circulation', log: 'IV Tranexamic Acid 1g administered.', type: 'bolus', duration: 60 },
        'Binder': { label: 'Pelvic Binder', effect: { BP: 8 }, category: 'Circulation', log: 'Pelvic binder applied.', type: 'continuous', duration: 60 },
        'Tourniquet': { label: 'Tourniquet', effect: { BP: 5 }, category: 'Circulation', log: 'Arterial Tourniquet applied.', type: 'continuous', duration: 10 },
        'Splinting': { label: 'Splint Limb', effect: { HR: -2 }, category: 'Circulation', log: 'Limb splinted.', type: 'continuous', duration: 120 },
        'Reduction': { label: 'Reduce Fracture', effect: { HR: -5, BP: -2 }, category: 'Procedures', log: 'Fracture reduction performed.', type: 'bolus', duration: 60 },
        'Plaster': { label: 'Apply Backslab', effect: {}, category: 'Procedures', log: 'Backslab/Plaster applied.', type: 'continuous', duration: 300 },
        'Collar': { label: 'C-Spine Collar', effect: {}, category: 'Procedures', log: 'C-spine collar applied.', type: 'continuous', duration: 30 },
        'Warming': { label: 'Warming Blanket', effect: { temp: 1, BP: 5 }, category: 'Procedures', log: 'Bair hugger / warming applied.', type: 'continuous', duration: 300 },
        'REBOA': { label: 'REBOA Inflation', effect: { BP: 40 }, category: 'Procedures', log: 'REBOA zone 1 inflated.', type: 'continuous', duration: 60 },
        'Adrenaline': { label: 'Adrenaline 1:1000 (IM)', effect: { HR: 20, BP: 15 }, category: 'Drugs', log: 'IM Adrenaline 500mcg administered.', type: 'bolus', duration: 5 },
        'AdrenalineIV': { label: 'Adrenaline 1:10,000 (IV)', effect: { changeRhythm: 'chance' }, category: 'Drugs', log: 'IV Adrenaline 1mg administered.', type: 'bolus', duration: 5 },
        'Amiodarone': { label: 'Amiodarone 300mg', effect: { changeRhythm: 'chance' }, category: 'Drugs', log: 'IV Amiodarone 300mg administered.', type: 'bolus', duration: 60 },
        'Atropine': { label: 'Atropine 600mcg', effect: { HR: 20 }, category: 'Drugs', log: 'IV Atropine 600mcg administered.', type: 'bolus', duration: 10 },
        'Adenosine': { label: 'Adenosine Rapid Bolus', effect: { HR: 'reset' }, category: 'Drugs', log: 'IV Adenosine rapid bolus administered.', type: 'bolus', duration: 2 },
        'Aspirin': { label: 'Aspirin 300mg', effect: {}, category: 'Drugs', log: 'Aspirin 300mg PO administered.', type: 'bolus', duration: 10 },
        'Clopidogrel': { label: 'Clopidogrel 300mg', effect: {}, category: 'Drugs', log: 'Clopidogrel 300mg PO administered.', type: 'bolus', duration: 10 },
        'Ticagrelor': { label: 'Ticagrelor 180mg', effect: {}, category: 'Drugs', log: 'Ticagrelor 180mg PO administered.', type: 'bolus', duration: 10 },
        'GTN': { label: 'GTN Spray', effect: { BP: -8 }, category: 'Drugs', log: 'GTN Spray sublingual administered.', type: 'bolus', duration: 5 },
        'GTNInfusion': { label: 'GTN Infusion', effect: { BP: -20 }, category: 'Drugs', log: 'GTN Infusion started (5ml/hr).', type: 'continuous', duration: 300 },
        'Furosemide': { label: 'Furosemide 40mg', effect: { BP: -5 }, category: 'Drugs', log: 'IV Furosemide 40mg administered.', type: 'bolus', duration: 30 },
        'Metaraminol': { label: 'Metaraminol', effect: { BP: 15 }, category: 'Drugs', log: 'IV Metaraminol bolus administered.', type: 'bolus', duration: 10 },
        'Noradrenaline': { label: 'Noradrenaline Infusion', effect: { BP: 25 }, category: 'Drugs', log: 'Noradrenaline infusion started.', type: 'continuous', duration: 300 },
        'Bisoprolol': { label: 'Bisoprolol 2.5mg', effect: { HR: -10, BP: -5 }, category: 'Drugs', log: 'Oral Bisoprolol 2.5mg administered.', type: 'bolus', duration: 10 },
        'Digoxin': { label: 'Digoxin Load', effect: { HR: -10 }, category: 'Drugs', log: 'IV Digoxin loading dose.', type: 'bolus', duration: 120 },
        'Calcium': { label: 'Calcium Gluconate', effect: { BP: 5 }, category: 'Drugs', log: 'IV Calcium Gluconate administered.', type: 'bolus', duration: 10 },
        'CalciumChlor': { label: 'Calcium Chloride', effect: { BP: 8 }, category: 'Drugs', log: 'IV Calcium Chloride administered.', type: 'bolus', duration: 10 },
        'MagSulph': { label: 'Magnesium Sulph 4g', effect: { BP: -5, RR: -2 }, category: 'Obs/Gynae', log: 'IV Magnesium Sulphate 4g loading dose.', type: 'bolus', duration: 600 },
        'Antibiotics': { label: 'Broad Spec Abx', effect: { BP: 5 }, category: 'Drugs', log: 'IV Broad Spectrum Antibiotics administered.', type: 'bolus', duration: 20 },
        'CoAmox': { label: 'Co-Amoxiclav', effect: {}, category: 'Drugs', log: 'IV Co-Amoxiclav 1.2g administered.', type: 'bolus', duration: 20 },
        'Ceftriaxone': { label: 'Ceftriaxone', effect: {}, category: 'Drugs', log: 'IV Ceftriaxone 2g administered.', type: 'bolus', duration: 20 },
        'Vancomycin': { label: 'Vancomycin', effect: {}, category: 'Drugs', log: 'IV Vancomycin administered.', type: 'bolus', duration: 60 },
        'Gentamicin': { label: 'Gentamicin', effect: {}, category: 'Drugs', log: 'IV Gentamicin administered.', type: 'bolus', duration: 30 },
        'PipTaz': { label: 'Pip-Taz', effect: {}, category: 'Drugs', log: 'IV Piperacillin-Tazobactam administered.', type: 'bolus', duration: 30 },
        'Fluconazole': { label: 'Fluconazole', effect: {}, category: 'Drugs', log: 'IV Fluconazole administered.', type: 'bolus', duration: 30 },
        'Acyclovir': { label: 'Acyclovir', effect: {}, category: 'Drugs', log: 'IV Acyclovir administered.', type: 'bolus', duration: 30 },
        'InsulinDextrose': { label: 'Insulin/Dextrose', effect: { potassium: -1 }, category: 'Drugs', log: 'Insulin/Dextrose infusion started.', type: 'bolus', duration: 10 },
        'Hydrocortisone': { label: 'Hydrocortisone', effect: { BP: 5 }, category: 'Drugs', log: 'IV Hydrocortisone 100mg administered.', type: 'bolus', duration: 5 },
        'Glucagon': { label: 'Glucagon', effect: { HR: 10, bm: 4 }, category: 'Drugs', log: 'IM/IV Glucagon administered.', type: 'bolus', duration: 10 },
        'Glucose10': { label: 'Glucose 10%', effect: { bm: 8 }, category: 'Drugs', log: 'IV Glucose 10% bolus administered.', type: 'bolus', duration: 10 },
        'Glucose20': { label: 'Glucose 20%', effect: { bm: 12 }, category: 'Drugs', log: 'IV Glucose 20% bolus administered.', type: 'bolus', duration: 10 },
        'Pabrinex': { label: 'Pabrinex', effect: {}, category: 'Drugs', log: 'IV Pabrinex pair administered.', type: 'bolus', duration: 10 },
        'T3T4': { label: 'T3/T4 (Liothyronine)', effect: { BP: 5, HR: 5, temp: 0.5 }, category: 'Drugs', log: 'Thyroid replacement hormone administered.', type: 'bolus', duration: 60 },
        'Bisphosphonate': { label: 'Bisphosphonate', effect: {}, category: 'Drugs', log: 'IV Bisphosphonate administered.', type: 'bolus', duration: 60 },
        'Midazolam': { label: 'Midazolam', effect: { gcs: -2, HR: -5 }, category: 'Drugs', log: 'Buccal/IV Midazolam administered.', type: 'bolus', duration: 15 },
        'Lorazepam': { label: 'Lorazepam', effect: { gcs: -3, HR: -5 }, category: 'Drugs', log: 'IV Lorazepam administered.', type: 'bolus', duration: 15 },
        'DiazepamPR': { label: 'Diazepam PR', effect: { gcs: -2 }, category: 'Drugs', log: 'PR Diazepam administered.', type: 'bolus', duration: 15 },
        'Phenytoin': { label: 'Phenytoin', effect: {}, category: 'Drugs', log: 'IV Phenytoin loading dose.', type: 'bolus', duration: 120 },
        'Levetiracetam': { label: 'Levetiracetam', effect: {}, category: 'Drugs', log: 'IV Levetiracetam 60mg/kg administered.', type: 'bolus', duration: 60 },
        'Mannitol': { label: 'Mannitol', effect: {}, category: 'Drugs', log: 'IV Mannitol administered.', type: 'bolus', duration: 30 },
        'HypertonicSaline': { label: 'Hypertonic Saline', effect: { BP: 5 }, category: 'Drugs', log: 'IV Hypertonic Saline administered.', type: 'bolus', duration: 30 },
        'Naloxone': { label: 'Naloxone', effect: { RR: 10, gcs: 5 }, category: 'Drugs', log: 'IV Naloxone 400mcg administered.', type: 'bolus', duration: 5 },
        'ActivatedCharcoal': { label: 'Activated Charcoal', effect: {}, category: 'Drugs', log: 'Activated Charcoal administered.', type: 'bolus', duration: 10 },
        'NAC': { label: 'Parvolex (NAC)', effect: {}, category: 'Drugs', log: 'N-Acetylcysteine infusion started.', type: 'continuous', duration: 300 },
        'AtropineHigh': { label: 'Atropine (High Dose)', effect: { HR: 40 }, category: 'Drugs', log: 'High dose Atropine (2mg+) administered.', type: 'bolus', duration: 10 },
        'Lipid': { label: 'Intralipid 20%', effect: {}, category: 'Drugs', log: 'Intralipid 20% administered.', type: 'bolus', duration: 30 },
        'Desferrioxamine': { label: 'Desferrioxamine', effect: {}, category: 'Drugs', log: 'Desferrioxamine infusion started.', type: 'continuous', duration: 300 },
        'Fomepizole': { label: 'Fomepizole', effect: {}, category: 'Drugs', log: 'Fomepizole administered.', type: 'bolus', duration: 30 },
        'Cyproheptadine': { label: 'Cyproheptadine', effect: { temp: -1 }, category: 'Drugs', log: 'PO Cyproheptadine administered.', type: 'bolus', duration: 15 },
        'Dantrolene': { label: 'Dantrolene', effect: { temp: -2 }, category: 'Drugs', log: 'IV Dantrolene administered.', type: 'bolus', duration: 20 },
        'Prothrombinex': { label: 'Beriplex/Octaplex', effect: {}, category: 'Drugs', log: 'PCC (Beriplex) administered.', type: 'bolus', duration: 20 },
        'VitaminK': { label: 'Vitamin K', effect: {}, category: 'Drugs', log: 'IV Vitamin K administered.', type: 'bolus', duration: 10 },
        'Protamine': { label: 'Protamine', effect: {}, category: 'Drugs', log: 'IV Protamine administered.', type: 'bolus', duration: 10 },
        'Oxytocin': { label: 'Oxytocin 10u', effect: { BP: -5 }, category: 'Obs/Gynae', log: 'IM Oxytocin 10u administered.', type: 'bolus', duration: 10 },
        'Ergometrine': { label: 'Ergometrine 500mcg', effect: { BP: 15 }, category: 'Obs/Gynae', log: 'IM Ergometrine 500mcg administered.', type: 'bolus', duration: 10 },
        'Syntometrine': { label: 'Syntometrine', effect: { BP: 10 }, category: 'Obs/Gynae', log: 'IM Syntometrine administered.', type: 'bolus', duration: 10 },
        'Carboprost': { label: 'Carboprost 250mcg', effect: { BP: 5 }, category: 'Obs/Gynae', log: 'IM Carboprost 250mcg administered.', type: 'bolus', duration: 10 },
        'Misoprostol': { label: 'Misoprostol 800mcg', effect: {}, category: 'Obs/Gynae', log: 'PR Misoprostol 800mcg administered.', type: 'bolus', duration: 30 },
        'Labetalol': { label: 'Labetalol 50mg', effect: { BP: -15, HR: -5 }, category: 'Obs/Gynae', log: 'IV Labetalol 50mg administered.', type: 'bolus', duration: 15 },
        'AntiD': { label: 'Anti-D Ig', effect: {}, category: 'Obs/Gynae', log: 'IM Anti-D administered.', type: 'bolus', duration: 10 },
        'Delivery': { label: 'Emergency Delivery', effect: {}, category: 'Obs/Gynae', log: 'Preparation for emergency delivery.', type: 'continuous', duration: 300 },
        'McRoberts': { label: 'McRoberts Manoeuvre', effect: {}, category: 'Obs/Gynae', log: 'McRoberts manoeuvre performed.', type: 'bolus', duration: 10 },
        'Defib': { label: 'Defibrillation', effect: { changeRhythm: 'defib' }, category: 'Procedures', log: 'Shock Delivered.', type: 'bolus', duration: 5 },
        'Pacing': { label: 'External Pacing', effect: { HR: 'pace' }, category: 'Procedures', log: 'External Pacing initiated @ 80bpm.', type: 'continuous', duration: 10 },
        'Cardioversion': { label: 'Sync Cardioversion', effect: { changeRhythm: 'sync' }, category: 'Procedures', log: 'Synchronised DC Shock delivered.', type: 'bolus', duration: 5 },
        'Lucas': { label: 'Lucas/AutoPulse', effect: { BP: 30 }, category: 'Procedures', log: 'Mechanical Chest Compression device applied.', type: 'continuous', duration: 30 },
        'CPR': { label: 'Manual CPR', effect: {}, category: 'Procedures', log: 'CPR in progress (30:2).', type: 'continuous', duration: 5 },
        'Surgery': { label: 'Surgical Consult', effect: {}, category: 'Procedures', log: 'Surgeons contacted urgently.', type: 'bolus', duration: 30 },
        'SurgicalDrain': { label: 'Chest Drain (Surgical)', effect: { SpO2: 15, BP: 10, RR: -5 }, category: 'Procedures', log: 'Surgical chest drain inserted.', type: 'continuous', duration: 600 },
        'SeldingerDrain': { label: 'Chest Drain (Seldinger)', effect: { SpO2: 15, BP: 10, RR: -5 }, category: 'Procedures', log: 'Seldinger chest drain inserted.', type: 'continuous', duration: 450 },
        'FingerThoracostomy': { label: 'Finger Thoracostomy', effect: { SpO2: 20, BP: 15, RR: -8 }, category: 'Procedures', log: 'Finger thoracostomy performed.', type: 'bolus', duration: 30 },
        'Pericardiocentesis': { label: 'Pericardiocentesis', effect: { BP: 20, HR: -10 }, category: 'Procedures', log: 'Pericardiocentesis performed.', type: 'bolus', duration: 30 },
        'Thoracotomy': { label: 'ED Thoracotomy', effect: {}, category: 'Procedures', log: 'Resuscitative Thoracotomy started.', type: 'continuous', duration: 300 },
        'AirEnema': { label: 'Air Enema', effect: {}, category: 'Procedures', log: 'Radiology air enema requested.', type: 'bolus', duration: 30 },
        'Escharotomy': { label: 'Escharotomy', effect: { SpO2: 5 }, category: 'Procedures', log: 'Escharotomy performed.', type: 'bolus', duration: 60 },
        'LateralCanthotomy': { label: 'Lateral Canthotomy', effect: {}, category: 'Procedures', log: 'Lateral Canthotomy performed.', type: 'bolus', duration: 30 },
    };
        const ALL_SCENARIOS = [
        { id: 's1', name: 'Anaphylaxis', category: 'Medical', ageRange: () => getRandomInt(5, 80), acuity: 'Critical', briefing: 'Sudden collapse after food. Severe allergic reaction suspected.', instructorNotes: 'Classic anaphylaxis. Test systematic ABCDE, IM Adrenaline 1:1000, fluids, antihistamines, steroids. Potential airway compromise.', startVitals: { hr: 125, rr: 28, bpSys: 75, bpDia: 45, spo2: 88, temp: 37.2, bm: 5.5, gcs: 14, pupils: '4mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'No ischaemia'], vbgState: 'normal', investigations: { xray: 'Clear lung fields', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'airway', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Adrenaline', successChance: 0.9 } },
        { id: 's2', name: 'Septic Shock', category: 'Medical', ageRange: () => getRandomInt(60, 90), acuity: 'Critical', briefing: 'Unwell for 48hrs. Febrile, confused, hypotensive.', instructorNotes: 'Sepsis Six. Source unclear initially. Broad spec Abx, fluid resus, cultures. May need vasopressors. Consider urosepsis vs chest.', startVitals: { hr: 118, rr: 24, bpSys: 82, bpDia: 48, spo2: 92, temp: 39.2, bm: 8.5, gcs: 13, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'No acute ischaemia'], vbgState: 'septic_shock', investigations: { xray: 'Left lower lobe consolidation', ct: 'Diffuse inflammatory changes', urine: 'Leucocytes ++, Nitrites +' }, deteriorationType: 'shock', deteriorationRate: 'medium', rosc: { possible: true, triggerIntervention: 'Antibiotics', successChance: 0.7 } },
        { id: 's3', name: 'STEMI (Anterior)', category: 'Medical', ageRange: () => getRandomInt(50, 80), acuity: 'Critical', briefing: 'Central crushing chest pain x 2 hours. Radiation to jaw. Pale, sweaty.', instructorNotes: 'STEMI pathway. MONA + dual antiplatelets. Urgent PCI. Consider cardiogenic shock if BP drops. Arrhythmia risk.', startVitals: { hr: 92, rr: 20, bpSys: 145, bpDia: 88, spo2: 97, temp: 36.8, bm: 7.0, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Rhythm', ecgFindings: ['ST elevation V1-V4 (8mm)', 'Reciprocal changes inferior leads', 'Hyperacute T waves'], vbgState: 'normal', investigations: { xray: 'Mild cardiomegaly', ct: 'Not indicated acutely', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'medium', rosc: { possible: true, triggerIntervention: 'AdrenalineIV', successChance: 0.6 } },
        { id: 's4', name: 'Massive PE', category: 'Medical', ageRange: () => getRandomInt(40, 75), acuity: 'Critical', briefing: 'Sudden onset severe dyspnoea. Recent long-haul flight. Hypoxic, tachycardic.', instructorNotes: 'Massive PE with RV strain. Anticoagulation, consider thrombolysis. High risk cardiac arrest. S1Q3T3 pattern on ECG.', startVitals: { hr: 128, rr: 32, bpSys: 88, bpDia: 52, spo2: 84, temp: 37.0, bm: 6.2, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'S1Q3T3 pattern', 'Right axis deviation', 'T wave inversion V1-V4'], vbgState: 'normal', investigations: { xray: 'Oligaemia right mid zone', ct: 'Bilateral PE with RV strain', urine: 'Normal' }, deteriorationType: 'respiratory', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Fluids', successChance: 0.5 } },
        { id: 's5', name: 'DKA (Severe)', category: 'Medical', ageRange: () => getRandomInt(16, 65), acuity: 'Critical', briefing: 'Known T1DM. Unwell 3 days, vomiting. Drowsy, Kussmaul breathing.', instructorNotes: 'Severe DKA. Fixed rate insulin, fluids, K+ replacement. Risk cerebral oedema if corrected too fast. Monitor pH and ketones.', startVitals: { hr: 115, rr: 28, bpSys: 95, bpDia: 58, spo2: 98, temp: 36.5, bm: 28.0, gcs: 12, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'No acute ischaemia'], vbgState: 'dka_severe', investigations: { xray: 'Clear', ct: 'Not indicated', urine: 'Glucose +++, Ketones +++' }, deteriorationType: 'metabolic', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's6', name: 'Tension Pneumothorax', category: 'Trauma', ageRange: () => getRandomInt(18, 60), acuity: 'Critical', briefing: 'Stabbed left chest. Severe respiratory distress. Hypoxic, tachycardic, hypotensive.', instructorNotes: 'Tension PTx. Needle decompression saves life. Then chest drain. High flow O2. Assess for other injuries.', startVitals: { hr: 135, rr: 38, bpSys: 78, bpDia: 45, spo2: 82, temp: 36.8, bm: 6.0, gcs: 13, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'Low voltage'], vbgState: 'normal', investigations: { xray: 'Left tension pneumothorax, mediastinal shift', ct: 'Massive left PTx', urine: 'Normal' }, deteriorationType: 'respiratory', deteriorationRate: 'very_fast', rosc: { possible: true, triggerIntervention: 'Needle', successChance: 0.95 } },
        { id: 's7', name: 'Major Haemorrhage (Polytrauma)', category: 'Trauma', ageRange: () => getRandomInt(18, 50), acuity: 'Critical', briefing: 'RTC. Restrained driver. Unstable pelvis, abdo distension. Shocked.', instructorNotes: 'Major haemorrhage protocol. Activate MHP. Pelvic binder, TXA, blood products 1:1:1. Damage control surgery needed.', startVitals: { hr: 142, rr: 30, bpSys: 68, bpDia: 42, spo2: 94, temp: 35.8, bm: 7.5, gcs: 13, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'No ischaemia'], vbgState: 'haemorrhagic_shock', investigations: { xray: 'Pelvic fracture (open book)', ct: 'Grade IV splenic laceration, pelvic haematoma', urine: 'Haematuria +' }, deteriorationType: 'shock', deteriorationRate: 'very_fast', rosc: { possible: true, triggerIntervention: 'Blood', successChance: 0.6 } },
        { id: 's8', name: 'Acute Severe Asthma', category: 'Medical', ageRange: () => getRandomInt(15, 60), acuity: 'Critical', briefing: 'Severe asthma attack. Unable to complete sentences. Exhausted.', instructorNotes: 'Life-threatening asthma. Back-to-back nebs, steroids, Mg, consider aminophylline/salbutamol IV. May need ITU/intubation.', startVitals: { hr: 125, rr: 32, bpSys: 118, bpDia: 72, spo2: 88, temp: 37.0, bm: 6.0, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'No ischaemia'], vbgState: 'respiratory_acidosis_acute', investigations: { xray: 'Hyperinflation, no PTx', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'respiratory', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Nebs', successChance: 0.8 } },
        { id: 's9', name: 'Status Epilepticus', category: 'Medical', ageRange: () => getRandomInt(18, 70), acuity: 'Critical', briefing: 'Continuous seizure for 15 minutes. Still convulsing on arrival.', instructorNotes: 'Status epilepticus protocol. Benzodiazepines, then phenytoin/levetiracetam. Protect airway. May need RSI. Consider causes.', startVitals: { hr: 118, rr: 22, bpSys: 155, bpDia: 92, spo2: 91, temp: 37.8, bm: 5.5, gcs: 3, pupils: '4mm reactive' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Clear', ct: 'No acute bleed or mass', urine: 'Normal' }, deteriorationType: 'neuro', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's10', name: 'Ectopic Pregnancy Rupture', category: 'Obstetrics', ageRange: () => getRandomInt(18, 40), acuity: 'Critical', briefing: 'Female, 8 weeks pregnant. Sudden severe abdominal pain. Collapsed. PV bleeding.', instructorNotes: 'Ruptured ectopic. Hypovolaemic shock. Urgent bloods inc G&S. Activate MHP. Emergency gynae to theatre.', startVitals: { hr: 128, rr: 26, bpSys: 78, bpDia: 48, spo2: 97, temp: 36.5, bm: 5.5, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'haemorrhagic_shock', investigations: { xray: 'Not indicated', ct: 'Not indicated', pocus: 'Free fluid in pelvis', urine: 'Pregnancy test positive' }, deteriorationType: 'shock', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Blood', successChance: 0.7 } },
        { id: 's11', name: 'Paracetamol OD (Late)', category: 'Toxicology', ageRange: () => getRandomInt(16, 45), acuity: 'High', briefing: 'Took 50x 500mg paracetamol 36hrs ago. Now jaundiced, confused, bleeding.', instructorNotes: 'Fulminant hepatic failure. NAC despite late presentation. King's criteria for transplant. Correct coagulopathy.', startVitals: { hr: 95, rr: 20, bpSys: 102, bpDia: 62, spo2: 98, temp: 37.2, bm: 3.5, gcs: 12, pupils: '3mm' }, ecgRhythm: 'Sinus Rhythm', ecgFindings: ['Normal sinus rhythm'], vbgState: 'metabolic_acidosis_severe', investigations: { xray: 'Clear', ct: 'Cerebral oedema', urine: 'Bilirubin ++' }, deteriorationType: 'metabolic', deteriorationRate: 'slow', rosc: { possible: false } },
        { id: 's12', name: 'Eclamptic Seizure', category: 'Obstetrics', ageRange: () => getRandomInt(18, 42), acuity: 'Critical', briefing: '36 weeks pregnant. New onset tonic-clonic seizure. Hypertensive.', instructorNotes: 'Eclampsia. Magnesium sulphate 4g loading. Control BP with labetalol. Left lateral. Urgent delivery planning.', startVitals: { hr: 108, rr: 24, bpSys: 178, bpDia: 112, spo2: 95, temp: 37.5, bm: 5.5, gcs: 13, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Not indicated', ct: 'Not indicated', urine: 'Protein +++' }, deteriorationType: 'neuro', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's13', name: 'Upper GI Bleed (Massive)', category: 'Medical', ageRange: () => getRandomInt(50, 80), acuity: 'Critical', briefing: 'Vomiting fresh blood. Known varices. Haemodynamically unstable.', instructorNotes: 'Variceal bleed. Terlipressin, prophylactic Abx, urgent endoscopy. Transfuse cautiously. Correct coagulopathy if on warfarin.', startVitals: { hr: 125, rr: 24, bpSys: 82, bpDia: 52, spo2: 96, temp: 36.8, bm: 5.0, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'gi_bleed', investigations: { xray: 'Clear', ct: 'Not indicated acutely', urine: 'Normal' }, deteriorationType: 'shock', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Blood', successChance: 0.65 } },
        { id: 's14', name: 'VF Cardiac Arrest', category: 'Medical', ageRange: () => getRandomInt(50, 80), acuity: 'Critical', briefing: 'Collapsed. Pulseless. Bystander CPR in progress.', instructorNotes: 'Shockable rhythm. ALS algorithm. High quality CPR. Reversible causes. ROSC likely with good management.', startVitals: { hr: 0, rr: 0, bpSys: 0, bpDia: 0, spo2: 0, temp: 36.5, bm: 6.0, gcs: 3, pupils: '5mm fixed' }, ecgRhythm: 'VF', ecgFindings: ['Ventricular Fibrillation'], vbgState: 'metabolic_acidosis_severe', investigations: { xray: 'Performed post-ROSC', ct: 'Performed post-ROSC', urine: 'N/A' }, deteriorationType: 'cardiac', deteriorationRate: 'arrest', rosc: { possible: true, triggerIntervention: 'Defib', successChance: 0.7 } },
        { id: 's15', name: 'PEA Arrest (Hypovolaemic)', category: 'Trauma', ageRange: () => getRandomInt(25, 60), acuity: 'Critical', briefing: 'Trauma patient arrested. Electrical activity present but no pulse.', instructorNotes: 'PEA secondary to hypovolaemia. Massive transfusion. Consider ED thoracotomy. Treat reversible causes (4Hs 4Ts).', startVitals: { hr: 0, rr: 0, bpSys: 0, bpDia: 0, spo2: 0, temp: 35.5, bm: 7.0, gcs: 3, pupils: '6mm fixed' }, ecgRhythm: 'PEA', ecgFindings: ['PEA - Organised electrical activity, no mechanical output'], vbgState: 'haemorrhagic_shock', investigations: { xray: 'Performed if ROSC', ct: 'Performed if ROSC', pocus: 'No cardiac tamponade' }, deteriorationType: 'cardiac', deteriorationRate: 'arrest', rosc: { possible: true, triggerIntervention: 'Blood', successChance: 0.4 } },
        { id: 's16', name: 'Acute Pulmonary Oedema', category: 'Medical', ageRange: () => getRandomInt(65, 90), acuity: 'Critical', briefing: 'Acute breathlessness. Pink frothy sputum. Known heart failure.', instructorNotes: 'Acute LVF. Sit up, high flow O2, furosemide, GTN. Consider CPAP/NIV. Watch for cardiogenic shock.', startVitals: { hr: 115, rr: 36, bpSys: 168, bpDia: 95, spo2: 84, temp: 36.8, bm: 6.5, gcs: 14, pupils: '3mm' }, ecgRhythm: 'AF', ecgFindings: ['AF with rapid ventricular response', 'LVH', 'Strain pattern'], vbgState: 'respiratory_acidosis_acute', investigations: { xray: 'Bat wing opacification, cardiomegaly, Kerley B lines', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'respiratory', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'CPAP', successChance: 0.8 } },
        { id: 's17', name: 'Hyperkalemia (Severe)', category: 'Medical', ageRange: () => getRandomInt(60, 85), acuity: 'Critical', briefing: 'Known CKD. Missed dialysis. Feeling unwell. Bradycardic.', instructorNotes: 'Life-threatening hyperkalaemia. Calcium, insulin/dextrose, salbutamol. Urgent dialysis. High arrest risk.', startVitals: { hr: 42, rr: 18, bpSys: 95, bpDia: 58, spo2: 97, temp: 36.5, bm: 6.0, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Bradycardia', ecgFindings: ['Broad QRS (180ms)', 'Peaked T waves', 'Loss of P waves', 'Sine wave pattern developing'], vbgState: 'hyperkalemia', investigations: { xray: 'Cardiomegaly', ct: 'Not indicated', urine: 'Not passed' }, deteriorationType: 'cardiac', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Calcium', successChance: 0.75 } },
        { id: 's18', name: 'Acute Stroke (Large Vessel)', category: 'Medical', ageRange: () => getRandomInt(60, 85), acuity: 'High', briefing: 'Sudden right sided weakness and dysphasia. FAST positive. Within window.', instructorNotes: 'Thrombolysis candidate. Urgent CT to exclude bleed. Time critical. NIHSS scoring. Hypertension management.', startVitals: { hr: 78, rr: 16, bpSys: 185, bpDia: 102, spo2: 97, temp: 36.8, bm: 6.2, gcs: 14, pupils: '3mm' }, ecgRhythm: 'AF', ecgFindings: ['Atrial Fibrillation'], vbgState: 'normal', investigations: { xray: 'Clear', ct: 'Large MCA territory infarct, no bleed', urine: 'Normal' }, deteriorationType: 'neuro', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's19', name: 'Acute Aortic Dissection', category: 'Medical', ageRange: () => getRandomInt(50, 75), acuity: 'Critical', briefing: 'Sudden tearing chest pain radiating to back. BP differential in arms.', instructorNotes: 'Type A dissection. Control HR and BP (beta blockers). Urgent cardiothoracics. High mortality. Pericardial tamponade risk.', startVitals: { hr: 95, rr: 22, bpSys: 168, bpDia: 95, spo2: 97, temp: 36.8, bm: 6.0, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Rhythm', ecgFindings: ['Normal sinus rhythm', 'LVH'], vbgState: 'normal', investigations: { xray: 'Widened mediastinum', ct: 'Type A aortic dissection', urine: 'Haematuria +' }, deteriorationType: 'cardiac', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Fluids', successChance: 0.3 } },
        { id: 's20', name: 'Meningococcal Septicaemia', category: 'Medical', ageRange: () => getRandomInt(2, 25), acuity: 'Critical', briefing: 'Unwell child. Non-blanching rash. Shocked. Reduced consciousness.', instructorNotes: 'Meningococcal sepsis. Immediate IV/IO Ceftriaxone. Aggressive fluid resus. May need inotropes. Inform public health.', startVitals: { hr: 155, rr: 38, bpSys: 65, bpDia: 38, spo2: 94, temp: 39.8, bm: 3.2, gcs: 11, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'septic_shock', investigations: { xray: 'Clear', ct: 'Cerebral oedema', urine: 'Not passed' }, deteriorationType: 'shock', deteriorationRate: 'very_fast', rosc: { possible: true, triggerIntervention: 'Ceftriaxone', successChance: 0.6 } },
        { id: 's21', name: 'Hypoglycaemia (Severe)', category: 'Medical', ageRange: () => getRandomInt(25, 75), acuity: 'High', briefing: 'Diabetic. Found unresponsive. GCS 8. Sweaty, clammy.', instructorNotes: 'Severe hypoglycaemia. IV glucose or IM glucagon. Protect airway. Consider cause - missed meal, excess insulin, sepsis.', startVitals: { hr: 95, rr: 18, bpSys: 125, bpDia: 75, spo2: 98, temp: 36.5, bm: 1.8, gcs: 8, pupils: '4mm reactive' }, ecgRhythm: 'Sinus Rhythm', ecgFindings: ['Normal sinus rhythm'], vbgState: 'normal', investigations: { xray: 'Clear', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'neuro', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's22', name: 'Acute Coronary Syndrome (NSTEMI)', category: 'Medical', ageRange: () => getRandomInt(55, 80), acuity: 'High', briefing: 'Chest pain 6 hours. Troponin elevated. Dynamic ECG changes.', instructorNotes: 'NSTEMI. MONA, dual antiplatelets, GRACE score. Cardiology referral. Risk of progression to STEMI or arrest.', startVitals: { hr: 88, rr: 18, bpSys: 142, bpDia: 82, spo2: 97, temp: 36.8, bm: 6.5, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Rhythm', ecgFindings: ['ST depression V4-V6', 'T wave inversion laterally', 'Troponin 2500ng/L'], vbgState: 'normal', investigations: { xray: 'Mild cardiomegaly', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'slow', rosc: { possible: true, triggerIntervention: 'AdrenalineIV', successChance: 0.6 } },
        { id: 's23', name: 'Post-Partum Haemorrhage', category: 'Obstetrics', ageRange: () => getRandomInt(18, 42), acuity: 'Critical', briefing: 'Delivered 20 mins ago. Estimated blood loss >1500ml ongoing. Shocked.', instructorNotes: 'Major PPH. Uterine massage, uterotonics (oxytocin, ergometrine, carboprost, misoprostol). Activate MHP. Theatre if medical fails.', startVitals: { hr: 132, rr: 26, bpSys: 82, bpDia: 48, spo2: 96, temp: 36.5, bm: 5.5, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'haemorrhagic_shock', investigations: { xray: 'Not indicated', ct: 'Not indicated', pocus: 'No retained products visible' }, deteriorationType: 'shock', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Blood', successChance: 0.75 } },
        { id: 's24', name: 'Head Injury (Extradural Haematoma)', category: 'Trauma', ageRange: () => getRandomInt(16, 50), acuity: 'Critical', briefing: 'Assault. Initial LOC, then lucid interval. Now deteriorating GCS.', instructorNotes: 'Classic extradural. Temporal bone fracture. Urgent neurosurgery. Intubate for airway protection. Hyperosmolar therapy.', startVitals: { hr: 58, rr: 10, bpSys: 168, bpDia: 95, spo2: 95, temp: 36.8, bm: 6.0, gcs: 9, pupils: '5mm left, 3mm right' }, ecgRhythm: 'Sinus Bradycardia', ecgFindings: ['Sinus bradycardia'], vbgState: 'normal', investigations: { xray: 'Skull fracture', ct: 'Large left extradural haematoma with midline shift', urine: 'Normal' }, deteriorationType: 'neuro', deteriorationRate: 'fast', rosc: { possible: false } },
        { id: 's25', name: 'Carbon Monoxide Poisoning', category: 'Toxicology', ageRange: () => getRandomInt(18, 70), acuity: 'High', briefing: 'Found unconscious at home. House fire. Cherry red appearance. Reduced GCS.', instructorNotes: 'CO poisoning. 100% O2 (high flow), consider hyperbaric. COHb level. Cyanide antidote if severe. Myocardial stunning risk.', startVitals: { hr: 105, rr: 22, bpSys: 112, bpDia: 68, spo2: 100, temp: 37.0, bm: 6.0, gcs: 11, pupils: '4mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'Possible ischaemic changes'], vbgState: 'co_poisoning', investigations: { xray: 'Smoke inhalation changes', ct: 'Cerebral oedema', urine: 'Normal' }, deteriorationType: 'respiratory', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's26', name: 'Tricyclic Antidepressant OD', category: 'Toxicology', ageRange: () => getRandomInt(16, 50), acuity: 'Critical', briefing: 'Intentional overdose. Drowsy, dry mouth, dilated pupils. Broad complex tachycardia.', instructorNotes: 'TCA toxicity. Sodium bicarbonate for QRS >120ms. Supportive. High risk VT/VF. Intralipid if refractory arrest.', startVitals: { hr: 125, rr: 16, bpSys: 98, bpDia: 62, spo2: 98, temp: 37.5, bm: 6.0, gcs: 11, pupils: '6mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Broad QRS (160ms)', 'Right axis deviation', 'Prolonged QT'], vbgState: 'metabolic_acidosis_severe', investigations: { xray: 'Clear', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'AdrenalineIV', successChance: 0.5 } },
        { id: 's27', name: 'Acute Liver Failure', category: 'Medical', ageRange: () => getRandomInt(25, 65), acuity: 'Critical', briefing: 'Jaundiced, confused, coagulopathic. No known liver disease. Paracetamol levels normal now.', instructorNotes: 'ALF unknown cause. NAC anyway. Correct coagulopathy. King's criteria for transplant referral. Cerebral oedema risk.', startVitals: { hr: 98, rr: 20, bpSys: 95, bpDia: 58, spo2: 98, temp: 37.2, bm: 3.2, gcs: 12, pupils: '3mm' }, ecgRhythm: 'Sinus Rhythm', ecgFindings: ['Normal sinus rhythm'], vbgState: 'metabolic_acidosis_severe', investigations: { xray: 'Clear', ct: 'Cerebral oedema', urine: 'Bilirubin +++' }, deteriorationType: 'metabolic', deteriorationRate: 'slow', rosc: { possible: false } },
        { id: 's28', name: 'Acute Epiglottitis', category: 'Medical', ageRange: () => getRandomInt(3, 12), acuity: 'Critical', briefing: 'Child with stridor, drooling, tripod position. Toxic appearance.', instructorNotes: 'Epiglottitis. Keep child calm. Senior anaesthetist + ENT. Gas induction in theatre. Do NOT examine throat. Ceftriaxone.', startVitals: { hr: 145, rr: 32, bpSys: 95, bpDia: 58, spo2: 92, temp: 39.5, bm: 5.5, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Thumb sign on lateral neck', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'airway', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'RSI', successChance: 0.9 } },
        { id: 's29', name: 'Spontaneous Pneumothorax (Large)', category: 'Medical', ageRange: () => getRandomInt(18, 35), acuity: 'High', briefing: 'Tall thin male. Sudden sharp chest pain and breathlessness. Reduced air entry right side.', instructorNotes: 'Large primary spontaneous PTx. Chest drain if >2cm or breathless. High flow O2. BTS guidelines.', startVitals: { hr: 105, rr: 24, bpSys: 122, bpDia: 72, spo2: 93, temp: 36.8, bm: 5.8, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Right 50% pneumothorax', ct: 'Confirms large PTx', urine: 'Normal' }, deteriorationType: 'respiratory', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's30', name: 'Hyperosmolar Hyperglycaemic State', category: 'Medical', ageRange: () => getRandomInt(55, 85), acuity: 'Critical', briefing: 'Type 2 diabetic. Drowsy. Glucose >40. Severely dehydrated.', instructorNotes: 'HHS. Slower fluid replacement than DKA. Lower rate insulin. Watch for cerebral oedema. Replace potassium. DVT prophylaxis.', startVitals: { hr: 115, rr: 24, bpSys: 88, bpDia: 52, spo2: 97, temp: 36.8, bm: 45.0, gcs: 12, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'hhs', investigations: { xray: 'Clear', ct: 'Not indicated acutely', urine: 'Glucose +++, Ketones negative' }, deteriorationType: 'metabolic', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's31', name: 'Thyroid Storm', category: 'Medical', ageRange: () => getRandomInt(25, 60), acuity: 'Critical', briefing: 'Known Graves. Extremely agitated, tachycardic, pyrexial. AF with RVR.', instructorNotes: 'Thyrotoxic crisis. Propylthiouracil/carbimazole, propranolol, hydrocortisone, cooling. Treat AF. ICU.', startVitals: { hr: 165, rr: 28, bpSys: 148, bpDia: 72, spo2: 96, temp: 40.2, bm: 6.5, gcs: 13, pupils: '4mm' }, ecgRhythm: 'AF', ecgFindings: ['AF with rapid ventricular response'], vbgState: 'normal', investigations: { xray: 'Cardiomegaly', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Bisoprolol', successChance: 0.7 } },
        { id: 's32', name: 'Acute Pancreatitis (Severe)', category: 'Medical', ageRange: () => getRandomInt(35, 70), acuity: 'High', briefing: 'Severe epigastric pain radiating to back. Vomiting. Known gallstones. Shocked.', instructorNotes: 'Severe pancreatitis. Aggressive fluid resus, analgesia. Check calcium, glucose. May need HDU/ITU. ERCP if obstructive.', startVitals: { hr: 118, rr: 24, bpSys: 95, bpDia: 58, spo2: 96, temp: 38.2, bm: 9.5, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'metabolic_acidosis_severe', investigations: { xray: 'Ground glass appearance', ct: 'Severe pancreatitis with necrosis', urine: 'Amylase +++' }, deteriorationType: 'shock', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's33', name: 'Serotonin Syndrome', category: 'Toxicology', ageRange: () => getRandomInt(18, 60), acuity: 'High', briefing: 'On multiple antidepressants. Agitated, tremor, hyperthermic, hyperreflexic, clonus.', instructorNotes: 'Serotonin syndrome. Stop offending agents. Benzodiazepines for agitation. Cyproheptadine. Cooling. Supportive care.', startVitals: { hr: 132, rr: 26, bpSys: 155, bpDia: 92, spo2: 97, temp: 39.8, bm: 6.5, gcs: 13, pupils: '6mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'metabolic_acidosis_severe', investigations: { xray: 'Clear', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'neuro', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's34', name: 'Blast Injury (Primary)', category: 'Trauma', ageRange: () => getRandomInt(18, 50), acuity: 'Critical', briefing: 'Explosion nearby. Ruptured tympanic membranes. Dyspnoeic. Haemoptysis.', instructorNotes: 'Primary blast lung injury. High flow O2, avoid IPPV if possible. Pneumothorax risk. Barotrauma. Hidden injuries.', startVitals: { hr: 125, rr: 32, bpSys: 102, bpDia: 65, spo2: 88, temp: 36.8, bm: 6.0, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Butterfly pattern pulmonary contusions', ct: 'Bilateral lung contusions, no PTx', urine: 'Haematuria +' }, deteriorationType: 'respiratory', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Oxygen', successChance: 0.7 } },
        { id: 's35', name: 'Necrotising Fasciitis', category: 'Medical', ageRange: () => getRandomInt(40, 75), acuity: 'Critical', briefing: 'Severe leg pain, fever. Rapidly spreading erythema. Skin blistering. Shocked.', instructorNotes: 'Necrotising fasciitis. Emergency surgical debridement. Aggressive Abx (pip-taz + clindamycin). Resuscitation. High mortality.', startVitals: { hr: 135, rr: 28, bpSys: 78, bpDia: 45, spo2: 95, temp: 39.5, bm: 8.5, gcs: 13, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'septic_shock', investigations: { xray: 'Gas in soft tissues', ct: 'Extensive soft tissue gas and inflammation', urine: 'Normal' }, deteriorationType: 'shock', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'PipTaz', successChance: 0.5 } },
        { id: 's36', name: 'Salicylate Poisoning', category: 'Toxicology', ageRange: () => getRandomInt(16, 60), acuity: 'High', briefing: 'Aspirin overdose. Tinnitus, hyperventilating, confused. Salicylate level 600mg/L.', instructorNotes: 'Salicylate toxicity. Urinary alkalinisation (sodium bicarbonate). Haemodialysis if severe. Mixed respiratory alkalosis + metabolic acidosis.', startVitals: { hr: 105, rr: 32, bpSys: 108, bpDia: 65, spo2: 98, temp: 38.5, bm: 6.0, gcs: 13, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'metabolic_acidosis_severe', investigations: { xray: 'Non-cardiogenic pulmonary oedema', ct: 'Not indicated', urine: 'pH 5.5' }, deteriorationType: 'metabolic', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's37', name: 'Myxoedema Coma', category: 'Medical', ageRange: () => getRandomInt(60, 85), acuity: 'Critical', briefing: 'Profoundly hypothermic, bradycardic, reduced GCS. Known hypothyroidism. Stopped thyroxine.', instructorNotes: 'Myxoedema coma. IV T3/T4 replacement, hydrocortisone (adrenal crisis risk), gentle rewarming. ICU. High mortality.', startVitals: { hr: 38, rr: 8, bpSys: 82, bpDia: 48, spo2: 92, temp: 32.5, bm: 5.5, gcs: 8, pupils: '2mm' }, ecgRhythm: 'Sinus Bradycardia', ecgFindings: ['Severe sinus bradycardia', 'Low voltage QRS', 'Prolonged QT'], vbgState: 'hypothermia', investigations: { xray: 'Cardiomegaly', ct: 'Cerebral oedema', urine: 'Not passed' }, deteriorationType: 'neuro', deteriorationRate: 'slow', rosc: { possible: true, triggerIntervention: 'T3T4', successChance: 0.6 } },
        { id: 's38', name: 'Opioid Overdose', category: 'Toxicology', ageRange: () => getRandomInt(18, 50), acuity: 'High', briefing: 'Found unresponsive. Pinpoint pupils. Respiratory rate 4. Suspected heroin.', instructorNotes: 'Opioid toxidrome. Naloxone 400mcg increments. Protect airway. May need repeated doses/infusion. Withdrawal risk.', startVitals: { hr: 55, rr: 4, bpSys: 95, bpDia: 58, spo2: 82, temp: 36.5, bm: 5.5, gcs: 5, pupils: '1mm pinpoint' }, ecgRhythm: 'Sinus Bradycardia', ecgFindings: ['Sinus bradycardia'], vbgState: 'respiratory_acidosis_acute', investigations: { xray: 'Aspiration risk', ct: 'Not indicated', urine: 'Opiates positive' }, deteriorationType: 'respiratory', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Naloxone', successChance: 0.95 } },
        { id: 's39', name: 'Acute Pericardial Tamponade', category: 'Medical', ageRange: () => getRandomInt(40, 75), acuity: 'Critical', briefing: 'Chest pain, dyspnoea. Hypotensive. Muffled heart sounds. Raised JVP. Recent viral illness.', instructorNotes: 'Cardiac tamponade. Beck's triad. Emergency pericardiocentesis. Fluid challenge may temporise. Echo confirms.', startVitals: { hr: 125, rr: 28, bpSys: 75, bpDia: 60, spo2: 94, temp: 37.5, bm: 6.0, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Low voltage QRS', 'Electrical alternans'], vbgState: 'normal', investigations: { xray: 'Globular heart', ct: 'Large pericardial effusion', pocus: 'Large pericardial effusion, RV collapse' }, deteriorationType: 'cardiac', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Pericardiocentesis', successChance: 0.8 } },
        { id: 's40', name: 'Hypothermia (Severe)', category: 'Medical', ageRange: () => getRandomInt(50, 80), acuity: 'Critical', briefing: 'Found outdoors in winter. Core temp 28C. Bradycardic, rigid, appears dead.', instructorNotes: 'Severe hypothermia. Gentle handling (VF risk). Active rewarming. Warm IV fluids. Not dead until warm and dead. CPR if arrested.', startVitals: { hr: 35, rr: 6, bpSys: 68, bpDia: 42, spo2: 88, temp: 28.0, bm: 4.5, gcs: 6, pupils: '2mm sluggish' }, ecgRhythm: 'Sinus Bradycardia', ecgFindings: ['Severe bradycardia', 'J waves (Osborn waves)', 'Prolonged QT'], vbgState: 'hypothermia', investigations: { xray: 'Clear', ct: 'Not indicated acutely', urine: 'Not passed' }, deteriorationType: 'metabolic', deteriorationRate: 'slow', rosc: { possible: true, triggerIntervention: 'Warming', successChance: 0.7 } },
        { id: 's41', name: 'Intussusception (Paediatric)', category: 'Paediatric', ageRange: () => getRandomInt(0.5, 3), acuity: 'High', briefing: 'Infant. Paroxysmal screaming, drawing up legs. Redcurrant jelly stool. Sausage-shaped mass.', instructorNotes: 'Intussusception. IV fluids, analgesia. Air enema (radiology) first line. Surgery if failed reduction or peritonitis.', startVitals: { hr: 165, rr: 38, bpSys: 75, bpDia: 45, spo2: 97, temp: 37.8, bm: 5.0, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Target sign', ct: 'Not first line', pocus: 'Target sign on USS' }, deteriorationType: 'shock', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's42', name: 'Supraventricular Tachycardia', category: 'Medical', ageRange: () => getRandomInt(25, 70), acuity: 'High', briefing: 'Palpitations, dizziness. HR 180. Narrow complex. Haemodynamically stable.', instructorNotes: 'SVT (likely AVNRT). Vagal manoeuvres, then adenosine 6-12-18mg. Cardioversion if unstable. Cardiology follow-up.', startVitals: { hr: 180, rr: 22, bpSys: 108, bpDia: 68, spo2: 97, temp: 36.8, bm: 6.0, gcs: 15, pupils: '3mm' }, ecgRhythm: 'SVT', ecgFindings: ['Narrow complex tachycardia 180bpm', 'No visible P waves', 'Regular'], vbgState: 'normal', investigations: { xray: 'Normal heart size', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'slow', rosc: { possible: false } },
        { id: 's43', name: 'Ventricular Tachycardia (Stable)', category: 'Medical', ageRange: () => getRandomInt(50, 80), acuity: 'Critical', briefing: 'Broad complex tachycardia 160bpm. Patient conscious but unwell. History of MI.', instructorNotes: 'Monomorphic VT. Amiodarone 300mg if stable. Synchronised cardioversion if deteriorates. Treat as VT if unsure.', startVitals: { hr: 160, rr: 24, bpSys: 95, bpDia: 58, spo2: 96, temp: 36.8, bm: 6.5, gcs: 14, pupils: '3mm' }, ecgRhythm: 'VT', ecgFindings: ['Broad complex tachycardia', 'AV dissociation', 'Capture beats'], vbgState: 'normal', investigations: { xray: 'Cardiomegaly', ct: 'Not indicated acutely', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Amiodarone', successChance: 0.7 } },
        { id: 's44', name: 'Atrial Fibrillation with RVR', category: 'Medical', ageRange: () => getRandomInt(60, 85), acuity: 'High', briefing: 'Palpitations, breathless. Irregular pulse 145bpm. New onset AF.', instructorNotes: 'AF with RVR. Rate control (beta blocker/digoxin). Anticoagulation decision. Cardioversion if <48hrs or TOE clear.', startVitals: { hr: 145, rr: 24, bpSys: 135, bpDia: 82, spo2: 94, temp: 36.8, bm: 6.5, gcs: 15, pupils: '3mm' }, ecgRhythm: 'AF', ecgFindings: ['Irregularly irregular rhythm', 'Absent P waves', 'Fibrillatory waves'], vbgState: 'normal', investigations: { xray: 'Cardiomegaly, mild pulmonary oedema', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'medium', rosc: { possible: false } },
        { id: 's45', name: 'Complete Heart Block', category: 'Medical', ageRange: () => getRandomInt(65, 90), acuity: 'Critical', briefing: 'Syncope, dizziness. HR 35. Haemodynamically compromised.', instructorNotes: 'Complete heart block. Atropine, then external pacing if needed. Urgent cardiology for pacing wire. High arrest risk.', startVitals: { hr: 35, rr: 18, bpSys: 82, bpDia: 48, spo2: 96, temp: 36.5, bm: 6.0, gcs: 14, pupils: '3mm' }, ecgRhythm: 'Complete Heart Block', ecgFindings: ['AV dissociation', 'P waves march through', 'Broad complex escape rhythm'], vbgState: 'normal', investigations: { xray: 'Cardiomegaly', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: 'cardiac', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Pacing', successChance: 0.85 } },
        { id: 's46', name: 'Kawasaki Disease', category: 'Paediatric', ageRange: () => getRandomInt(1, 5), acuity: 'High', briefing: 'Child. High fever 5 days. Rash, red eyes, strawberry tongue, peeling hands/feet.', instructorNotes: 'Kawasaki disease. IVIG + high dose aspirin. Urgent echo for coronary aneurysms. Cardiology input.', startVitals: { hr: 155, rr: 32, bpSys: 85, bpDia: 52, spo2: 98, temp: 39.5, bm: 5.5, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Normal', ct: 'Not indicated', echo: 'Dilated coronary arteries' }, deteriorationType: 'cardiac', deteriorationRate: 'slow', rosc: { possible: false } },
        { id: 's47', name: 'Addisonian Crisis', category: 'Medical', ageRange: () => getRandomInt(25, 70), acuity: 'Critical', briefing: 'Known Addison's. Vomiting, abdo pain. Profoundly hypotensive. Hyperpigmented.', instructorNotes: 'Adrenal crisis. IV hydrocortisone 100mg stat, then 6-hourly. Aggressive fluid resus. Correct hypoglycaemia if present.', startVitals: { hr: 125, rr: 24, bpSys: 72, bpDia: 42, spo2: 97, temp: 37.5, bm: 3.2, gcs: 13, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia', 'Peaked T waves'], vbgState: 'hyperkalemia', investigations: { xray: 'Small heart', ct: 'Not indicated acutely', urine: 'Sodium low' }, deteriorationType: 'shock', deteriorationRate: 'fast', rosc: { possible: true, triggerIntervention: 'Hydrocortisone', successChance: 0.8 } },
        { id: 's48', name: 'Testicular Torsion', category: 'Medical', ageRange: () => getRandomInt(12, 25), acuity: 'High', briefing: 'Sudden severe testicular pain. Nausea. High riding testis. Absent cremasteric reflex.', instructorNotes: 'Testicular torsion. 6-hour window. Emergency urology. Manual detorsion can be attempted. Analgesia. Theatre.', startVitals: { hr: 105, rr: 20, bpSys: 135, bpDia: 82, spo2: 98, temp: 37.0, bm: 6.0, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Not indicated', ct: 'Not indicated', pocus: 'Reduced testicular flow on Doppler' }, deteriorationType: null, deteriorationRate: 'none', rosc: { possible: false } },
        { id: 's49', name: 'Acute Glaucoma', category: 'Medical', ageRange: () => getRandomInt(50, 80), acuity: 'High', briefing: 'Severe eye pain, blurred vision, seeing halos. Red eye. Fixed mid-dilated pupil. Rock hard eye.', instructorNotes: 'Acute angle closure glaucoma. Pilocarpine, IV acetazolamide, analgesia, antiemetics. Urgent ophthalmology.', startVitals: { hr: 88, rr: 18, bpSys: 145, bpDia: 85, spo2: 98, temp: 36.8, bm: 6.0, gcs: 15, pupils: '5mm fixed right' }, ecgRhythm: 'Sinus Rhythm', ecgFindings: ['Normal sinus rhythm'], vbgState: 'normal', investigations: { xray: 'Not indicated', ct: 'Not indicated', urine: 'Normal' }, deteriorationType: null, deteriorationRate: 'none', rosc: { possible: false } },
        { id: 's50', name: 'Acute Compartment Syndrome', category: 'Trauma', ageRange: () => getRandomInt(18, 50), acuity: 'High', briefing: 'Tibial fracture post-plaster. Severe pain, tense calf. Pain on passive stretch. Paraesthesia.', instructorNotes: 'Compartment syndrome. 5 Ps. Emergency fasciotomy. Remove plaster. Limb-threatening. Do NOT delay for pressure measurements.', startVitals: { hr: 112, rr: 22, bpSys: 135, bpDia: 82, spo2: 98, temp: 37.2, bm: 6.0, gcs: 15, pupils: '3mm' }, ecgRhythm: 'Sinus Tachycardia', ecgFindings: ['Sinus tachycardia'], vbgState: 'normal', investigations: { xray: 'Tibial fracture', ct: 'Not indicated', urine: 'May show myoglobin' }, deteriorationType: null, deteriorationRate: 'none', rosc: { possible: false } },
    ];

    // ... [continuing with more functions - will split at next logical point]

    // --- 2. SIMULATION ENGINE ---
    
    const simulationReducer = (state, action) => {
        switch (action.type) {
            case 'TICK': {
                let newVitals = { ...state.vitals };
                const age = state.scenario?.age || 40;
                
                // Apply active interventions
                state.activeInterventions.forEach(intv => {
                    const def = INTERVENTIONS[intv.id];
                    if (!def || !def.effect) return;
                    Object.keys(def.effect).forEach(key => {
                        if (key === 'SpO2' && newVitals.spo2 !== undefined) newVitals.spo2 = clamp(newVitals.spo2 + def.effect[key], 0, 100);
                        else if (key === 'HR' && newVitals.hr !== undefined) newVitals.hr = clamp(newVitals.hr + def.effect[key], 0, 220);
                        else if (key === 'BP' && newVitals.bpSys !== undefined) {
                            newVitals.bpSys = clamp(newVitals.bpSys + def.effect[key], 0, 250);
                            newVitals.bpDia = clamp(newVitals.bpDia + Math.floor(def.effect[key] / 2), 0, 150);
                        }
                        else if (key === 'RR' && newVitals.rr !== undefined && def.effect[key] !== 'vent') newVitals.rr = clamp(newVitals.rr + def.effect[key], 0, 60);
                        else if (key === 'temp' && newVitals.temp !== undefined) newVitals.temp = parseFloat((newVitals.temp + def.effect[key]).toFixed(1));
                        else if (key === 'bm' && newVitals.bm !== undefined) newVitals.bm = parseFloat((newVitals.bm + def.effect[key]).toFixed(1));
                        else if (key === 'gcs' && newVitals.gcs !== undefined && def.effect[key] !== 'sedated') newVitals.gcs = clamp(newVitals.gcs + def.effect[key], 3, 15);
                    });
                });

                // Deterioration logic
                if (state.scenario?.deteriorationType && state.scenario.deteriorationRate !== 'none') {
                    const rate = state.scenario.deteriorationRate;
                    let delta = 0;
                    if (rate === 'very_fast') delta = 3;
                    else if (rate === 'fast') delta = 2;
                    else if (rate === 'medium') delta = 1;
                    else if (rate === 'slow') delta = 0.5;

                    if (state.scenario.deteriorationType === 'shock') {
                        newVitals.bpSys = clamp(newVitals.bpSys - delta, 0, 250);
                        newVitals.hr = clamp(newVitals.hr + delta, 0, 220);
                    } else if (state.scenario.deteriorationType === 'respiratory') {
                        newVitals.spo2 = clamp(newVitals.spo2 - delta, 0, 100);
                        newVitals.rr = clamp(newVitals.rr + delta, 0, 60);
                    } else if (state.scenario.deteriorationType === 'cardiac') {
                        newVitals.hr = clamp(newVitals.hr + delta * 2, 0, 220);
                        newVitals.bpSys = clamp(newVitals.bpSys - delta, 0, 250);
                    } else if (state.scenario.deteriorationType === 'airway') {
                        newVitals.spo2 = clamp(newVitals.spo2 - delta * 1.5, 0, 100);
                    }
                }

                // Arrest detection
                if (newVitals.bpSys <= 40 || newVitals.spo2 <= 50) {
                    if (!state.inArrest) {
                        return { ...state, inArrest: true, rhythm: 'PEA', vitals: { ...newVitals, hr: 0, bpSys: 0, bpDia: 0, spo2: 0 } };
                    }
                }

                // Update history
                let newHistory = [...state.history, newVitals];
                if (newHistory.length > 60) newHistory.shift();

                return { ...state, vitals: newVitals, history: newHistory, ticks: state.ticks + 1 };
            }
            case 'APPLY_INTERVENTION': {
                const intv = action.payload;
                const def = INTERVENTIONS[intv];
                if (!def) return state;

                let newLog = [...state.log, { time: state.elapsedTime, text: def.log, intervention: intv }];
                let newActiveInterventions = [...state.activeInterventions];

                if (def.type === 'continuous') {
                    newActiveInterventions.push({ id: intv, startTime: state.elapsedTime, duration: def.duration });
                }

                // Immediate effects
                let newVitals = { ...state.vitals };
                let newRhythm = state.rhythm;
                let newInArrest = state.inArrest;

                if (def.effect) {
                    Object.keys(def.effect).forEach(key => {
                        if (key === 'changeRhythm') {
                            if (def.effect[key] === 'defib' && state.rhythm === 'VF') {
                                if (Math.random() < 0.7) {
                                    newRhythm = 'Sinus Rhythm';
                                    newVitals.hr = 75;
                                    newVitals.bpSys = 100;
                                    newVitals.bpDia = 60;
                                    newVitals.spo2 = 95;
                                    newInArrest = false;
                                    newLog.push({ time: state.elapsedTime, text: 'ROSC achieved!', intervention: 'Defib' });
                                }
                            }
                        }
                    });
                }

                return { ...state, log: newLog, activeInterventions: newActiveInterventions, vitals: newVitals, rhythm: newRhythm, inArrest: newInArrest };
            }
            case 'EDIT_VITAL': {
                const { vital, value } = action.payload;
                return { ...state, vitals: { ...state.vitals, [vital]: value } };
            }
            case 'INCREMENT_TIME': {
                let newActiveInterventions = state.activeInterventions.filter(intv => {
                    const elapsed = state.elapsedTime - intv.startTime;
                    return elapsed < intv.duration;
                });
                return { ...state, elapsedTime: state.elapsedTime + 1, activeInterventions: newActiveInterventions };
            }
            case 'TOGGLE_SOUND': return { ...state, soundEnabled: !state.soundEnabled };
            case 'RHYTHM_CHANGE': return { ...state, rhythm: action.payload };
            default: return state;
        }
    };

    // --- 3. REACT COMPONENTS ---

    const { useState, useEffect, useRef, useReducer } = React;

    const SimulatorApp = () => {
        const [screen, setScreen] = useState('setup'); 
        const [scenario, setScenario] = useState(null);
        const [simState, dispatch] = useReducer(simulationReducer, {
            vitals: {},
            rhythm: 'Sinus Rhythm',
            log: [],
            history: [],
            activeInterventions: [],
            inArrest: false,
            soundEnabled: false,
            elapsedTime: 0,
            ticks: 0,
            scenario: null
        });

        const startSim = (selectedScenario) => {
            const age = typeof selectedScenario.ageRange === 'function' ? selectedScenario.ageRange() : 40;
            const hist = generateHistory(age);
            const fullScenario = {
                ...selectedScenario,
                age,
                sex: Math.random() > 0.5 ? 'Male' : 'Female',
                history: hist,
                weight: estimateWeight(age)
            };
            
            setScenario(fullScenario);
            dispatch({ type: 'SET_SCENARIO', payload: fullScenario });
            setScreen('briefing');
        };

        const goLive = () => {
            const initialState = {
                vitals: scenario.startVitals,
                rhythm: scenario.ecgRhythm,
                log: [{ time: 0, text: 'Simulation started.', intervention: null }],
                history: [scenario.startVitals],
                activeInterventions: [],
                inArrest: false,
                soundEnabled: false,
                elapsedTime: 0,
                ticks: 0,
                scenario: scenario
            };
            // Reset reducer with new state
            setScreen('live');
        };

        const endSim = () => {
            setScreen('debrief');
        };

        return (
            <div className="flex flex-col h-full bg-slate-900">
                {screen === 'setup' && <SetupScreen onStart={startSim} />}
                {screen === 'briefing' && <BriefingScreen scenario={scenario} onContinue={goLive} onBack={() => setScreen('setup')} />}
                {screen === 'live' && <LiveSimScreen scenario={scenario} simState={simState} dispatch={dispatch} onEnd={endSim} />}
                {screen === 'debrief' && <DebriefScreen scenario={scenario} simState={simState} onRestart={() => { setScreen('setup'); setScenario(null); }} />}
            </div>
        );
    };

    const SetupScreen = ({ onStart }) => {
        const [mode, setMode] = useState('random');
        const [filters, setFilters] = useState({ category: 'All', ageRange: 'All', acuity: 'All' });
        const [selectedScenario, setSelectedScenario] = useState(null);

        const generateRandom = () => {
            let pool = ALL_SCENARIOS;
            if (filters.category !== 'All') pool = pool.filter(s => s.category === filters.category);
            if (filters.acuity !== 'All') pool = pool.filter(s => s.acuity === filters.acuity);
            const chosen = getRandomItem(pool);
            onStart(chosen);
        };

        const categories = ['All', ...new Set(ALL_SCENARIOS.map(s => s.category))];
        const acuities = ['All', 'Critical', 'High'];

        return (
            <div className="flex-1 overflow-auto p-6">
                <div className="max-w-4xl mx-auto">
                    <h1 className="text-4xl font-bold text-sky-400 mb-2">WMEBEM Sim Generator</h1>
                    <p className="text-slate-400 mb-6">v13.3 - Emergency Medicine Simulation Tool</p>

                    <div className="flex gap-4 mb-6">
                        <button onClick={() => setMode('random')} className={`px-6 py-3 rounded font-semibold ${mode === 'random' ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-300'}`}>Random Scenario</button>
                        <button onClick={() => setMode('custom')} className={`px-6 py-3 rounded font-semibold ${mode === 'custom' ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-300'}`}>Choose Scenario</button>
                    </div>

                    {mode === 'random' && (
                        <div className="bg-slate-800 p-6 rounded-lg mb-6">
                            <h2 className="text-xl font-semibold text-sky-400 mb-4">Filters (Optional)</h2>
                            <div className="grid grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm text-slate-400 mb-2">Category</label>
                                    <select value={filters.category} onChange={e => setFilters({...filters, category: e.target.value})} className="w-full bg-slate-700 text-white p-2 rounded">
                                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-400 mb-2">Acuity</label>
                                    <select value={filters.acuity} onChange={e => setFilters({...filters, acuity: e.target.value})} className="w-full bg-slate-700 text-white p-2 rounded">
                                        {acuities.map(a => <option key={a} value={a}>{a}</option>)}
                                    </select>
                                </div>
                            </div>
                            <button onClick={generateRandom} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded font-semibold">Generate Random Scenario</button>
                        </div>
                    )}

                    {mode === 'custom' && (
                        <div className="bg-slate-800 p-6 rounded-lg">
                            <h2 className="text-xl font-semibold text-sky-400 mb-4">Select Scenario</h2>
                            <div className="grid gap-3 max-h-96 overflow-y-auto">
                                {ALL_SCENARIOS.map(s => (
                                    <button key={s.id} onClick={() => setSelectedScenario(s)} className={`text-left p-4 rounded ${selectedScenario?.id === s.id ? 'bg-sky-700 border-2 border-sky-400' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="font-semibold text-sky-300">{s.name}</h3>
                                                <p className="text-sm text-slate-400">{s.category}  {s.acuity}</p>
                                            </div>
                                            <span className="text-xs px-2 py-1 bg-slate-800 rounded">{s.acuity}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            {selectedScenario && (
                                <button onClick={() => onStart(selectedScenario)} className="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded font-semibold">Start This Scenario</button>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const BriefingScreen = ({ scenario, onContinue, onBack }) => {
        if (!scenario) return null;

        return (
            <div className="flex-1 overflow-auto p-6">
                <div className="max-w-3xl mx-auto">
                    <button onClick={onBack} className="mb-4 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white"> Back</button>
                    
                    <div className="bg-slate-800 p-6 rounded-lg mb-6">
                        <h1 className="text-3xl font-bold text-sky-400 mb-2">{scenario.name}</h1>
                        <div className="flex gap-4 mb-4">
                            <span className="px-3 py-1 bg-slate-700 rounded text-sm">{scenario.category}</span>
                            <span className={`px-3 py-1 rounded text-sm ${scenario.acuity === 'Critical' ? 'bg-red-900 text-red-200' : 'bg-amber-900 text-amber-200'}`}>{scenario.acuity}</span>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <h3 className="font-semibold text-slate-300 mb-1">Patient Demographics</h3>
                                <p className="text-slate-400">{scenario.age} year old {scenario.sex}</p>
                                <p className="text-slate-400">Estimated Weight: {scenario.weight}kg</p>
                            </div>

                            <div>
                                <h3 className="font-semibold text-slate-300 mb-1">Handover</h3>
                                <p className="text-white">{scenario.briefing}</p>
                            </div>

                            <div>
                                <h3 className="font-semibold text-slate-300 mb-1">Past Medical History</h3>
                                <p className="text-slate-400">{scenario.history.pmh.join(', ')}</p>
                            </div>

                            <div>
                                <h3 className="font-semibold text-slate-300 mb-1">Medications</h3>
                                <p className="text-slate-400">{scenario.history.dhx.join(', ')}</p>
                            </div>

                            <div>
                                <h3 className="font-semibold text-slate-300 mb-1">Allergies</h3>
                                <p className="text-slate-400">{scenario.history.allergies.join(', ')}</p>
                            </div>

                            <div className="bg-slate-900 p-4 rounded border-l-4 border-amber-500">
                                <h3 className="font-semibold text-amber-400 mb-2">Instructor Notes</h3>
                                <p className="text-slate-300 text-sm">{scenario.instructorNotes}</p>
                            </div>
                        </div>
                    </div>

                    <button onClick={onContinue} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded font-semibold text-lg">Start Simulation </button>
                </div>
            </div>
        );
    };

    const LiveSimScreen = ({ scenario, simState, dispatch, onEnd }) => {
        const [searchTerm, setSearchTerm] = useState('');
        
        useEffect(() => {
            const tickInterval = setInterval(() => {
                dispatch({ type: 'TICK' });
                dispatch({ type: 'INCREMENT_TIME' });
            }, 3000);
            return () => clearInterval(tickInterval);
        }, []);

        const filteredInterventions = Object.keys(INTERVENTIONS).filter(key =>
            INTERVENTIONS[key].label.toLowerCase().includes(searchTerm.toLowerCase())
        );

        const interventionsByCategory = {};
        filteredInterventions.forEach(key => {
            const cat = INTERVENTIONS[key].category || 'Other';
            if (!interventionsByCategory[cat]) interventionsByCategory[cat] = [];
            interventionsByCategory[cat].push(key);
        });

        return (
            <div className="flex-1 flex flex-col overflow-hidden">
                <div className="bg-slate-800 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                    <div className="flex items-center gap-4">
                        <h2 className="text-lg font-semibold text-sky-400">{scenario.name}</h2>
                        <span className="text-slate-400">{Math.floor(simState.elapsedTime / 60)}:{String(simState.elapsedTime % 60).padStart(2, '0')}</span>
                    </div>
                    <button onClick={onEnd} className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white font-semibold">End Simulation</button>
                </div>

                <div className="flex-1 flex overflow-hidden">
                    <div className="w-2/3 flex flex-col border-r border-slate-700">
                        <div className="p-4 bg-slate-800 flex gap-4 items-center">
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className={`w-3 h-3 rounded-full ${simState.inArrest ? 'bg-red-500 animate-pulse' : 'bg-emerald-500'}`}></span>
                                    <span className="text-slate-300 font-semibold">{simState.rhythm}</span>
                                </div>
                                <div className="grid grid-cols-4 gap-2">
                                    <VitalDisplay label="HR" value={simState.vitals.hr} unit="bpm" />
                                    <VitalDisplay label="BP" value={`${simState.vitals.bpSys}/${simState.vitals.bpDia}`} unit="mmHg" />
                                    <VitalDisplay label="SpO2" value={simState.vitals.spo2} unit="%" />
                                    <VitalDisplay label="RR" value={simState.vitals.rr} unit="/min" />
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-auto p-4 space-y-4">
                            <div className="bg-slate-800 p-4 rounded">
                                <h3 className="font-semibold text-sky-400 mb-2">Event Log</h3>
                                <div className="space-y-1 max-h-48 overflow-y-auto">
                                    {simState.log.map((entry, idx) => (
                                        <div key={idx} className="text-sm text-slate-300">
                                            <span className="text-slate-500">[{Math.floor(entry.time / 60)}:{String(entry.time % 60).padStart(2, '0')}]</span> {entry.text}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-slate-800 p-4 rounded">
                                <h3 className="font-semibold text-sky-400 mb-2">Active Interventions</h3>
                                {simState.activeInterventions.length === 0 && <p className="text-slate-500 text-sm">None active</p>}
                                {simState.activeInterventions.map((intv, idx) => {
                                    const remaining = intv.duration - (simState.elapsedTime - intv.startTime);
                                    const progress = (remaining / intv.duration) * 100;
                                    return (
                                        <div key={idx} className="mb-2">
                                            <div className="flex justify-between text-sm text-slate-300 mb-1">
                                                <span>{INTERVENTIONS[intv.id].label}</span>
                                                <span>{remaining}s</span>
                                            </div>
                                            <div className="w-full bg-slate-700 h-1 rounded-full overflow-hidden">
                                                <div className="bg-emerald-500 h-full" style={{width: `${progress}%`}}></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    <div className="w-1/3 flex flex-col">
                        <div className="p-4 bg-slate-800 border-b border-slate-700">
                            <input type="text" placeholder="Search interventions..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full bg-slate-700 text-white p-2 rounded" />
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {Object.keys(interventionsByCategory).map(category => (
                                <div key={category}>
                                    <h3 className="font-semibold text-sky-400 mb-2">{category}</h3>
                                    <div className="grid gap-2">
                                        {interventionsByCategory[category].map(key => (
                                            <button key={key} onClick={() => dispatch({ type: 'APPLY_INTERVENTION', payload: key })} className="p-2 bg-slate-700 hover:bg-slate-600 rounded text-left text-sm text-white">
                                                {INTERVENTIONS[key].label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const VitalDisplay = ({ label, value, unit }) => {
        return (
            <div className="bg-slate-700 p-2 rounded">
                <div className="text-xs text-slate-400">{label}</div>
                <div className="text-lg font-bold text-white">{value}<span className="text-xs text-slate-400 ml-1">{unit}</span></div>
            </div>
        );
    };

    const DebriefScreen = ({ scenario, simState, onRestart }) => {
        return (
            <div className="flex-1 overflow-auto p-6">
                <div className="max-w-4xl mx-auto">
                    <h1 className="text-3xl font-bold text-sky-400 mb-6">Simulation Complete</h1>
                    
                    <div className="bg-slate-800 p-6 rounded-lg mb-6">
                        <h2 className="text-xl font-semibold text-sky-400 mb-4">{scenario.name}</h2>
                        <p className="text-slate-300 mb-4">Duration: {Math.floor(simState.elapsedTime / 60)}:{String(simState.elapsedTime % 60).padStart(2, '0')}</p>
                        
                        <div className="space-y-4">
                            <div>
                                <h3 className="font-semibold text-slate-300 mb-2">Actions Taken</h3>
                                <div className="space-y-1">
                                    {simState.log.map((entry, idx) => (
                                        <div key={idx} className="text-sm text-slate-400">
                                            <span className="text-slate-500">[{Math.floor(entry.time / 60)}:{String(entry.time % 60).padStart(2, '0')}]</span> {entry.text}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-slate-900 p-4 rounded border-l-4 border-emerald-500">
                                <h3 className="font-semibold text-emerald-400 mb-2">Learning Points</h3>
                                <p className="text-slate-300 text-sm">{scenario.instructorNotes}</p>
                            </div>
                        </div>
                    </div>

                    <button onClick={onRestart} className="w-full bg-sky-600 hover:bg-sky-700 text-white py-3 rounded font-semibold">Start New Simulation</button>
                </div>
            </div>
        );
    };

    ReactDOM.render(<SimulatorApp />, document.getElementById('root'));

    </script>
</body>
</html>
