<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Sim Generator v10.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for Exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .flash-red { animation: flashRed 1.5s ease-in-out infinite; }
        @keyframes flashRed {
            0%, 100% { background-color: rgba(30, 41, 59, 1); } 
            50% { background-color: rgba(127, 29, 29, 0.5); } 
        }
        
        .flash-green { animation: flashGreen 1s ease-in-out; }
        @keyframes flashGreen {
            0%, 100% { border-color: #334155; }
            50% { border-color: #10b981; }
        }
        
        html { overflow-y: scroll; -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: none; }

        @keyframes loadProgress { from { width: 0%; } to { width: 100%; } }
        .loading-bar {
            position: absolute; bottom: 0; left: 0; height: 100%;
            background-color: rgba(16, 185, 129, 0.2);
            animation: loadProgress 2s linear forwards; z-index: 0;
        }
        
        /* ECG Animation - Duration set dynamically in JS */
        .ecg-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation-name: drawECG;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        @keyframes drawECG {
            to { stroke-dashoffset: 0; }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 antialiased selection:bg-sky-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
    
    // --- 1. HELPER FUNCTIONS & DATA ---

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getRandomFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));

    const getBaseVitals = (age) => {
        if (age < 1) return { hr: 145, rr: 45, bpSys: 75, bpDia: 45, temp: 37.0, bm: 4.5 }; 
        if (age <= 2) return { hr: 125, rr: 30, bpSys: 90, bpDia: 55, temp: 37.0, bm: 5.0 }; 
        if (age <= 5) return { hr: 110, rr: 25, bpSys: 95, bpDia: 60, temp: 37.0, bm: 5.0 }; 
        if (age <= 12) return { hr: 90, rr: 20, bpSys: 105, bpDia: 65, temp: 36.8, bm: 5.5 }; 
        if (age > 65) return { hr: 70, rr: 18, bpSys: 135, bpDia: 80, temp: 36.5, bm: 6.0 }; 
        return { hr: 75, rr: 16, bpSys: 120, bpDia: 75, temp: 36.8, bm: 5.8 }; 
    };

    const estimateWeight = (age) => {
        if (age === 0) return "3.5"; 
        if (age < 1) return "4-9"; 
        if (age >= 1 && age <= 10) return ((age + 4) * 2).toFixed(1); 
        if (age > 10) return (age * 3 + 7).toFixed(1); // Improved estimation for older kids
        return null; 
    };

    // Calculate Paediatric Drugs (WETFLAG)
    const calculatePaedDoses = (weight) => {
        const w = parseFloat(weight);
        if(!w) return [];
        return [
            { label: "Fluid Bolus (20ml/kg)", dose: `${(20 * w).toFixed(0)} ml`, type: "Vol" },
            { label: "Adrenaline 1:10,000 (10mcg/kg)", dose: `${(0.1 * w).toFixed(2)} ml`, type: "IV/IO" },
            { label: "Amiodarone (5mg/kg)", dose: `${(5 * w).toFixed(0)} mg`, type: "IV/IO" },
            { label: "Lorazepam (0.1mg/kg)", dose: `${(0.1 * w).toFixed(2)} mg`, type: "IV/IO" },
            { label: "Glucose 10% (2ml/kg)", dose: `${(2 * w).toFixed(0)} ml`, type: "IV/IO" },
            { label: "Tube Size (Age/4 + 4)", dose: `Size 4-5`, type: "ET" }, // Simplified
            { label: "DC Shock (4J/kg)", dose: `${(4 * w).toFixed(0)} J`, type: "Defib" },
        ];
    };

    const generateVbg = (clinicalState = "normal") => {
        let vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.0, K: 4.0, Glu: 5.5 };
        vbg.pH += getRandomFloat(-0.03, 0.03, 2);
        switch (clinicalState) {
            case "dka_severe": vbg = { pH: 6.95, pCO2: 2.5, HCO3: 5, BE: -24, Lac: 2.5, K: 5.4, Glu: 28.0 }; break;
            case "septic_shock": vbg = { pH: 7.25, pCO2: 4.5, HCO3: 16, BE: -8, Lac: 6.5, K: 4.2, Glu: 4.0 }; break;
            case "haemorrhagic_shock": vbg = { pH: 7.20, pCO2: 4.8, HCO3: 14, BE: -10, Lac: 8.0, K: 3.8, Glu: 9.0 }; break;
            case "copd_retainer": vbg = { pH: 7.30, pCO2: 9.5, HCO3: 34, BE: 8, Lac: 1.2, K: 4.0, Glu: 6.0 }; break;
            case "respiratory_acidosis_acute": vbg = { pH: 7.15, pCO2: 9.5, HCO3: 24, BE: 0, Lac: 1.5, K: 4.1, Glu: 6.2 }; break;
            case "metabolic_acidosis_severe": vbg = { pH: 6.90, pCO2: 6.0, HCO3: 10, BE: -22, Lac: 12.0, K: 6.5, Glu: 6.0 }; break;
            case "metabolic_alkalosis": vbg = { pH: 7.50, pCO2: 5.8, HCO3: 30, BE: 6, Lac: 1.0, K: 3.0, Glu: 5.5 }; break;
            case "hyperkalemia": vbg = { pH: 7.35, pCO2: 5.0, HCO3: 22, BE: -2, Lac: 1.5, K: 7.5, Glu: 6.0 }; break;
            case "hyponatremia": vbg = { pH: 7.40, pCO2: 5.3, HCO3: 24, BE: 0, Lac: 1.2, K: 4.0, Na: 115, Glu: 5.5 }; break;
            default: break;
        }
        return vbg;
    };

    const HUMAN_FACTOR_CHALLENGES = [
      { id: 'hf0', type: 'Standard Simulation', description: 'Manage effectively.' },
      { id: 'hf1', type: 'Blindfolded Lead', description: 'Leader blindfolded. Tests closed-loop comms.' },
      { id: 'hf2', type: 'Silent Team', description: 'Only leader speaks.' },
      { id: 'hf3', type: 'New Junior', description: 'Junior member needs explicit instructions.' },
      { id: 'hf4', type: 'Missing Kit', description: 'Crucial equipment missing.' },
      { id: 'hf5', type: 'Distracted Senior', description: 'Consultant on phone, dismissive.' },
    ];

    const INTERVENTIONS = {
        // COMMON
        'Obs': { label: 'Apply Monitoring', effect: {}, category: 'Common', log: 'Full monitoring applied (ECG, SpO2, BP).', type: 'continuous' },
        'Oxygen': { label: 'High Flow O2', effect: { SpO2: 5 }, category: 'Common', log: 'High flow oxygen applied.', type: 'continuous' },
        'IV Access': { label: 'IV/IO Access', effect: {}, category: 'Common', log: 'IV/IO access secured.', type: 'continuous' },
        'Fluids': { label: 'Fluid Bolus', effect: { BP: 5, HR: -2 }, category: 'Common', log: 'Fluid bolus given.', type: 'bolus' },
        'Analgesia': { label: 'Analgesia (Morphine)', effect: { HR: -5, RR: -2 }, category: 'Common', log: 'Morphine administered.', type: 'bolus' },
        'Antiemetic': { label: 'Ondansetron', effect: {}, category: 'Common', log: 'Ondansetron administered.', type: 'bolus' },
        'Sedation': { label: 'Sedation (Ketamine)', effect: { gcs: -2 }, category: 'Common', log: 'Procedural sedation administered.', type: 'bolus' },

        // AIRWAY
        'Nebs': { label: 'Nebs (Salb/Iprat)', effect: { HR: 5, RR: -2, SpO2: 2 }, category: 'Airway', log: 'Nebulisers administered.', type: 'bolus' },
        'Needle': { label: 'Needle Decompression', effect: { SpO2: 10, BP: 10, RR: -5 }, category: 'Airway', log: 'Needle thoracocentesis performed.', type: 'bolus' },
        'Intubation': { label: 'RSI / Intubation', effect: { SpO2: 100, RR: -10 }, category: 'Procedures', log: 'Patient Intubated and Ventilated.', type: 'continuous' },
        
        // CIRCULATION
        'Blood': { label: 'Blood Tx', effect: { BP: 10, HR: -5 }, category: 'Circulation', log: 'Blood products transfused.', type: 'bolus' },
        'Binder': { label: 'Pelvic Binder', effect: { BP: 5 }, category: 'Circulation', log: 'Pelvic binder applied.', type: 'continuous' },

        // DRUGS
        'Salbutamol': { label: 'Salbutamol 5mg', effect: { HR: 5 }, category: 'Drugs', log: 'Salbutamol administered.', type: 'bolus' },
        'Ipratropium': { label: 'Ipratropium 500mcg', effect: {}, category: 'Drugs', log: 'Ipratropium administered.', type: 'bolus' },
        'Aspirin': { label: 'Aspirin 300mg', effect: {}, category: 'Drugs', log: 'Aspirin 300mg administered.', type: 'bolus' },
        'GTN': { label: 'GTN Spray', effect: { BP: -5 }, category: 'Drugs', log: 'GTN Spray administered.', type: 'bolus' },
        'Clopidogrel': { label: 'Clopidogrel 300mg', effect: {}, category: 'Drugs', log: 'Clopidogrel 300mg administered.', type: 'bolus' },
        'Antibiotics': { label: 'Antibiotics (Broad)', effect: {}, category: 'Drugs', log: 'IV Antibiotics administered.', type: 'bolus' },
        'Adrenaline': { label: 'Adrenaline (1:1000)', effect: { HR: 20, BP: 10, RR: -2 }, category: 'Drugs', log: 'Adrenaline IM administered.', type: 'bolus' },
        'Benzos': { label: 'Benzodiazepines', effect: { HR: -10, RR: -2, gcs: -1 }, category: 'Drugs', log: 'Benzodiazepines administered.', type: 'bolus' },
        'Dexamethasone': { label: 'Steroids', effect: {}, category: 'Drugs', log: 'Steroids administered.', type: 'bolus' },
        'Magnesium': { label: 'Magnesium', effect: { BP: -5 }, category: 'Drugs', log: 'IV Magnesium administered.', type: 'bolus' },
        'Glucose': { label: 'Glucose', effect: { gcs: 2 }, category: 'Drugs', log: 'IV Glucose administered.', type: 'bolus' },
        'Furosemide': { label: 'Furosemide', effect: { BP: -5 }, category: 'Drugs', log: 'IV Furosemide administered.', type: 'bolus' },
        'Naloxone': { label: 'Naloxone', effect: { RR: 5, gcs: 3 }, category: 'Drugs', log: 'Naloxone administered.', type: 'bolus' },
        'Calcium': { label: 'Calcium', effect: { BP: 2 }, category: 'Drugs', log: 'Calcium Gluconate given.', type: 'bolus' },
        'Insulin': { label: 'Insulin/Dextrose', effect: {}, category: 'Drugs', log: 'Insulin/Dextrose infusion started.', type: 'continuous' },
        'TXA': { label: 'TXA', effect: {}, category: 'Drugs', log: 'TXA administered.', type: 'bolus' },
        'Adenosine': { label: 'Adenosine', effect: { HR: -80 }, category: 'Drugs', log: 'Adenosine administered.', type: 'bolus' },
        'Hypertonic': { label: 'Hypertonic Saline', effect: { BP: 5 }, category: 'Drugs', log: 'Hypertonic Saline administered.', type: 'bolus' },

        // PROCEDURES
        'Surgery': { label: 'Surgical Consult', effect: {}, category: 'Procedures', log: 'Surgeons contacted urgently.', type: 'bolus' },
        'Splinting': { label: 'Splinting', effect: {}, category: 'Procedures', log: 'Limb splinted.', type: 'continuous' },
        'Cardioversion': { label: 'Cardioversion', effect: { HR: -50, BP: 10 }, category: 'Procedures', log: 'Synchronised DC Cardioversion delivered.', type: 'bolus' },
        'Defib': { label: 'Defibrillation', effect: {}, category: 'Procedures', log: 'Shock Delivered (200J).', type: 'bolus' },
        'Pacing': { label: 'External Pacing', effect: { HR: 30 }, category: 'Procedures', log: 'External Pacing initiated.', type: 'continuous' },
        'CPR': { label: 'CPR', effect: {}, category: 'Procedures', log: 'CPR in progress.', type: 'continuous' },
    };
    
    // === SCENARIO DATABASE ---
    const ALL_SCENARIOS = [
      { 
          id: 'AM001', title: 'Acute STEMI', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(45, 75), 
          patientProfileTemplate: "A {age}-year-old {sex}. Crushing central chest pain radiating to left arm.", presentingComplaint: 'Chest pain, Diaphoresis.', 
          scenarioDetails: ['Pale, clammy, looks unwell.', 'Pain 10/10.', 'ECG: Anterior ST Elevation V1-V4.'], 
          instructorBrief: {
              progression: "Patient is anxious and in severe pain. Will vomit if analgesia is delayed.",
              interventions: ["12 Lead ECG within 10 mins", "Aspirin 300mg + Clopidogrel 300mg", "IV Morphine", "GTN", "Activate PPCI"],
              equipment: "Defib (pads on), ECG Machine, IV Access kit",
              debriefPoints: ["Time to ECG target (<10 mins)", "Contraindications to GTN (Inferior MI)", "Pain management"]
          },
          vitalsMod: { hr: 100, bpSys: 130, bpDia: 85, spO2: 94, rr: 20 }, 
          deterioration: { active: true, rate: 0.05, type: 'cardiac' }, stabilisers: ['Analgesia', 'Oxygen', 'Aspirin', 'GTN', 'Clopidogrel', 'Cardioversion'], 
          fluidResponse: 'positive',
          events: [{ time: 60, msg: "Patient vomits. Complains pain is worsening.", effect: { hr: 10, bpSys: -5 } }],
          ecg: { type: "Anterior STEMI", findings: "STE V1-V4." }, learningLinks: [{ label: "NICE NG185: ACS", url: "https://www.nice.org.uk/guidance/ng185" }] 
      },
      { 
        id: 'AT020', title: 'Ankle Fracture-Dislocation', category: 'Trauma', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(20, 60), 
        patientProfileTemplate: "A {age}-year-old. Fell down stairs.", presentingComplaint: 'Ankle deformity.', 
        scenarioDetails: ['Foot facing wrong way.', 'Skin tenting.', 'Dorsalis pedis pulse weak.'], 
        instructorBrief: {
             progression: "Painful. Foot dusky. Needs urgent reduction.",
             interventions: ["Analgesia/Sedation", "Reduce & Splint", "X-ray"],
             equipment: "Plaster trolley, Ketamine",
             debriefPoints: ["Skin viability", "Reduction techniques"]
        },
        vitalsMod: { hr: 110, bpSys: 130, bpDia: 80, spO2: 98, rr: 20 }, deterioration: { active: false, rate: 0 }, 
        stabilisers: ['Analgesia', 'Splinting', 'reduce_ankle'], 
        customActions: [
             { id: 'reduce_ankle', label: 'Reduce Ankle', effect: { bpSys: -5 }, log: 'Ankle reduced and held.', type: 'bolus' },
             { id: 'backslab', label: 'Apply Backslab', effect: {}, log: 'Backslab applied.', type: 'continuous' }
        ],
        chestXray: { findings: "Trimalleolar fracture dislocation." }, learningLinks: [{ label: "BOAST: Ankle Fractures", url: "https://www.boa.ac.uk/" }] 
      },
      { id: 'OB014', title: 'Shoulder Dystocia', category: 'Obstetrics & Gynae', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(18, 40), 
        patientProfileTemplate: "A {age}-year-old. Head delivered, body stuck.", presentingComplaint: 'Shoulder Dystocia.', 
        scenarioDetails: ['Turtle sign.', 'Failure to restituate.', 'Emergency.'], 
        instructorBrief: {
             progression: "Head delivers but shoulders impacted. Call for help immediately.",
             interventions: ["Call for Help", "McRoberts", "Suprapubic Pressure"],
             equipment: "Maternity Pack",
             debriefPoints: ["HELPERR mnemonic", "Team communication"]
        },
        vitalsMod: { hr: 120, bpSys: 130, bpDia: 80, spO2: 98, rr: 24 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Surgery'], 
        customActions: [
             { id: 'mcroberts', label: 'McRoberts Manoeuvre', effect: {}, log: 'Legs hyperflexed (McRoberts).', type: 'continuous' },
             { id: 'suprapubic', label: 'Suprapubic Pressure', effect: {}, log: 'Suprapubic pressure applied.', type: 'bolus' },
             { id: 'internal', label: 'Internal Manoeuvres', effect: {}, log: 'Internal rotational manoeuvres attempted.', type: 'bolus' }
        ],
        learningLinks: [{ label: "RCOG: Shoulder Dystocia", url: "https://www.rcog.org.uk/" }] 
      },
      { id: 'AM010', title: 'Cardiac Arrest (VF)', category: 'Medical', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(50, 80), patientProfileTemplate: "A {age}-year-old {sex} collapsed.", presentingComplaint: 'Cardiac Arrest.', scenarioDetails: ['Unresponsive, apnoeic.', 'CPR in progress.', 'No output.'], vitalsMod: { hr: 0, bpSys: 0, bpDia: 0, spO2: 0, rr: 0, gcs: 3 }, deterioration: { active: false, rate: 0 }, stabilisers: ['CPR', 'Defib', 'Adrenaline', 'Amiodarone'], fluidResponse: 'neutral', ecg: { type: "VF", findings: "Ventricular Fibrillation." }, learningLinks: [{ label: "Resus Council UK: ALS", url: "https://www.resus.org.uk/" }] },
      { id: 'AT006', title: 'Tension Pneumothorax', category: 'Trauma', ageRange: 'Adult', acuity: 'Resus', ageGenerator: () => getRandomInt(20, 50), patientProfileTemplate: "A {age}-year-old male. Stabbed in chest.", presentingComplaint: 'Respiratory Distress.', scenarioDetails: ['Tracheal deviation.', 'Absent breath sounds.', 'Shock.'], vitalsMod: { hr: 140, bpSys: 70, bpDia: 40, spO2: 80, rr: 35, gcs: 12 }, deterioration: { active: true, rate: 0.2, type: 'arrest' }, stabilisers: ['Needle', 'Oxygen'], chestXray: { findings: "Large pneumothorax." }, learningLinks: [{ label: "ATLS Guidelines", url: "https://www.facs.org/" }] },
      { id: 'PA001', title: 'Paediatric Sepsis', category: 'Medical', ageRange: 'Paediatric', acuity: 'Resus', ageGenerator: () => getRandomInt(1, 10), patientProfileTemplate: "A {age}-year-old child. Lethargic, high fever.", presentingComplaint: 'Fever & Lethargy.', scenarioDetails: ['Mottled skin.', 'Cap refill 4s.', 'Tachycardic.'], vitalsMod: { hr: 160, bpSys: 80, bpDia: 40, spO2: 92, rr: 40, temp: 39.5, gcs: 12 }, deterioration: { active: true, rate: 0.1, type: 'shock' }, stabilisers: ['Fluids', 'Antibiotics', 'Oxygen'], learningLinks: [{ label: "NICE NG51: Sepsis", url: "https://www.nice.org.uk/guidance/ng51" }] },
      { id: 'AM040', title: 'Renal Colic', category: 'Medical', ageRange: 'Adult', acuity: 'Majors', ageGenerator: () => getRandomInt(30, 60), patientProfileTemplate: "A {age}-year-old. Loin to groin pain, writhing.", presentingComplaint: 'Severe flank pain.', scenarioDetails: ['Unable to sit still.', 'Haematuria.', 'Vomiting.'], instructorBrief: { progression: "Patient is writhing in agony.", interventions: ["Analgesia"], equipment: "Urine pot, Analgesia", debriefPoints: ["Analgesic ladder"] }, vitalsMod: { hr: 110, bpSys: 140, bpDia: 85, spO2: 98, rr: 22, temp: 37.2 }, deterioration: { active: false, rate: 0 }, stabilisers: ['Analgesia', 'Fluids'], learningLinks: [{ label: "NICE NG118: Renal Stones", url: "https://www.nice.org.uk/" }] }
    ];

    // --- 2. COMPONENTS ---

    const { useState, useEffect, useRef, useReducer } = React;
    
    // OPTIMIZED: Wrapped in React.memo to prevent Lucide scanning on every tick
    const Lucide = React.memo(({ icon, className }) => {
        useEffect(() => {
            if (window.lucide) window.lucide.createIcons();
        }, [icon]); // Only re-run if the icon name changes
        return <i data-lucide={icon} className={className}></i>;
    });

    const Button = ({ onClick, children, variant = 'primary', className = '', disabled = false }) => {
        let variants = {
            primary: "bg-sky-600 hover:bg-sky-500 text-white",
            secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
            danger: "bg-red-600 hover:bg-red-500 text-white",
            success: "bg-emerald-600 hover:bg-emerald-500 text-white",
            warning: "bg-amber-500 hover:bg-amber-600 text-white",
            amber: "bg-amber-600 hover:bg-amber-700 text-white border border-amber-500", 
            outline: "border border-slate-600 text-slate-300 hover:bg-slate-800"
        };
        let base = "px-4 py-3 rounded font-semibold transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm relative overflow-hidden touch-manipulation";
        if (className.includes("h-16")) { base += " text-xl px-8"; } 
        else if (className.includes("h-14")) { base += " text-lg px-4"; } 
        else { base += " text-xs"; }

        return <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>{children}</button>;
    };

    const Card = ({ title, icon, children, className = "", collapsible = false, defaultOpen = true }) => {
        const [isOpen, setIsOpen] = useState(defaultOpen);
        
        return (
            <div className={`bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-lg ${className}`}>
                {title && (
                    <div 
                        className={`bg-slate-800/50 p-3 border-b border-slate-700 flex items-center justify-between ${collapsible ? 'cursor-pointer hover:bg-slate-700/50 transition-colors' : ''}`}
                        onClick={() => collapsible && setIsOpen(!isOpen)}
                    >
                        <div className="flex items-center gap-2">
                            {icon && <Lucide icon={icon} className="w-5 h-5 text-sky-400" />}
                            <h3 className="font-bold text-slate-200">{title}</h3>
                        </div>
                        {collapsible && (
                            <Lucide icon="chevron-down" className={`w-4 h-4 text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                        )}
                    </div>
                )}
                {(!collapsible || isOpen) && (
                    <div className="p-4 animate-fadeIn">{children}</div>
                )}
            </div>
        );
    };
    
    const VitalDisplay = ({ label, value, prev, unit, lowIsBad = true, onUpdate }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editVal, setEditVal] = useState(value);
        const getTrendColor = (curr, prev, lowIsBad = true) => {
            if (curr === prev) return 'text-slate-500';
            if (lowIsBad) return curr > prev ? 'text-emerald-400' : 'text-red-400';
            return curr > prev ? 'text-red-400' : 'text-emerald-400';
        };
        useEffect(() => { if (!isEditing) setEditVal(value); }, [value, isEditing]);
        const handleBlur = () => { setIsEditing(false); if (editVal !== value) onUpdate(parseInt(editVal)); };

        return (
            <div className="bg-slate-900/50 p-3 rounded border border-slate-700 flex flex-col items-center justify-center h-28 relative touch-manipulation">
                <span className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">{label}</span>
                {isEditing ? (
                    <input type="number" value={editVal} onChange={(e) => setEditVal(e.target.value)} onBlur={handleBlur} onKeyDown={(e) => e.key === 'Enter' && handleBlur()} className="text-2xl font-mono font-bold text-white bg-slate-800 border border-slate-500 rounded w-20 text-center" autoFocus />
                ) : (
                    <div className="flex items-baseline gap-1 cursor-pointer hover:bg-slate-800/50 rounded px-2 py-2" onClick={() => { setEditVal(value); setIsEditing(true); }}>
                        <span className="text-3xl font-mono font-bold text-white">{Math.round(value)}</span>
                        <span className={`text-sm font-bold ${getTrendColor(value, prev, lowIsBad)}`}>{value > prev ? '▲' : value < prev ? '▼' : '▬'}</span>
                    </div>
                )}
                <span className="text-[10px] text-slate-600 mt-1">{unit}</span>
            </div>
        );
    };

    // --- UPDATED SVG ECG COMPONENT WITH DYNAMIC SPEED ---
    const ECGStrip = ({ type, hr }) => {
        let path = ""; const h = 60, w = 300;
        if (type.includes("Anterior STEMI")) { path = "M0,30 L20,30 L25,28 L30,30 L35,30 L40,28 L42,5 L45,35 L48,20 L65,15 L80,30 L100,30 L120,30 L125,28 L130,30 L135,30 L140,28 L142,5 L145,35 L148,20 L165,15 L180,30 L200,30"; } 
        else if (type.includes("VF")) { path = "M0,30 Q10,5 20,30 T40,30 T60,45 T80,15 T100,35 T120,20 T140,40 T160,25 T180,35 T200,20 T220,40 T240,10 T260,30 T280,50 T300,30"; } 
        else if (type.includes("SVT")) { path = "M0,30 L5,30 L8,5 L11,35 L14,30 L18,30 L20,30 L23,5 L26,35 L29,30 L33,30 L35,30 L38,5 L41,35 L44,30 L48,30 L50,30 L53,5 L56,35 L59,30 L63,30 L65,30 L68,5 L71,35 L74,30 L78,30 L80,30 L83,5 L86,35 L89,30 L93,30"; } 
        else if (type.includes("Hyperkalemia")) { path = "M0,30 L10,30 L20,10 L30,50 L40,30 L50,10 L60,30 L70,30 L80,30 L90,10 L100,50 L110,30 L120,10 L130,30"; } 
        else if (type.includes("CHB")) { path = "M0,30 L10,25 L15,30 L30,30 L35,25 L40,30 L45,10 L48,40 L50,30 L60,20 L70,30 L80,30 L90,25 L95,30"; } 
        else if (type.includes("AF")) { path = "M0,30 L5,29 L10,31 L15,29 L20,30 L23,5 L26,35 L29,30 L35,29 L40,31 L45,30 L60,30 L63,5 L66,35 L69,30"; } 
        else { path = "M0,30 L10,30 L15,25 L20,30 L25,30 L28,32 L30,5 L32,35 L35,30 L45,20 L55,30 L80,30 L90,30 L95,25 L100,30 L105,30 L108,32 L110,5 L112,35 L115,30 L125,20 L135,30 L160,30"; }
        
        // Dynamic speed calculation
        const safeHr = Math.max(20, Math.min(250, hr || 60));
        const duration = (60 / safeHr) * 4; 

        return (<div className="w-full overflow-hidden bg-black border border-slate-700 rounded h-20 relative flex items-center"><svg width="100%" height="100%" viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none"><path d={path} fill="none" stroke="#00ff00" strokeWidth="2" className="ecg-line" style={{ animationDuration: `${duration}s` }} /></svg><div className="absolute top-1 left-2 text-[10px] text-green-500 font-mono">LEAD II</div></div>);
    };

    const InvestigationButton = ({ type, icon, label, isRevealed, isLoading, revealInvestigation, isRunning, scenario, currentVitals }) => {
        const hasData = (type === 'ECG' && scenario.ecg) || (type === 'CXR' && scenario.chestXray) || (type === 'POCUS' && scenario.ultrasound) || (type === 'VBG' && scenario.vbg) || (type === 'CT' && scenario.ct);
        return (
            <div className="flex flex-col gap-2">
                <Button variant={isRevealed ? "secondary" : "outline"} onClick={() => revealInvestigation(type)} disabled={!isRunning || isRevealed || isLoading} className="h-10 text-xs relative overflow-hidden">
                    {isLoading && <div className="loading-bar"></div>}
                    <div className="relative z-10 flex items-center gap-2"><Lucide icon={icon} className="w-3 h-3"/> {isLoading ? `Requesting...` : (isRevealed ? `View ${type}` : `Request ${type}`)}</div>
                </Button>
                {isRevealed && (
                    <div className="p-3 bg-slate-700/30 rounded text-xs border-l-2 border-sky-500 animate-fadeIn">
                        {hasData ? (
                            type === 'VBG' ? `pH ${scenario.vbg.pH.toFixed(2)} | pCO2 ${scenario.vbg.pCO2} | Lac ${scenario.vbg.Lac} | K ${scenario.vbg.K}` : 
                            type === 'ECG' ? <div><p className="mb-1">{scenario.ecg.findings}</p><ECGStrip type={scenario.ecg.type} hr={currentVitals?.hr || 80}/></div> : 
                            type === 'CXR' ? scenario.chestXray.findings : 
                            type === 'POCUS' ? scenario.ultrasound.findings : 
                            type === 'CT' ? scenario.ct.findings : 'Normal / Not Indicated'
                        ) : 'Normal / Not Indicated'}
                    </div>
                )}
            </div>
        );
    };

    // --- 3. REDUCER & SIMULATION ENGINE ---
    
    const initialState = {
        scenario: null,
        time: 0,
        isRunning: false,
        vitals: {},
        prevVitals: {},
        log: [],
        flash: null,
        history: [],
        investigationsRevealed: {},
        loadingInvestigations: {},
        activeInterventions: new Set(), // Sets don't serialize well, we handle this in hydration
        interventionCounts: {},
        tempActive: {},
        processedEvents: new Set(),
        isMuted: false,
    };

    const simReducer = (state, action) => {
        switch (action.type) {
            case 'START_SIM':
                return { ...state, isRunning: true, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: '00:00', msg: "Simulation Started", type: 'system' }] };
            case 'PAUSE_SIM':
                return { ...state, isRunning: false, log: [...state.log, { time: new Date().toLocaleTimeString(), simTime: `${Math.floor(state.time/60)}:${(state.time%60).toString().padStart(2,'0')}`, msg: "Simulation Paused", type: 'system' }] };
            case 'LOAD_SCENARIO':
                return { ...initialState, scenario: action.payload, vitals: {...action.payload.vitals}, prevVitals: {...action.payload.vitals}, processedEvents: new Set(), activeInterventions: new Set() };
            case 'RESTORE_SESSION':
                // Rehydrate Sets and complex objects from storage
                const restored = action.payload;
                return {
                    ...restored,
                    activeInterventions: new Set(restored.activeInterventions || []),
                    processedEvents: new Set(restored.processedEvents || []),
                    isRunning: false // Always pause on restore
                };
            case 'TICK_TIME':
                return { ...state, time: state.time + 1 };
            case 'UPDATE_VITALS': 
                const newHist = [...state.history, { time: state.time, hr: action.payload.hr, bp: action.payload.bpSys, spo2: action.payload.spO2, rr: action.payload.rr, actions: [] }];
                return { ...state, vitals: action.payload, history: newHist };
            case 'ADD_LOG':
                const timestamp = new Date().toLocaleTimeString('en-GB');
                const simTime = `${Math.floor(state.time/60).toString().padStart(2,'0')}:${(state.time%60).toString().padStart(2,'0')}`;
                const entry = { time: timestamp, simTime, msg: action.payload.msg, type: action.payload.type, timeSeconds: state.time };
                
                // Add action marker to history
                let updatedHistory = [...state.history];
                if (action.payload.type === 'action' || action.payload.type === 'success') {
                    if (updatedHistory.length > 0) {
                        const lastIdx = updatedHistory.length - 1;
                        updatedHistory[lastIdx] = { ...updatedHistory[lastIdx], actions: [...(updatedHistory[lastIdx].actions || []), action.payload.msg.split(' ')[0]] };
                    }
                }
                return { ...state, log: [...state.log, entry], history: updatedHistory };
            case 'SET_FLASH':
                return { ...state, flash: action.payload };
            case 'UPDATE_INTERVENTION_STATE':
                return { 
                    ...state, 
                    activeInterventions: action.payload.active ? action.payload.active : state.activeInterventions,
                    interventionCounts: action.payload.counts ? action.payload.counts : state.interventionCounts,
                    tempActive: action.payload.temp ? action.payload.temp : state.tempActive
                };
            case 'REVEAL_INVESTIGATION':
                return { ...state, investigationsRevealed: { ...state.investigationsRevealed, [action.payload]: true }, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: false } };
            case 'SET_LOADING_INVESTIGATION':
                return { ...state, loadingInvestigations: { ...state.loadingInvestigations, [action.payload]: true } };
            case 'SET_MUTED':
                return { ...state, isMuted: action.payload };
            case 'MANUAL_VITAL_UPDATE':
                return { ...state, vitals: { ...state.vitals, [action.payload.key]: action.payload.value }, prevVitals: { ...state.vitals } };
            case 'UPDATE_SCENARIO':
                return { ...state, scenario: action.payload };
            case 'MARK_EVENT_PROCESSED':
                const newEvents = new Set(state.processedEvents);
                newEvents.add(action.payload);
                return { ...state, processedEvents: newEvents };
            default:
                return state;
        }
    };

    const useSimulation = (initialScenario) => {
        const [state, dispatch] = useReducer(simReducer, initialState);
        const timerRef = useRef(null);
        const tickRef = useRef(null);
        const audioCtxRef = useRef(null);
        
        // --- SESSION PERSISTENCE ---
        // 1. Save state to localStorage every time relevant data changes
        useEffect(() => {
            if (state.scenario && state.log.length > 0) {
                const serializableState = {
                    ...state,
                    activeInterventions: Array.from(state.activeInterventions),
                    processedEvents: Array.from(state.processedEvents)
                };
                localStorage.setItem('wmebem_sim_state', JSON.stringify(serializableState));
            }
        }, [state.vitals, state.log, state.time, state.scenario]);

        // 2. Initial Load logic moved to App component to decide whether to resume

        useEffect(() => { if (!audioCtxRef.current) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtxRef.current = new AudioContext(); } }, []);

        // --- AUDIO ENGINE ---
        useEffect(() => {
            let timerId;
            if (state.isRunning && state.vitals.hr > 0) {
                const ctx = audioCtxRef.current;
                if (ctx.state === 'suspended') ctx.resume();
                const playBeep = () => {
                    if (state.isMuted) { timerId = setTimeout(playBeep, 60000 / (state.vitals.hr || 60)); return; }
                    const osc = ctx.createOscillator(); const gain = ctx.createGain();
                    osc.type = 'sine';
                    const freq = state.vitals.spO2 >= 95 ? 880 : state.vitals.spO2 >= 85 ? 600 : 400;
                    osc.frequency.value = freq;
                    osc.connect(gain); gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now + 0.01); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15); 
                    osc.start(now); osc.stop(now + 0.2);
                    timerId = setTimeout(playBeep, 60000 / (state.vitals.hr || 60));
                };
                playBeep();
            }
            return () => clearTimeout(timerId);
        }, [state.isRunning, state.isMuted, state.vitals.hr, state.vitals.spO2]);

        const addLogEntry = (msg, type = 'info') => dispatch({ type: 'ADD_LOG', payload: { msg, type } });

        const applyIntervention = (key, customDef = null) => {
            const action = customDef || INTERVENTIONS[key];
            if (!action) return;
            
            const newVitals = { ...state.vitals };
            let newActive = new Set(state.activeInterventions);
            let newCounts = { ...state.interventionCounts };
            let newTemp = { ...state.tempActive };

            if (action.type === 'continuous') {
                if (newActive.has(key)) { 
                    newActive.delete(key); 
                    addLogEntry(`${key} stopped/removed.`, 'action'); 
                } else { 
                    newActive.add(key); 
                    addLogEntry(action.log, 'action'); 
                }
            } else {
                newCounts[key] = (newCounts[key] || 0) + 1;
                newTemp[key] = true;
                setTimeout(() => { 
                    dispatch({ type: 'UPDATE_INTERVENTION_STATE', payload: { temp: { ...newTemp, [key]: false } } });
                }, 120000);
                addLogEntry(action.log, 'action');
            }

            dispatch({ type: 'UPDATE_INTERVENTION_STATE', payload: { active: newActive, counts: newCounts, temp: newTemp } });

            // --- PHYSIOLOGY LOGIC ---
            // (Simplified from original for brevity, keeping core logic)
            if (key === 'Magnesium' && (state.scenario.id === 'OB001')) {
                newVitals.bpSys -= 15; newVitals.bpDia -= 10; addLogEntry("Magnesium effective.", 'success'); dispatch({ type: 'SET_FLASH', payload: 'green' });
            } else if (key === 'Fluids' && state.scenario.fluidResponse === 'positive') {
                 newVitals.bpSys += 10; newVitals.hr -= 5; addLogEntry("Fluid response positive.", 'success');
            } else {
                if (action.effect) {
                    if (action.effect.SpO2) newVitals.spO2 = Math.min(100, newVitals.spO2 + action.effect.SpO2);
                    if (action.effect.BP) newVitals.bpSys += action.effect.BP;
                    if (action.effect.BP) newVitals.bpDia += Math.floor(action.effect.BP * 0.65); 
                    if (action.effect.HR) newVitals.hr += action.effect.HR;
                    if (action.effect.RR) newVitals.rr += action.effect.RR;
                    if (action.effect.gcs) newVitals.gcs = Math.max(3, Math.min(15, newVitals.gcs + action.effect.gcs));
                    if (action.effect.bpSys) newVitals.bpSys += action.effect.bpSys; 
                }
                if (state.scenario.stabilisers && state.scenario.stabilisers.includes(key)) {
                    dispatch({ type: 'UPDATE_SCENARIO', payload: { ...state.scenario, deterioration: { ...state.scenario.deterioration, rate: Math.max(0, state.scenario.deterioration.rate - 0.05) } } });
                    if (action.type !== 'continuous') addLogEntry(`${key} effective.`, 'success');
                    dispatch({ type: 'SET_FLASH', payload: 'green' });
                }
            }
            dispatch({ type: 'UPDATE_VITALS', payload: newVitals });
            setTimeout(() => dispatch({ type: 'SET_FLASH', payload: null }), 1000);
        };

        const manualUpdateVital = (key, value) => { dispatch({ type: 'MANUAL_VITAL_UPDATE', payload: { key, value } }); addLogEntry(`Manual override: ${key} set to ${value}`, 'manual'); };
        const toggleDeterioration = () => { 
            const newState = !state.scenario.deterioration.active; 
            addLogEntry(`Deterioration ${newState ? 'Resumed' : 'Paused'}`, 'manual'); 
            dispatch({ type: 'UPDATE_SCENARIO', payload: { ...state.scenario, deterioration: { ...state.scenario.deterioration, active: newState } } }); 
        };
        const triggerArrest = () => { dispatch({ type: 'UPDATE_VITALS', payload: { ...state.vitals, hr: 0, bpSys: 0, bpDia: 0, spO2: 0, rr: 0, gcs: 3 } }); addLogEntry('CARDIAC ARREST', 'manual'); dispatch({ type: 'SET_FLASH', payload: 'red' }); };
        const triggerROSC = () => { dispatch({ type: 'UPDATE_VITALS', payload: { ...state.vitals, hr: 80, bpSys: 110, bpDia: 70, spO2: 94, rr: 16, gcs: 3 } }); addLogEntry('ROSC', 'success'); dispatch({ type: 'SET_FLASH', payload: 'green' }); };

        const revealInvestigation = (type) => {
             if (state.investigationsRevealed[type] || state.loadingInvestigations[type]) return;
             dispatch({ type: 'SET_LOADING_INVESTIGATION', payload: type });
             setTimeout(() => {
                 dispatch({ type: 'REVEAL_INVESTIGATION', payload: type });
                 addLogEntry(`${type} Result Available`, 'success');
             }, 2000);
        };

        const tick = () => {
            let next = { ...state.vitals };
            if (next.hr === 0 && next.bpSys === 0) return; 
            
            // Random fluctuation
            next.hr += getRandomInt(-1, 1); next.bpSys += getRandomInt(-2, 2); next.bpDia += getRandomInt(-2, 2); next.spO2 += Math.random() > 0.9 ? getRandomInt(-1, 1) : 0;
            
            // Deterioration logic
            if (state.scenario?.deterioration?.active && state.scenario.deterioration.rate > 0) {
                const rate = state.scenario.deterioration.rate;
                if (Math.random() < rate) {
                    if (state.scenario.deterioration.type === 'shock') { next.bpSys -= 1; next.bpDia -= 1; next.hr += 1; }
                    else if (state.scenario.deterioration.type === 'respiratory') { next.spO2 -= 1; next.rr += (Math.random() > 0.8 ? 1 : 0); }
                    else if (state.scenario.deterioration.type === 'cardiac') { next.bpSys -= 1; next.bpDia -= 1; }
                    else if (state.scenario.deterioration.type === 'neuro') { next.hr -= 1; next.bpSys += 1; }
                }
            }
            next.spO2 = Math.min(100, Math.max(0, next.spO2)); next.hr = Math.max(0, next.hr);
            
            dispatch({ type: 'UPDATE_VITALS', payload: next });

            // Event Triggering
            if (state.scenario?.events) {
                state.scenario.events.forEach(event => {
                    if (state.time === event.time && !state.processedEvents.has(event.msg)) {
                        addLogEntry(`UPDATE: ${event.msg}`, 'manual');
                        dispatch({ type: 'MARK_EVENT_PROCESSED', payload: event.msg });
                        let evtVitals = { ...next };
                        if (event.effect) { if (event.effect.hr) evtVitals.hr += event.effect.hr; if (event.effect.bpSys) evtVitals.bpSys += event.effect.bpSys; } 
                        dispatch({ type: 'UPDATE_VITALS', payload: evtVitals });
                        dispatch({ type: 'SET_FLASH', payload: 'red' });
                    }
                });
            }
        };
        
        // Critical Limit Alarms
        useEffect(() => { 
            if (state.vitals.spO2 < 85 || state.vitals.bpSys < 80 || state.vitals.hr > 160 || (state.vitals.hr < 40 && state.vitals.hr > 0)) { 
                if (state.time % 5 === 0 && state.isRunning) dispatch({ type: 'SET_FLASH', payload: 'red' }); else dispatch({ type: 'SET_FLASH', payload: null }); 
            } 
        }, [state.vitals, state.time, state.isRunning]);

        const start = () => { if (state.isRunning) return; dispatch({ type: 'START_SIM' }); timerRef.current = setInterval(() => dispatch({ type: 'TICK_TIME' }), 1000); tickRef.current = setInterval(tick, 3000); if (audioCtxRef.current && audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume(); };
        const pause = () => { dispatch({ type: 'PAUSE_SIM' }); clearInterval(timerRef.current); clearInterval(tickRef.current); };
        const stop = () => { pause(); addLogEntry("Simulation Ended", 'system'); localStorage.removeItem('wmebem_sim_state'); };

        return { state, dispatch, start, pause, stop, applyIntervention, addLogEntry, manualUpdateVital, toggleDeterioration, triggerArrest, triggerROSC, revealInvestigation };
    };

    // --- UI SCREENS ---

    const SetupScreen = ({ onGenerate, initialParams, savedState, onResume }) => {
        const [category, setCategory] = useState(initialParams?.category || 'Any');
        const [age, setAge] = useState(initialParams?.age || 'Any');
        const [hf, setHf] = useState(initialParams?.hf || 'hf0');
        const [acuity, setAcuity] = useState('Any'); 
        const [loading, setLoading] = useState(false);
        const [customMode, setCustomMode] = useState(initialParams?.customMode || false);
        const [error, setError] = useState("");
        const [customCategory, setCustomCategory] = useState('Medical');
        
        // Custom Scenario & Persistence Logic
        const [customScenario, setCustomScenario] = useState({ title: "Custom Scenario", age: 40, sex: "male", complaint: "Shortness of breath", profile: "A 40-year-old male with no past medical history.", hr: 80, bpSys: 120, rr: 16, spO2: 98, temp: 37.0, gcs: 15, bm: 5.5, ecgType: "Sinus Rhythm", ecgFindings: "Normal", cxrFindings: "Clear", vbgState: "normal" });
        const [savedTemplates, setSavedTemplates] = useState([]);
        const [selectedTemplateId, setSelectedTemplateId] = useState('');

        useEffect(() => {
            const saved = localStorage.getItem('wmebem_custom_templates');
            if (saved) setSavedTemplates(JSON.parse(saved));
        }, []);

        const saveTemplate = () => {
            const newTemplate = { id: `CUS_${Date.now()}`, ...customScenario, isCustom: true };
            const updatedList = [...savedTemplates, newTemplate];
            setSavedTemplates(updatedList);
            localStorage.setItem('wmebem_custom_templates', JSON.stringify(updatedList));
            alert("Scenario saved as template!");
        };

        const loadTemplate = (id) => {
            // Check built-in first
            let template = ALL_SCENARIOS.find(s => s.id === id);
            // Check custom
            if (!template) template = savedTemplates.find(s => s.id === id);
            
            if (template) {
                if(template.isCustom) {
                    setCustomScenario(template);
                } else {
                    const age = template.ageGenerator();
                    const vitals = template.vitalsMod || getBaseVitals(age);
                    const profile = template.patientProfileTemplate.replace(/{age}/g, age).replace(/{sex}/g, 'male');
                    setCustomScenario({ ...customScenario, title: template.title, age: age, complaint: template.presentingComplaint, profile: profile, hr: vitals.hr, bpSys: vitals.bpSys, rr: vitals.rr, spO2: vitals.spO2, temp: vitals.temp || 37.0, gcs: vitals.gcs || 15, bm: vitals.bm || 5.5, ecgType: template.ecg ? template.ecg.type : "Normal", ecgFindings: template.ecg ? template.ecg.findings : "Normal", cxrFindings: template.chestXray ? template.chestXray.findings : "Clear", vbgState: template.vbgClinicalState || "normal" });
                }
            }
        };

        const handleGenerate = () => {
            setError(""); setLoading(true);
            setTimeout(() => {
                let generatedScenario;
                const currentParams = { category, age, hf, customMode, acuity }; 
                if (customMode) {
                    generatedScenario = { id: 'CUSTOM', title: customScenario.title, category: 'Custom', ageRange: 'Custom', patientAge: customScenario.age, profile: customScenario.profile, presentingComplaint: customScenario.complaint, scenarioDetails: ['Custom scenario generated by user.'], instructorBrief: { progression: "Custom scenario.", interventions: [], equipment: "Standard", debriefPoints: [] }, vitals: { hr: parseInt(customScenario.hr), bpSys: parseInt(customScenario.bpSys), bpDia: Math.floor(parseInt(customScenario.bpSys) * 0.65), rr: parseInt(customScenario.rr), spO2: parseInt(customScenario.spO2), temp: parseFloat(customScenario.temp), gcs: parseInt(customScenario.gcs), bm: parseFloat(customScenario.bm) }, vbg: generateVbg(customScenario.vbgState), hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf), ecg: { type: customScenario.ecgType, findings: customScenario.ecgFindings }, chestXray: { findings: customScenario.cxrFindings }, deterioration: { active: false, rate: 0 }, stabilisers: [], interventions: ['Oxygen', 'Fluids', 'Analgesia'] };
                } else {
                    let pool = ALL_SCENARIOS.filter(s => (category === 'Any' || s.category === category) && (age === 'Any' || s.ageRange === age) && (acuity === 'Any' || s.acuity === acuity));
                    if (pool.length === 0) { setLoading(false); setError(`No scenarios found for ${category} + ${age} + ${acuity}. Please try a different combination.`); return; }
                    const base = pool[Math.floor(Math.random() * pool.length)];
                    const patientAge = base.ageGenerator();
                    const ranges = getBaseVitals(patientAge);
                    let startVitals = { hr: base.vitalsMod?.hr !== undefined ? base.vitalsMod.hr : ranges.hr, bpSys: base.vitalsMod?.bpSys !== undefined ? base.vitalsMod.bpSys : ranges.bpSys, bpDia: base.vitalsMod?.bpDia !== undefined ? base.vitalsMod.bpDia : (ranges.bpDia || Math.floor((base.vitalsMod?.bpSys || ranges.bpSys) * 0.65)), rr: base.vitalsMod?.rr !== undefined ? base.vitalsMod.rr : ranges.rr, spO2: base.vitalsMod?.spO2 !== undefined ? base.vitalsMod.spO2 : 98, temp: base.vitalsMod?.temp !== undefined ? base.vitalsMod.temp : ranges.temp, gcs: base.vitalsMod?.gcs !== undefined ? base.vitalsMod.gcs : 15, bm: ranges.bm };
                    const profile = base.patientProfileTemplate.replace(/{age}/g, patientAge).replace(/{sex}/g, 'male').replace(/{durationPain}/g, '2');
                    generatedScenario = { ...base, patientAge, profile, vitals: startVitals, vbg: generateVbg(base.vbgClinicalState), hf: HUMAN_FACTOR_CHALLENGES.find(h => h.id === hf) };
                }
                if (generatedScenario.ageRange === 'Paediatric' || generatedScenario.patientAge < 18) { generatedScenario.weight = estimateWeight(generatedScenario.patientAge); }
                setLoading(false); onGenerate(generatedScenario, currentParams);
            }, 600);
        };

        useEffect(() => { if (initialParams && initialParams.autoGenerate) { handleGenerate(); } }, []);

        return (
            <div className="max-w-2xl mx-auto space-y-6 p-2">
                {savedState && (
                    <div className="bg-emerald-900/30 border border-emerald-500 p-4 rounded-lg flex items-center justify-between">
                        <div><h3 className="font-bold text-emerald-400">Previous Session Found</h3><p className="text-sm text-slate-300">Resume {savedState.scenario.title} ({savedState.log.length} actions)?</p></div>
                        <Button onClick={onResume} variant="success">Resume</Button>
                    </div>
                )}
                
                <div className="bg-slate-800 p-4 md:p-6 rounded-lg border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-sky-400 mb-4 flex items-center gap-2"><Lucide icon="settings" className="w-5 h-5"/> Simulation Parameters</h2>
                    <div className="flex gap-4 mb-6 border-b border-slate-700 pb-2 overflow-x-auto">
                        <button onClick={() => setCustomMode(false)} className={`text-sm font-bold uppercase pb-1 whitespace-nowrap ${!customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Random Scenario</button>
                        <button onClick={() => setCustomMode(true)} className={`text-sm font-bold uppercase pb-1 whitespace-nowrap ${customMode ? 'text-sky-400 border-b-2 border-sky-400' : 'text-slate-500'}`}>Custom Scenario</button>
                    </div>
                    {!customMode ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Category</label><select value={category} onChange={e=>setCategory(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Medical">Medical</option><option value="Trauma">Trauma</option><option value="Obstetrics & Gynae">Obstetrics & Gynae</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Age</label><select value={age} onChange={e=>setAge(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Adult">Adult (18-65)</option><option value="Paediatric">Paediatric (&lt;18)</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Acuity</label><select value={acuity} onChange={e=>setAcuity(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm"><option value="Any">Any</option><option value="Majors">Majors</option><option value="Resus">Resus</option></select></div>
                            <div><label className="text-xs uppercase text-slate-500 font-bold">Human Factor</label><select value={hf} onChange={e=>setHf(e.target.value)} className="w-full bg-slate-700 border-slate-600 rounded p-3 text-sm">{HUMAN_FACTOR_CHALLENGES.map(h => <option key={h.id} value={h.id}>{h.type}</option>)}</select></div>
                        </div>
                    ) : (
                        <div className="space-y-4 mb-6">
                             <div className="bg-slate-700/30 p-4 rounded border border-slate-600 mb-4">
                                <h3 className="text-sm font-bold text-sky-400 mb-3 uppercase">Load Template</h3>
                                <select value={selectedTemplateId} onChange={e => loadTemplate(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm">
                                    <option value="">-- Select --</option>
                                    <optgroup label="Saved">
                                        {savedTemplates.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                                    </optgroup>
                                    <optgroup label="Presets">
                                        {ALL_SCENARIOS.map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                                    </optgroup>
                                </select>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="text-xs text-slate-500 font-bold">Title</label><input type="text" value={customScenario.title} onChange={e => setCustomScenario({...customScenario, title: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm"/></div><div><label className="text-xs text-slate-500 font-bold">Age</label><input type="number" value={customScenario.age} onChange={e => setCustomScenario({...customScenario, age: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm"/></div></div>
                            <Button onClick={saveTemplate} variant="outline" className="w-full text-xs">Save as Template</Button>
                        </div>
                    )}
                    {error && <div className="mb-4 p-3 bg-red-900/30 border border-red-500 rounded text-red-200 text-sm font-bold flex items-center gap-2"><Lucide icon="alert-circle" className="w-4 h-4"/>{error}</div>}
                    <Button onClick={handleGenerate} disabled={loading} className="w-full py-4 text-lg">{loading ? <Lucide icon="loader-2" className="animate-spin"/> : <Lucide icon="play"/>}{loading ? "Building Scenario..." : "Generate Scenario"}</Button>
                </div>
            </div>
        );
    };

    const BriefingScreen = ({ scenario, onStart, onBack, onNewScenario }) => (
        <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-2">
            <div className="bg-slate-800 p-4 md:p-6 rounded-lg border-l-4 border-sky-500 shadow-lg">
                <div className="flex flex-col md:flex-row justify-between items-start gap-4">
                    <div><h2 className="text-2xl md:text-3xl font-bold text-white">{scenario.title}</h2><span className="inline-block bg-slate-700 text-sky-300 text-xs px-2 py-1 rounded mt-2">{scenario.category}</span> <span className="inline-block bg-slate-700 text-amber-400 text-xs px-2 py-1 rounded mt-2 ml-2">{scenario.acuity}</span></div>
                    <div className="text-left md:text-right"><p className="text-2xl font-mono font-bold text-emerald-400">GCS {scenario.vitals.gcs}</p><p className="text-sm text-slate-400">Initial Status</p></div>
                </div>
                <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><h3 className="text-sm font-bold text-slate-500 uppercase mb-1">Patient Profile</h3><p className="text-lg leading-relaxed">{scenario.profile}</p>{scenario.weight && <div className="mt-2 p-2 bg-sky-900/30 border border-sky-700/50 rounded inline-block"><p className="text-xs text-sky-400 font-bold uppercase">Est. Weight (APLS)</p><p className="text-lg font-mono text-white">{scenario.weight} kg</p></div>}<div className="mt-4 p-3 bg-slate-700/50 rounded border border-slate-600"><p className="font-bold text-sky-300"><Lucide icon="alert-circle" className="inline w-4 h-4 mr-1"/> PC: {scenario.presentingComplaint}</p></div></div>
                    
                    <div className="space-y-4">
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-amber-400 uppercase mb-2"><Lucide icon="activity" className="inline w-4 h-4 mr-1"/> Progression</h4>
                            <p className="text-sm text-slate-300">{scenario.instructorBrief ? scenario.instructorBrief.progression : "Standard clinical progression."}</p>
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-600">
                            <h4 className="text-sm font-bold text-emerald-400 uppercase mb-2"><Lucide icon="check-circle" className="inline w-4 h-4 mr-1"/> Key Interventions</h4>
                            <ul className="text-sm text-slate-300 list-disc pl-4">
                                {scenario.instructorBrief?.interventions ? scenario.instructorBrief.interventions.map((x, i) => <li key={i}>{x}</li>) : <li>ABCDE Assessment</li>}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {scenario.hf.id !== 'hf0' && (<div className="bg-purple-900/20 border border-purple-500/50 p-4 rounded flex items-center gap-3"><Lucide icon="users" className="text-purple-400 w-6 h-6"/><div><h4 className="font-bold text-purple-200">{scenario.hf.type}</h4><p className="text-sm text-purple-300">{scenario.hf.description}</p></div></div>)}
            <div className="flex flex-col md:flex-row justify-center gap-4 pt-4"><Button onClick={onBack} variant="secondary" className="w-full md:w-1/3 py-4 text-lg"><Lucide icon="arrow-left"/> Back</Button><Button onClick={onNewScenario} variant="secondary" className="w-full md:w-1/3 py-4 text-lg"><Lucide icon="refresh-cw"/> New Scenario</Button><Button onClick={onStart} className="w-full md:w-1/3 py-4 text-lg shadow-sky-900/20 shadow-xl"><Lucide icon="activity"/> Start Live Simulation</Button></div>
        </div>
    );

    const LiveSimScreen = ({ sim, onFinish, onBack }) => {
        const { state, start, pause, applyIntervention, addLogEntry, manualUpdateVital, toggleDeterioration, triggerArrest, triggerROSC, revealInvestigation } = sim;
        const { scenario, time, isRunning, vitals, prevVitals, log, flash, activeInterventions, interventionCounts, tempActive, isMuted } = state;
        
        const logContainerRef = useRef(null);
        const [manualLog, setManualLog] = useState("");
        const [manualNotes, setManualNotes] = useState("");
        const [activeTab, setActiveTab] = useState("Common");
        const [paedsDoses, setPaedsDoses] = useState([]);

        useEffect(() => { 
            if (logContainerRef.current) logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight; 
            if (scenario.weight) setPaedsDoses(calculatePaedDoses(scenario.weight));
        }, [log, scenario]);
        
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        const getInterventionsByCat = (cat) => Object.keys(INTERVENTIONS).filter(key => INTERVENTIONS[key].category === cat);

        return (
            <div className={`max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 transition-colors duration-500 ${flash === 'red' ? 'flash-red' : (flash === 'green' ? 'flash-green' : '')}`}>
                <div className="lg:col-span-2 space-y-6 order-1">
                    <Card className="bg-slate-800 border-slate-700">
                        <div className="flex justify-between items-start flex-wrap gap-2">
                            <div><h3 className="font-bold text-lg text-white mb-1">{scenario.title} ({scenario.patientAge})</h3><p className="text-sm text-slate-300">{scenario.profile}</p>{scenario.weight && <p className="text-xs text-sky-400 mt-1 font-bold">Est. Weight: {scenario.weight}kg</p>}</div>
                            <div className="bg-sky-900/50 border border-sky-700 px-3 py-1 rounded"><p className="text-xs font-bold text-sky-300 uppercase">Presenting Complaint</p><p className="text-sm text-white">{scenario.presentingComplaint}</p></div>
                        </div>
                    </Card>

                    <Card className="bg-slate-900 border-slate-800">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 border-b border-slate-800 pb-2 gap-3">
                            <div className="flex gap-2 w-full md:w-auto">
                                <Button variant="secondary" onClick={onBack} disabled={isRunning} className="h-10 md:h-8 text-xs px-3 flex-1 md:flex-none"><Lucide icon="arrow-left" className="w-3 h-3"/> Back</Button>
                                {!isRunning ? <Button variant="success" onClick={start} className="h-16 text-xl px-8 font-bold shadow-lg flex-grow md:flex-none"><Lucide icon="play" className="w-6 h-6"/> START</Button> : <Button variant="danger" onClick={pause} className="h-14 text-lg px-4 flex-1 md:flex-none"><Lucide icon="pause" className="w-5 h-5"/> Pause</Button>}
                                <Button variant="primary" onClick={onFinish} className="h-14 text-lg px-4 flex-1 md:flex-none"><Lucide icon="square" className="w-5 h-5"/> Finish</Button>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => sim.dispatch({type: 'SET_MUTED', payload: !isMuted})} className={`p-2 rounded-full ${isMuted ? 'bg-red-900 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}><Lucide icon={isMuted ? "volume-x" : "volume-2"} className="w-5 h-5" /></button>
                                <div className={`w-3 h-3 rounded-full ${isRunning ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`}></div>
                                <div className="font-mono text-2xl font-bold text-emerald-400 bg-black/40 px-4 py-1 rounded">{formatTime(time)}</div>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <VitalDisplay label="Heart Rate" value={vitals.hr} prev={prevVitals.hr} unit="bpm" lowIsBad={false} onUpdate={(v) => manualUpdateVital('hr', v)}/>
                            <div className="bg-slate-900/50 p-3 rounded border border-slate-700 flex flex-col items-center justify-center h-28"><span className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">BP</span><span className="text-2xl font-mono font-bold text-white">{Math.round(vitals.bpSys)}/{Math.round(vitals.bpDia)}</span><span className="text-[10px] text-slate-600 mt-1">mmHg</span></div>
                            <VitalDisplay label="SpO2" value={vitals.spO2} prev={prevVitals.spO2} unit="%" onUpdate={(v) => manualUpdateVital('spO2', v)}/>
                            <VitalDisplay label="Resp Rate" value={vitals.rr} prev={prevVitals.rr} unit="/min" lowIsBad={false} onUpdate={(v) => manualUpdateVital('rr', v)}/>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-slate-900/30 p-2 rounded text-center border border-slate-700"><span className="text-xs text-slate-500 block">GCS</span><span className="font-mono font-bold text-lg">{vitals.gcs}</span></div>
                            <div className="bg-slate-900/30 p-2 rounded text-center border border-slate-700"><span className="text-xs text-slate-500 block">Temp</span><span className="font-mono font-bold text-lg">{vitals.temp}°C</span></div>
                            <div className="bg-slate-900/30 p-2 rounded text-center border border-slate-700"><span className="text-xs text-slate-500 block">Glucose</span><span className="font-mono font-bold text-lg">{vitals.bm}</span></div>
                        </div>
                    </Card>

                    <Card title="Clinical Actions" icon="activity" collapsible={true}>
                        <div className="flex justify-end gap-2 mb-4 border-b border-slate-700 pb-2">
                            <Button variant={scenario.deterioration.active ? "warning" : "success"} onClick={toggleDeterioration} className="text-xs h-10 border border-slate-600"><Lucide icon={scenario.deterioration.active ? "pause-circle" : "play-circle"} className="w-3 h-3"/> {scenario.deterioration.active ? "Pause Det." : "Resume Det."}</Button>
                            <Button variant="danger" onClick={triggerArrest} className="text-xs h-10"><Lucide icon="alert-triangle" className="w-3 h-3"/> Arrest</Button>
                            <Button variant="success" onClick={triggerROSC} className="text-xs h-10"><Lucide icon="heart-pulse" className="w-3 h-3"/> ROSC</Button>
                        </div>
                        
                        <div className="flex space-x-2 mb-4 overflow-x-auto pb-2 border-b border-slate-700 no-scrollbar">
                            {['Common', 'Airway', 'Circulation', 'Drugs', 'Procedures'].map(cat => (
                                <button key={cat} onClick={() => setActiveTab(cat)} className={`px-4 py-2 text-sm font-bold rounded transition-colors whitespace-nowrap ${activeTab === cat ? 'bg-sky-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{cat}</button>
                            ))}
                        </div>

                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4">
                            {getInterventionsByCat(activeTab).map(key => {
                                const isActive = activeInterventions.has(key);
                                const isTemp = tempActive[key];
                                return (
                                    <Button key={key} variant={(isActive || isTemp) ? "success" : "secondary"} onClick={() => applyIntervention(key)} disabled={!isRunning} className="text-xs h-12 touch-manipulation relative">
                                        {INTERVENTIONS[key]?.label || key}
                                        {interventionCounts[key] > 0 && INTERVENTIONS[key].type !== 'continuous' && <span className="absolute top-1 right-1 bg-white/20 text-white text-[10px] px-1 rounded-full">x{interventionCounts[key]}</span>}
                                    </Button>
                                )
                            })}
                        </div>
                    </Card>

                    <Card title="Investigations" icon="file-search" collapsible={true} defaultOpen={false}>
                         <div className="grid grid-cols-2 gap-3">
                             {['ECG', 'VBG', 'CXR', 'POCUS', 'CT'].map(t => (
                                 <InvestigationButton key={t} type={t} icon="activity" label={t} isRevealed={state.investigationsRevealed[t]} isLoading={state.loadingInvestigations[t]} revealInvestigation={revealInvestigation} isRunning={isRunning} scenario={scenario} currentVitals={vitals}/>
                             ))}
                         </div>
                    </Card>
                </div>

                <div className="space-y-6 flex flex-col h-full order-2 lg:order-2">
                    {/* PAEDIATRIC CALCULATOR */}
                    {scenario.weight && (
                        <Card title="Paediatric Drug Guide" icon="baby" className="bg-sky-900/20 border-sky-500" collapsible={true}>
                            <div className="grid grid-cols-1 gap-1">
                                {paedsDoses.map((d, i) => (
                                    <div key={i} className="flex justify-between items-center text-xs p-2 bg-slate-800/50 rounded border border-slate-700">
                                        <span className="font-bold text-slate-300">{d.label}</span>
                                        <span className="font-mono font-bold text-sky-400 bg-black/30 px-2 py-1 rounded">{d.dose}</span>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    )}

                    <Card title="Instructor Notes" icon="clipboard" collapsible={true} defaultOpen={false}><form onSubmit={(e) => { e.preventDefault(); if(manualNotes.trim()){ addLogEntry(`Note: ${manualNotes}`, 'note'); setManualNotes(""); } }} className="flex gap-2"><input type="text" value={manualNotes} onChange={(e) => setManualNotes(e.target.value)} placeholder="Add note..." className="flex-grow bg-slate-900 border border-slate-600 rounded px-3 py-3 text-sm focus:outline-none focus:border-purple-500" disabled={!isRunning} /><Button type="submit" variant="secondary" disabled={!isRunning || !manualNotes.trim()} className="h-12">Add</Button></form></Card>

                    <Card className="flex-grow flex flex-col bg-slate-800 h-96 lg:h-auto" collapsible={true}>
                        <div className="flex items-center gap-2 mb-3 border-b border-slate-700 pb-2"><Lucide icon="list" className="w-5 h-5 text-sky-400" /><h3 className="font-bold text-slate-200">Incident Log</h3></div>
                        <div ref={logContainerRef} className="flex-grow overflow-y-auto space-y-2 pr-2 text-sm font-mono touch-pan-y overscroll-contain" style={{WebkitOverflowScrolling: 'touch'}}>{log.map((l, i) => (<div key={i} className={`p-2 rounded border-l-2 ${l.type === 'success' ? 'bg-emerald-900/20 border-emerald-500' : l.type === 'action' ? 'bg-sky-900/20 border-sky-500' : l.type === 'manual' ? 'bg-purple-900/20 border-purple-500' : l.type === 'note' ? 'bg-yellow-900/20 border-yellow-500' : 'bg-slate-700/30 border-slate-500'}`}><span className="text-xs text-slate-500 block">{l.simTime}</span><p className="text-slate-200">{l.msg}</p></div>))}</div>
                    </Card>
                </div>
            </div>
        );
    };

    const DebriefScreen = ({ sim, onRestart }) => {
        const { state } = sim;
        const { log, scenario, history } = state; 
        const chartRef = useRef(null);

        useEffect(() => {
            if (!chartRef.current || !history.length) return;
            const labels = history.map(h => h.time); 
            const chart = new window.Chart(chartRef.current, {
                type: 'line',
                data: {
                    labels: labels.map(t => `${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`),
                    datasets: [ { label: 'HR', data: history.map(h => h.hr), borderColor: '#ef4444', tension: 0.4 }, { label: 'Sys BP', data: history.map(h => h.bp), borderColor: '#3b82f6', tension: 0.4 }, { label: 'SpO2', data: history.map(h => h.spo2), borderColor: '#10b981', tension: 0.4, yAxisID: 'y1' } ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { title: { display: true, text: 'Vital Signs Trend' } },
                    scales: { y: { position: 'left', min: 0 }, y1: { position: 'right', min: 0, max: 100, grid: {drawOnChartArea: false} } }
                }
            });
            return () => chart.destroy();
        }, [history]);

        const handleExport = () => {
            const doc = new window.jspdf.jsPDF();
            doc.setFontSize(18); doc.text(`Simulation Debrief: ${scenario.title}`, 10, 10);
            let y = 30;
            log.forEach(l => { if (y > 280) { doc.addPage(); y = 10; } doc.text(`[${l.simTime}] ${l.msg}`, 10, y); y += 7; });
            doc.save("sim-debrief.pdf");
        };

        return (
            <div className="max-w-4xl mx-auto space-y-6 animate-fadeIn p-2">
                <div className="flex flex-col md:flex-row justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700 gap-4">
                    <h2 className="text-2xl font-bold text-white">Simulation Debrief</h2>
                    <div className="flex gap-2 w-full md:w-auto">
                        <Button onClick={handleExport} variant="secondary" className="flex-1 md:flex-none h-12"><Lucide icon="download"/> Export PDF</Button>
                        <Button onClick={onRestart} variant="primary" className="flex-1 md:flex-none h-12"><Lucide icon="rotate-ccw"/> New Scenario</Button>
                    </div>
                </div>
                <Card title="Physiological Trends" icon="activity"><div className="bg-slate-900 p-4 rounded h-80 relative"><canvas ref={chartRef}></canvas></div></Card>
                <Card title="Action Timeline" icon="clock"><div className="space-y-2 max-h-96 overflow-y-auto">{log.map((l, i) => (<div key={i} className="flex gap-4 border-b border-slate-700 pb-2"><span className="font-mono text-sky-400 w-16 flex-shrink-0">{l.simTime}</span><span className="text-slate-300">{l.msg}</span></div>))}</div></Card>
            </div>
        );
    };

    const App = () => {
        const [view, setView] = useState('setup'); 
        const [currentScenario, setCurrentScenario] = useState(null);
        const [lastSetupParams, setLastSetupParams] = useState(null);
        const [resumeState, setResumeState] = useState(null);

        // --- FIX: One-time persistence check ---
        useEffect(() => { 
            const saved = localStorage.getItem('wmebem_sim_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.scenario && parsed.vitals) {
                        setResumeState(parsed);
                    }
                } catch(e) { console.error("Save state corrupt", e); }
            }
        }, []); 

        const regenerateScenario = () => { setView('setup_regen'); };
        
        const handleResume = () => {
            setCurrentScenario(resumeState.scenario);
            setView('resume'); // Trigger special resume view
        };

        return (
            <div className="min-h-screen flex flex-col p-2 md:p-6 max-w-7xl mx-auto">
                <header className="flex items-center justify-between mb-8 pb-4 border-b border-slate-800">
                    <div className="flex items-center gap-4"><img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" className="h-12 md:h-16 object-contain" /><div><h1 className="text-xl md:text-3xl font-bold text-sky-400">Sim Generator v10.0</h1><p className="text-slate-500 text-xs md:text-sm">West Midlands Evidence Based Emergency Medicine</p></div></div>
                    <div className="hidden md:block text-right"><p className="text-xs text-slate-600">In-situ Simulation Tool</p><p className="text-xs text-slate-600">UK Clinical Guidelines</p></div>
                </header>
                <main className="flex-grow">
                    {view === 'setup' && (<SetupScreen onGenerate={(s, params) => { setCurrentScenario(s); setLastSetupParams(params); setView('briefing'); }} savedState={resumeState} onResume={handleResume} />)}
                    {view === 'setup_regen' && (<SetupScreen initialParams={{ ...lastSetupParams, autoGenerate: true }} onGenerate={(s, params) => { setCurrentScenario(s); setLastSetupParams(params); setView('briefing'); }} />)}
                    {view === 'briefing' && currentScenario && (<BriefingScreen scenario={currentScenario} onStart={() => setView('live')} onBack={() => setView('setup')} onNewScenario={regenerateScenario} />)}
                    {(view === 'live' || view === 'debrief' || view === 'resume') && currentScenario && (<LiveSimContainer scenario={currentScenario} view={view} setView={setView} resumeData={view === 'resume' ? resumeState : null} onRestart={() => { setCurrentScenario(null); setView('setup'); setResumeState(null); localStorage.removeItem('wmebem_sim_state'); }} />)}
                </main>
                <footer className="mt-12 text-center text-slate-600 text-xs py-4 border-t border-slate-800"><p>© {new Date().getFullYear()} WMEBEM. All rights reserved.</p></footer>
            </div>
        );
    };

    const LiveSimContainer = ({ scenario, view, setView, resumeData, onRestart }) => {
        // We pass resumeData to useSimulation to hydrate the reducer if it exists
        const sim = useSimulation(scenario);
        
        useEffect(() => {
            if (view === 'resume' && resumeData) {
                sim.dispatch({ type: 'RESTORE_SESSION', payload: resumeData });
                setView('live');
            } else if (view !== 'debrief' && !sim.state.scenario) {
                 // New Sim init
                 sim.dispatch({ type: 'LOAD_SCENARIO', payload: scenario });
            }
        }, []);
        
        // Guard clause: Don't render screens until scenario is loaded
        if (!sim.state.scenario) {
            return (
                <div className="flex flex-col items-center justify-center min-h-[50vh] text-slate-400 animate-pulse">
                    <Lucide icon="loader-2" className="w-10 h-10 mb-4 animate-spin text-sky-500" />
                    <p className="text-lg font-mono">Initializing Simulation Engine...</p>
                </div>
            );
        }

        if (view === 'live' || view === 'resume') return <LiveSimScreen sim={sim} onFinish={() => { sim.stop(); setView('debrief'); }} onBack={() => setView('briefing')} />;
        if (view === 'debrief') return <DebriefScreen sim={sim} onRestart={onRestart} />;
        return <div className="text-white text-center">Loading Sim Engine...</div>;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
